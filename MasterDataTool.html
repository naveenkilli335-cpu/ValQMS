<!DOCTYPE html>
<html lang="en" data-theme="green">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>LIMS Master Data Tool — ValQMS</title>
  <link rel="icon" href="favicon.jpg?v=5">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <!-- SheetJS & PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    if (typeof pdfjsLib !== "undefined") {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    }
  </script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    
    /* === ALL 15 COLOR THEMES === */
    [data-theme="green"]{--accent:#10b981;--accent-bright:#34d399;--accent-dim:rgba(16,185,129,0.1)}
    [data-theme="cyan"]{--accent:#06b6d4;--accent-bright:#22d3ee;--accent-dim:rgba(6,182,212,0.1)}
    [data-theme="purple"]{--accent:#8b5cf6;--accent-bright:#a78bfa;--accent-dim:rgba(139,92,246,0.1)}
    [data-theme="orange"]{--accent:#f97316;--accent-bright:#fb923c;--accent-dim:rgba(249,115,22,0.1)}
    [data-theme="blue"]{--accent:#3b82f6;--accent-bright:#60a5fa;--accent-dim:rgba(59,130,246,0.1)}
    [data-theme="red"]{--accent:#ef4444;--accent-bright:#f87171;--accent-dim:rgba(239,68,68,0.1)}
    [data-theme="pink"]{--accent:#ec4899;--accent-bright:#f472b6;--accent-dim:rgba(236,72,153,0.1)}
    [data-theme="teal"]{--accent:#14b8a6;--accent-bright:#2dd4bf;--accent-dim:rgba(20,184,166,0.1)}
    [data-theme="indigo"]{--accent:#6366f1;--accent-bright:#818cf8;--accent-dim:rgba(99,102,241,0.1)}
    [data-theme="yellow"]{--accent:#eab308;--accent-bright:#facc15;--accent-dim:rgba(234,179,8,0.1)}
    [data-theme="magenta"]{--accent:#d946ef;--accent-bright:#e879f9;--accent-dim:rgba(217,70,239,0.1)}
    [data-theme="emerald"]{--accent:#059669;--accent-bright:#10b981;--accent-dim:rgba(5,150,105,0.1)}
    [data-theme="amber"]{--accent:#d97706;--accent-bright:#f59e0b;--accent-dim:rgba(217,119,6,0.1)}
    [data-theme="lime"]{--accent:#84cc16;--accent-bright:#a3e635;--accent-dim:rgba(132,204,22,0.1)}
    [data-theme="violet"]{--accent:#7c3aed;--accent-bright:#a78bfa;--accent-dim:rgba(124,58,237,0.1)}

    :root{
      --bg:#0a0e1a;
      --surface:#1a1f2e;
      --border:rgba(255,255,255,0.08);
      --text:#f8fafc;
      --text-dim:#94a3b8;
      --ok:#10b981;
      --warn:#fbbf24;
      --err:#ef4444;
    }
    
    html{scroll-behavior:smooth}
    
    body{
      font-family:'Inter',system-ui,-apple-system,sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
      padding:24px;
      transition:background 0.3s,color 0.3s;
    }

    /* Header */
    .topbar{
      max-width:1400px;
      margin:0 auto 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 24px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      backdrop-filter:blur(12px);
    }

    .brand{display:flex;gap:16px;align-items:center}

    .logo-container{
      display:flex;
      align-items:center;
      gap:12px;
      text-decoration:none;
      color:var(--text);
    }

    .logo-mark{
      display:flex;
      align-items:center;
      justify-content:center;
      width:40px;
      height:40px;
      background:linear-gradient(135deg,var(--accent),var(--accent-bright));
      border-radius:10px;
      overflow:hidden;
      box-shadow:0 4px 16px var(--accent-dim);
      transition:all 0.3s;
    }

    .logo-mark img{
      width:100%;
      height:100%;
      object-fit:contain;
      padding:5px;
    }

    .brand-text h1{
      font-size:20px;
      font-weight:800;
      letter-spacing:-0.5px;
      margin:0;
    }

    .brand-text .subtitle{
      font-size:13px;
      color:var(--text-dim);
      font-weight:500;
    }

    .header-actions{display:flex;gap:12px;align-items:center}

    .btn-home{
      padding:8px 16px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:10px;
      color:var(--text-dim);
      text-decoration:none;
      font-size:14px;
      font-weight:600;
      transition:all 0.2s;
    }

    .btn-home:hover{
      background:var(--accent-dim);
      color:var(--text);
      border-color:var(--accent);
    }

    /* Container */
    .container{max-width:1400px;margin:0 auto}

    .card{
      background:var(--surface);
      padding:24px;
      border-radius:16px;
      border:1px solid var(--border);
      margin-bottom:16px;
      transition:all 0.3s;
    }

    .card h3{
      font-size:16px;
      font-weight:700;
      margin:0 0 12px 0;
      letter-spacing:-0.3px;
    }

    /* How to Use with Toggle */
    .how-to-use{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      padding:20px 24px;
      margin-bottom:24px;
      transition:all 0.3s;
    }

    .how-to-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      user-select:none;
    }

    .how-to-header h3{
      font-size:16px;
      font-weight:700;
      margin:0;
      color:var(--accent);
      display:flex;
      align-items:center;
      gap:8px;
      transition:color 0.3s;
    }

    .toggle-icon{
      font-size:14px;
      transition:transform 0.3s;
    }

    .toggle-icon.collapsed{
      transform:rotate(-90deg);
    }

    .how-to-content{
      overflow:hidden;
      transition:max-height 0.3s ease-out, opacity 0.3s;
      max-height:500px;
      opacity:1;
    }

    .how-to-content.hidden{
      max-height:0;
      opacity:0;
      margin-top:0;
    }

    .how-to-content ul{
      margin:12px 0 0 20px;
      color:var(--text-dim);
      font-size:13px;
      line-height:1.8;
    }

    .how-to-content li{margin-bottom:6px}

/* File Upload */
.upload-area{
  border:2px dashed var(--border);
  border-radius:16px;
  padding:40px 20px;
  text-align:center;
  cursor:pointer;
  transition:all 0.3s;
  background:var(--accent-dim);
}

.upload-area:hover{
  border-color:var(--accent);
  background:var(--accent-dim);
  filter:brightness(1.2);
  transform:translateY(-2px);
}

.upload-icon{
  font-size:48px;
  margin-bottom:12px;
}

.upload-text{
  font-size:16px;
  font-weight:700;
  color:var(--text);
  margin-bottom:6px;
}

.upload-subtext{
  font-size:13px;
  color:var(--text-dim);
}

.file-input{display:none}

/* Two Column Layout */
.two-column{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:16px;
  margin-bottom:16px;
}

/* Buttons */
.btn{
  width:100%;
  padding:14px 24px;
  border:none;
  border-radius:12px;
  font-size:15px;
  font-weight:700;
  cursor:pointer;
  transition:all 0.3s;
  display:flex;
  align-items:center;
  justify-content:center;
  gap:10px;
}

.btn-primary{
  background:var(--accent);
  color:#fff;
}

.btn-primary:hover{
  background:var(--accent-bright);
  transform:translateY(-2px);
  box-shadow:0 8px 20px var(--accent-dim);
}

.btn-success{
  background:var(--ok);
  color:#fff;
}

.btn-success:hover{
  transform:translateY(-2px);
  box-shadow:0 8px 20px rgba(16,185,129,0.3);
}

/* Stats */
.stats{
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:12px;
  margin-bottom:20px;
}

.stat-card{
  padding:20px;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:12px;
  text-align:center;
  transition:all 0.3s;
}

.stat-card:hover{
  transform:translateY(-4px);
  box-shadow:0 8px 20px rgba(0,0,0,0.1);
  border-color:var(--accent);
}

.stat-number{
  font-size:32px;
  font-weight:900;
  color:var(--accent);
  margin-bottom:6px;
  transition:color 0.3s;
}

.stat-label{
  font-size:12px;
  font-weight:600;
  color:var(--text-dim);
  text-transform:uppercase;
  letter-spacing:0.5px;
}

/* Table */
table{
  width:100%;
  border-collapse:collapse;
  font-size:13px;
}

th,td{
  padding:12px;
  border-bottom:1px solid var(--border);
  text-align:left;
}

th{
  position:sticky;
  top:0;
  background:var(--surface);
  z-index:2;
  font-weight:700;
  color:var(--text);
}

td.truncated{
  background:rgba(251,191,36,0.15);
  border-left:3px solid var(--warn);
}

/* Info boxes */
.info-box{
  background:var(--accent-dim);
  border:1px solid var(--accent);
  border-left:4px solid var(--accent);
  padding:16px 20px;
  border-radius:12px;
  margin-bottom:16px;
  transition:all 0.3s;
}

.info-box h4{
  color:var(--accent);
  font-size:14px;
  font-weight:700;
  margin-bottom:8px;
  transition:color 0.3s;
}

.info-box p{
  font-size:13px;
  color:var(--text-dim);
  line-height:1.7;
}

.warning-box{
  background:rgba(251,191,36,0.08);
  border:1px solid rgba(251,191,36,0.2);
  border-left:4px solid var(--warn);
  padding:16px 20px;
  border-radius:12px;
  margin-bottom:16px;
}

.warning-box h4{
  color:var(--warn);
  font-size:14px;
  font-weight:700;
  margin-bottom:8px;
}

.pdf-notice{
  background:rgba(251,191,36,0.08);
  border:1px solid rgba(251,191,36,0.2);
  border-left:4px solid var(--warn);
  padding:16px 20px;
  border-radius:12px;
  margin-bottom:16px;
  color:var(--text);
}

.pdf-preview{
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:12px;
  padding:16px;
  margin-bottom:16px;
  max-height:300px;
  overflow-y:auto;
}

.pdf-preview h5{
  color:var(--text);
  font-size:14px;
  font-weight:700;
  margin-bottom:12px;
}

.pdf-preview pre{
  background:var(--accent-dim);
  padding:12px;
  border-radius:8px;
  font-size:12px;
  color:var(--text);
  border:1px solid var(--border);
}

/* Mapping Table */
.mapping-table-container{
  max-height:500px;
  overflow:auto;
  border:1px solid var(--border);
  border-radius:12px;
  background:var(--surface);
  margin-top:12px;
}

.mapping-table{
  width:100%;
  border-collapse:collapse;
}

.mapping-table thead{
  background:linear-gradient(135deg,var(--accent),var(--accent-bright));
  position:sticky;
  top:0;
  z-index:10;
  transition:background 0.3s;
}

.mapping-table th{
  padding:14px 12px;
  text-align:left;
  font-size:12px;
  font-weight:800;
  text-transform:uppercase;
  letter-spacing:0.5px;
  color:#fff;
}

.mapping-table tbody tr:hover{
  background:var(--accent-dim);
}

.mapping-table td{
  padding:10px 12px;
  font-size:13px;
  border-bottom:1px solid var(--border);
  color:var(--text);
}

.mapping-table td.field-name{
  font-weight:700;
}

.mapping-table td.field-name.required{
  background:rgba(251,191,36,0.08);
  border-left:3px solid var(--warn);
}

.mapping-select{
  width:100%;
  padding:8px 12px;
  border:2px solid var(--border);
  border-radius:8px;
  font-size:13px;
  font-weight:600;
  background:var(--surface);
  color:var(--text);
  cursor:pointer;
  transition:all 0.2s;
}

.mapping-select:hover{
  border-color:var(--accent);
}

.mapping-select:focus{
  outline:none;
  border-color:var(--accent);
  box-shadow:0 0 0 3px var(--accent-dim);
}

.mapping-select.unmapped{
  background:rgba(251,191,36,0.1);
  border-color:var(--warn);
}

.mapping-select.mapped{
  background:rgba(16,185,129,0.1);
  border-color:var(--ok);
}

/* Utility */
.hidden{display:none}

.length-badge{
  display:inline-block;
  padding:4px 8px;
  border-radius:6px;
  font-size:11px;
  font-weight:700;
  background:rgba(239,68,68,0.1);
  color:var(--err);
  margin-left:6px;
}

.round-badge{
  display:inline-block;
  padding:4px 8px;
  border-radius:6px;
  font-size:11px;
  font-weight:700;
  background:rgba(16,185,129,0.1);
  color:var(--ok);
  margin-left:6px;
}

.export-options{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}

.preview-section{
  background:var(--surface);
  padding:24px;
  border-radius:16px;
  margin-bottom:16px;
  border:1px solid var(--border);
  overflow-x:auto;
}

.preview-table{
  max-height:450px;
  overflow:auto;
  border:1px solid var(--border);
  border-radius:12px;
  background:var(--surface);
}

.truncation-log{
  max-height:220px;
  overflow-y:auto;
  background:var(--surface);
  border:1px solid var(--border);
  border-radius:8px;
  padding:12px;
  font-size:12px;
  font-family:'SF Mono','Monaco','Courier New',monospace;
  margin-top:12px;
}

.truncation-log div{
  padding:6px;
  border-bottom:1px solid var(--border);
  color:var(--text);
}

/* Responsive */
@media(max-width:768px){
  .two-column,.stats,.export-options{grid-template-columns:1fr}
  .topbar{flex-direction:column;gap:16px;text-align:center}
  .header-actions{width:100%;justify-content:center}
}

::-webkit-scrollbar{width:10px;height:10px}
::-webkit-scrollbar-track{background:var(--bg);border-radius:10px}
::-webkit-scrollbar-thumb{background:linear-gradient(135deg,var(--accent),var(--accent-bright));border-radius:10px;transition:background 0.3s}
  </style>
</head>
<body>
  
  <!-- Header -->
  <div class="topbar">
    <div class="brand">
      <a href="index.html" class="logo-container">
        <div class="logo-mark">
          <img src="favicon.jpg" alt="ValQMS Logo">
        </div>
        <div class="brand-text">
          <h1>ValQMS Tools</h1>
          <div class="subtitle">LIMS Master Data Tool</div>
        </div>
      </a>
    </div>
    <div class="header-actions">
      <a href="index.html" class="btn-home">← Home</a>
    </div>
  </div>

  <div class="container">
    
    <!-- How to Use with Toggle -->
    <div class="how-to-use">
      <div class="how-to-header" id="howToToggle">
        <h3>📖 How to Use</h3>
        <span class="toggle-icon" id="toggleIcon">▼</span>
      </div>
      <div class="how-to-content" id="howToContent">
        <ul>
          <li><strong>Step 1:</strong> Upload your LIMS field template (Excel with field definitions)</li>
          <li><strong>Step 2:</strong> Upload your user data file (Excel, CSV, or PDF)</li>
          <li><strong>Step 3:</strong> For PDF: Tool uses smart multi-line detection for product names</li>
          <li><strong>Step 4:</strong> Map user data columns to LIMS fields</li>
          <li><strong>Step 5:</strong> Tool will auto-transform and truncate fields based on LIMS rules</li>
        </ul>
      </div>
    </div>

    <div id="statusBox" class="info-box hidden">
      <h4>✓ Status</h4>
      <p id="statusText">Waiting for files...</p>
    </div>

    <div class="two-column">
      <div>
        <label style="display:block;font-weight:700;margin-bottom:12px">Upload LIMS Template</label>
        <div class="upload-area" onclick="document.getElementById('templateInput').click()">
          <div class="upload-icon">📋</div>
          <div class="upload-text" id="templateText">Upload Template</div>
          <div class="upload-subtext">Excel: LIMS TEMPLATE WITH FIELDS</div>
        </div>
        <input type="file" id="templateInput" class="file-input" accept=".xlsx,.xls">
      </div>

      <div>
        <label style="display:block;font-weight:700;margin-bottom:12px">Upload User Data</label>
        <div class="upload-area" onclick="document.getElementById('dataInput').click()">
          <div class="upload-icon">📁</div>
          <div class="upload-text" id="dataText">Upload Data</div>
          <div class="upload-subtext">Excel, CSV, or PDF accepted</div>
        </div>
        <input type="file" id="dataInput" class="file-input" accept=".xlsx,.xls,.csv,.pdf">
      </div>
    </div>

    <div id="pdfNotice" class="pdf-notice hidden">
      <strong>⚠️ PDF File Detected:</strong> Using smart multi-line product name detection. Review extracted data carefully.
    </div>

    <div id="pdfPreview" class="pdf-preview hidden">
      <h5>📄 Detected Columns & Sample Data:</h5>
      <pre id="pdfPreviewText"></pre>
    </div>

    <div id="dependencyInfo" class="info-box hidden" style="background:rgba(16,185,129,0.08);border-left-color:var(--ok)">
      <h5 style="color:var(--ok)">⚠️ Dependency Order Detected</h5>
      <p id="dependencyText"></p>
    </div>

    <div id="mappingSection" class="card hidden">
      <h3>📋 Map Your Columns to LIMS Fields</h3>
      <div id="mappingRows"></div>
    </div>

    <div id="processSection" class="hidden">
      <button class="btn btn-primary" onclick="processData()">
        <span>⚙️</span> Process & Transform Data
      </button>
      <p style="text-align:center;color:var(--text-dim);font-size:13px;margin-top:12px">
        💡 Tip: Fields exceeding MAX_LENGTH will be automatically truncated
      </p>
    </div>

    <div id="truncationWarning" class="warning-box hidden">
      <h4>⚠️ Length Truncations Detected</h4>
      <p id="truncationSummary" style="margin-bottom:8px;color:var(--text)"></p>
      <div id="truncationLog" class="truncation-log"></div>
    </div>

    <div id="resultsSection" class="hidden">
      <div class="stats">
        <div class="stat-card">
          <div class="stat-number" id="totalStat">0</div>
          <div class="stat-label">Total Records</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="cleanedStat">0</div>
          <div class="stat-label">Valid Records</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="transformedStat">0</div>
          <div class="stat-label">Transformations</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="issuesStat">0</div>
          <div class="stat-label">Auto-Fixed</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="truncatedStat">0</div>
          <div class="stat-label">Truncated</div>
        </div>
      </div>

      <div class="preview-section">
        <h3>👀 Preview LIMS-Ready Data</h3>
        <div class="preview-table">
          <table>
            <thead id="previewHeader"></thead>
            <tbody id="previewBody"></tbody>
          </table>
        </div>
      </div>

      <div class="export-options">
        <button class="btn btn-success" onclick="exportMainData()">
          <span>⬇️</span> Download Main Table
        </button>
        <button class="btn btn-success" onclick="exportAllTables()" id="exportAllBtn" style="display:none">
          <span>📦</span> Download All Tables (Ordered)
        </button>
      </div>
    </div>

  </div>

<script>
/* === HOW TO USE TOGGLE === */
const howToToggle = document.getElementById('howToToggle');
const howToContent = document.getElementById('howToContent');
const toggleIcon = document.getElementById('toggleIcon');

// Load toggle state
const howToVisible = localStorage.getItem('howToVisible') !== 'false';
if(!howToVisible){
  howToContent.classList.add('hidden');
  toggleIcon.classList.add('collapsed');
}

howToToggle.addEventListener('click', () => {
  const isHidden = howToContent.classList.toggle('hidden');
  toggleIcon.classList.toggle('collapsed');
  localStorage.setItem('howToVisible', !isHidden);
});

/* === THEME SYNC (Shared with index.html) === */
function initTheme(){
  const savedTheme = localStorage.getItem('valqmsTheme') || 'green';
  document.documentElement.setAttribute('data-theme', savedTheme);
}
initTheme();

/* === YOUR EXISTING JAVASCRIPT CODE GOES HERE === */
// [Insert all your existing Master Data Tool JavaScript code here]
// All the data processing logic, PDF parsing, Excel handling, etc.
</script>

</body>
</html>
