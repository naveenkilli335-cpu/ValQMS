<!DOCTYPE html>
<html lang="en" data-theme="green">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Advanced SOP Version Comparator ‚Äî ValQMS</title>
  <link rel="icon" href="favicon.jpg?v=5">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    
    [data-theme="green"]{--accent:#10b981;--accent-bright:#34d399;--accent-dim:rgba(16,185,129,0.1)}
    [data-theme="cyan"]{--accent:#06b6d4;--accent-bright:#22d3ee;--accent-dim:rgba(6,182,212,0.1)}
    [data-theme="purple"]{--accent:#8b5cf6;--accent-bright:#a78bfa;--accent-dim:rgba(139,92,246,0.1)}
    [data-theme="orange"]{--accent:#f97316;--accent-bright:#fb923c;--accent-dim:rgba(249,115,22,0.1)}
    [data-theme="blue"]{--accent:#3b82f6;--accent-bright:#60a5fa;--accent-dim:rgba(59,130,246,0.1)}
    [data-theme="red"]{--accent:#ef4444;--accent-bright:#f87171;--accent-dim:rgba(239,68,68,0.1)}
    [data-theme="pink"]{--accent:#ec4899;--accent-bright:#f472b6;--accent-dim:rgba(236,72,153,0.1)}
    [data-theme="teal"]{--accent:#14b8a6;--accent-bright:#2dd4bf;--accent-dim:rgba(20,184,166,0.1)}
    [data-theme="indigo"]{--accent:#6366f1;--accent-bright:#818cf8;--accent-dim:rgba(99,102,241,0.1)}
    [data-theme="yellow"]{--accent:#eab308;--accent-bright:#facc15;--accent-dim:rgba(234,179,8,0.1)}
    [data-theme="magenta"]{--accent:#d946ef;--accent-bright:#e879f9;--accent-dim:rgba(217,70,239,0.1)}
    [data-theme="emerald"]{--accent:#059669;--accent-bright:#10b981;--accent-dim:rgba(5,150,105,0.1)}
    [data-theme="amber"]{--accent:#d97706;--accent-bright:#f59e0b;--accent-dim:rgba(217,119,6,0.1)}
    [data-theme="lime"]{--accent:#84cc16;--accent-bright:#a3e635;--accent-dim:rgba(132,204,22,0.1)}
    [data-theme="violet"]{--accent:#7c3aed;--accent-bright:#a78bfa;--accent-dim:rgba(124,58,237,0.1)}

    :root{
      --bg:#0a0e1a;
      --surface:#1a1f2e;
      --border:rgba(255,255,255,0.08);
      --text:#f8fafc;
      --text-dim:#94a3b8;
      --added:#34d399;
      --deleted:#f87171;
      --modified:#facc15;
    }
    
    html{scroll-behavior:smooth}
    body{
      font-family:'Inter',system-ui,-apple-system,sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
      padding:24px;
    }

    .topbar{
      max-width:1800px;
      margin:0 auto 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 24px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
    }
    .logo-container{display:flex;align-items:center;gap:12px;text-decoration:none;color:var(--text)}
    .logo-mark{
      display:flex;
      align-items:center;
      justify-content:center;
      width:40px;
      height:40px;
      background:linear-gradient(135deg,var(--accent),var(--accent-bright));
      border-radius:10px;
      overflow:hidden;
    }
    .logo-mark img{width:100%;height:100%;object-fit:contain;padding:5px}
    .brand-text h1{font-size:20px;font-weight:800;letter-spacing:-0.5px;margin:0}
    .brand-text .subtitle{font-size:13px;color:var(--text-dim);font-weight:500}
    .btn-home{
      padding:8px 16px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:10px;
      color:var(--text-dim);
      text-decoration:none;
      font-size:14px;
      font-weight:600;
      transition:all 0.2s;
    }
    .btn-home:hover{background:var(--accent-dim);color:var(--text);border-color:var(--accent)}

    .container{max-width:1800px;margin:0 auto}
    .card{
      background:var(--surface);
      padding:24px;
      border-radius:16px;
      border:1px solid var(--border);
      margin-bottom:16px;
    }
    .card h3{font-size:16px;font-weight:700;margin:0 0 12px 0}

    .how-to-use{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      padding:20px 24px;
      margin-bottom:24px;
    }
    .how-to-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      user-select:none;
    }
    .how-to-header h3{font-size:16px;font-weight:700;margin:0;color:var(--accent)}
    .toggle-icon{font-size:14px;transition:transform 0.3s}
    .toggle-icon.collapsed{transform:rotate(-90deg)}
    .how-to-content{
      overflow:hidden;
      transition:max-height 0.3s ease-out,opacity 0.3s;
      max-height:500px;
      opacity:1;
    }
    .how-to-content.hidden{max-height:0;opacity:0;margin-top:0}
    .how-to-content ol{margin:12px 0 0 20px;color:var(--text-dim);font-size:13px;line-height:1.8}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:16px}
    
    .upload-zone{
      border:2px dashed var(--border);
      border-radius:12px;
      padding:32px;
      text-align:center;
      cursor:pointer;
      transition:all 0.3s;
      background:rgba(0,0,0,0.2);
    }
    .upload-zone:hover{border-color:var(--accent);background:var(--accent-dim)}
    
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 20px;
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:10px;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
      transition:all 0.2s;
    }
    .btn:hover{background:var(--accent-bright);transform:translateY(-1px)}
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .btn.secondary{background:var(--surface);border:1px solid var(--border);color:var(--text-dim)}
    .btn.secondary:hover{background:var(--accent-dim);border-color:var(--accent);color:var(--text)}
    
    .actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    
    .stats{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(180px,1fr));
      gap:16px;
      margin-bottom:24px;
    }
    .stat-card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:12px;
      padding:20px;
    }
    .stat-label{font-size:12px;color:var(--text-dim);font-weight:600;text-transform:uppercase;margin-bottom:8px}
    .stat-value{font-size:28px;font-weight:900}
    .stat-added{color:var(--added)}
    .stat-deleted{color:var(--deleted)}
    .stat-modified{color:var(--modified)}
    
    .comparison-view{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
      margin-top:16px;
    }
    .version-panel{
      background:rgba(0,0,0,0.3);
      border:1px solid var(--border);
      border-radius:12px;
      padding:16px;
      max-height:600px;
      overflow-y:auto;
    }
    .version-panel h4{
      font-size:14px;
      font-weight:700;
      margin-bottom:12px;
      padding-bottom:8px;
      border-bottom:1px solid var(--border);
    }
    .diff-line{
      padding:4px 8px;
      margin:2px 0;
      border-radius:4px;
      font-family:'SF Mono',Monaco,monospace;
      font-size:13px;
      line-height:1.8;
    }
    .diff-added{background:rgba(52,211,153,0.15);border-left:3px solid var(--added)}
    .diff-deleted{background:rgba(248,113,113,0.15);border-left:3px solid var(--deleted)}
    .diff-modified{background:rgba(250,204,21,0.15);border-left:3px solid var(--modified)}
    .diff-unchanged{background:transparent;opacity:0.6}
    
    .legend{
      display:flex;
      gap:16px;
      padding:12px;
      background:rgba(0,0,0,0.3);
      border-radius:8px;
      font-size:12px;
      margin-bottom:16px;
    }
    .legend-item{display:flex;align-items:center;gap:8px}
    .legend-color{width:16px;height:16px;border-radius:4px}

    @media(max-width:768px){
      .grid,.comparison-view{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="brand">
      <a href="index.html" class="logo-container">
        <div class="logo-mark">
          <img src="favicon.jpg" alt="ValQMS">
        </div>
        <div class="brand-text">
          <h1>ValQMS Tools</h1>
          <div class="subtitle">Advanced SOP Version Comparator</div>
        </div>
      </a>
    </div>
    <div class="header-actions">
      <a href="index.html" class="btn-home">‚Üê Home</a>
    </div>
  </div>

  <div class="container">
    
    <div class="how-to-use">
      <div class="how-to-header" id="howToToggle">
        <h3>üìñ How to Use SOP Comparator</h3>
        <span class="toggle-icon" id="toggleIcon">‚ñº</span>
      </div>
      <div class="how-to-content" id="howToContent">
        <ol>
          <li><strong>Upload Old Version:</strong> Drop or select the previous SOP version (TXT/Word/PDF)</li>
          <li><strong>Upload New Version:</strong> Drop or select the current SOP version</li>
          <li><strong>Click Compare:</strong> System performs intelligent diff analysis</li>
          <li><strong>Review Changes:</strong> See additions (green), deletions (red), modifications (yellow)</li>
          <li><strong>Training Impact:</strong> AI suggests which sections require retraining</li>
          <li><strong>Export Report:</strong> Download change summary with training matrix</li>
        </ol>
      </div>
    </div>

    <div class="stats" id="statsContainer" style="display:none">
      <div class="stat-card">
        <div class="stat-label">Total Changes</div>
        <div class="stat-value" id="statTotal" style="color:var(--accent)">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Additions</div>
        <div class="stat-value stat-added" id="statAdded">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Deletions</div>
        <div class="stat-value stat-deleted" id="statDeleted">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Modifications</div>
        <div class="stat-value stat-modified" id="statModified">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Training Impact</div>
        <div class="stat-value" id="statImpact" style="color:#ec4899">-</div>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>üìÑ Old Version (Previous)</h3>
        <div class="upload-zone" id="oldUploadZone">
          <div style="font-size:48px;margin-bottom:12px">üìã</div>
          <div style="font-weight:700;margin-bottom:8px">Drop Old SOP Version</div>
          <div style="font-size:13px;color:var(--text-dim)">TXT, Word, or PDF</div>
          <input type="file" id="oldFileInput" accept=".txt,.doc,.docx,.pdf" style="display:none">
        </div>
        <div id="oldStatus" style="margin-top:12px;font-size:13px;color:var(--text-dim)"></div>
      </div>

      <div class="card">
        <h3>üìù New Version (Current)</h3>
        <div class="upload-zone" id="newUploadZone">
          <div style="font-size:48px;margin-bottom:12px">üìÑ</div>
          <div style="font-weight:700;margin-bottom:8px">Drop New SOP Version</div>
          <div style="font-size:13px;color:var(--text-dim)">TXT, Word, or PDF</div>
          <input type="file" id="newFileInput" accept=".txt,.doc,.docx,.pdf" style="display:none">
        </div>
        <div id="newStatus" style="margin-top:12px;font-size:13px;color:var(--text-dim)"></div>
      </div>
    </div>

    <div class="card">
      <div class="actions">
        <button id="compareBtn" class="btn" disabled>
          <span>üîç</span>
          <span>Compare Versions with AI Analysis</span>
        </button>
        <button id="exportReport" class="btn secondary" disabled>
          <span>üì•</span>
          <span>Export Change Report</span>
        </button>
        <button id="exportTraining" class="btn secondary" disabled>
          <span>üéì</span>
          <span>Export Training Matrix</span>
        </button>
      </div>
    </div>

    <div class="card" id="resultsCard" style="display:none">
      <h3>üìä Comparison Results</h3>
      
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color" style="background:var(--added)"></div>
          <span>Added Lines</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background:var(--deleted)"></div>
          <span>Deleted Lines</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background:var(--modified)"></div>
          <span>Modified Lines</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background:rgba(255,255,255,0.1)"></div>
          <span>Unchanged</span>
        </div>
      </div>

      <div class="comparison-view">
        <div class="version-panel">
          <h4>üìÑ Old Version</h4>
          <div id="oldVersionContent"></div>
        </div>
        <div class="version-panel">
          <h4>üìù New Version</h4>
          <div id="newVersionContent"></div>
        </div>
      </div>
    </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script>
    // Theme sync
    function initTheme(){
      const savedTheme = localStorage.getItem('valqmsTheme') || 'green';
      document.documentElement.setAttribute('data-theme', savedTheme);
    }
    initTheme();

    // Toggle
    document.getElementById('howToToggle').addEventListener('click', () => {
      const content = document.getElementById('howToContent');
      const icon = document.getElementById('toggleIcon');
      content.classList.toggle('hidden');
      icon.classList.toggle('collapsed');
    });

    let oldText = '';
    let newText = '';
    let diffResults = [];

    // Upload handlers
    const oldUploadZone = document.getElementById('oldUploadZone');
    const oldFileInput = document.getElementById('oldFileInput');
    const newUploadZone = document.getElementById('newUploadZone');
    const newFileInput = document.getElementById('newFileInput');

    oldUploadZone.addEventListener('click', () => oldFileInput.click());
    newUploadZone.addEventListener('click', () => newFileInput.click());

    oldFileInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0], 'old'));
    newFileInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0], 'new'));

    async function handleFileUpload(file, type) {
      if (!file) return;
      
      const statusEl = document.getElementById(type + 'Status');
      statusEl.textContent = 'Processing...';
      statusEl.style.color = 'var(--accent)';
      
      try {
        let text = '';
        
        if (file.name.endsWith('.txt')) {
          text = await file.text();
        } else if (file.name.endsWith('.docx') || file.name.endsWith('.doc')) {
          const arrayBuffer = await file.arrayBuffer();
          const result = await mammoth.extractRawText({arrayBuffer});
          text = result.value;
        } else if (file.name.endsWith('.pdf')) {
          text = await extractPDFText(file);
        }
        
        if (type === 'old') {
          oldText = text;
          statusEl.textContent = '‚úÖ Old version loaded (' + text.length + ' chars)';
        } else {
          newText = text;
          statusEl.textContent = '‚úÖ New version loaded (' + text.length + ' chars)';
        }
        
        checkReadyToCompare();
      } catch (err) {
        statusEl.textContent = '‚ùå Error: ' + err.message;
        statusEl.style.color = 'var(--deleted)';
      }
    }

    async function extractPDFText(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
      let fullText = '';
      
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        fullText += pageText + '\n';
      }
      
      return fullText;
    }

    function checkReadyToCompare() {
      const ready = oldText.length > 0 && newText.length > 0;
      document.getElementById('compareBtn').disabled = !ready;
    }

    // Compare versions
    document.getElementById('compareBtn').addEventListener('click', compareVersions);

    function compareVersions() {
      const oldLines = oldText.split('\n').filter(l => l.trim());
      const newLines = newText.split('\n').filter(l => l.trim());
      
      diffResults = computeDiff(oldLines, newLines);
      displayComparison(oldLines, newLines, diffResults);
      updateStatistics(diffResults);
      
      document.getElementById('resultsCard').style.display = 'block';
      document.getElementById('exportReport').disabled = false;
      document.getElementById('exportTraining').disabled = false;
    }

    function computeDiff(oldLines, newLines) {
      const results = [];
      let added = 0, deleted = 0, modified = 0;
      
      const oldSet = new Set(oldLines);
      const newSet = new Set(newLines);
      
      // Find additions
      newLines.forEach((line, idx) => {
        if (!oldSet.has(line)) {
          const similar = findSimilar(line, oldLines);
          if (similar) {
            results.push({type: 'modified', line, oldLine: similar, index: idx});
            modified++;
          } else {
            results.push({type: 'added', line, index: idx});
            added++;
          }
        } else {
          results.push({type: 'unchanged', line, index: idx});
        }
      });
      
      // Find deletions
      oldLines.forEach((line, idx) => {
        if (!newSet.has(line) && !results.some(r => r.oldLine === line)) {
          results.push({type: 'deleted', line, index: idx});
          deleted++;
        }
      });
      
      return {changes: results, stats: {added, deleted, modified}};
    }

    function findSimilar(line, lines) {
      for (let l of lines) {
        const similarity = getSimilarity(line, l);
        if (similarity > 0.6 && similarity < 1.0) return l;
      }
      return null;
    }

    function getSimilarity(s1, s2) {
      const longer = s1.length > s2.length ? s1 : s2;
      const shorter = s1.length > s2.length ? s2 : s1;
      if (longer.length === 0) return 1.0;
      return (longer.length - editDistance(longer, shorter)) / longer.length;
    }

    function editDistance(s1, s2) {
      s1 = s1.toLowerCase();
      s2 = s2.toLowerCase();
      const costs = [];
      for (let i = 0; i <= s1.length; i++) {
        let lastValue = i;
        for (let j = 0; j <= s2.length; j++) {
          if (i === 0) costs[j] = j;
          else if (j > 0) {
            let newValue = costs[j - 1];
            if (s1.charAt(i - 1) !== s2.charAt(j - 1))
              newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1;
            costs[j - 1] = lastValue;
            lastValue = newValue;
          }
        }
        if (i > 0) costs[s2.length] = lastValue;
      }
      return costs[s2.length];
    }

    function displayComparison(oldLines, newLines, diff) {
      const oldContent = document.getElementById('oldVersionContent');
      const newContent = document.getElementById('newVersionContent');
      
      oldContent.innerHTML = '';
      newContent.innerHTML = '';
      
      // Display old version
      oldLines.forEach((line, idx) => {
        const change = diff.changes.find(c => c.oldLine === line || (c.type === 'unchanged' && c.line === line && c.index === idx));
        const type = change ? (change.type === 'modified' ? 'deleted' : change.type === 'unchanged' ? 'unchanged' : 'deleted') : 'unchanged';
        const div = document.createElement('div');
        div.className = 'diff-line diff-' + type;
        div.textContent = line || '(empty line)';
        oldContent.appendChild(div);
      });
      
      // Display new version
      diff.changes.forEach(change => {
        if (change.type === 'deleted') return;
        const div = document.createElement('div');
        div.className = 'diff-line diff-' + change.type;
        div.textContent = change.line || '(empty line)';
        newContent.appendChild(div);
      });
    }

    function updateStatistics(diff) {
      const {added, deleted, modified} = diff.stats;
      const total = added + deleted + modified;
      
      document.getElementById('statTotal').textContent = total;
      document.getElementById('statAdded').textContent = added;
      document.getElementById('statDeleted').textContent = deleted;
      document.getElementById('statModified').textContent = modified;
      
      // Calculate training impact
      let impact = 'Low';
      if (total > 20 || deleted > 5) impact = 'High';
      else if (total > 10 || modified > 5) impact = 'Medium';
      
      document.getElementById('statImpact').textContent = impact;
      document.getElementById('statsContainer').style.display = 'grid';
    }

    // Export report
    document.getElementById('exportReport').addEventListener('click', () => {
      const {added, deleted, modified} = diffResults.stats;
      const report = `SOP VERSION COMPARISON REPORT\n` +
        `Generated: ${new Date().toLocaleString()}\n\n` +
        `SUMMARY\n` +
        `Total Changes: ${added + deleted + modified}\n` +
        `Additions: ${added}\n` +
        `Deletions: ${deleted}\n` +
        `Modifications: ${modified}\n\n` +
        `DETAILED CHANGES\n\n` +
        diffResults.changes.filter(c => c.type !== 'unchanged').map(c => 
          `[${c.type.toUpperCase()}] ${c.line}`
        ).join('\n');
      
      const blob = new Blob([report], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'SOP_Comparison_Report_' + new Date().toISOString().split('T')[0] + '.txt';
      a.click();
      URL.revokeObjectURL(url);
    });

    // Export training matrix
    document.getElementById('exportTraining').addEventListener('click', () => {
      const critical = diffResults.changes.filter(c => c.type === 'deleted' || c.type === 'modified');
      const matrix = `TRAINING IMPACT MATRIX\n\n` +
        `Critical Changes Requiring Retraining:\n\n` +
        critical.map((c, i) => `${i+1}. [${c.type.toUpperCase()}] ${c.line.substring(0, 100)}...`).join('\n') +
        `\n\nRECOMMENDATION: All personnel must complete retraining on modified procedures.`;
      
      const blob = new Blob([matrix], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'Training_Impact_Matrix_' + new Date().toISOString().split('T')[0] + '.txt';
      a.click();
      URL.revokeObjectURL(url);
    });
  </script>
</body>
</html>
