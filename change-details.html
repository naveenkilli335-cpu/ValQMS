<!DOCTYPE html>
<html lang="en" data-theme="green" data-bg="mint">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Change Request Details ‚Äî ValQMS</title>
<link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
<link rel="icon" type="image/x-icon" href="valqms-logo.svg" sizes="any">
<link rel="apple-touch-icon" sizes="180x180" href="favicon.jpg">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<style>
*{margin:0;padding:0;box-sizing:border-box}
[data-theme="green"]{--accent:#10b981;--accent-bright:#34d399;--accent-dim:rgba(16,185,129,0.15);--accent-glow:rgba(16,185,129,0.4)}
:root{--text:#ffffff;--text-dim:#94a3b8;--surface:rgba(255,255,255,0.05);--surface-hover:rgba(255,255,255,0.08);--border:rgba(255,255,255,0.1);--glass:rgba(255,255,255,0.03)}
[data-bg="mesh"] body{background:#0f172a;position:relative}
[data-bg="mesh"] body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 20% 50%, rgba(16,185,129,0.15) 0%, transparent 50%),radial-gradient(circle at 80% 80%, rgba(99,102,241,0.15) 0%, transparent 50%);animation:meshMove 15s ease-in-out infinite alternate;z-index:-1}
@keyframes meshMove{0%{transform:scale(1)}100%{transform:scale(1.1)}}
body{font-family:'Inter',sans-serif;color:var(--text);line-height:1.6;min-height:100vh;overflow-x:hidden;padding-top:72px}
.container{width:100%;max-width:none;margin:24px 0 0;padding:24px}
/* Fixed glass header (match tools/comparison) */
header{position:fixed;top:12px;left:0;right:0;z-index:1000;padding:0 24px;pointer-events:none}
.header-glass{background:#0f172a !important;backdrop-filter:blur(20px) saturate(180%);-webkit-backdrop-filter:blur(20px) saturate(180%);border:1px solid rgba(255,255,255,0.08) !important;border-radius:20px;box-shadow:0 8px 32px rgba(0,0,0,0.2),inset 0 1px 0 rgba(255,255,255,0.06);color:#fff;pointer-events:auto}
.header-container{display:flex;justify-content:space-between;align-items:center;height:72px;width:100%;max-width:none;margin:0;padding:0 32px}
/* Logo mark + brand text */
.logo{display:flex;align-items:center;gap:12px;text-decoration:none;color:#fff;font-weight:800;font-size:22px;letter-spacing:-0.7px;transition:all 0.3s}
.logo:hover{transform:translateY(-2px)}
.logo-mark{display:flex;align-items:center;justify-content:center;width:48px;height:48px;background:linear-gradient(135deg,var(--accent),var(--accent-bright));border-radius:12px;box-shadow:0 4px 20px var(--accent-glow);transition:all 0.3s;position:relative}
.logo-mark::after{content:'';position:absolute;inset:-2px;background:linear-gradient(135deg,var(--accent),var(--accent-bright));border-radius:14px;z-index:-1;opacity:0;filter:blur(10px);transition:opacity 0.3s}
.logo-mark:hover::after{opacity:0.7}
.logo-mark .brand-initials{font-weight:900;font-size:18px;letter-spacing:-0.5px;color:#fff;text-shadow:0 1px 2px rgba(0,0,0,0.25)}
.brand-text{display:flex;flex-direction:column;gap:2px}
.brand-text h1{font-size:20px;font-weight:800;letter-spacing:-0.5px;margin:0;line-height:1.2;color:#fff}
.brand-text .subtitle{font-size:13px;color:rgba(255,255,255,0.85);font-weight:500;line-height:1.2}
.header-controls{display:flex;gap:12px;align-items:center}
/* Green Home button */
.btn-home{padding:10px 20px;background:linear-gradient(135deg,#10b981,#34d399);border:none;border-radius:12px;color:#000;font-size:14px;font-weight:700;text-decoration:none;transition:all 0.3s;display:inline-flex;align-items:center;gap:8px;box-shadow:0 4px 16px rgba(16,185,129,0.4)}
.btn-home:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(16,185,129,0.4)}
/* Compact header action */
.btn-head{padding:10px 14px;background:var(--surface);border:1px solid var(--border);border-radius:10px;color:#fff;font-size:13px;font-weight:700;text-decoration:none;transition:all 0.3s;display:inline-flex;align-items:center;gap:8px}
.btn-head:hover{background:rgba(255,255,255,0.12);border-color:rgba(255,255,255,0.25)}
/* White header buttons (Back, PDF) */
header .btn-head{background:#ffffff !important;border:1px solid #e5e7eb !important;color:#0f172a !important;box-shadow:0 1px 2px rgba(15,23,42,0.06),0 1px 1px rgba(15,23,42,0.03) !important}
header .btn-head:hover{background:#ffffff !important;border-color:var(--accent) !important;transform:translateY(-1px);box-shadow:0 4px 12px rgba(16,185,129,0.15) !important}
.page-header{display:flex;justify-content:space-between;align-items:start;margin-bottom:32px}
.page-title{font-size:28px;font-weight:800;margin-bottom:8px}
.page-subtitle{color:var(--text-dim);font-size:14px}
.workflow-progress{display:flex;justify-content:space-between;margin:32px 0;padding:0 20px;position:relative}
.workflow-progress::before{content:'';position:absolute;top:20px;left:40px;right:40px;height:3px;background:var(--border);z-index:0}
/* Progress line that fills as stages complete */
.workflow-progress::after{
  content:'';
  position:absolute;
  top:20px;
  left:40px;
  height:3px;
  background:var(--accent);
  z-index:0;
  transition:width 0.5s ease;
}

/* Dynamically set width based on completion */
.workflow-progress[data-completion="0"]::after{width:0%}
.workflow-progress[data-completion="1"]::after{width:calc(11.11% - 4px)}
.workflow-progress[data-completion="2"]::after{width:calc(22.22% - 4px)}
.workflow-progress[data-completion="3"]::after{width:calc(33.33% - 4px)}
.workflow-progress[data-completion="4"]::after{width:calc(44.44% - 4px)}
.workflow-progress[data-completion="5"]::after{width:calc(55.55% - 4px)}
.workflow-progress[data-completion="6"]::after{width:calc(66.66% - 4px)}
.workflow-progress[data-completion="7"]::after{width:calc(77.77% - 4px)}
.workflow-progress[data-completion="8"]::after{width:calc(88.88% - 4px)}
.workflow-progress[data-completion="9"]::after{width:calc(100% - 80px)}
.workflow-step{display:flex;flex-direction:column;align-items:center;position:relative;z-index:1;flex:1;max-width:100px}
.workflow-circle{width:42px;height:42px;border-radius:50%;background:var(--surface);border:3px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:20px;margin-bottom:8px;transition:all 0.3s}
.workflow-step.active .workflow-circle{background:var(--accent);border-color:var(--accent);box-shadow:0 0 0 4px var(--accent-dim)}
.workflow-step.completed .workflow-circle,
.workflow-step.active.completed .workflow-circle {
  background: var(--accent);
  border-color: var(--accent);
  color: #000;
  font-weight: 700;
}
.workflow-step.completed .workflow-label{
  color:var(--accent);
}
.workflow-label{font-size:11px;color:var(--text-dim);text-align:center;font-weight:600}
.workflow-step.active .workflow-label{color:var(--accent)}
.grid-2col{display:grid;grid-template-columns:2fr 1fr;gap:24px;margin-bottom:24px}
.card{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:20px}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding-bottom:12px;border-bottom:1px solid var(--border)}
.card-title{font-size:18px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:8px}
.detail-row{display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.05)}
.detail-label{color:var(--text-dim);font-size:13px;font-weight:600}
.detail-value{color:var(--text);font-size:14px;font-weight:500}
.badge{display:inline-flex;align-items:center;padding:4px 12px;border-radius:999px;font-size:11px;font-weight:700}
.badge.draft{background:rgba(148,163,184,0.2);color:#94a3b8}
.badge.medium{background:rgba(251,146,60,0.2);color:#fb923c}
.badge.high{background:rgba(239,68,68,0.2);color:#f87171}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;background:linear-gradient(135deg,var(--accent),var(--accent-bright));color:#000;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.3s;text-decoration:none}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px var(--accent-glow)}
.btn-secondary{background:var(--surface);border:1px solid var(--border);color:var(--text)}
.actions-grid{display:grid;gap:12px}
.action-btn{width:100%;padding:12px;background:var(--surface);border:1px solid var(--border);border-radius:10px;color:var(--text);font-size:14px;font-weight:600;cursor:pointer;transition:all 0.3s;text-align:left}
.action-btn:hover{background:var(--surface-hover);border-color:var(--accent)}
.loading{display:flex;justify-content:center;align-items:center;padding:60px;font-size:18px;color:var(--text-dim)}

/* Theme Colors */
[data-theme="green"]{--accent:#10b981;--accent-bright:#34d399;--accent-dim:rgba(16,185,129,0.15);--accent-glow:rgba(16,185,129,0.4)}
[data-theme="blue"]{--accent:#3b82f6;--accent-bright:#60a5fa;--accent-dim:rgba(59,130,246,0.15);--accent-glow:rgba(59,130,246,0.4)}
[data-theme="purple"]{--accent:#8b5cf6;--accent-bright:#a78bfa;--accent-dim:rgba(139,92,246,0.15);--accent-glow:rgba(139,92,246,0.4)}
[data-theme="orange"]{--accent:#f97316;--accent-bright:#fb923c;--accent-dim:rgba(249,115,22,0.15);--accent-glow:rgba(249,115,22,0.4)}

/* Background Styles */
[data-bg="mesh"] body{background:#0f172a;position:relative}
[data-bg="mesh"] body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 20% 50%, rgba(16,185,129,0.15) 0%, transparent 50%),radial-gradient(circle at 80% 80%, rgba(99,102,241,0.15) 0%, transparent 50%);animation:meshMove 15s ease-in-out infinite alternate;z-index:-1}
[data-bg="gradient"] body{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);position:relative}
[data-bg="dark"] body{background:#0a0e1a;position:relative}
[data-bg="dark"] body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at center, rgba(59,130,246,0.05) 0%, transparent 70%);z-index:-1}
[data-bg="mesh2"] body{background:#0f172a;position:relative}
[data-bg="mesh2"] body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 15% 60%, rgba(255,0,128,0.12), transparent 50%),radial-gradient(circle at 85% 40%, rgba(0,128,255,0.12), transparent 50%),radial-gradient(circle at 50% 90%, rgba(0,255,128,0.1), transparent 50%);animation:mesh2Move 25s ease-in-out infinite alternate;z-index:-1}

@keyframes meshMove{0%{transform:scale(1)}100%{transform:scale(1.1)}}
@keyframes mesh2Move{0%{transform:translate(0,0)}100%{transform:translate(-50px,40px)}}


/* Mint/Light Green Background Theme */
[data-bg="mint"] body {
  background: #d1fae5;
  position: relative;
}

[data-bg="mint"] body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle at 20% 50%, rgba(16,185,129,0.08) 0%, transparent 50%),
              radial-gradient(circle at 80% 80%, rgba(52,211,153,0.08) 0%, transparent 50%);
  z-index: -1;
}

/* Update colors for light theme */
[data-bg="mint"] {
  --text: #1e293b;
  --text-dim: #64748b;
  --surface: rgba(255,255,255,0.7);
  --surface-hover: rgba(255,255,255,0.9);
  --border: rgba(16,185,129,0.2);
  --glass: rgba(255,255,255,0.5);
}

/* Header glass for light theme */
[data-bg="mint"] .header-glass {
  /* Keep dark header like index, override any light theme */
  background: #0f172a !important;
  border: 1px solid rgba(255,255,255,0.08) !important;
  color: #ffffff !important;
}

/* Cards for light theme */
[data-bg="mint"] .card,
[data-bg="mint"] .detail-card,
[data-bg="mint"] .section-card {
  background: rgba(255, 255, 255, 0.7);
  border: 1px solid rgba(16,185,129,0.2);
}

/* Status header for light theme */
[data-bg="mint"] .status-header {
  background: rgba(255, 255, 255, 0.7);
  border: 1px solid rgba(16,185,129,0.2);
}

/* Info grid for light theme */
[data-bg="mint"] .info-item {
  background: rgba(255, 255, 255, 0.5);
  border: 1px solid rgba(16,185,129,0.15);
}

/* Timeline for light theme */
[data-bg="mint"] .timeline-item {
  background: rgba(255, 255, 255, 0.6);
  border-left: 3px solid var(--accent);
}

[data-bg="mint"] .timeline-item::before {
  background: var(--accent);
  border: 3px solid #d1fae5;
}

/* Comments for light theme */
[data-bg="mint"] .comment {
  background: rgba(255, 255, 255, 0.6);
  border: 1px solid rgba(16,185,129,0.15);
}

/* Modal for light theme */
[data-bg="mint"] .modal-content {
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(16,185,129,0.2);
}
/* Dark header + light body for modals (match Manage Roles look) */
[data-bg="mint"] .modal-header {
  background: #0f172a;
  color: #ffffff;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}
[data-bg="mint"] .close-modal {
  color: #ffffff;
}
[data-bg="mint"] .modal-body,
[data-bg="mint"] .modal-footer {
  background: #ffffff;
  color: #1e293b;
}

/* Table styling for light theme */
[data-bg="mint"] thead {
  background: rgba(16,185,129,0.1);
}

[data-bg="mint"] td {
  border-bottom: 1px solid rgba(16,185,129,0.15);
}

[data-bg="mint"] tbody tr:hover {
  background: rgba(16,185,129,0.05);
}

/* Input fields for light theme */
[data-bg="mint"] input[type="text"],
[data-bg="mint"] input[type="date"],
[data-bg="mint"] textarea,
[data-bg="mint"] select {
  background: rgba(255, 255, 255, 0.8);
  border: 1px solid rgba(16,185,129,0.3);
  color: #1e293b;
}

/* Dropdown menus for light theme */
[data-bg="mint"] .btn-secondary { background: rgba(255, 255, 255, 0.7); border: 1px solid rgba(16,185,129,0.3); color: #1e293b; }

/* Workflow progress for light theme */
[data-bg="mint"] .workflow-progress::before {
  background: rgba(16,185,129,0.2);
}

[data-bg="mint"] .workflow-circle {
  background: rgba(255, 255, 255, 0.8);
  border: 2px solid rgba(16,185,129,0.3);
}

/* Tabs for light theme */
[data-bg="mint"] .tabs {
  background: rgba(255, 255, 255, 0.5);
  border: 1px solid rgba(16,185,129,0.2);
}

[data-bg="mint"] .tab {
  color: #64748b;
}

[data-bg="mint"] .tab.active {
  background: rgba(16,185,129,0.15);
  color: #1e293b;
}

/* Action buttons section for light theme */
[data-bg="mint"] .actions {
  background: rgba(255, 255, 255, 0.6);
  border-top: 1px solid rgba(16,185,129,0.2);
}

/* Modal styles (match create form styling) */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);z-index:2000;padding:24px;overflow-y:auto}
.modal.active{display:flex;align-items:center;justify-content:center}
.modal-content{background:rgba(15,23,42,0.95);border:1px solid var(--border);border-radius:20px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto}
.modal-header{padding:24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-header h2{font-size:22px;font-weight:800}
.modal-body{padding:24px}
.modal-footer{padding:24px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end}
.close-modal{background:none;border:none;color:var(--text-dim);font-size:24px;cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:8px;transition:all 0.3s}
.close-modal:hover{background:var(--surface);color:var(--text)}
.form-group{margin-bottom:20px}
label{display:block;font-size:12px;color:var(--text-dim);margin-bottom:8px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
input[type="text"],input[type="date"],textarea,select{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:12px;background:var(--surface);color:#fff;font-size:14px;font-family:inherit;transition:all 0.3s}
textarea{min-height:100px;resize:vertical}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}



</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="assets/theme.css">
</head>
<body>

<header>
  <div class="header-glass">
    <div class="header-container">
      <a href="index.html" class="logo">
        <div class="logo-mark"><span class="brand-initials">VQ</span></div>
        <div class="brand-text">
          <h1>ValQMS Applications</h1>
          <div class="subtitle">Change Request Details</div>
        </div>
      </a>
      <div class="header-controls">
        <a href="change-management.html" class="btn-head" aria-label="Back to Change Management">‚Üê Back</a>
        <button class="btn-head" onclick="exportToPDF()">üìÑ PDF</button>
        <a href="index.html" class="btn-home"><span>‚Üê</span><span>Home</span></a>
      </div>
    </div>
  </div>
  </header>


<div class="container">
<div class="page-header">
<div>
<h1 class="page-title" id="changeTitle">Loading...</h1>
<p class="page-subtitle" id="changeSubtitle">Change Request Details</p>
</div>
</div>

<div class="card">
<div class="card-header">
<h3 class="card-title">üìä Workflow Progress</h3>
</div>
<div class="workflow-progress" id="workflowProgress">
<!-- Dynamic workflow steps -->
</div>
</div>

 

<div class="grid-2col">
<div>
<div class="card">
<div class="card-header">
<h3 class="card-title">üìù Change Description</h3>
</div>
<p id="changeDescription" style="color:var(--text);line-height:1.8"></p>
</div>

<div class="card">
<div class="card-header">
<h3 class="card-title">‚ö†Ô∏è Impact Assessment</h3>
</div>
<div id="impactSection">
<p style="color:var(--text-dim);font-size:14px">No impact assessment submitted yet</p>
</div>
</div>

<div class="card">
<div class="card-header">
<h3 class="card-title">üéØ Risk Assessment</h3>
</div>
<div id="riskSection">
<p style="color:var(--text-dim);font-size:14px">No risk assessment available</p>
</div>
</div>
</div>

<div>
<div class="card">
<div class="card-header">
<h3 class="card-title">‚ÑπÔ∏è Details</h3>
</div>
<div id="detailsSection"></div>
</div>

<div class="card">
<div class="card-header">
<h3 class="card-title">‚ö° Actions</h3>
</div>
<div class="actions-grid">
<button class="action-btn" onclick="editChange()">‚úèÔ∏è Edit Change Request</button>
<button class="action-btn" onclick="addComment()">üí¨ Add Comment</button>
<button class="action-btn" onclick="attachDocument()">üìé Attach Document</button>
<button class="action-btn" onclick="viewAuditTrail()">üîç View Audit Trail</button>
</div>
</div>
</div>
</div>

</div>

<!-- Edit Change Modal (same structure as New Change form) -->
<div id="editChangeModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Edit Change Request</h2>
      <button class="close-modal" onclick="closeEditModal()">√ó</button>
    </div>
    <form id="editChangeForm">
      <div class="modal-body">
        <div class="form-group">
          <label>Change Title *</label>
          <input type="text" id="edit_changeTitle" required>
        </div>
        <div class="form-group">
          <label>Description *</label>
          <textarea id="edit_changeDescription" required></textarea>
        </div>
        <!-- Current vs Proposed (mandatory, placed right after Description) -->
        <div class="form-group">
          <label>Current State *</label>
          <textarea id="edit_currentState" maxlength="4000" required aria-required="true" placeholder="Describe the current state/process/equipment"></textarea>
        </div>
        <div class="form-group">
          <label>Proposed Change *</label>
          <textarea id="edit_proposedChange" maxlength="4000" required aria-required="true" placeholder="Describe the proposed change in detail"></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Type *</label>
            <select id="edit_changeType" required>
              <option value="">Select...</option>
              <option value="Normal">Normal</option>
              <option value="Emergency">Emergency</option>
              <option value="Temporary">Temporary</option>
              <option value="Planned">Planned</option>
            </select>
          </div>
          <div class="form-group">
            <label>Category *</label>
            <select id="edit_changeCategory" required>
              <option value="">Select...</option>
              <option value="Process Change">Process</option>
              <option value="Equipment Change">Equipment</option>
              <option value="Document Change">Document</option>
              <option value="System Change">System</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Department *</label>
            <select id="edit_changeDepartment" required>
              <option value="">Select...</option>
              <option value="Quality Assurance">Quality Assurance</option>
              <option value="Production">Production</option>
              <option value="Engineering">Engineering</option>
              <option value="Regulatory">Regulatory</option>
            </select>
          </div>
          <div class="form-group">
            <label>Priority</label>
            <select id="edit_changePriority">
              <option value="Medium">Medium</option>
              <option value="Low">Low</option>
              <option value="High">High</option>
              <option value="Critical">Critical</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label>Justification *</label>
          <textarea id="edit_justification" required placeholder="Why is this change needed? Business and compliance rationale."></textarea>
        </div>

        <div class="form-group">
          <label>Initial Risk (optional)</label>
          <select id="edit_changeRisk">
            <option value="">Not assessed</option>
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
            <option value="Critical">Critical</option>
          </select>
          <div class="help-text">You can refine this during Impact/Risk Assessment</div>
        </div>


        <div class="form-group">
          <label>Due Date</label>
          <input type="date" id="edit_proposedDate" disabled>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancel</button>
        <button type="submit" class="btn">Save Changes</button>
      </div>
    </form>
  </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL='https://nufpaayytxtjihqrvtfi.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51ZnBhYXl5dHh0amlocXJ2dGZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMzA5NjIsImV4cCI6MjA3NTkwNjk2Mn0.766ENc3lMQSVJIsyxK6xlPE5DNlB3Np3eeXxvcoRGGY';
const {createClient}=supabase;
const sb=createClient(SUPABASE_URL,SUPABASE_KEY);

const urlParams=new URLSearchParams(window.location.search);
const changeId=urlParams.get('id');

if(!changeId){
window.location.href='change-management.html';
}


const WORKFLOW_STAGES=['Draft','Submitted for QA Review','Impact Assessment','Risk Assessment','QA Consolidation','CAB Review','Approved','Implementation','Verification','Closed'];
// Normalize stage strings from DB to our canonical labels
function normalizeStage(stage){
  if(!stage) return 'Draft';
  const s = String(stage).trim().toLowerCase();
  const aliases = {
    'submitted for qa review':'Submitted for QA Review',
    'qa review':'Submitted for QA Review',
    'impact assessment':'Impact Assessment',
    'risk assessment':'Risk Assessment',
    'qa consolidation':'QA Consolidation',
    'cab review':'CAB Review',
    'approved':'Approved',
    'implementation':'Implementation',
    'verification':'Verification',
    'closed':'Closed',
    'draft':'Draft'
  };
  if(aliases[s]) return aliases[s];
  // fuzzy: find first canonical that includes the words
  const found = WORKFLOW_STAGES.find(w=>w.toLowerCase()===s || w.toLowerCase().includes(s) || s.includes(w.toLowerCase()));
  return found || 'Draft';
}

// Compute due date (proposed_implementation_date) based on change type
function computeDueDateByType(type){
  const map = { 'Emergency': 7, 'Temporary': 14, 'Planned': 21, 'Normal': 30 };
  const days = map[type] ?? 30;
  const d = new Date();
  d.setHours(12,0,0,0);
  d.setDate(d.getDate()+days);
  return d.toISOString().slice(0,10);
}

// Get SLA days by type
function getSlaDays(type){
  const map = { 'Emergency': 7, 'Temporary': 14, 'Planned': 21, 'Normal': 30 };
  return map[type] ?? 30;
}

// Global variables
let currentUser = null;
let changeData = null;
// Schema flags for optional columns
let hasCurrentState=false, hasProposedChange=false;

(async function loadChangeDetails() {
  try {
    const { data: change, error } = await sb
      .from('change_requests')
      .select('*')
      .eq('id', changeId)
      .single();
    
    if (error) throw error;
    
    if (!change) {
      throw new Error('Change request not found');
    }
    
    // STORE GLOBALLY - THIS IS CRITICAL
    changeData = change;
    console.log('‚úì Change data loaded:', changeData);
    
    document.getElementById('changeTitle').textContent = `${change.change_number} - ${change.title}`;
    document.getElementById('changeSubtitle').textContent = `Created by ${change.initiator_name} on ${new Date(change.created_at).toLocaleDateString()}`;
    document.getElementById('changeDescription').textContent = change.description || 'No description provided';
    
  const currentStage = normalizeStage(change.workflow_stage || 'Draft');
  renderWorkflowProgress(currentStage);
  renderDetails(change);
  // Detect optional columns after initial load
  await detectChangeRequestColumns();
    
  } catch (error) {
    console.error('Error:', error);
    document.querySelector('.container').innerHTML = '<div class="loading">Error loading change request: ' + error.message + '</div>';
  }
})();

// Detect presence of optional columns for updates
async function detectChangeRequestColumns(){
  try{
    const { data, error } = await sb
      .from('change_requests')
      .select('id,current_state,proposed_change')
      .limit(1);
    if(error){
      hasCurrentState=false; hasProposedChange=false;
    }else{
      hasCurrentState=true; hasProposedChange=true;
    }
  }catch{
    hasCurrentState=false; hasProposedChange=false;
  }
}


function renderDetails(change){
const details=[
  {label:'Initiator',value:change.initiator_name||'Unknown'},
  {label:'Department',value:change.department||'-'},
  {label:'Change Type',value:change.change_type||'-'},
  {label:'Category',value:change.change_category||'-'},
  {label:'Priority',value:`<span class="badge ${(change.priority||'medium').toLowerCase()}">${change.priority||'Medium'}</span>`},
  {label:'Status',value:`<span class="badge ${(change.workflow_stage||'draft').toLowerCase().replace(/\s+/g,'-')}">${change.workflow_stage||'Draft'}</span>`},
  {label:'Created',value:new Date(change.created_at).toLocaleString('en-IN')},
  {label:'Last Updated',value:change.updated_at?new Date(change.updated_at).toLocaleString('en-IN'):'-'},
  {label:'Due Date',value:change.due_date?new Date(change.due_date).toLocaleDateString('en-IN'):'-'},
  {label:'Approved At',value:change.approved_at?new Date(change.approved_at).toLocaleString('en-IN'):'-'},
  {label:'Closed At',value:change.closed_at?new Date(change.closed_at).toLocaleString('en-IN'):'-'}
];

let html='';
details.forEach(d=>{
html+=`<div class="detail-row"><span class="detail-label">${d.label}</span><span class="detail-value">${d.value}</span></div>`;
});
document.getElementById('detailsSection').innerHTML=html;
}

// ============================================
// ACTION BUTTONS - FULLY FUNCTIONAL
// ============================================

function editChange(){
  // Check if change is closed
  if(changeData && changeData.workflow_stage === 'Closed'){
    showToast('‚ùå Cannot edit a closed change request', 'error');
    return;
  }
  openEditModal();
}

function openEditModal(){
  const modal = document.getElementById('editChangeModal');
  if(!modal) return;
  // Prefill fields from loaded changeData
  document.getElementById('edit_changeTitle').value = changeData?.title || '';
  document.getElementById('edit_changeDescription').value = changeData?.description || '';
  document.getElementById('edit_changeType').value = changeData?.change_type || '';
  document.getElementById('edit_changeCategory').value = changeData?.change_category || '';
  document.getElementById('edit_changeDepartment').value = changeData?.department || '';
  document.getElementById('edit_changePriority').value = changeData?.priority || 'Medium';
  document.getElementById('edit_justification').value = changeData?.justification || '';
  const riskSel = document.getElementById('edit_changeRisk');
  if(riskSel) riskSel.value = changeData?.overall_risk_rating || '';
  // Prefill current/proposed if present
  const cs = document.getElementById('edit_currentState');
  const pc = document.getElementById('edit_proposedChange');
  if(cs) cs.value = changeData?.current_state || '';
  if(pc) pc.value = changeData?.proposed_change || '';
  const d = changeData?.due_date ? new Date(changeData.due_date) : null;
  document.getElementById('edit_proposedDate').value = d ? new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,10) : '';
  // Enable due date editing only for Draft or Rejected
  const stageRaw = (changeData?.workflow_stage || '').toLowerCase();
  const statusRaw = (changeData?.status || '').toLowerCase();
  const isDraft = normalizeStage(changeData?.workflow_stage || 'Draft') === 'Draft';
  const isRejected = stageRaw === 'rejected' || statusRaw === 'rejected';
  const dueInput = document.getElementById('edit_proposedDate');
  dueInput.disabled = !(isDraft || isRejected);
  // In Draft/Rejected, restrict date to exactly the SLA date calculated from today's submission baseline
  if(isDraft || isRejected){
    const t = document.getElementById('edit_changeType').value;
    const expected = computeDueDateByType(t);
    if (expected){
      dueInput.min = expected;
      dueInput.max = expected;
      // If current value deviates, snap to expected to prevent invalid state
      if(dueInput.value !== expected){ dueInput.value = expected; }
    }
  }else{
    // Clear constraints when not editable
    dueInput.removeAttribute('min');
    dueInput.removeAttribute('max');
  }
  // Auto-update due date when Type changes (keeps stage-based editability)
  document.getElementById('edit_changeType')?.addEventListener('change', ()=>{
    const t = document.getElementById('edit_changeType').value;
    const newDue = t ? computeDueDateByType(t) : '';
    const di = document.getElementById('edit_proposedDate');
    di.value = newDue;
    // Update constraints to the new expected due date
    if(newDue){ di.min = newDue; di.max = newDue; }
  });
  modal.classList.add('active');
}

function closeEditModal(){
  const modal = document.getElementById('editChangeModal');
  if(modal) modal.classList.remove('active');
}

// Close on backdrop click
document.getElementById('editChangeModal')?.addEventListener('click', (e)=>{
  if(e.target?.id === 'editChangeModal') closeEditModal();
});

// Handle form submit to update change
document.getElementById('editChangeForm')?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  if(!currentUser){ showToast('User not authenticated','error'); return; }
  const updates = {
    title: document.getElementById('edit_changeTitle').value.trim(),
    description: document.getElementById('edit_changeDescription').value.trim(),
    change_type: document.getElementById('edit_changeType').value,
    change_category: document.getElementById('edit_changeCategory').value,
    department: document.getElementById('edit_changeDepartment').value,
    priority: document.getElementById('edit_changePriority').value,
    justification: document.getElementById('edit_justification').value.trim(),
  due_date: document.getElementById('edit_proposedDate').value || null,
    sla_days: (function(){ const t=document.getElementById('edit_changeType').value; const map={'Emergency':7,'Temporary':14,'Planned':21,'Normal':30}; return map[t]??30; })(),
    overall_risk_rating: document.getElementById('edit_changeRisk')?.value || null,
    updated_at: new Date().toISOString(),
    updated_by: currentUser.id
  };
  if(hasCurrentState){ updates.current_state = (document.getElementById('edit_currentState')?.value || '').trim() || null; }
  if(hasProposedChange){ updates.proposed_change = (document.getElementById('edit_proposedChange')?.value || '').trim() || null; }
  try{
    const { error } = await sb.from('change_requests').update(updates).eq('id', changeId);
    if(error) throw error;
    // Optional audit log
    if(typeof logManualAudit === 'function'){
      await logManualAudit('UPDATE', 'change_request', null, null, 'Change request updated');
    }
    showToast('‚úì Change updated successfully','success');
    closeEditModal();
    setTimeout(()=> location.reload(), 500);
  }catch(err){
    console.error('Update error:', err);
    showToast('Error updating change: '+err.message,'error');
  }
});

function addComment(){
  const comment=prompt('Enter your comment:');
  if(comment){
    submitComment(comment);
  }
}

// Handle submission from Draft: align due_date to SLA from today, then transition
async function submitForQAReview(){
  try{
    if(!currentUser){ showToast('You must be logged in','error'); return; }
    if(!changeData){ showToast('Change not loaded','error'); return; }
    // Compute expected due date from submission day and current type
    const typeNow = changeData.change_type || document.getElementById('edit_changeType')?.value || 'Normal';
    const expectedDue = computeDueDateByType(typeNow);
    const sla = getSlaDays(typeNow);

    // If stored due_date differs or sla_days mismatches, update before transition
    const storedDue = changeData.due_date ? new Date(changeData.due_date) : null;
    const storedDueStr = storedDue ? new Date(storedDue.getTime()-storedDue.getTimezoneOffset()*60000).toISOString().slice(0,10) : '';
    const needsUpdate = (storedDueStr !== expectedDue) || (changeData.sla_days !== sla);

    if(needsUpdate){
      const proceed = confirm(`Due Date must match SLA from today for ${typeNow}.\nExpected: ${new Date(expectedDue).toLocaleDateString('en-IN')}\nCurrent: ${storedDueStr ? new Date(storedDueStr).toLocaleDateString('en-IN') : 'N/A'}\n\nUpdate and continue?`);
      if(!proceed){
        showToast('Submission cancelled. Please correct Due Date.', 'warning');
        return;
      }
      const { error: updErr } = await sb
        .from('change_requests')
        .update({
          due_date: expectedDue,
          sla_days: sla,
          updated_at: new Date().toISOString(),
          updated_by: currentUser.id
        })
        .eq('id', changeId);
      if(updErr) throw updErr;
      // Reflect locally for consistent UI
      changeData.due_date = expectedDue;
      changeData.sla_days = sla;
    }

    await transitionToNextStage('Submitted for QA Review');
    closeStageModal();
  }catch(err){
    console.error('Submit for QA error:', err);
    showToast('Error submitting for QA: '+err.message, 'error');
  }
}

async function submitComment(commentText) {
  try {
    const {data:{session}} = await sb.auth.getSession();
    
    if (!session) {
      throw new Error('Not authenticated');
    }
    
    const {error} = await sb.from('change_comments').insert([{
      change_request_id: changeId,
      user_id: session.user.id,
      user_name: session.user.email,
      comment: commentText,
      comment_type: 'General'
    }]);
    
    if (error) throw error;
    
    console.log('‚úì Comment added:', commentText);
    
  } catch (error) {
    console.error('Error adding comment:', error);
    throw error;
  }
}

async function loadComments(){
  try{
    const {data,error}=await sb.from('change_comments').select('*').eq('change_request_id',changeId).order('created_at',{ascending:false});
    if(error)throw error;
    if(data.length>0){
      let html='<div style="margin-top:20px;border-top:1px solid var(--border);padding-top:20px">';
      html+='<h4 style="color:var(--text);margin-bottom:12px">üí¨ Comments ('+data.length+')</h4>';
      data.forEach(c=>{
        html+=`<div style="background:var(--surface);padding:12px;border-radius:8px;margin-bottom:8px">
          <div style="display:flex;justify-content:space-between;margin-bottom:6px">
            <strong style="color:var(--accent)">${c.user_name}</strong>
            <span style="color:var(--text-dim);font-size:12px">${new Date(c.created_at).toLocaleString()}</span>
          </div>
          <p style="color:var(--text);font-size:14px">${c.comment}</p>
        </div>`;
      });
      html+='</div>';
      document.querySelector('.card:nth-child(2)').insertAdjacentHTML('beforeend',html);
    }
  }catch(error){
    console.error('Error loading comments:',error);
  }
}

async function attachDocument() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.jpg,.jpeg,.png,.txt';
  input.multiple = true;
  
  input.onchange = async (e) => {
    const files = Array.from(e.target.files);
    
    if (files.length === 0) {
      showToast('No files selected', 'error');
      return;
    }
    
    showToast(`Uploading ${files.length} file(s)...`, 'success');
    
    for (const file of files) {
      try {
        // Validate file size (max 10MB)
        const maxSize = 10 * 1024 * 1024;
        if (file.size > maxSize) {
          showToast(`‚ùå ${file.name} is too large (max 10MB)`, 'error');
          continue;
        }
        
        console.log('Uploading file:', file.name, 'Size:', file.size, 'Type:', file.type);
        
        // Generate unique filename
        const fileExt = file.name.split('.').pop();
        const fileName = `change-requests/${changeId}/${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
        
        // Upload to Supabase Storage - USING ValQMS BUCKET
        const { data: uploadData, error: uploadError } = await sb.storage
          .from('ValQMS')
          .upload(fileName, file, {
            cacheControl: '3600',
            upsert: false
          });
        
        if (uploadError) {
          console.error('Upload error:', uploadError);
          throw uploadError;
        }
        
        console.log('File uploaded:', uploadData);
        
        // Get public URL
        const { data: urlData } = sb.storage
          .from('ValQMS')
          .getPublicUrl(fileName);
        
        const fileUrl = urlData.publicUrl;
        console.log('Public URL:', fileUrl);
        
        // Save attachment metadata to database
        const { data: attachmentData, error: dbError } = await sb
          .from('change_attachments')
          .insert([{
            change_request_id: changeId,
            filename: fileName,
            original_filename: file.name,
            file_size: file.size,
            mime_type: file.type || 'application/octet-stream',
            storage_path: fileName,
            file_url: fileUrl,
            category: 'Document',
            uploaded_by: currentUser.id,
            uploaded_by_name: currentUser.email.split('@')[0]
          }])
          .select()
          .single();
        
        if (dbError) {
          console.error('Database error:', dbError);
          
          // Cleanup: delete uploaded file if database insert fails
          await sb.storage.from('ValQMS').remove([fileName]);
          throw dbError;
        }
        
        console.log('Attachment saved to database:', attachmentData);
        
        // Log audit event
        if (typeof logManualAudit === 'function') {
          await logManualAudit(
            'UPDATE',
            'attachments',
            null,
            file.name,
            `Document attached: ${file.name}`
          );
        }
        
        showToast(`‚úì ${file.name} uploaded successfully`, 'success');
        
      } catch (error) {
        console.error('Error uploading file:', error);
        showToast(`‚ùå Failed to upload ${file.name}: ${error.message}`, 'error');
      }
    }
    
    // Reload attachments list
    setTimeout(() => loadAttachments(), 500);
  };
  
  input.click();
}


async function uploadFile(file){
  try{
    const {data:{session}}=await sb.auth.getSession();
    const fileName=`${changeId}/${Date.now()}_${file.name}`;
    
    // Note: You need to set up Supabase Storage bucket first
    // For now, just log the file info
    const {error}=await sb.from('change_attachments').insert([{
      change_request_id:changeId,
      file_name:file.name,
      file_path:fileName,
      file_type:file.type,
      file_size:file.size,
      document_type:'Other',
      uploaded_by:session.user.id
    }]);
    
    if(error)throw error;
    alert('‚úÖ Document attached successfully!\n\nFile: '+file.name);
    loadAttachments();
  }catch(error){
    console.error('Error:',error);
    alert('‚ùå Error: '+error.message);
  }
}

async function loadAttachments(){
  try{
    const {data,error}=await sb.from('change_attachments').select('*').eq('change_request_id',changeId).order('uploaded_at',{ascending:false});
    if(error)throw error;
    if(data.length>0){
      let html='<div style="margin-top:20px;border-top:1px solid var(--border);padding-top:20px">';
      html+='<h4 style="color:var(--text);margin-bottom:12px">üìé Attachments ('+data.length+')</h4>';
      data.forEach(a=>{
        html+=`<div style="background:var(--surface);padding:10px;border-radius:8px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center">
          <div>
            <strong style="color:var(--text)">${a.file_name}</strong>
            <div style="color:var(--text-dim);font-size:12px">${(a.file_size/1024).toFixed(1)} KB ‚Ä¢ ${new Date(a.uploaded_at).toLocaleDateString()}</div>
          </div>
        </div>`;
      });
      html+='</div>';
      document.querySelector('.card:nth-child(3)').insertAdjacentHTML('beforeend',html);
    }
  }catch(error){
    console.error('Error loading attachments:',error);
  }
}

function viewAuditTrail(){
  loadAuditTrail();
}

async function loadAuditTrail(){
  try{
    console.log('Loading audit trail for change ID:', changeId);
    
    // CHANGED: Use audit_events instead of audit_trail
    const {data,error}=await sb
      .from('audit_events')
      .select('*')
      .eq('entity_type', 'change_request')
      .eq('entity_id', changeId)
      .order('timestamp_utc',{ascending:false});
    
    if(error){
      console.error('Audit trail error:', error);
      throw error;
    }
    
  console.log('Audit events loaded:', data?.length || 0);
    
let html=`<div class="modal" style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);backdrop-filter:blur(2px);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px" onclick="this.remove()">
  <div class="modal-content" style="max-width:900px;max-height:85vh;overflow-y:auto" onclick="event.stopPropagation()">
    <div class="modal-header">
      <h3 class="modal-title" style="margin:0">üîç Complete Audit Trail</h3>
      <button class="close-btn" onclick="this.closest('.modal').remove()" aria-label="Close">√ó</button>
    </div>
    <div class="modal-body" style="padding:20px 24px">`;

if(!data || data.length===0){
  html+=`<div style="text-align:center;padding:60px 20px;color:#64748b">
    <div style="font-size:64px;margin-bottom:16px;opacity:0.5">üìã</div>
    <p style="font-size:18px;font-weight:600;margin-bottom:8px;color:#1e293b">No Audit Records Found</p>
    <p style="font-size:14px;color:#64748b">Audit trail will be automatically created when changes are made</p>
  </div>`;
}else{
  data.forEach(a=>{
    let actionTitle = a.action;
    let actionIcon = '';
    let actionColor = '#10b981';
    
    // Action type mapping (keep existing logic)
    if(a.action === 'CREATE'){
      actionTitle = 'Change Request Created';
      actionIcon = '‚ú®';
      actionColor = '#10b981';
    }else if(a.action === 'UPDATE'){
      if(a.field_name === 'workflow_stage'){
        if(a.old_value && a.new_value){
          actionTitle = `${a.old_value} ‚Üí ${a.new_value}`;
        }else{
          actionTitle = 'Workflow Stage Changed';
        }
        actionIcon = 'üîÑ';
        actionColor = '#3b82f6';
      }else if(a.field_name === 'status'){
        actionTitle = a.old_value && a.new_value ? `Status: ${a.old_value} ‚Üí ${a.new_value}` : 'Status Updated';
        actionIcon = 'üìä';
        actionColor = '#8b5cf6';
      }else if(a.field_name === 'priority'){
        actionTitle = a.old_value && a.new_value ? `Priority: ${a.old_value} ‚Üí ${a.new_value}` : 'Priority Changed';
        actionIcon = '‚ö†Ô∏è';
        actionColor = '#f59e0b';
      }else if(a.field_name === 'title'){
        actionTitle = 'Title Modified';
        actionIcon = '‚úèÔ∏è';
        actionColor = '#06b6d4';
      }else if(a.field_name === 'description'){
        actionTitle = 'Description Updated';
        actionIcon = 'üìù';
        actionColor = '#fb923c';
      }else{
        actionTitle = `Field Updated: ${a.field_name || 'Unknown'}`;
        actionIcon = 'üîß';
        actionColor = '#fb923c';
      }
    }else if(a.action === 'APPROVE'){
      actionTitle = 'Change Request Approved';
      actionIcon = '‚úÖ';
      actionColor = '#10b981';
    }else if(a.action === 'REJECT'){
      actionTitle = 'Change Request Rejected';
      actionIcon = '‚ùå';
      actionColor = '#ef4444';
    }else if(a.action === 'SUBMIT'){
      actionTitle = 'Submitted for Review';
      actionIcon = 'üì§';
      actionColor = '#06b6d4';
    }else if(a.action === 'SIGN'){
      actionTitle = 'Digitally Signed';
      actionIcon = 'üîè';
      actionColor = '#ec4899';
    }else if(a.action === 'LOCK'){
      actionTitle = 'Record Locked';
      actionIcon = 'üîí';
      actionColor = '#f97316';
    }else if(a.action === 'UNLOCK'){
      actionTitle = 'Record Unlocked';
      actionIcon = 'üîì';
      actionColor = '#06b6d4';
    }

  let fieldDisplay = a.field_name ? a.field_name.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) : '';

    html+=`<div style="background:rgba(255,255,255,0.7);padding:20px;border-radius:12px;margin-bottom:16px;border-left:4px solid ${actionColor};box-shadow:0 2px 8px rgba(0,0,0,0.1);border:1px solid rgba(16,185,129,0.15)">
      <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
        <div style="flex:1">
          <div style="color:${actionColor};font-size:18px;font-weight:700;margin-bottom:8px;display:flex;align-items:center;gap:8px">
            <span>${actionIcon}</span>
            <span>${actionTitle}</span>
          </div>
          <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
            <div style="display:flex;align-items:center;gap:6px">
              <span style="color:#64748b;font-size:13px">üë§</span>
              <span style="color:#1e293b;font-size:14px;font-weight:600">${a.user_full_name||'System'}</span>
            </div>
            ${a.user_employee_id ? `<div style="background:rgba(16,185,129,0.1);padding:3px 10px;border-radius:6px">
              <span style="color:#059669;font-size:12px">ID: ${a.user_employee_id}</span>
            </div>` : ''}
            <div style="display:flex;align-items:center;gap:6px">
              <span style="color:#64748b;font-size:13px">üïê</span>
              <span style="color:#64748b;font-size:13px">${new Date(a.timestamp_utc).toLocaleString('en-IN', {day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:true})}</span>
            </div>
            ${a.ip_address ? `<div style="display:flex;align-items:center;gap:6px">
              <span style="color:#64748b;font-size:13px">üåê</span>
              <span style="color:#64748b;font-size:12px">${a.ip_address}</span>
            </div>` : ''}
          </div>
        </div>
      </div>
      
      ${a.field_name ? `<div style="margin-bottom:12px">
        <span style="color:#64748b;font-size:12px;text-transform:uppercase;letter-spacing:0.5px">Field Changed:</span>
        <code style="background:rgba(99,102,241,0.1);color:#6366f1;padding:4px 10px;border-radius:6px;font-size:13px;margin-left:8px;font-family:monospace">${fieldDisplay}</code>
      </div>` : ''}
      
      ${(a.old_value && a.new_value) ? (a.field_name === 'workflow_stage' ? 
        `<div style="background:rgba(255,255,255,0.5);padding:16px;border-radius:10px;margin-top:12px;text-align:center;border:1px solid rgba(16,185,129,0.2)">
          <div style="display:flex;align-items:center;justify-content:center;gap:16px;font-size:16px;font-weight:600">
            ${a.old_value ? `<span style="color:#f87171">${a.old_value}</span>` : ''}
            <span style="color:#10b981;font-size:24px">‚Üí</span>
            ${a.new_value ? `<span style="color:#34d399">${a.new_value}</span>` : ''}
          </div>
          <div style="color:#64748b;font-size:12px;margin-top:8px">Stage Transition</div>
        </div>` :
        `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px">
          ${a.old_value ? `<div style="background:rgba(239,68,68,0.1);padding:12px;border-radius:8px;border-left:3px solid #ef4444;border:1px solid rgba(239,68,68,0.2)">
            <div style="color:#f87171;font-size:11px;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">PREVIOUS</div>
            <div style="color:#1e293b;font-size:14px;word-break:break-word;white-space:pre-wrap">${a.old_value}</div>
          </div>` : ''}
          ${a.new_value ? `<div style="background:rgba(16,185,129,0.1);padding:12px;border-radius:8px;border-left:3px solid #10b981;border:1px solid rgba(16,185,129,0.2)">
            <div style="color:#34d399;font-size:11px;font-weight:700;margin-bottom:6px;text-transform:uppercase;letter-spacing:0.5px">UPDATED</div>
            <div style="color:#1e293b;font-size:14px;word-break:break-word;white-space:pre-wrap">${a.new_value}</div>
          </div>` : ''}
        </div>`) : ''}
      
      ${a.reason ? `<div style="margin-top:12px;padding:10px 14px;background:rgba(99,102,241,0.05);border-radius:8px;border-left:2px solid #6366f1;border:1px solid rgba(99,102,241,0.15)">
        <span style="color:#6366f1;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:0.5px">Reason: </span>
        <span style="color:#1e293b;font-size:13px">${a.reason}</span>
      </div>` : ''}
      
      <div style="margin-top:12px;padding-top:10px;border-top:1px solid rgba(16,185,129,0.15);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
        <div style="display:flex;align-items:center;gap:6px">
          <span style="color:#10b981;font-size:12px">‚úì</span>
          <span style="color:#64748b;font-size:10px;font-family:monospace">Checksum: ${a.checksum ? a.checksum.substring(0,20)+'...' : 'N/A'}</span>
        </div>
        ${a.event_id || a.id ? `<div style="color:#64748b;font-size:10px">Event ID: ${(a.event_id||a.id).substring(0,8)}</div>` : ''}
      </div>
    </div>`;
  });
}

const uniqueUsers = new Set(data.map(e => e.user_id)).size;
const updateCount = data.filter(e => e.action === 'UPDATE').length;

html+=`<div style="margin-top:24px;padding:20px;border-top:2px solid rgba(16,185,129,0.2);background:rgba(255,255,255,0.7);border-radius:12px;border:1px solid rgba(16,185,129,0.15)">
  <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:20px;text-align:center">
    <div>
      <div style="color:#10b981;font-size:28px;font-weight:800">${data.length}</div>
      <div style="color:#64748b;font-size:12px;margin-top:4px">Total Events</div>
    </div>
    <div>
      <div style="color:#10b981;font-size:28px;font-weight:800">${updateCount}</div>
      <div style="color:#64748b;font-size:12px;margin-top:4px">Modifications</div>
    </div>
    <div>
      <div style="color:#10b981;font-size:28px;font-weight:800">${uniqueUsers}</div>
      <div style="color:#64748b;font-size:12px;margin-top:4px">Unique Users</div>
    </div>
  </div>
  <p style="color:#64748b;font-size:11px;text-align:center;margin-top:16px;padding-top:16px;border-top:1px solid rgba(16,185,129,0.15)">
    üîí This audit trail is tamper-proof and complies with 21 CFR Part 11 regulations
  </p>

</div>
    </div>
  </div>
</div>`;

document.body.insertAdjacentHTML('beforeend',html);

    
  }catch(error){
    console.error('Error loading audit trail:',error);
    let errorHtml='<div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);backdrop-filter:blur(4px);z-index:9999;display:flex;align-items:center;justify-content:center;padding:20px" onclick="this.remove()">';
    errorHtml+='<div style="background:#0f172a;border:1px solid var(--border);border-radius:16px;max-width:500px;width:100%;padding:28px" onclick="event.stopPropagation()">';
    errorHtml+='<h2 style="color:#ef4444;font-size:24px;font-weight:800;margin-bottom:16px">‚ùå Error Loading Audit Trail</h2>';
    errorHtml+=`<p style="color:var(--text-dim);margin-bottom:16px">${error.message}</p>`;
    errorHtml+='<p style="color:var(--text-dim);font-size:13px;margin-bottom:24px">Please ensure:</p>';
    errorHtml+='<ul style="color:var(--text-dim);font-size:13px;margin-left:20px;margin-bottom:24px">';
    errorHtml+='<li>The audit_events table exists in Supabase</li>';
    errorHtml+='<li>RLS policies are configured correctly</li>';
    errorHtml+='<li>The trigger function is active</li>';
    errorHtml+='</ul>';
    errorHtml+='<button onclick="this.closest(\'div[style*=fixed]\').remove()" class="btn" style="width:100%">Close</button>';
    errorHtml+='</div></div>';
    document.body.insertAdjacentHTML('beforeend',errorHtml);
  }
}

// Load comments and attachments on page load
setTimeout(()=>{
  loadComments();
  loadAttachments();
},1000);

function formatDateTime(dt){
  if(!dt) return '-';
  try{ return new Date(dt).toLocaleString('en-IN',{day:'2-digit',month:'short',year:'numeric',hour:'2-digit',minute:'2-digit',hour12:true}); }catch{ return '-'; }
}

function renderKeyDates(change){
  const el = document.getElementById('keyDatesContent');
  if(!el) return;
  const rows = [
    {label:'Created', value: formatDateTime(change.created_at)},
    {label:'Last Updated', value: formatDateTime(change.updated_at)},
    {label:'Proposed Date', value: change.proposed_implementation_date ? new Date(change.proposed_implementation_date).toLocaleDateString('en-IN') : '-'},
    {label:'Approved At', value: formatDateTime(change.approved_at)},
    {label:'Closed At', value: formatDateTime(change.closed_at)}
  ];
  el.innerHTML = rows.map(r=>`<div class="detail-row"><span class="detail-label">${r.label}</span><span class="detail-value">${r.value}</span></div>`).join('');
}

// ============================================
// INTERACTIVE WORKFLOW STEPS
// ============================================

// Manual audit logging function - use when trigger might not capture everything
async function logManualAudit(action, fieldName = null, oldValue = null, newValue = null, reason = null) {
  try {
    if (!currentUser) {
      console.error('No current user for audit logging');
      return false;
    }
    
    const auditEntry = {
      entity_type: 'change_request',
      entity_id: changeId,
      action: action, // CREATE, UPDATE, APPROVE, REJECT, SUBMIT, etc.
      user_id: currentUser.id,
      user_full_name: currentUser.email.split('@')[0],
      user_employee_id: 'USR-' + currentUser.id.substring(0, 8),
      // Rely on DB default for timestamp_utc to avoid clock skew check constraint
      timestamp_local: new Date().toISOString(),
      timezone: 'Asia/Kolkata',
      field_name: fieldName,
      old_value: oldValue,
      new_value: newValue,
      reason: reason || `${action} performed`,
      metadata: {
        change_number: changeData?.change_number,
        browser: navigator.userAgent,
        timestamp: new Date().toISOString()
      },
      checksum: generateChecksum()
    };
    
    const { data, error } = await sb.from('audit_events').insert([auditEntry]).select();
    
    if (error) {
      console.error('Error logging audit:', error);
      return false;
    }
    
    console.log('‚úì Audit logged:', action, data);
    return true;
  } catch (error) {
    console.error('Exception in logManualAudit:', error);
    return false;
  }
}

// Generate checksum for audit integrity
function generateChecksum() {
  const data = changeId + currentUser.id + Date.now() + Math.random();
  return btoa(data).substring(0, 32);
}



function renderWorkflowProgress(currentStage){
  const container=document.getElementById('workflowProgress');
  let html='';
  
  const normalized = normalizeStage(currentStage);
  let currentIndex = WORKFLOW_STAGES.indexOf(normalized);
  if(currentIndex < 0) currentIndex = 0;

  container.setAttribute('data-completion', currentIndex);
  
  WORKFLOW_STAGES.forEach((stage, index) => {
    const isCurrent = index === currentIndex;
    const isCompleted = index < currentIndex;
    const isNextStage = index === currentIndex + 1;

    const isLastAndCurrent = isCurrent && index === WORKFLOW_STAGES.length - 1;
    
    let statusClass = '';
    if(isCompleted) statusClass = 'completed';
    else if(isCurrent) statusClass = 'active';
    
    const icon = (isCompleted || isLastAndCurrent) ? '‚úì' : (index + 1);
    
    // Make clickable if it's current or next stage
  const clickHandler = (isCurrent || isNextStage) ? `onclick="openStageModal('${stage}')"` : 
                        isCompleted ? `onclick="viewStageInfo('${stage}')"` : '';
    
    const cursorStyle = (isCurrent || isNextStage) ? 'cursor:pointer' : 
                        isCompleted ? 'cursor:pointer' : 'cursor:not-allowed';
    
    html+=`
    <div class="workflow-step ${statusClass}" ${clickHandler} style="${cursorStyle}">
      <div class="workflow-circle">${icon}</div>
      <div class="workflow-label">${stage}</div>
    </div>
    `;
  });
  container.innerHTML=html;
}


function openStageModal(stageName) {
  let modalContent = '';
  
  switch(stageName) {
    case 'Draft':
      modalContent = `
        <h3>Submit for QA Review</h3>
        <p style="margin:12px 0;color:var(--text-dim)">On submission, the Due Date will be aligned to SLA from today based on the selected Change Type.</p>
        <div style="display:flex;gap:12px;margin-top:20px">
          <button class="btn" onclick="submitForQAReview()">
            ‚úì Submit for QA Review
          </button>
          <button class="btn btn-secondary" onclick="closeStageModal()">Cancel</button>
        </div>
      `;
      break;
      
case 'Submitted for QA Review':
  modalContent=`
    <h3>üìã QA Review</h3>
    <div class="form-group">
      <label>QA Review Comments</label>
      <textarea id="qaComments" style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--surface);color:var(--text);min-height:100px;font-family:inherit" placeholder="Enter your review comments..."></textarea>
    </div>
    <div style="display:flex;gap:12px;margin-top:20px">
      <button class="btn" onclick="acceptQAReview()">Accept & Move to Impact Assessment</button>
      <button class="btn btn-secondary" onclick="rejectQAReview()">Reject to Draft</button>
    </div>
  `;
  break;
      
    case 'Impact Assessment':
      modalContent=`
        <h3>‚ö†Ô∏è Impact Assessment</h3>
        <div class="form-group">
          <label>Impact on Quality</label>
          <textarea id="impactQuality" placeholder="Describe impact on product quality..."></textarea>
        </div>
        <div class="form-group">
          <label>Impact on Safety</label>
          <textarea id="impactSafety" placeholder="Describe impact on patient safety..."></textarea>
        </div>
        <div class="form-group">
          <label>Risk Rating</label>
          <select id="riskRating">
            <option value="Low">Low</option>
            <option value="Medium">Medium</option>
            <option value="High">High</option>
            <option value="Critical">Critical</option>
          </select>
        </div>
        <button class="btn" onclick="submitImpactAssessment()">Submit & Move to Risk Assessment</button>
      `;
      break;
      
    case 'Risk Assessment':
      modalContent=`
        <h3>üéØ Risk Assessment</h3>
        <div class="form-row">
          <div class="form-group">
            <label>Severity (1-5)</label>
            <input type="number" id="severity" min="1" max="5" value="3">
          </div>
          <div class="form-group">
            <label>Occurrence (1-5)</label>
            <input type="number" id="occurrence" min="1" max="5" value="3">
          </div>
        </div>
        <div class="form-group">
          <label>Mitigation Strategy</label>
          <textarea id="mitigation" placeholder="Describe mitigation actions..."></textarea>
        </div>
        <button class="btn" onclick="submitRiskAssessment()">Submit & Move to QA Consolidation</button>
      `;
      break;
      
    case 'CAB Review':
      modalContent=`
        <h3>üë• CAB Review</h3>
        <div class="form-group">
          <label>CAB Decision Comments</label>
          <textarea id="cabComments" placeholder="Enter CAB review comments..."></textarea>
        </div>
        <div style="display:flex;gap:12px">
          <button class="btn" onclick="submitCABDecision('approved')">‚úÖ Approve for Implementation</button>
          <button class="btn btn-secondary" onclick="submitCABDecision('rejected')" style="background:#ef4444;color:#fff">‚ùå Reject</button>
        </div>
      `;
      break;
      
    case 'Approved':
      modalContent=`
        <h3>‚úÖ Approved for Implementation</h3>
        <p style="margin:12px 0;color:var(--text-dim)">This change has been approved. Click below to start implementation.</p>
        <button class="btn" onclick="transitionToNextStage('Implementation');closeStageModal()">Start Implementation</button>
      `;
      break;
      
    case 'Implementation':
      modalContent=`
        <h3>‚öôÔ∏è Implementation</h3>
        <div class="form-group">
          <label>Implementation Notes</label>
          <textarea id="implNotes" placeholder="Document implementation details..."></textarea>
        </div>
        <button class="btn" onclick="submitImplementation()">Complete & Move to Verification</button>
      `;
      break;
      
    case 'Verification':
      modalContent=`
        <h3>‚úîÔ∏è Verification</h3>
        <div class="form-group">
          <label>Verification Result</label>
          <select id="verifyResult">
            <option value="Passed">Passed</option>
            <option value="Failed">Failed - Return to Implementation</option>
          </select>
        </div>
        <div class="form-group">
          <label>Verification Comments</label>
          <textarea id="verifyComments" placeholder="Enter verification results..."></textarea>
        </div>
        <button class="btn" onclick="submitVerification()">Submit Verification</button>
      `;
      break;
      
case 'Closed':
  // Check if we're already on Closed stage
  if (changeData && changeData.workflow_stage === 'Closed') {
    modalContent = `
      <h3>‚úÖ Change Request Closed</h3>
      <p style="color:var(--text-dim);margin:16px 0">This change request has been successfully completed and closed.</p>
      <div style="background:var(--surface);padding:16px;border-radius:8px;margin:16px 0">
        <p style="color:var(--text);font-size:14px;margin-bottom:8px"><strong>Closed Date:</strong> ${changeData.closed_at ? new Date(changeData.closed_at).toLocaleString() : 'N/A'}</p>
        <p style="color:var(--text);font-size:14px"><strong>Status:</strong> <span class="badge completed" style="background:var(--accent);color:#000">Completed</span></p>
      </div>
      <button class="btn btn-secondary" onclick="closeStageModal()">Close</button>
    `;
  } else {
    // We're on Verification and moving to Closed
    modalContent = `
      <h3>üéâ Close Change Request</h3>
      <p style="margin:12px 0;color:var(--text-dim)">Mark this change request as closed and completed.</p>
      <div class="form-group">
        <label>Final Comments (Optional)</label>
        <textarea id="closingComments" style="width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--surface);color:var(--text);min-height:80px;font-family:inherit" placeholder="Enter any final comments..."></textarea>
      </div>
      <div style="display:flex;gap:12px;margin-top:20px">
        <button class="btn" onclick="finalizeClose()">‚úì Close Change Request</button>
        <button class="btn btn-secondary" onclick="closeStageModal()">Cancel</button>
      </div>
    `;
  }
  break;
      
    default:
      modalContent=`<h3>${stageName}</h3><p>Form coming soon...</p>`;
  }
  
  showStageModal(modalContent);
}

function showStageModal(content){
  const modal = `
    <div id="stageModal" class="modal active">
      <div class="modal-content">
        <div class="modal-body">
          ${content}
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" onclick="closeStageModal()">Cancel</button>
        </div>
      </div>
    </div>`;
  document.body.insertAdjacentHTML('beforeend', modal);
}

function closeStageModal(){
  const modal=document.getElementById('stageModal');
  if(modal)modal.remove();
}

async function transitionToNextStage(nextStage) {
  // Check authentication
  if (!currentUser) {
    console.error('No user authenticated');
    showToast('You must be logged in to perform this action', 'error');
    return;
  }
  
  if (!changeData) {
    console.error('No change data loaded');
    showToast('Change data not loaded. Please refresh the page.', 'error');
    return;
  }
  
  const oldStage = changeData.workflow_stage;
  
  console.log(`üîÑ Transitioning from "${oldStage}" to "${nextStage}"`);
  console.log('Current user:', currentUser.email);
  console.log('Change ID:', changeId);
  
  try {
    // Update the change request (no select to avoid 406 when SELECT is not allowed by RLS)
    const { error } = await sb
      .from('change_requests')
      .update({ 
        workflow_stage: nextStage,
        updated_at: new Date().toISOString(),
        updated_by: currentUser?.id || null
      })
      .eq('id', changeId);
    
    if (error) {
      console.error('‚ùå Transition error:', error);
      throw error;
    }
    
    console.log('‚úì Workflow stage updated to:', nextStage);
    
    // Log the transition manually (backup to trigger)
    await logManualAudit(
      'UPDATE',
      'workflow_stage',
      oldStage,
      nextStage,
      `Workflow transitioned from ${oldStage} to ${nextStage}`
    );
    
    showToast(`‚úì Successfully moved to: ${nextStage}`, 'success');
    
    // Update local data and UI immediately
    changeData.workflow_stage = nextStage;
    renderWorkflowProgress(normalizeStage(nextStage));
    
    // Reload the page shortly to refresh all sections (audit, details)
    setTimeout(() => {
      location.reload();
    }, 800);
    
  } catch (error) {
    console.error('‚ùå Error in transitionToNextStage:', error);
    showToast(`Error: ${error.message}`, 'error');
  }
}


async function submitImpactAssessment() {
  const quality = document.getElementById('impactQuality')?.value || '';
  const safety = document.getElementById('impactSafety')?.value || '';
  const risk = document.getElementById('riskRating')?.value || 'Medium';
  
  if (!quality.trim() || !safety.trim()) {
    showToast('Please fill in all impact assessment fields', 'warning');
    return;
  }
  
  try {
    const {data:{session}} = await sb.auth.getSession();
    
    await sb.from('impact_assessments').insert([{
      change_request_id: changeId,
      department: 'Quality Assurance',
      assessor_id: session.user.id,
      assessor_name: session.user.email,
      impact_on_quality: quality,
      impact_on_safety: safety,
      risk_rating: risk
    }]);
    
    // Update change request with risk rating
    await sb.from('change_requests').update({
      overall_risk_rating: risk,
      updated_at: new Date().toISOString(),
      updated_by: session.user.id
    }).eq('id', changeId);
    
    // Transition to next stage
    await transitionToNextStage('Risk Assessment');
    
    closeStageModal();
    showToast('‚úì Impact Assessment submitted!', 'success');
    
  } catch (error) {
    console.error('Error:', error);
    showToast('Error: ' + error.message, 'error');
  }
}

async function submitRiskAssessment() {
  const severity = document.getElementById('severity')?.value || '3';
  const occurrence = document.getElementById('occurrence')?.value || '3';
  const mitigation = document.getElementById('mitigation')?.value || '';
  
  if (!mitigation.trim()) {
    showToast('Please enter mitigation strategy', 'warning');
    return;
  }
  
  try {
    const {data:{session}} = await sb.auth.getSession();
    
    await sb.from('risk_assessments').insert([{
      change_request_id: changeId,
      assessor_id: session.user.id,
      assessor_name: session.user.email,
      severity: parseInt(severity),
      occurrence: parseInt(occurrence),
      detection: 3,
      mitigation_strategy: mitigation,
      risk_level: 'Medium'
    }]);
    
    await transitionToNextStage('CAB Review');
    
    closeStageModal();
    showToast('‚úì Risk Assessment submitted!', 'success');
    
  } catch (error) {
    console.error('Error:', error);
    showToast('Error: ' + error.message, 'error');
  }
}

async function submitCABDecision(decision) {
  const comments = document.getElementById('cabComments')?.value || '';
  
  if (!comments.trim()) {
    showToast('Please enter CAB decision comments', 'warning');
    return;
  }
  
  const nextStage = decision === 'approved' ? 'Approved' : 'Draft';
  
  try {
    // Update with approved_at if approved
    const updateData = {
      updated_at: new Date().toISOString()
    };
    
    if (decision === 'approved') {
      updateData.approved_at = new Date().toISOString();
    }
    updateData.updated_by = currentUser?.id || null;
    await sb.from('change_requests').update(updateData).eq('id', changeId);
    
    await submitComment(`CAB Decision: ${decision.toUpperCase()} - ${comments}`);
    
    await transitionToNextStage(nextStage);
    
    closeStageModal();
    showToast('‚úì CAB Decision recorded!', 'success');
    
  } catch (error) {
    console.error('Error:', error);
    showToast('Error: ' + error.message, 'error');
  }
}

async function submitImplementation() {
  const notes = document.getElementById('implNotes')?.value || '';
  
  if (!notes.trim()) {
    showToast('Please enter implementation notes', 'warning');
    return;
  }
  
  try {
    await submitComment(`Implementation completed: ${notes}`);
    await transitionToNextStage('Verification');
    closeStageModal();
    showToast('‚úì Implementation completed!', 'success');
  } catch (error) {
    console.error('Error:', error);
    showToast('Error: ' + error.message, 'error');
  }
}

async function submitVerification() {
  const result = document.getElementById('verifyResult')?.value || 'Passed';
  const comments = document.getElementById('verifyComments')?.value || '';
  
  if (!comments.trim()) {
    showToast('Please enter verification comments', 'warning');
    return;
  }
  
  const nextStage = result === 'Passed' ? 'Closed' : 'Implementation';
  
  try {
    const updateData = {
      verification_result: result,
      updated_at: new Date().toISOString(),
      updated_by: currentUser?.id || null
    };
    
    if (result === 'Passed') {
      updateData.closed_at = new Date().toISOString();
    }
    
    await sb.from('change_requests').update(updateData).eq('id', changeId);
    
    await submitComment(`Verification: ${result} - ${comments}`);
    await transitionToNextStage(nextStage);
    
    closeStageModal();
    showToast('‚úì Verification submitted!', 'success');
    
  } catch (error) {
    console.error('Error:', error);
    showToast('Error: ' + error.message, 'error');
  }
}

function viewStageInfo(stage){
  alert('This stage ('+stage+') has been completed. View audit trail for details.');
}



// Initialize user and verify authentication
(async function initializeUser(){
  try {
    const {data:{session}, error} = await sb.auth.getSession();
    
    if (error) {
      console.error('Session error:', error);
      return;
    }
    
    if (!session) {
      console.log('No session found - redirecting to login');
      window.location.href = 'login.html';
      return;
    }
    
    currentUser = session.user;
    console.log('‚úì User authenticated:', currentUser.email);
    
  } catch (error) {
    console.error('Error initializing user:', error);
    alert('Authentication error. Please log in again.');
    window.location.href = 'login.html';
  }
})();

// Toast notification helper
function showToast(message, type = 'info') {
  const bgColors = {
    success: '#10b981',
    error: '#ef4444',
    info: '#3b82f6',
    warning: '#f59e0b'
  };
  
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${bgColors[type] || bgColors.info};
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    font-weight: 600;
    font-size: 14px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
    z-index: 10000;
    animation: slideIn 0.3s ease;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Add animation styles
if (!document.getElementById('toastStyles')) {
  const style = document.createElement('style');
  style.id = 'toastStyles';
  style.textContent = `
    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(400px); opacity: 0; }
    }
  `;
  document.head.appendChild(style);
}

// QA Review Functions
async function acceptQAReview() {
  const comments = document.getElementById('qaComments')?.value || '';
  
  if (!comments.trim()) {
    showToast('Please enter review comments', 'warning');
    return;
  }
  
  try {
    // Add comment first
    await submitComment(`QA Review: ACCEPTED - ${comments}`);
    
    // Then transition to next stage
    await transitionToNextStage('Impact Assessment');
    
    closeStageModal();
    
  } catch (error) {
    console.error('Error in acceptQAReview:', error);
    showToast('Error: ' + error.message, 'error');
  }
}

async function rejectQAReview() {
  const comments = document.getElementById('qaComments')?.value || '';
  
  if (!comments.trim()) {
    showToast('Please enter rejection reason', 'warning');
    return;
  }
  
  if (!confirm('Are you sure you want to reject this change request back to Draft?')) {
    return;
  }
  
  try {
    // Add comment first
    await submitComment(`QA Review: REJECTED - ${comments}`);
    
    // Then transition back to Draft
    await transitionToNextStage('Draft');
    
    closeStageModal();
    
  } catch (error) {
    console.error('Error in rejectQAReview:', error);
    showToast('Error: ' + error.message, 'error');
  }
}

async function finalizeClose() {
  const comments = document.getElementById('closingComments')?.value || '';
  
  try {
    // Update to Closed status
    const { error } = await sb
      .from('change_requests')
      .update({ 
        workflow_stage: 'Closed',
        status: 'Closed',
        closed_at: new Date().toISOString(),
        updated_at: new Date().toISOString(),
        updated_by: currentUser?.id || null
      })
      .eq('id', changeId);
    
    if (error) throw error;
    
    // Add closing comment if provided
    if (comments.trim()) {
      await submitComment(`Change Request Closed: ${comments}`);
    }
    
    // Log audit
    await logManualAudit(
      'UPDATE',
      'workflow_stage',
      changeData.workflow_stage,
      'Closed',
      'Change request closed and completed'
    );
    
    closeStageModal();
    showToast('‚úì Change Request closed successfully!', 'success');
    
    // Update local data
    changeData.workflow_stage = 'Closed';
    changeData.closed_at = new Date().toISOString();
    
    // Reload to show updated state with checkmark
    setTimeout(() => {
      location.reload();
    }, 1000);
    
  } catch (error) {
    console.error('Error closing change request:', error);
    showToast('Error: ' + error.message, 'error');
  }
}

// Add this in the renderDetails function or create a new function
function renderActionButtons() {
  const isClosed = changeData && changeData.workflow_stage === 'Closed';
  
  return `
    <button class="action-btn" onclick="editChange()" ${isClosed ? 'disabled style="opacity:0.5;cursor:not-allowed"' : ''}>
      ‚úèÔ∏è Edit Change Request
    </button>
    <button class="action-btn" onclick="addComment()" ${isClosed ? 'disabled style="opacity:0.5;cursor:not-allowed"' : ''}>
      üí¨ Add Comment
    </button>
    <button class="action-btn" onclick="attachDocument()" ${isClosed ? 'disabled style="opacity:0.5;cursor:not-allowed"' : ''}>
      üìé Attach Document
    </button>
    <button class="action-btn" onclick="viewAuditTrail()">
      üîç View Audit Trail
    </button>
  `;
}

async function exportToPDF() {
  if (!changeData) {
    showToast('Change data not loaded', 'error');
    return;
  }
  
  try {
    showToast('Generating comprehensive audit report...', 'info');
    
    // Fetch comments and attachments for the PDF
    let commentsData = [];
    let attachmentsData = [];
    let auditEventsData = [];
    
    try {
      const { data: comments } = await sb
        .from('change_comments')
        .select('*')
        .eq('change_request_id', changeId)
        .order('created_at', { ascending: true });
      commentsData = comments || [];
    } catch (e) {
      console.warn('Could not load comments:', e);
    }
    
    try {
      const { data: attachments } = await sb
        .from('change_attachments')
        .select('*')
        .eq('change_request_id', changeId)
        .order('uploaded_at', { ascending: false });
      attachmentsData = attachments || [];
    } catch (e) {
      console.warn('Could not load attachments:', e);
    }

    try {
      const { data: auditEvents } = await sb
        .from('audit_events')
        .select('*')
        .eq('entity_type', 'change_request')
        .eq('entity_id', changeId)
        .order('timestamp_utc', { ascending: true });
      auditEventsData = auditEvents || [];
    } catch (e) {
      console.warn('Could not load audit trail:', e);
    }

    // Create comprehensive HTML content
    const htmlContent = `
      <div style="font-family: 'Calibri', Arial, sans-serif; color: #333; line-height: 1.5; font-size: 11px;">
        
        <!-- Cover Page -->
        <div style="page-break-after: always; text-align: center; padding: 80px 40px; border-bottom: 2px solid #333;">
          <p style="color: #10b981; font-size: 14px; margin: 0 0 20px 0; font-weight: bold; letter-spacing: 2px;">ValQMS</p>
          <h1 style="color: #333; font-size: 32px; margin: 0; font-weight: bold;">CHANGE REQUEST REPORT</h1>
          <h2 style="color: #888; font-size: 14px; margin: 10px 0 30px 0; font-weight: normal;">Quality Management System</h2>
          
          <div style="margin: 60px 0; text-align: left; background: #f5f5f5; border-left: 3px solid #10b981; padding: 20px; border-radius: 4px;">
            <p style="margin: 5px 0; color: #333;"><strong>Change Number:</strong> ${changeData.change_number || 'N/A'}</p>
            <p style="margin: 5px 0; color: #333;"><strong>Title:</strong> ${changeData.title || 'Untitled'}</p>
            <p style="margin: 5px 0; color: #333;"><strong>Status:</strong> ${changeData.workflow_stage || 'Draft'}</p>
            <p style="margin: 5px 0; color: #333;"><strong>Generated:</strong> ${new Date().toLocaleString('en-IN')}</p>
            <p style="margin: 5px 0; color: #666; font-size: 10px;"><strong>Document ID:</strong> ${changeId}</p>
          </div>
          
          <div style="margin-top: 100px; color: #666; font-size: 10px;">
            <p>This is an official document from the ValQMS Change Management System</p>
            <p>Compliant with 21 CFR Part 11 and FDA Requirements</p>
          </div>
        </div>

        <!-- Document Control Page -->
        <div style="page-break-after: always; padding: 40px;">
          <h2 style="color: #333; background: #f5f5f5; font-size: 14px; padding: 10px 15px; margin: -40px -40px 20px -40px; font-weight: bold; border-bottom: 2px solid #10b981;">DOCUMENT CONTROL</h2>
          
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; margin-top: 20px;">
            <tr style="background: #f0fdf4;">
              <td style="padding: 8px; font-weight: bold; width: 35%; border: 1px solid #10b981;">Document Title</td>
              <td style="padding: 8px; border: 1px solid #10b981;">Change Request - ${changeData.title}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Change Number</td>
              <td style="padding: 8px; border: 1px solid #10b981; color: #10b981; font-weight: bold;">${changeData.change_number}</td>
            </tr>
            <tr style="background: #f0fdf4;">
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Document Version</td>
              <td style="padding: 8px; border: 1px solid #10b981;">1.0</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Date of Issue</td>
              <td style="padding: 8px; border: 1px solid #10b981;">${new Date(changeData.created_at).toLocaleDateString('en-IN')}</td>
            </tr>
            <tr style="background: #f0fdf4;">
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Last Revised</td>
              <td style="padding: 8px; border: 1px solid #10b981;">${new Date(changeData.updated_at).toLocaleDateString('en-IN')}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Status</td>
              <td style="padding: 8px; border: 1px solid #10b981; color: #10b981; font-weight: bold;">${changeData.workflow_stage}</td>
            </tr>
          </table>

          <h3 style="color: #10b981; font-size: 12px; margin-top: 30px; margin-bottom: 10px; border-bottom: 2px solid #10b981; padding-bottom: 5px;">Document Approval</h3>
          <table style="width: 100%; border-collapse: collapse;">
            <tr style="background: #f0fdf4;">
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Prepared By</td>
              <td style="padding: 8px; border: 1px solid #10b981;">${changeData.initiator_name}</td>
              <td style="padding: 8px; border: 1px solid #10b981;">Date: ${new Date(changeData.created_at).toLocaleDateString('en-IN')}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Reviewed By</td>
              <td style="padding: 8px; border: 1px solid #10b981;">QA Department</td>
              <td style="padding: 8px; border: 1px solid #10b981;">Pending</td>
            </tr>
            <tr style="background: #f0fdf4;">
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Approved By</td>
              <td style="padding: 8px; border: 1px solid #10b981;">CAB/Management</td>
              <td style="padding: 8px; border: 1px solid #10b981;">Pending</td>
            </tr>
          </table>
        </div>

        <!-- Change Details Page -->
        <div style="page-break-after: always; padding: 40px;">
          <h2 style="color: #333; background: #f5f5f5; font-size: 14px; padding: 10px 15px; margin: -40px -40px 20px -40px; font-weight: bold; border-bottom: 2px solid #10b981;">CHANGE REQUEST DETAILS</h2>
          
          <h3 style="color: #10b981; font-size: 11px; margin: 20px 0 10px 0; font-weight: bold; border-bottom: 1px solid #10b981; padding-bottom: 5px;">1. CHANGE IDENTIFICATION</h3>
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
            <tr style="background: #f0fdf4;">
              <td style="padding: 8px; font-weight: bold; width: 25%; border: 1px solid #10b981;">Change ID</td>
              <td style="padding: 8px; border: 1px solid #10b981; width: 25%; font-size: 10px;">${changeData.id}</td>
              <td style="padding: 8px; font-weight: bold; width: 25%; border: 1px solid #10b981;">Change Number</td>
              <td style="padding: 8px; border: 1px solid #10b981; width: 25%; color: #10b981; font-weight: bold;">${changeData.change_number}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Initiator</td>
              <td style="padding: 8px; border: 1px solid #10b981;">${changeData.initiator_name}</td>
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Department</td>
              <td style="padding: 8px; border: 1px solid #10b981;">${changeData.department}</td>
            </tr>
            <tr style="background: #f0fdf4;">
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Date Initiated</td>
              <td style="padding: 8px; border: 1px solid #10b981;">${new Date(changeData.created_at).toLocaleDateString('en-IN')}</td>
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Contact</td>
              <td style="padding: 8px; border: 1px solid #10b981;">${changeData.contact_email || 'N/A'}</td>
            </tr>
          </table>

          <h3 style="color: #10b981; font-size: 11px; margin: 15px 0 10px 0; font-weight: bold; border-bottom: 1px solid #10b981; padding-bottom: 5px;">2. CHANGE CLASSIFICATION</h3>
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
            <tr style="background: #f0fdf4;">
              <td style="padding: 8px; font-weight: bold; width: 25%; border: 1px solid #10b981;">Change Type</td>
              <td style="padding: 8px; border: 1px solid #10b981;">${changeData.change_type}</td>
              <td style="padding: 8px; font-weight: bold; width: 25%; border: 1px solid #10b981;">Category</td>
              <td style="padding: 8px; border: 1px solid #10b981;">${changeData.change_category}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Priority</td>
              <td style="padding: 8px; border: 1px solid #10b981; color: ${changeData.priority === 'High' ? '#dc2626' : changeData.priority === 'Medium' ? '#f59e0b' : '#10b981'}; font-weight: bold;">
                ${changeData.priority}
              </td>
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Urgency</td>
              <td style="padding: 8px; border: 1px solid #10b981;">${changeData.urgency || 'Normal'}</td>
            </tr>
          </table>

          <h3 style="color: #10b981; font-size: 11px; margin: 15px 0 10px 0; font-weight: bold; border-bottom: 1px solid #10b981; padding-bottom: 5px;">3. CHANGE DESCRIPTION</h3>
          <div style="background: #f0fdf4; padding: 12px; border-left: 4px solid #10b981; border: 1px solid #10b981; border-radius: 4px; margin-bottom: 15px;">
            <p style="margin: 0; white-space: pre-wrap; font-size: 10px;">
              ${changeData.description || 'No description provided'}
            </p>
          </div>

          <h3 style="color: #10b981; font-size: 11px; margin: 15px 0 10px 0; font-weight: bold; border-bottom: 1px solid #10b981; padding-bottom: 5px;">4. TIMELINE</h3>
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
            <tr style="background: #f0fdf4;">
              <td style="padding: 8px; font-weight: bold; width: 35%; border: 1px solid #10b981;">Proposed Implementation Date</td>
              <td style="padding: 8px; border: 1px solid #10b981;">${changeData.proposed_implementation_date ? new Date(changeData.proposed_implementation_date).toLocaleDateString('en-IN') : 'N/A'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Request Created</td>
              <td style="padding: 8px; border: 1px solid #10b981;">${new Date(changeData.created_at).toLocaleString('en-IN')}</td>
            </tr>
            <tr style="background: #f0fdf4;">
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Last Updated</td>
              <td style="padding: 8px; border: 1px solid #10b981;">${new Date(changeData.updated_at).toLocaleString('en-IN')}</td>
            </tr>
            ${changeData.closed_at ? `
              <tr>
                <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Closed Date</td>
                <td style="padding: 8px; border: 1px solid #10b981;">${new Date(changeData.closed_at).toLocaleString('en-IN')}</td>
              </tr>
            ` : ''}
          </table>
        </div>

        <!-- Risk & Impact Assessment Page -->
        <div style="page-break-after: always; padding: 40px;">
          <h2 style="color: #fff; background: #10b981; font-size: 14px; padding: 10px 15px; margin: -40px -40px 20px -40px; font-weight: bold;">RISK & IMPACT ASSESSMENT</h2>
          
          <h3 style="color: #10b981; font-size: 11px; margin: 20px 0 10px 0; font-weight: bold; border-bottom: 1px solid #10b981; padding-bottom: 5px;">5. IMPACT ANALYSIS</h3>
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 15px;">
            <tr style="background: #f0fdf4;">
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Overall Risk Rating</td>
              <td style="padding: 8px; border: 1px solid #10b981; font-weight: bold; color: ${changeData.overall_risk_rating === 'High' ? '#dc2626' : changeData.overall_risk_rating === 'Medium' ? '#f59e0b' : '#10b981'};">
                ${changeData.overall_risk_rating || 'Not Yet Assessed'}
              </td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Impact on Product Quality</td>
              <td style="padding: 8px; border: 1px solid #10b981;">${changeData.impact_on_quality || 'To be assessed'}</td>
            </tr>
            <tr style="background: #f0fdf4;">
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Impact on Patient Safety</td>
              <td style="padding: 8px; border: 1px solid #10b981;">${changeData.impact_on_safety || 'To be assessed'}</td>
            </tr>
            <tr>
              <td style="padding: 8px; font-weight: bold; border: 1px solid #10b981;">Regulatory Impact</td>
              <td style="padding: 8px; border: 1px solid #10b981;">${changeData.regulatory_impact || 'To be assessed'}</td>
            </tr>
          </table>

          <h3 style="color: #10b981; font-size: 11px; margin: 15px 0 10px 0; font-weight: bold; border-bottom: 1px solid #10b981; padding-bottom: 5px;">6. JUSTIFICATION & RATIONALE</h3>
          <div style="background: #f0fdf4; padding: 12px; border-left: 4px solid #10b981; border: 1px solid #10b981; border-radius: 4px; margin-bottom: 15px;">
            <p style="margin: 0; white-space: pre-wrap; font-size: 10px;">
              ${changeData.justification || 'No justification provided'}
            </p>
          </div>

          <h3 style="color: #10b981; font-size: 11px; margin: 15px 0 10px 0; font-weight: bold; border-bottom: 1px solid #10b981; padding-bottom: 5px;">7. CURRENT WORKFLOW STATUS</h3>
          <div style="background: #f0fdf4; padding: 12px; border: 2px solid #10b981; border-radius: 4px;">
            <p style="margin: 0; font-size: 10px;"><strong>Current Stage:</strong> <span style="color: #10b981; font-weight: bold;">${changeData.workflow_stage}</span></p>
            <p style="margin: 5px 0 0 0; font-size: 10px;"><strong>Status:</strong> ${changeData.status || 'In Progress'}</p>
          </div>
        </div>

        <!-- Comments Page -->
        ${commentsData.length > 0 ? `
          <div style="page-break-after: always; padding: 40px;">
            <h2 style="color: #fff; background: #10b981; font-size: 14px; padding: 10px 15px; margin: -40px -40px 20px -40px; font-weight: bold;">COMMENTS & COMMUNICATIONS (${commentsData.length})</h2>
            
            ${commentsData.map((comment, idx) => `
              <div style="margin-bottom: 15px; padding: 12px; background: #f0fdf4; border-left: 4px solid #10b981; border: 1px solid #10b981; border-radius: 4px;">
                <p style="margin: 0 0 5px 0; font-weight: bold; font-size: 10px; color: #10b981;">
                  ${comment.user_name || 'Unknown User'} (${comment.comment_type || 'General'})
                </p>
                <p style="margin: 0 0 8px 0; color: #666; font-size: 9px;">
                  ${new Date(comment.created_at).toLocaleString('en-IN')}
                </p>
                <p style="margin: 0; font-size: 10px; white-space: pre-wrap; color: #333;">
                  ${comment.comment}
                </p>
              </div>
            `).join('')}
          </div>
        ` : ''}

        <!-- Attachments Page -->
        ${attachmentsData.length > 0 ? `
          <div style="page-break-after: always; padding: 40px;">
            <h2 style="color: #fff; background: #10b981; font-size: 14px; padding: 10px 15px; margin: -40px -40px 20px -40px; font-weight: bold;">ATTACHMENTS & SUPPORTING DOCUMENTS (${attachmentsData.length})</h2>
            
            <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
              <tr style="background: #10b981; color: white;">
                <td style="padding: 10px; font-weight: bold; border: 1px solid #10b981;">Document Name</td>
                <td style="padding: 10px; font-weight: bold; border: 1px solid #10b981;">Category</td>
                <td style="padding: 10px; font-weight: bold; border: 1px solid #10b981;">Size</td>
                <td style="padding: 10px; font-weight: bold; border: 1px solid #10b981;">Uploaded Date</td>
              </tr>
              ${attachmentsData.map((att, idx) => `
                <tr ${idx % 2 === 0 ? 'style="background: #f0fdf4;"' : ''}>
                  <td style="padding: 8px; border: 1px solid #10b981; font-size: 10px;">${att.original_filename || att.filename}</td>
                  <td style="padding: 8px; border: 1px solid #10b981; font-size: 10px;">${att.category || 'Document'}</td>
                  <td style="padding: 8px; border: 1px solid #10b981; font-size: 10px;">${(att.file_size / 1024).toFixed(2)} KB</td>
                  <td style="padding: 8px; border: 1px solid #10b981; font-size: 10px;">${new Date(att.uploaded_at).toLocaleDateString('en-IN')}</td>
                </tr>
              `).join('')}
            </table>
          </div>
        ` : ''}

        <!-- Audit Trail Page -->
        ${auditEventsData.length > 0 ? `
          <div style="page-break-after: always; padding: 40px;">
            <h2 style="color: #fff; background: #10b981; font-size: 14px; padding: 10px 15px; margin: -40px -40px 20px -40px; font-weight: bold;">COMPLETE AUDIT TRAIL (${auditEventsData.length} Events)</h2>
            
            <p style="color: #666; font-size: 10px; margin-bottom: 15px;">
              This audit trail provides a complete record of all changes, approvals, and modifications to this change request.
            </p>

            ${auditEventsData.map((event, idx) => {
              let actionTitle = event.action;
              let actionIcon = 'üìù';
              
              if(event.action === 'CREATE') {
                actionTitle = 'Change Request Created';
                actionIcon = '‚ú®';
              } else if(event.action === 'UPDATE' && event.field_name === 'workflow_stage') {
                actionTitle = 'Workflow Stage Changed';
                actionIcon = 'üîÑ';
              } else if(event.action === 'APPROVE') {
                actionTitle = 'Approved';
                actionIcon = '‚úÖ';
              } else if(event.action === 'REJECT') {
                actionTitle = 'Rejected';
                actionIcon = '‚ùå';
              }

              return `
                <div style="margin-bottom: 12px; padding: 10px; background: #f0fdf4; border-left: 4px solid #10b981; border: 1px solid #10b981; border-radius: 4px;">
                  <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <p style="margin: 0; font-weight: bold; font-size: 10px; color: #10b981;">${actionIcon} ${actionTitle}</p>
                    <p style="margin: 0; color: #666; font-size: 9px;">${new Date(event.timestamp_utc).toLocaleString('en-IN')}</p>
                  </div>
                  <p style="margin: 5px 0 0 0; color: #555; font-size: 9px;">
                    <strong>User:</strong> ${event.user_full_name || 'System'} 
                    ${event.user_employee_id ? '(' + event.user_employee_id + ')' : ''}
                  </p>
                  ${event.field_name ? `
                    <p style="margin: 3px 0 0 0; color: #555; font-size: 9px;">
                      <strong>Field:</strong> ${event.field_name}
                      ${event.old_value && event.new_value ? ` (${event.old_value} ‚Üí ${event.new_value})` : ''}
                    </p>
                  ` : ''}
                  ${event.reason ? `
                    <p style="margin: 3px 0 0 0; color: #555; font-size: 9px;">
                      <strong>Reason:</strong> ${event.reason}
                    </p>
                  ` : ''}
                </div>
              `;
            }).join('')}
          </div>
        ` : ''}

        <!-- Footer Page -->
        <div style="padding: 40px; border-top: 3px solid #10b981; margin-top: 40px;">
          <h2 style="color: #fff; background: #10b981; font-size: 14px; padding: 10px 15px; margin: -40px -40px 20px -40px; font-weight: bold;">REGULATORY COMPLIANCE & AUDIT INFORMATION</h2>
          
          <h3 style="color: #10b981; font-size: 11px; margin: 15px 0 10px 0; font-weight: bold; border-bottom: 1px solid #10b981; padding-bottom: 5px;">Regulatory Compliance</h3>
          <ul style="margin: 0; padding-left: 20px; font-size: 10px; color: #333;">
            <li>Document prepared in compliance with 21 CFR Part 11 (Electronic Records)</li>
            <li>Unique Change ID: ${changeId}</li>
            <li>Digital signatures and audit trails maintained in system</li>
            <li>Document retention as per company retention policy</li>
            <li>System audit trail available upon request</li>
          </ul>

          <div style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #10b981; text-align: center; color: #666; font-size: 9px;">
            <p style="margin: 0 0 5px 0;">
              <strong>Document Generated:</strong> ${new Date().toLocaleString('en-IN')}
            </p>
            <p style="margin: 0 0 5px 0;">
              <strong>System:</strong> ValQMS Change Management System v1.0
            </p>
            <p style="margin: 0 0 5px 0;">
              <strong>Generated By:</strong> ${currentUser?.email || 'System'}
            </p>
            <p style="margin: 0 0 10px 0;">
              <strong>Change ID:</strong> ${changeId}
            </p>
            <p style="margin: 0; color: #999; font-size: 8px; padding-top: 10px; border-top: 1px solid #10b981;">
              Confidentiality: Internal Use Only - Regulatory Records
            </p>
          </div>
        </div>

      </div>
    `;

    // Configure PDF options
    const options = {
      margin: [10, 10, 10, 10],
      filename: changeData.change_number + '_AUDIT_REPORT_' + new Date().toISOString().split('T')[0] + '.pdf',
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, letterRendering: true },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };

    // Generate PDF
    html2pdf()
      .set(options)
      .from(htmlContent)
      .save()
      .then(() => {
        showToast('Audit-ready PDF exported successfully!', 'success');
      })
      .catch(error => {
        console.error('PDF export error:', error);
        showToast('Error generating PDF: ' + error.message, 'error');
      });

  } catch (error) {
    console.error('Error in exportToPDF:', error);
    showToast('Error: ' + error.message, 'error');
  }
}

</script>
</body>
</html>
