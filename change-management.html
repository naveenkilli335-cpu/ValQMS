<!DOCTYPE html>
<html lang="en" data-theme="green" data-bg="mesh">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Change Control Dashboard — ValQMS</title>
<link rel="icon" href="favicon.jpg?v=5">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
[data-theme="green"]{--accent:#10b981;--accent-bright:#34d399;--accent-dim:rgba(16,185,129,0.15);--accent-glow:rgba(16,185,129,0.4)}
:root{--text:#ffffff;--text-dim:#94a3b8;--surface:rgba(255,255,255,0.05);--surface-hover:rgba(255,255,255,0.08);--border:rgba(255,255,255,0.1);--glass:rgba(255,255,255,0.03)}
[data-bg="mesh"] body{background:#0f172a;position:relative}
[data-bg="mesh"] body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 20% 50%, rgba(16,185,129,0.15) 0%, transparent 50%),radial-gradient(circle at 80% 80%, rgba(99,102,241,0.15) 0%, transparent 50%);animation:meshMove 15s ease-in-out infinite alternate;z-index:-1}
@keyframes meshMove{0%{transform:scale(1)}100%{transform:scale(1.1)}}
body{font-family:'Inter',sans-serif;color:var(--text);line-height:1.6;min-height:100vh}
.container{max-width:1400px;margin:0 auto;padding:24px}
header{position:sticky;top:12px;z-index:1000;padding:0 24px;margin-bottom:24px}
.header-glass{background:rgba(255,255,255,0.03);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:20px;padding:16px 32px;display:flex;justify-content:space-between;align-items:center}
.logo{display:flex;align-items:center;gap:12px;text-decoration:none;color:var(--text);font-weight:800;font-size:18px}
nav{display:flex;gap:20px;align-items:center}
nav a{color:var(--text-dim);text-decoration:none;font-size:14px;font-weight:600;padding:8px 16px;border-radius:8px;transition:all 0.3s}
nav a:hover,nav a.active{color:var(--text);background:var(--surface)}
.page-title{font-size:32px;font-weight:800;margin-bottom:8px}
.page-subtitle{color:var(--text-dim);font-size:14px;margin-bottom:32px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:32px}
.stat-card{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:16px;padding:24px;transition:all 0.3s;cursor:pointer}
.stat-card:hover{border-color:var(--accent);transform:translateY(-2px)}
.stat-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.stat-value{font-size:36px;font-weight:800;color:var(--text)}
.stat-label{font-size:13px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px}
.stat-change{font-size:12px;color:#10b981;font-weight:600}
.card{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:20px}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.card-title{font-size:18px;font-weight:700;color:var(--text)}
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:32px}
.chart-container{position:relative;height:300px}
table{width:100%;border-collapse:collapse}
thead{background:var(--surface);border-bottom:2px solid var(--border)}
th{padding:12px 16px;text-align:left;font-size:12px;font-weight:700;color:var(--text-dim);text-transform:uppercase}
td{padding:12px 16px;border-bottom:1px solid var(--border);font-size:14px;color:var(--text)}
tbody tr{transition:all 0.2s}
tbody tr:hover{background:var(--surface)}
.badge{display:inline-flex;align-items:center;padding:4px 12px;border-radius:999px;font-size:11px;font-weight:700}
.badge.draft{background:rgba(148,163,184,0.2);color:#94a3b8}
.badge.cab-review{background:rgba(251,146,60,0.2);color:#fb923c}
.badge.implementation{background:rgba(59,130,246,0.2);color:#60a5fa}
.badge.closed{background:rgba(100,116,139,0.2);color:#64748b}
.badge.high{background:rgba(239,68,68,0.2);color:#f87171}
.badge.critical{background:rgba(220,38,38,0.3);color:#dc2626}
.badge.medium{background:rgba(251,146,60,0.2);color:#fb923c}
.badge.low{background:rgba(16,185,129,0.2);color:#10b981}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;background:linear-gradient(135deg,var(--accent),var(--accent-bright));color:#000;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.3s;text-decoration:none}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px var(--accent-glow)}
.btn-secondary{background:var(--surface);border:1px solid var(--border);color:var(--text)}
.btn-sm{padding:6px 12px;font-size:12px}
.workflow-progress{display:flex;justify-content:space-between;margin:32px 0;position:relative}
.workflow-progress::before{content:'';position:absolute;top:20px;left:0;right:0;height:2px;background:var(--border);z-index:0}
.workflow-step{display:flex;flex-direction:column;align-items:center;position:relative;z-index:1}
.workflow-circle{width:40px;height:40px;border-radius:50%;background:var(--surface);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:18px;margin-bottom:8px;transition:all 0.3s}
.workflow-step.active .workflow-circle{background:var(--accent);border-color:var(--accent);box-shadow:0 0 0 4px var(--accent-dim)}
.workflow-step.completed .workflow-circle{background:var(--accent);border-color:var(--accent)}
.workflow-label{font-size:11px;color:var(--text-dim);text-align:center;max-width:80px}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-dim)}
.loading{display:flex;justify-content:center;padding:40px}
.spinner{width:40px;height:40px;border:4px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);z-index:2000;padding:24px;overflow-y:auto}
.modal.active{display:flex;align-items:center;justify-content:center}
.modal-content{background:rgba(15,23,42,0.95);border:1px solid var(--border);border-radius:20px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto}
.modal-header{padding:24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-header h2{font-size:22px;font-weight:800}
.modal-body{padding:24px}
.modal-footer{padding:24px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end}
.close-modal{background:none;border:none;color:var(--text-dim);font-size:24px;cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:8px;transition:all 0.3s}
.close-modal:hover{background:var(--surface);color:var(--text)}
.form-group{margin-bottom:20px}
label{display:block;font-size:12px;color:var(--text-dim);margin-bottom:8px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
input[type="text"],input[type="date"],input[type="password"],textarea,select{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:12px;background:var(--surface);color:#fff;font-size:14px;font-family:inherit;transition:all 0.3s}
textarea{min-height:100px;resize:vertical}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.toast{position:fixed;bottom:24px;right:24px;background:var(--accent);color:#000;padding:16px 24px;border-radius:12px;font-weight:600;box-shadow:0 8px 24px rgba(0,0,0,0.3);z-index:3000;transform:translateY(100px);opacity:0;transition:all 0.3s}
.toast.show{transform:translateY(0);opacity:1}
.toast.error{background:#ef4444;color:#fff}
@media(max-width:768px){.charts-grid{grid-template-columns:1fr}.workflow-progress{flex-wrap:wrap;gap:20px}}

/* Theme Colors */
[data-theme="green"]{--accent:#10b981;--accent-bright:#34d399;--accent-dim:rgba(16,185,129,0.15);--accent-glow:rgba(16,185,129,0.4)}
[data-theme="blue"]{--accent:#3b82f6;--accent-bright:#60a5fa;--accent-dim:rgba(59,130,246,0.15);--accent-glow:rgba(59,130,246,0.4)}
[data-theme="purple"]{--accent:#8b5cf6;--accent-bright:#a78bfa;--accent-dim:rgba(139,92,246,0.15);--accent-glow:rgba(139,92,246,0.4)}
[data-theme="orange"]{--accent:#f97316;--accent-bright:#fb923c;--accent-dim:rgba(249,115,22,0.15);--accent-glow:rgba(249,115,22,0.4)}

/* Background Styles */
[data-bg="mesh"] body{background:#0f172a;position:relative}
[data-bg="mesh"] body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 20% 50%, rgba(16,185,129,0.15) 0%, transparent 50%),radial-gradient(circle at 80% 80%, rgba(99,102,241,0.15) 0%, transparent 50%);animation:meshMove 15s ease-in-out infinite alternate;z-index:-1}
[data-bg="gradient"] body{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);position:relative}
[data-bg="dark"] body{background:#0a0e1a;position:relative}
[data-bg="dark"] body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at center, rgba(59,130,246,0.05) 0%, transparent 70%);z-index:-1}
[data-bg="mesh2"] body{background:#0f172a;position:relative}
[data-bg="mesh2"] body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 15% 60%, rgba(255,0,128,0.12), transparent 50%),radial-gradient(circle at 85% 40%, rgba(0,128,255,0.12), transparent 50%),radial-gradient(circle at 50% 90%, rgba(0,255,128,0.1), transparent 50%);animation:mesh2Move 25s ease-in-out infinite alternate;z-index:-1}

@keyframes meshMove{0%{transform:scale(1)}100%{transform:scale(1.1)}}
@keyframes mesh2Move{0%{transform:translate(0,0)}100%{transform:translate(-50px,40px)}}

/* Selector Buttons */
.bg-selector, .theme-selector{position:relative}
.bg-btn, .theme-btn{padding:10px 18px;background:var(--surface);border:1px solid var(--border);border-radius:12px;color:var(--text-dim);font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;gap:8px;transition:all 0.3s}
.bg-btn:hover, .theme-btn:hover{background:var(--surface-hover);border-color:var(--accent);color:var(--text)}
.bg-dropdown, .theme-dropdown{position:absolute;top:calc(100% + 12px);right:0;background:rgba(255,255,255,0.05);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:16px;padding:12px;display:none;min-width:180px;box-shadow:0 20px 60px rgba(0,0,0,0.3);z-index:100}
.bg-dropdown.active, .theme-dropdown.active{display:block}
.bg-option, .theme-option{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;cursor:pointer;transition:all 0.3s;font-size:14px;font-weight:500}
.bg-option:hover, .theme-option:hover{background:var(--surface-hover)}
.bg-preview, .theme-color{width:28px;height:28px;border-radius:8px;border:2px solid rgba(255,255,255,0.2)}
.bg-preview.mesh{background:radial-gradient(circle, #10b981 0%, #6366f1 100%)}
.bg-preview.gradient{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%)}
.bg-preview.dark{background:#0a0e1a}
.bg-preview.mesh2{background:radial-gradient(circle, rgba(255,0,128,0.3) 0%, transparent 50%),radial-gradient(circle, rgba(0,255,128,0.3) 0%, transparent 50%)}
.theme-color.green{background:linear-gradient(135deg,#10b981,#34d399)}
.theme-color.blue{background:linear-gradient(135deg,#3b82f6,#60a5fa)}
.theme-color.purple{background:linear-gradient(135deg,#8b5cf6,#a78bfa)}
.theme-color.orange{background:linear-gradient(135deg,#f97316,#fb923c)}


</style>
</head>
<body>

<header>
<div class="header-glass">
<a href="change-management.html" class="logo">📊 Change Control Dashboard</a>
<nav>
<a href="change-management.html" class="active">Dashboard</a>
<a href="change-management.html" onclick="alert('Change Requests feature coming soon')">Change Requests</a>
<a href="change-management.html" onclick="alert('Reports feature coming soon')">Reports</a>
<a href="change-management.html" onclick="alert('Settings feature coming soon')">Settings</a>
<span style="color:var(--border);margin:0 8px">|</span>

<!-- Background Selector -->
<div class="bg-selector" style="position:relative">
  <button class="bg-btn" id="bgBtn" style="padding:8px 14px;font-size:12px" type="button"><span>🎨</span></button>
  <div class="bg-dropdown" id="bgDropdown">
    <div class="bg-option" data-bg="mesh"><div class="bg-preview mesh"></div><span>Mesh</span></div>
    <div class="bg-option" data-bg="gradient"><div class="bg-preview gradient"></div><span>Gradient</span></div>
    <div class="bg-option" data-bg="dark"><div class="bg-preview dark"></div><span>Dark</span></div>
    <div class="bg-option" data-bg="mesh2"><div class="bg-preview mesh2"></div><span>Mesh 2</span></div>
  </div>
</div>

<!-- Theme Selector -->
<div class="theme-selector" style="position:relative">
  <button class="theme-btn" id="themeBtn" style="padding:8px 14px;font-size:12px" type="button"><span>🎨</span></button>
  <div class="theme-dropdown" id="themeDropdown">
    <div class="theme-option" data-theme="green"><div class="theme-color green"></div><span>Green</span></div>
    <div class="theme-option" data-theme="blue"><div class="theme-color blue"></div><span>Blue</span></div>
    <div class="theme-option" data-theme="purple"><div class="theme-color purple"></div><span>Purple</span></div>
    <div class="theme-option" data-theme="orange"><div class="theme-color orange"></div><span>Orange</span></div>
  </div>
</div>

<a href="index.html" style="display:flex;align-items:center;gap:6px;text-decoration:none">
<span style="font-size:16px">🏠</span>
<span>Home</span>
</a>
</nav>
</div>
</header>


<div class="container">
<h1 class="page-title">Change Control Dashboard</h1>
<p class="page-subtitle">Monitor and manage change requests across your organization</p>

<div class="stats-grid">
<div class="stat-card" onclick="filterByStatus('all')">
<div class="stat-header">
<span class="stat-label">Total Changes</span>
<span style="font-size:24px">📊</span>
</div>
<div class="stat-value" id="totalChanges">0</div>
<div class="stat-change">All time</div>
</div>

<div class="stat-card" onclick="filterByStatus('active')">
<div class="stat-header">
<span class="stat-label">Active Changes</span>
<span style="font-size:24px">🔄</span>
</div>
<div class="stat-value" id="activeChanges">0</div>
<div class="stat-change">In progress</div>
</div>

<div class="stat-card" onclick="filterByStatus('pending')">
<div class="stat-header">
<span class="stat-label">Pending Approval</span>
<span style="font-size:24px">⏳</span>
</div>
<div class="stat-value" id="pendingChanges">0</div>
<div class="stat-change">Awaiting CAB review</div>
</div>

<div class="stat-card" onclick="filterByStatus('completed')">
<div class="stat-header">
<span class="stat-label">Completed This Month</span>
<span style="font-size:24px">✅</span>
</div>
<div class="stat-value" id="completedChanges">0</div>
<div class="stat-change">+12% from last month</div>
</div>
</div>

<div class="charts-grid">
<div class="card">
<div class="card-header">
<h3 class="card-title">Changes by Status</h3>
</div>
<div class="chart-container">
<canvas id="statusChart"></canvas>
</div>
</div>

<div class="card">
<div class="card-header">
<h3 class="card-title">Changes by Priority</h3>
</div>
<div class="chart-container">
<canvas id="priorityChart"></canvas>
</div>
</div>
</div>

<div class="card">
<div class="card-header">
<h3 class="card-title">Recent Change Requests</h3>
<button class="btn btn-sm" onclick="openNewChangeModal()">+ New Change Request</button>
</div>
<div id="loadingState" class="loading" style="display:none"><div class="spinner"></div></div>
<div id="changesContainer"></div>
</div>
</div>

<!-- New Change Modal -->
<div id="newChangeModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>New Change Request</h2>
<button class="close-modal" onclick="closeModal('newChangeModal')">×</button>
</div>
<form id="newChangeForm">
<div class="modal-body">
<div class="form-group">
<label>Change Title *</label>
<input type="text" id="changeTitle" required>
</div>
<div class="form-group">
<label>Description *</label>
<textarea id="changeDescription" required></textarea>
</div>
<div class="form-row">
<div class="form-group">
<label>Type *</label>
<select id="changeType" required>
<option value="">Select...</option>
<option value="Normal">Normal</option>
<option value="Emergency">Emergency</option>
<option value="Temporary">Temporary</option>
<option value="Planned">Planned</option>
</select>
</div>
<div class="form-group">
<label>Category *</label>
<select id="changeCategory" required>
<option value="">Select...</option>
<option value="Process Change">Process</option>
<option value="Equipment Change">Equipment</option>
<option value="Document Change">Document</option>
<option value="System Change">System</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>Department *</label>
<select id="changeDepartment" required>
<option value="">Select...</option>
<option value="Quality Assurance">Quality Assurance</option>
<option value="Production">Production</option>
<option value="Engineering">Engineering</option>
<option value="Regulatory">Regulatory</option>
</select>
</div>
<div class="form-group">
<label>Priority</label>
<select id="changePriority">
<option value="Medium">Medium</option>
<option value="Low">Low</option>
<option value="High">High</option>
<option value="Critical">Critical</option>
</select>
</div>
</div>
<div class="form-group">
<label>Justification *</label>
<textarea id="justification" required></textarea>
</div>
<div class="form-group">
<label>Proposed Date</label>
<input type="date" id="proposedDate">
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" onclick="closeModal('newChangeModal')">Cancel</button>
<button type="submit" class="btn">Create Change Request</button>
</div>
</form>
</div>
</div>

<div id="toast" class="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL='https://nufpaayytxtjihqrvtfi.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51ZnBhYXl5dHh0amlocXJ2dGZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMzA5NjIsImV4cCI6MjA3NTkwNjk2Mn0.766ENc3lMQSVJIsyxK6xlPE5DNlB3Np3eeXxvcoRGGY';
const {createClient}=supabase;
const sb=createClient(SUPABASE_URL,SUPABASE_KEY);
let currentUser=null;
let statusChart,priorityChart;

// Check authentication
(async function checkAuth(){
    try {
        const {data:{session}, error}=await sb.auth.getSession();
        if(error) throw error;
        
        if(!session){
            console.log('No session found, redirecting to login');
            window.location.href='login.html';
            return;
        }
        
        currentUser=session.user;
        console.log('User authenticated:', currentUser.email);
        loadDashboard();
    } catch(err) {
        console.error('Auth check error:', err);
        showToast('Authentication error: ' + err.message, 'error');
        setTimeout(() => window.location.href='login.html', 2000);
    }
})();

// Load dashboard data
async function loadDashboard(){
    showLoading();
    try{
        console.log('Loading dashboard data...');
        
        const {data:changes,error}=await sb
            .from('change_requests')
            .select('*')
            .order('created_at',{ascending:false});
        
        if(error){
            console.error('Supabase error:', error);
            throw error;
        }
        
        console.log('Loaded changes:', changes.length);
        
        // Update statistics
        document.getElementById('totalChanges').textContent=changes.length;
        
        const activeChanges = changes.filter(c=>
            c.workflow_stage && 
            !['Draft','Closed','Rejected'].includes(c.workflow_stage)
        );
        document.getElementById('activeChanges').textContent=activeChanges.length;
        
        const pendingChanges = changes.filter(c=>c.workflow_stage==='CAB Review');
        document.getElementById('pendingChanges').textContent=pendingChanges.length;
        
        const thisMonth=new Date().getMonth();
        const thisYear=new Date().getFullYear();
        const completedThisMonth = changes.filter(c=>{
            if(!c.closed_at || c.workflow_stage !== 'Closed') return false;
            const closedDate = new Date(c.closed_at);
            return closedDate.getMonth()===thisMonth && closedDate.getFullYear()===thisYear;
        });
        document.getElementById('completedChanges').textContent=completedThisMonth.length;
        
        // Render charts and table
        renderCharts(changes);
        renderRecentChanges(changes.slice(0,10));
        hideLoading();
        
        showToast('Dashboard loaded successfully', 'success');
    }catch(error){
        console.error('Dashboard load error:',error);
        hideLoading();
        
        // Show user-friendly error message
        const container=document.getElementById('changesContainer');
        container.innerHTML=`
            <div class="empty-state">
                <h3>Error Loading Dashboard</h3>
                <p style="color:var(--text-dim);margin-top:12px">
                    ${error.message || 'Unable to load change requests'}
                </p>
                <p style="color:var(--text-dim);margin-top:8px;font-size:12px">
                    Please ensure the database table is created and RLS policies are configured.
                </p>
                <button class="btn btn-sm" onclick="loadDashboard()" style="margin-top:20px">
                    Retry
                </button>
            </div>
        `;
        
        showToast('Error: ' + (error.message || 'Database connection failed'), 'error');
    }
}

// Render charts
function renderCharts(changes){
    if(!changes || changes.length === 0){
        console.log('No changes to render charts');
        return;
    }
    
    // Count by status
    const statusCounts={};
    changes.forEach(c=>{
        const stage=c.workflow_stage||'Draft';
        statusCounts[stage]=(statusCounts[stage]||0)+1;
    });
    
    // Count by priority
    const priorityCounts={Low:0,Medium:0,High:0,Critical:0};
    changes.forEach(c=>{
        const priority = c.priority||'Medium';
        if(priorityCounts.hasOwnProperty(priority)){
            priorityCounts[priority]++;
        }
    });
    
    // Status Chart
    const statusCtx=document.getElementById('statusChart')?.getContext('2d');
    if(statusCtx){
        if(statusChart)statusChart.destroy();
        statusChart=new Chart(statusCtx,{
            type:'bar',
            data:{
                labels:Object.keys(statusCounts),
                datasets:[{
                    label:'Changes',
                    data:Object.values(statusCounts),
                    backgroundColor:'rgba(16,185,129,0.8)',
                    borderColor:'#10b981',
                    borderWidth:1,
                    borderRadius:8
                }]
            },
            options:{
                responsive:true,
                maintainAspectRatio:false,
                plugins:{
                    legend:{display:false},
                    tooltip:{
                        backgroundColor:'rgba(15,23,42,0.9)',
                        padding:12,
                        titleColor:'#fff',
                        bodyColor:'#94a3b8'
                    }
                },
                scales:{
                    y:{
                        beginAtZero:true,
                        ticks:{color:'#94a3b8'},
                        grid:{color:'rgba(255,255,255,0.05)'}
                    },
                    x:{
                        ticks:{color:'#94a3b8'},
                        grid:{display:false}
                    }
                }
            }
        });
    }
    
    // Priority Chart
    const priorityCtx=document.getElementById('priorityChart')?.getContext('2d');
    if(priorityCtx){
        if(priorityChart)priorityChart.destroy();
        priorityChart=new Chart(priorityCtx,{
            type:'doughnut',
            data:{
                labels:['Low','Medium','High','Critical'],
                datasets:[{
                    data:[
                        priorityCounts.Low,
                        priorityCounts.Medium,
                        priorityCounts.High,
                        priorityCounts.Critical
                    ],
                    backgroundColor:['#10b981','#fb923c','#ef4444','#dc2626'],
                    borderWidth:0
                }]
            },
            options:{
                responsive:true,
                maintainAspectRatio:false,
                plugins:{
                    legend:{
                        position:'right',
                        labels:{color:'#94a3b8',padding:12}
                    },
                    tooltip:{
                        backgroundColor:'rgba(15,23,42,0.9)',
                        padding:12
                    }
                }
            }
        });
    }
}

// Render recent changes table
function renderRecentChanges(changes){
    const container=document.getElementById('changesContainer');
    
    if(!changes || changes.length===0){
        container.innerHTML='<div class="empty-state">No change requests found. Click "New Change Request" to create one.</div>';
        return;
    }
    
    let html='<table><thead><tr><th>ID</th><th>Title</th><th>Status</th><th>Priority</th><th>Initiator</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
    
    changes.forEach(c=>{
        const statusBadge=(c.workflow_stage||'draft').toLowerCase().replace(/\s+/g,'-');
        const priorityBadge=(c.priority||'medium').toLowerCase();
        const createdDate = new Date(c.created_at).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
        
        html+=`<tr>
            <td><strong>${c.change_number||'PENDING'}</strong></td>
            <td>${c.title||'Untitled'}</td>
            <td><span class="badge ${statusBadge}">${c.workflow_stage||'Draft'}</span></td>
            <td><span class="badge ${priorityBadge}">${c.priority||'Medium'}</span></td>
            <td>${c.initiator_name||'Unknown'}</td>
            <td>${createdDate}</td>
            <td><button class="btn btn-sm btn-secondary" onclick="viewChange('${c.id}')">View</button></td>
        </tr>`;
    });
    
    html+='</tbody></table>';
    container.innerHTML=html;
}

// Form submission
document.getElementById('newChangeForm').addEventListener('submit',async(e)=>{
    e.preventDefault();
    
    if(!currentUser){
        showToast('User not authenticated','error');
        return;
    }
    
    const formData={
        title:document.getElementById('changeTitle').value.trim(),
        description:document.getElementById('changeDescription').value.trim(),
        change_type:document.getElementById('changeType').value,
        change_category:document.getElementById('changeCategory').value,
        department:document.getElementById('changeDepartment').value,
        priority:document.getElementById('changePriority').value,
        justification:document.getElementById('justification').value.trim(),
        proposed_implementation_date:document.getElementById('proposedDate').value||null,
        initiator_id:currentUser.id,
        initiator_name:currentUser.email.split('@')[0],
        workflow_stage:'Draft',
        status:'Draft',
        created_by:currentUser.id
    };
    
    try{
        const {data,error}=await sb
            .from('change_requests')
            .insert([formData])
            .select()
            .single();
        
        if(error) throw error;
        
        showToast('Change request created successfully!','success');
        closeModal('newChangeModal');
        document.getElementById('newChangeForm').reset();
        loadDashboard();
    }catch(error){
        console.error('Create change error:',error);
        showToast('Error creating change: '+error.message,'error');
    }
});

// View change details
function viewChange(id){
    window.location.href=`change-details.html?id=${id}`;
}

// Modal functions
function openNewChangeModal(){
    document.getElementById('newChangeModal').classList.add('active');
}

function closeModal(id){
    document.getElementById(id).classList.remove('active');
}

// Loading states
function showLoading(){
    const loadingEl = document.getElementById('loadingState');
    const containerEl = document.getElementById('changesContainer');
    if(loadingEl) loadingEl.style.display='flex';
    if(containerEl) containerEl.style.display='none';
}

function hideLoading(){
    const loadingEl = document.getElementById('loadingState');
    const containerEl = document.getElementById('changesContainer');
    if(loadingEl) loadingEl.style.display='none';
    if(containerEl) containerEl.style.display='';
}

// Toast notifications
function showToast(message,type='success'){
    const toast=document.getElementById('toast');
    if(!toast) return;
    
    toast.textContent=message;
    toast.className=`toast ${type} show`;
    
    setTimeout(()=>{
        toast.classList.remove('show');
    },3000);
}

// Filter by status (placeholder)
function filterByStatus(status){
    console.log('Filter by status:', status);
    showToast('Filtering by: '+status,'success');
    // TODO: Implement actual filtering
}

// Close modals on backdrop click
document.querySelectorAll('.modal').forEach(modal=>{
    modal.addEventListener('click',(e)=>{
        if(e.target===modal){
            modal.classList.remove('active');
        }
    });
});

// Initialize theme and background from localStorage
const savedTheme = localStorage.getItem('valqmsTheme') || 'green';
const savedBg = localStorage.getItem('valqmsBg') || 'mesh';
document.documentElement.setAttribute('data-theme', savedTheme);
document.documentElement.setAttribute('data-bg', savedBg);

// Wait for DOM to be ready
setTimeout(() => {
  // Background selector
  const bgBtn = document.getElementById('bgBtn');
  const bgDropdown = document.getElementById('bgDropdown');
  const themeBtn = document.getElementById('themeBtn');
  const themeDropdown = document.getElementById('themeDropdown');

  if (bgBtn) {
    bgBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      themeDropdown?.classList.remove('active');
      bgDropdown.classList.toggle('active');
    });
  }

  document.querySelectorAll('.bg-option').forEach(opt => {
    opt.addEventListener('click', () => {
      const bg = opt.dataset.bg;
      document.documentElement.setAttribute('data-bg', bg);
      localStorage.setItem('valqmsBg', bg);
      bgDropdown?.classList.remove('active');
    });
  });

  if (themeBtn) {
    themeBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      bgDropdown?.classList.remove('active');
      themeDropdown.classList.toggle('active');
    });
  }

  document.querySelectorAll('.theme-option').forEach(opt => {
    opt.addEventListener('click', () => {
      const theme = opt.dataset.theme;
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('valqmsTheme', theme);
      themeDropdown?.classList.remove('active');
    });
  });

  // Close dropdowns on outside click
  document.addEventListener('click', (e) => {
    if (e.target !== bgBtn && e.target !== themeBtn && !bgDropdown?.contains(e.target) && !themeDropdown?.contains(e.target)) {
      bgDropdown?.classList.remove('active');
      themeDropdown?.classList.remove('active');
    }
  });

  bgDropdown?.addEventListener('click', (e) => e.stopPropagation());
  themeDropdown?.addEventListener('click', (e) => e.stopPropagation());
}, 100);

</script>

</body>
</html>
