<!DOCTYPE html>
<html lang="en" data-theme="green" data-bg="mesh">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Change Control Dashboard ‚Äî ValQMS</title>
<link rel="icon" href="favicon.jpg?v=5">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
[data-theme="green"]{--accent:#10b981;--accent-bright:#34d399;--accent-dim:rgba(16,185,129,0.15);--accent-glow:rgba(16,185,129,0.4)}
:root{--text:#ffffff;--text-dim:#94a3b8;--surface:rgba(255,255,255,0.05);--surface-hover:rgba(255,255,255,0.08);--border:rgba(255,255,255,0.1);--glass:rgba(255,255,255,0.03)}
[data-bg="mesh"] body{background:#0f172a;position:relative}
[data-bg="mesh"] body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 20% 50%, rgba(16,185,129,0.15) 0%, transparent 50%),radial-gradient(circle at 80% 80%, rgba(99,102,241,0.15) 0%, transparent 50%);animation:meshMove 15s ease-in-out infinite alternate;z-index:-1}
@keyframes meshMove{0%{transform:scale(1)}100%{transform:scale(1.1)}}
body{font-family:'Inter',sans-serif;color:var(--text);line-height:1.6;min-height:100vh}
.container{max-width:1400px;margin:0 auto;padding:24px}
header{position:sticky;top:12px;z-index:1000;padding:0 24px;margin-bottom:24px}
.header-glass{background:rgba(255,255,255,0.03);backdrop-filter:blur(20px);border:1px solid var(--border);border-radius:20px;padding:16px 32px;display:flex;justify-content:space-between;align-items:center}
.logo{display:flex;align-items:center;gap:12px;text-decoration:none;color:var(--text);font-weight:800;font-size:18px}
nav{display:flex;gap:20px;align-items:center}
nav a{color:var(--text-dim);text-decoration:none;font-size:14px;font-weight:600;padding:8px 16px;border-radius:8px;transition:all 0.3s}
nav a:hover,nav a.active{color:var(--text);background:var(--surface)}
.page-title{font-size:32px;font-weight:800;margin-bottom:8px}
.page-subtitle{color:var(--text-dim);font-size:14px;margin-bottom:32px}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;margin-bottom:32px}
.stat-card{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:16px;padding:24px;transition:all 0.3s;cursor:pointer}
.stat-card:hover{border-color:var(--accent);transform:translateY(-2px)}
.stat-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.stat-value{font-size:36px;font-weight:800;color:var(--text)}
.stat-label{font-size:13px;color:var(--text-dim);text-transform:uppercase;letter-spacing:0.5px}
.stat-change{font-size:12px;color:#10b981;font-weight:600}
.card{background:var(--glass);backdrop-filter:blur(10px);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:20px}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.card-title{font-size:18px;font-weight:700;color:var(--text)}
.charts-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:32px}
.chart-container{position:relative;height:300px}
table{width:100%;border-collapse:collapse}
thead{background:var(--surface);border-bottom:2px solid var(--border)}
th{padding:12px 16px;text-align:left;font-size:12px;font-weight:700;color:var(--text-dim);text-transform:uppercase}
td{padding:12px 16px;border-bottom:1px solid var(--border);font-size:14px;color:var(--text)}
tbody tr{transition:all 0.2s}
tbody tr:hover{background:var(--surface)}
.badge{display:inline-flex;align-items:center;padding:4px 12px;border-radius:999px;font-size:11px;font-weight:700}
.badge.draft{background:rgba(148,163,184,0.2);color:#94a3b8}
.badge.cab-review{background:rgba(251,146,60,0.2);color:#fb923c}
.badge.implementation{background:rgba(59,130,246,0.2);color:#60a5fa}
.badge.closed{background:rgba(100,116,139,0.2);color:#64748b}
.badge.high{background:rgba(239,68,68,0.2);color:#f87171}
.badge.critical{background:rgba(220,38,38,0.3);color:#dc2626}
.badge.medium{background:rgba(251,146,60,0.2);color:#fb923c}
.badge.low{background:rgba(16,185,129,0.2);color:#10b981}
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;background:linear-gradient(135deg,var(--accent),var(--accent-bright));color:#000;border:none;border-radius:10px;font-size:14px;font-weight:700;cursor:pointer;transition:all 0.3s;text-decoration:none}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px var(--accent-glow)}
.btn-secondary{background:var(--surface);border:1px solid var(--border);color:var(--text)}
.btn-sm{padding:6px 12px;font-size:12px}
.workflow-progress{display:flex;justify-content:space-between;margin:32px 0;position:relative}
.workflow-progress::before{content:'';position:absolute;top:20px;left:0;right:0;height:2px;background:var(--border);z-index:0}
.workflow-step{display:flex;flex-direction:column;align-items:center;position:relative;z-index:1}
.workflow-circle{width:40px;height:40px;border-radius:50%;background:var(--surface);border:2px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:18px;margin-bottom:8px;transition:all 0.3s}
.workflow-step.active .workflow-circle{background:var(--accent);border-color:var(--accent);box-shadow:0 0 0 4px var(--accent-dim)}
.workflow-step.completed .workflow-circle{background:var(--accent);border-color:var(--accent)}
.workflow-label{font-size:11px;color:var(--text-dim);text-align:center;max-width:80px}
.empty-state{text-align:center;padding:60px 20px;color:var(--text-dim)}
.loading{display:flex;justify-content:center;padding:40px}
.spinner{width:40px;height:40px;border:4px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);backdrop-filter:blur(8px);z-index:2000;padding:24px;overflow-y:auto}
.modal.active{display:flex;align-items:center;justify-content:center}
.modal-content{background:rgba(15,23,42,0.95);border:1px solid var(--border);border-radius:20px;max-width:700px;width:100%;max-height:90vh;overflow-y:auto}
.modal-header{padding:24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-header h2{font-size:22px;font-weight:800}
.modal-body{padding:24px}
.modal-footer{padding:24px;border-top:1px solid var(--border);display:flex;gap:12px;justify-content:flex-end}
.close-modal{background:none;border:none;color:var(--text-dim);font-size:24px;cursor:pointer;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:8px;transition:all 0.3s}
.close-modal:hover{background:var(--surface);color:var(--text)}
.form-group{margin-bottom:20px}
label{display:block;font-size:12px;color:var(--text-dim);margin-bottom:8px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
input[type="text"],input[type="date"],input[type="password"],textarea,select{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:12px;background:var(--surface);color:#fff;font-size:14px;font-family:inherit;transition:all 0.3s}
textarea{min-height:100px;resize:vertical}
input:focus,textarea:focus,select:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-dim)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.toast{position:fixed;bottom:24px;right:24px;background:var(--accent);color:#000;padding:16px 24px;border-radius:12px;font-weight:600;box-shadow:0 8px 24px rgba(0,0,0,0.3);z-index:3000;transform:translateY(100px);opacity:0;transition:all 0.3s}
.toast.show{transform:translateY(0);opacity:1}
.toast.error{background:#ef4444;color:#fff}
@media(max-width:768px){.charts-grid{grid-template-columns:1fr}.workflow-progress{flex-wrap:wrap;gap:20px}}
</style>
</head>
<body>

<header>
<div class="header-glass">
<a href="change-management.html" class="logo">üìä Change Control Dashboard</a>
<nav>
<a href="change-management.html" class="active">Dashboard</a>
<a href="#" onclick="showPage('changes')">Change Requests</a>
<a href="#">Reports</a>
<a href="#">Settings</a>
<span style="color:var(--border);margin:0 8px">|</span>
<a href="index.html" style="display:flex;align-items:center;gap:6px">
<span style="font-size:16px">üè†</span>
<span>Home</span>
</a>
</nav>
</div>
</header>


<div class="container">
<h1 class="page-title">Change Control Dashboard</h1>
<p class="page-subtitle">Monitor and manage change requests across your organization</p>

<div class="stats-grid">
<div class="stat-card" onclick="filterByStatus('all')">
<div class="stat-header">
<span class="stat-label">Total Changes</span>
<span style="font-size:24px">üìä</span>
</div>
<div class="stat-value" id="totalChanges">0</div>
<div class="stat-change">All time</div>
</div>

<div class="stat-card" onclick="filterByStatus('active')">
<div class="stat-header">
<span class="stat-label">Active Changes</span>
<span style="font-size:24px">üîÑ</span>
</div>
<div class="stat-value" id="activeChanges">0</div>
<div class="stat-change">In progress</div>
</div>

<div class="stat-card" onclick="filterByStatus('pending')">
<div class="stat-header">
<span class="stat-label">Pending Approval</span>
<span style="font-size:24px">‚è≥</span>
</div>
<div class="stat-value" id="pendingChanges">0</div>
<div class="stat-change">Awaiting CAB review</div>
</div>

<div class="stat-card" onclick="filterByStatus('completed')">
<div class="stat-header">
<span class="stat-label">Completed This Month</span>
<span style="font-size:24px">‚úÖ</span>
</div>
<div class="stat-value" id="completedChanges">0</div>
<div class="stat-change">+12% from last month</div>
</div>
</div>

<div class="charts-grid">
<div class="card">
<div class="card-header">
<h3 class="card-title">Changes by Status</h3>
</div>
<div class="chart-container">
<canvas id="statusChart"></canvas>
</div>
</div>

<div class="card">
<div class="card-header">
<h3 class="card-title">Changes by Priority</h3>
</div>
<div class="chart-container">
<canvas id="priorityChart"></canvas>
</div>
</div>
</div>

<div class="card">
<div class="card-header">
<h3 class="card-title">Recent Change Requests</h3>
<button class="btn btn-sm" onclick="openNewChangeModal()">+ New Change Request</button>
</div>
<div id="loadingState" class="loading" style="display:none"><div class="spinner"></div></div>
<div id="changesContainer"></div>
</div>
</div>

<!-- New Change Modal -->
<div id="newChangeModal" class="modal">
<div class="modal-content">
<div class="modal-header">
<h2>New Change Request</h2>
<button class="close-modal" onclick="closeModal('newChangeModal')">√ó</button>
</div>
<form id="newChangeForm">
<div class="modal-body">
<div class="form-group">
<label>Change Title *</label>
<input type="text" id="changeTitle" required>
</div>
<div class="form-group">
<label>Description *</label>
<textarea id="changeDescription" required></textarea>
</div>
<div class="form-row">
<div class="form-group">
<label>Type *</label>
<select id="changeType" required>
<option value="">Select...</option>
<option value="Normal">Normal</option>
<option value="Emergency">Emergency</option>
<option value="Temporary">Temporary</option>
<option value="Planned">Planned</option>
</select>
</div>
<div class="form-group">
<label>Category *</label>
<select id="changeCategory" required>
<option value="">Select...</option>
<option value="Process Change">Process</option>
<option value="Equipment Change">Equipment</option>
<option value="Document Change">Document</option>
<option value="System Change">System</option>
</select>
</div>
</div>
<div class="form-row">
<div class="form-group">
<label>Department *</label>
<select id="changeDepartment" required>
<option value="">Select...</option>
<option value="Quality Assurance">Quality Assurance</option>
<option value="Production">Production</option>
<option value="Engineering">Engineering</option>
<option value="Regulatory">Regulatory</option>
</select>
</div>
<div class="form-group">
<label>Priority</label>
<select id="changePriority">
<option value="Medium">Medium</option>
<option value="Low">Low</option>
<option value="High">High</option>
<option value="Critical">Critical</option>
</select>
</div>
</div>
<div class="form-group">
<label>Justification *</label>
<textarea id="justification" required></textarea>
</div>
<div class="form-group">
<label>Proposed Date</label>
<input type="date" id="proposedDate">
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" onclick="closeModal('newChangeModal')">Cancel</button>
<button type="submit" class="btn">Create Change Request</button>
</div>
</form>
</div>
</div>

<div id="toast" class="toast"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
const SUPABASE_URL='https://nufpaayytxtjihqrvtfi.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51ZnBhYXl5dHh0amlocXJ2dGZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMzA5NjIsImV4cCI6MjA3NTkwNjk2Mn0.766ENc3lMQSVJIsyxK6xlPE5DNlB3Np3eeXxvcoRGGY';
const {createClient}=supabase;
const sb=createClient(SUPABASE_URL,SUPABASE_KEY);
let currentUser=null;
let statusChart,priorityChart;

(async function checkAuth(){
const {data:{session}}=await sb.auth.getSession();
if(!session){window.location.href='login.html';return}
currentUser=session.user;
loadDashboard();
})();

async function loadDashboard(){
showLoading();
try{
const {data:changes,error}=await sb.from('change_requests').select('*').order('created_at',{ascending:false});
if(error)throw error;

document.getElementById('totalChanges').textContent=changes.length;
document.getElementById('activeChanges').textContent=changes.filter(c=>c.workflow_stage&&!['Draft','Closed','Rejected'].includes(c.workflow_stage)).length;
document.getElementById('pendingChanges').textContent=changes.filter(c=>c.workflow_stage==='CAB Review').length;
const thisMonth=changes.filter(c=>c.workflow_stage==='Closed'&&new Date(c.closed_at).getMonth()===new Date().getMonth()).length;
document.getElementById('completedChanges').textContent=thisMonth;

renderCharts(changes);
renderRecentChanges(changes.slice(0,5));
hideLoading();
}catch(error){
console.error('Error:',error);
showToast('Error loading dashboard','error');
hideLoading();
}
}

function renderCharts(changes){
const statusCounts={};
changes.forEach(c=>{
const stage=c.workflow_stage||'Draft';
statusCounts[stage]=(statusCounts[stage]||0)+1;
});

const priorityCounts={Low:0,Medium:0,High:0,Critical:0};
changes.forEach(c=>{priorityCounts[c.priority||'Medium']++});

const statusCtx=document.getElementById('statusChart').getContext('2d');
if(statusChart)statusChart.destroy();
statusChart=new Chart(statusCtx,{
type:'bar',
data:{
labels:Object.keys(statusCounts),
datasets:[{
label:'Changes',
data:Object.values(statusCounts),
backgroundColor:'rgba(16,185,129,0.8)',
borderColor:'#10b981',
borderWidth:1
}]
},
options:{
responsive:true,
maintainAspectRatio:false,
plugins:{legend:{display:false}},
scales:{y:{beginAtZero:true,ticks:{color:'#94a3b8'}},x:{ticks:{color:'#94a3b8'}}}
}
});

const priorityCtx=document.getElementById('priorityChart').getContext('2d');
if(priorityChart)priorityChart.destroy();
priorityChart=new Chart(priorityCtx,{
type:'doughnut',
data:{
labels:['Low','Medium','High','Critical'],
datasets:[{
data:[priorityCounts.Low,priorityCounts.Medium,priorityCounts.High,priorityCounts.Critical],
backgroundColor:['#10b981','#fb923c','#ef4444','#dc2626'],
borderWidth:0
}]
},
options:{
responsive:true,
maintainAspectRatio:false,
plugins:{legend:{position:'right',labels:{color:'#94a3b8'}}}
}
});
}

function renderRecentChanges(changes){
const container=document.getElementById('changesContainer');
if(changes.length===0){
container.innerHTML='<div class="empty-state">No changes found</div>';
return;
}
let html='<table><thead><tr><th>ID</th><th>Title</th><th>Status</th><th>Priority</th><th>Initiator</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
changes.forEach(c=>{
const statusBadge=c.workflow_stage?.toLowerCase().replace(/\s+/g,'-')||'draft';
html+=`<tr>
<td><strong>${c.change_number||'PENDING'}</strong></td>
<td>${c.title}</td>
<td><span class="badge ${statusBadge}">${c.workflow_stage||'Draft'}</span></td>
<td><span class="badge ${(c.priority||'medium').toLowerCase()}">${c.priority||'Medium'}</span></td>
<td>${c.initiator_name||'Unknown'}</td>
<td>${new Date(c.created_at).toLocaleDateString()}</td>
<td><button class="btn btn-sm btn-secondary" onclick="viewChange('${c.id}')">View Details</button></td>
</tr>`;
});
html+='</tbody></table>';
container.innerHTML=html;
}

document.getElementById('newChangeForm').addEventListener('submit',async(e)=>{
e.preventDefault();
const formData={
title:document.getElementById('changeTitle').value,
description:document.getElementById('changeDescription').value,
change_type:document.getElementById('changeType').value,
change_category:document.getElementById('changeCategory').value,
department:document.getElementById('changeDepartment').value,
priority:document.getElementById('changePriority').value,
justification:document.getElementById('justification').value,
proposed_implementation_date:document.getElementById('proposedDate').value||null,
initiator_id:currentUser.id,
initiator_name:currentUser.email.split('@')[0],
workflow_stage:'Draft',
status:'Draft',
created_by:currentUser.id
};
try{
const {data,error}=await sb.from('change_requests').insert([formData]).select().single();
if(error)throw error;
showToast('Change request created!','success');
closeModal('newChangeModal');
document.getElementById('newChangeForm').reset();
loadDashboard();
}catch(error){
console.error('Error:',error);
showToast('Error: '+error.message,'error');
}
});

function viewChange(id){
  window.location.href=`change-details.html?id=${id}`;
}



function openNewChangeModal(){
document.getElementById('newChangeModal').classList.add('active');
}

function closeModal(id){
document.getElementById(id).classList.remove('active');
}

function showLoading(){
document.getElementById('loadingState').style.display='flex';
document.getElementById('changesContainer').style.display='none';
}

function hideLoading(){
document.getElementById('loadingState').style.display='none';
document.getElementById('changesContainer').style.display='';
}

function showToast(message,type='success'){
const toast=document.getElementById('toast');
toast.textContent=message;
toast.className=`toast ${type} show`;
setTimeout(()=>toast.classList.remove('show'),3000);
}

function filterByStatus(status){
showToast('Filter: '+status,'success');
}

document.querySelectorAll('.modal').forEach(modal=>{
modal.addEventListener('click',(e)=>{
if(e.target===modal)modal.classList.remove('active');
});
});
</script>
</body>
</html>
