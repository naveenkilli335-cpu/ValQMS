<!DOCTYPE html>
<html lang="en" data-bg="mint">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Non-Conformance Management | ValQMS</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <link rel="icon" href="valqms-logo.svg" sizes="any">
    <link rel="apple-touch-icon" sizes="180x180" href="favicon.jpg">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', Arial, sans-serif;
            background: #d1fae5;
            min-height: 100vh;
            padding: 24px;
        }


        .container {
            width: 100%;
            max-width: none;
            margin: 0;
        }

        /* Header */
        .header {
            background: #0f172a; /* match index header color */
            color: #ffffff;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-box {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #10b981, #34d399);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 20px;
        }


        .logo-text {
            font-size: 24px;
            font-weight: 700;
            color: #ffffff; /* white on dark header */
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }


        .btn-secondary {
            background: white;
            border: 2px solid #e5e7eb;
            color: #374151;
        }

        .btn-secondary:hover {
            border-color: #10b981;
            color: #10b981;
        }


        /* Dashboard Cards */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: #1e293b;
        }

        .stat-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        .badge-critical { background: #fee2e2; color: #991b1b; }
        .badge-major { background: #fef3c7; color: #92400e; }
        .badge-minor { background: #dbeafe; color: #1e40af; }

        /* Main Content */
        .content-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .tabs {
            display: flex;
            gap: 10px;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 30px;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #10b981;
            border-bottom-color: #10b981;
        }

        .tab:hover {
            color: #10b981;
        }


        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Form Styles */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-label.required::after {
            content: ' *';
            color: #ef4444;
        }

        .form-input, .form-select, .form-textarea {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #10b981;
        }


        .form-textarea {
            min-height: 100px;
            resize: vertical;
            font-family: inherit;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            background: #f9fafb;
        }

        th {
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #374151;
            border-bottom: 2px solid #e5e7eb;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        tr:hover {
            background: #f9fafb;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-open { background: #dbeafe; color: #1e40af; }
        .status-investigation { background: #fef3c7; color: #92400e; }
        .status-impact { background: #e0f2fe; color: #075985; }
        .status-action { background: #fed7aa; color: #9a3412; }
        .status-implementation { background: #f0fdf4; color: #166534; }
        .status-effectiveness { background: #e9d5ff; color: #6b21a8; }
        .status-closed { background: #d1fae5; color: #065f46; }

        /* Subtabs (modal) */
        .subtabs { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px; border-bottom: 2px solid #e5e7eb; padding-bottom: 6px; }
        .subtab { padding: 8px 14px; background:none; border:none; font-weight:600; color:#6b7280; cursor:pointer; border-bottom:3px solid transparent; transition:all .3s; }
        .subtab.active { color:#10b981; border-bottom-color:#10b981; }

    /* Inline fields utility (single-line layout) */
    .inline-fields { display:flex; gap:12px; align-items:flex-end; }
    .inline-fields .form-group { flex:1; margin-bottom:0; }

        /* Overdue badge */
        .overdue-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 9999px;
            background: #fee2e2;
            color: #991b1b;
            font-size: 11px;
            font-weight: 700;
            margin-left: 8px;
            border: 1px solid #fecaca;
        }

        /* Modal summary line */
        .nc-summary {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 10px 12px;
            color: #374151;
            margin-bottom: 12px;
            font-size: 13px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 8px;
        }
        .nc-summary .dot {
            width: 6px; height: 6px; background:#9ca3af; border-radius:50%; display:inline-block;
        }
        .nc-summary .pill { background:#eef2ff; color:#3730a3; border-radius:9999px; padding:2px 8px; font-weight:600; font-size:12px; }
        .nc-summary .overdue { background:#fee2e2; color:#991b1b; border:1px solid #fecaca; }

        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            margin-right: 5px;
        }

        .action-btn.view { background: #dbeafe; color: #1e40af; }
        .action-btn.edit { background: #fef3c7; color: #92400e; }
        .action-btn.history { background: #e9d5ff; color: #6b21a8; }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 700;
            color: #1e293b;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
        }

        /* Alert */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .alert.error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .alert.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 768px) {
            body { padding: 12px; }
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <link rel="stylesheet" href="assets/theme.css">
</head>
<body>
    <div class="container">
        

        <!-- Alert -->
        <div id="alert" class="alert"></div>

        <!-- Dashboard Stats -->
        <div class="dashboard">
            <div class="stat-card">
                <div class="stat-label">Total NCs</div>
                <div class="stat-value" id="totalNCs">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Open</div>
                <div class="stat-value" id="openNCs">0</div>
                <span class="stat-badge badge-critical">Requires Action</span>
            </div>
            <div class="stat-card">
                <div class="stat-label">Under Investigation</div>
                <div class="stat-value" id="investigationNCs">0</div>
                <span class="stat-badge badge-major">In Progress</span>
            </div>
            <div class="stat-card">
                <div class="stat-label">Closed This Month</div>
                <div class="stat-value" id="closedNCs">0</div>
                <span class="stat-badge badge-minor">Completed</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="content-card">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('list')">NC List</button>
                <button class="tab" onclick="switchTab('analytics')">Analytics</button>
                <button class="tab" onclick="switchTab('reports')">Reports</button>
            </div>

            <!-- NC List Tab -->
            <div id="listTab" class="tab-content active">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
                    <h3>Non-Conformance Register</h3>
                    <button class="btn btn-primary" onclick="openNewNCModal()">+ New NC Report</button>
                </div>
                <div class="table-container">
                    <table id="ncTable">
                        <thead>
                            <tr>
                                <th>NC Number</th>
                                <th>Title</th>
                                <th>Source</th>
                                <th>Severity</th>
                                <th>Status</th>
                                <th>Initiated Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ncTableBody">
                            <tr>
                                <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                                    Loading non-conformances...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="analyticsTab" class="tab-content">
                <h3>Analytics Dashboard</h3>
                <p style="color:#6b7280;margin-bottom:16px">Trends by status and severity</p>
                <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px">
                    <div class="content-card" style="padding:16px">
                        <div style="font-weight:700;margin-bottom:8px">By Status</div>
                        <canvas id="ncChartByStatus" height="220"></canvas>
                    </div>
                    <div class="content-card" style="padding:16px">
                        <div style="font-weight:700;margin-bottom:8px">By Severity</div>
                        <canvas id="ncChartBySeverity" height="220"></canvas>
                    </div>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reportsTab" class="tab-content">
                <h3>Reports</h3>
                <p style="color:#6b7280">Generate and download reports.</p>
                <div style="display:flex;gap:10px;margin:16px 0 24px">
                    <button class="btn btn-primary" onclick="exportNCsCSV()">Export NC Register (CSV)</button>
                    <button class="btn btn-secondary" onclick="exportNCSummaryCSV()">Export Summary (CSV)</button>
                </div>
                <div class="info-box">
                    <h4>Summary</h4>
                    <p id="ncReportsSummaryText" style="margin:6px 0 0"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- View/Edit NC Modal -->
    <div id="ncEditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">View / Edit Non-Conformance</h2>
                <button class="close-btn" onclick="closeNcEditModal()">&times;</button>
            </div>
            <form id="ncEditForm">
                <input type="hidden" id="editNcId">
                <!-- Summary line for quick context -->
                <div id="ncSummaryLine" class="nc-summary" aria-live="polite"></div>
                <div class="subtabs">
                    <button type="button" class="subtab" id="editTab-details" onclick="switchEditTab('details')">Details</button>
                    <button type="button" class="subtab" id="editTab-investigation" onclick="switchEditTab('investigation')">Investigation</button>
                    <button type="button" class="subtab" id="editTab-impact" onclick="switchEditTab('impact')">Impact Assessment</button>
                    <button type="button" class="subtab" id="editTab-rootcause" onclick="switchEditTab('rootcause')">Root Cause</button>
                    <button type="button" class="subtab" id="editTab-actionplan" onclick="switchEditTab('actionplan')">Action Plan</button>
                    <button type="button" class="subtab" id="editTab-implementation" onclick="switchEditTab('implementation')">Implementation</button>
                    <button type="button" class="subtab" id="editTab-effectiveness" onclick="switchEditTab('effectiveness')">Effectiveness/Closure</button>
                </div>

                <!-- Details -->
                <div class="form-grid editpane" id="editPane-details">
                    <div class="form-group">
                        <label class="form-label">NC Number</label>
                        <input id="editNcNumber" class="form-input" disabled>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Title</label>
                        <input id="editTitle" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Source</label>
                        <select id="editSource" class="form-select" required>
                            <option value="">Select Source</option>
                            <option>Production</option>
                            <option>Quality Control</option>
                            <option>Customer Complaint</option>
                            <option>Internal Audit</option>
                            <option>Regulatory Inspection</option>
                            <option>Supplier</option>
                            <option>Environmental Monitoring</option>
                            <option>Equipment</option>
                            <option>Documentation</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Severity</label>
                        <select id="editSeverity" class="form-select" required>
                            <option>Critical</option>
                            <option>Major</option>
                            <option>Minor</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Department</label>
                        <select id="editDepartment" class="form-select" required>
                            <option value="">Select Department</option>
                            <option>Manufacturing</option>
                            <option>Quality Assurance</option>
                            <option>Quality Control</option>
                            <option>Warehouse</option>
                            <option>Engineering</option>
                            <option>R&D</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Affected Product</label>
                        <input id="editAffectedProduct" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Affected Batch</label>
                        <input id="editAffectedBatch" class="form-input">
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label required">Description</label>
                        <textarea id="editDescription" class="form-textarea" required></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Status</label>
                        <select id="editStatus" class="form-select" required>
                            <option>Open</option>
                            <option>Under Investigation</option>
                            <option>Impact Assessment</option>
                            <option>Action Plan</option>
                            <option>Implementation</option>
                            <option>Effectiveness Check</option>
                            <option>Closed</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label required">Target Closure Date</label>
                        <input type="date" id="editTargetClosureDate" class="form-input" required>
                    </div>
                </div>

                <!-- Investigation -->
                <div class="form-grid editpane" id="editPane-investigation" style="display:none">
                    <div class="form-group">
                        <label class="form-label">Investigator</label>
                        <input id="editInvestigator" class="form-input" placeholder="Assigned investigator">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Investigation Start Date</label>
                        <input type="date" id="editInvestigationStart" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Analysis Method</label>
                        <select id="editInvestigationMethod" class="form-select">
                            <option value="">Select Method</option>
                            <option>5-Whys</option>
                            <option>Fishbone (Ishikawa)</option>
                            <option>FMEA</option>
                            <option>Fault Tree Analysis</option>
                            <option>Pareto Analysis</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Investigation Summary</label>
                        <textarea id="editInvestigationSummary" class="form-textarea" placeholder="What happened? What data was reviewed?"></textarea>
                    </div>
                </div>

                <!-- Impact Assessment -->
                <div class="form-grid editpane" id="editPane-impact" style="display:none">
                    <div class="form-group">
                        <label class="form-label">Impact Area</label>
                        <select id="editImpactArea" class="form-select">
                            <option value="">Select Impact Area</option>
                            <option>Product</option>
                            <option>Process</option>
                            <option>Patient/Customer</option>
                            <option>Regulatory</option>
                            <option>Data Integrity</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Risk Rating</label>
                        <select id="editRiskRating" class="form-select">
                            <option value="">Select Risk</option>
                            <option>High</option>
                            <option>Medium</option>
                            <option>Low</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Impact Assessment</label>
                        <textarea id="editImpactAssessment" class="form-textarea" placeholder="Scope, batches affected, regulatory/customer impact"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Immediate Containment</label>
                        <textarea id="editContainmentActions" class="form-textarea" placeholder="Containment performed to stop further impact"></textarea>
                    </div>
                </div>

                <!-- Root Cause -->
                <div class="form-grid editpane" id="editPane-rootcause" style="display:none">
                    <div class="form-group">
                        <label class="form-label">Analysis Method</label>
                        <select id="editAnalysisMethod" class="form-select">
                            <option value="">Select Method</option>
                            <option>5-Whys</option>
                            <option>Fishbone (Ishikawa)</option>
                            <option>FMEA</option>
                            <option>Other</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Root Cause</label>
                        <textarea id="editRootCause" class="form-textarea" placeholder="Primary root cause identified"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Contributing Factors</label>
                        <textarea id="editContributingFactors" class="form-textarea" placeholder="List contributing/secondary causes"></textarea>
                    </div>
                </div>

                <!-- Action Plan -->
                <div class="form-grid editpane" id="editPane-actionplan" style="display:none">
                    <div class="form-group full-width">
                        <label class="form-label">Corrective Actions</label>
                        <textarea id="editCorrectiveActions" class="form-textarea" placeholder="Steps to correct the non-conformance"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Preventive Actions</label>
                        <textarea id="editPreventiveActions" class="form-textarea" placeholder="Steps to prevent recurrence"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Action Owner</label>
                        <input id="editActionOwner" class="form-input" placeholder="Responsible person/team">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Action Due Date</label>
                        <input type="date" id="editActionDueDate" class="form-input">
                    </div>
                </div>

                <!-- Implementation -->
                <div class="form-grid editpane" id="editPane-implementation" style="display:none">
                    <div class="form-group full-width">
                        <label class="form-label">Implementation Notes</label>
                        <textarea id="editImplementationNotes" class="form-textarea" placeholder="What was implemented and how"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Implemented By</label>
                        <input id="editImplementedBy" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Implementation Date</label>
                        <input type="date" id="editImplementationDate" class="form-input">
                    </div>
                </div>

                <!-- Effectiveness / Closure (single line layout for key fields) -->
                <div class="form-grid editpane" id="editPane-effectiveness" style="display:none">
                    <div class="inline-fields full-width">
                        <div class="form-group">
                            <label class="form-label">Effectiveness Result</label>
                            <select id="editEffectivenessResult" class="form-select">
                                <option value="">Select</option>
                                <option>Pass</option>
                                <option>Fail</option>
                                <option>Pending</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Closed By</label>
                            <input id="editClosedBy" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Closed Date</label>
                            <input type="date" id="editClosedDate" class="form-input">
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Effectiveness Notes</label>
                        <textarea id="editEffectivenessNotes" class="form-textarea"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label class="form-label">Closure Remarks</label>
                        <textarea id="editClosureRemarks" class="form-textarea" placeholder="Final approval comments"></textarea>
                    </div>
                </div>

                <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:10px">
                    <button type="button" class="btn btn-secondary" onclick="previousStage()">◀ Previous Stage</button>
                    <button type="button" class="btn btn-secondary" onclick="nextStage()">Next Stage ▶</button>
                    <button type="button" class="btn btn-secondary" onclick="closeNcEditModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    <!-- New/Edit NC Modal -->
    <div id="ncModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">New Non-Conformance Report</h2>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            
            <form id="ncForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label required">Title</label>
                        <input type="text" class="form-input" id="title" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label required">Source</label>
                        <select class="form-select" id="source" required>
                            <option value="">Select Source</option>
                            <option value="Production">Production</option>
                            <option value="Quality Control">Quality Control</option>
                            <option value="Customer Complaint">Customer Complaint</option>
                            <option value="Internal Audit">Internal Audit</option>
                            <option value="Regulatory Inspection">Regulatory Inspection</option>
                            <option value="Supplier">Supplier</option>
                            <option value="Environmental Monitoring">Environmental Monitoring</option>
                            <option value="Equipment">Equipment</option>
                            <option value="Documentation">Documentation</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label required">Severity</label>
                        <select class="form-select" id="severity" required>
                            <option value="">Select Severity</option>
                            <option value="Critical">Critical - Patient Safety Risk</option>
                            <option value="Major">Major - Quality Impact</option>
                            <option value="Minor">Minor - Documentation</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label required">Department</label>
                        <select class="form-select" id="department" required>
                            <option value="">Select Department</option>
                            <option value="Manufacturing">Manufacturing</option>
                            <option value="Quality Assurance">Quality Assurance</option>
                            <option value="Quality Control">Quality Control</option>
                            <option value="Warehouse">Warehouse</option>
                            <option value="Engineering">Engineering</option>
                            <option value="R&D">R&D</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Affected Product</label>
                        <input type="text" class="form-input" id="affectedProduct">
                    </div>

                    <div class="form-group">
                        <label class="form-label">Affected Batch</label>
                        <input type="text" class="form-input" id="affectedBatch">
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label required">Description</label>
                        <textarea class="form-textarea" id="description" required></textarea>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Initiated By</label>
                        <input type="text" class="form-input" id="initiatedByDisplay" disabled placeholder="Auto (current user)">
                    </div>

                    <div class="form-group">
                        <label class="form-label required">Target Closure Date</label>
                        <input type="date" class="form-input" id="targetClosureDate" required>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 30px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit NC Report</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Audit Trail Modal -->
    <div id="auditModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Audit Trail</h2>
                <button class="close-btn" onclick="closeAuditModal()">&times;</button>
            </div>
            <div id="auditContent">
                <table>
                    <thead>
                        <tr>
                            <th>Date/Time</th>
                            <th>Action</th>
                            <th>Field Changed</th>
                            <th>Changed By</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="auditTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // **REPLACE WITH YOUR SUPABASE CREDENTIALS**
        const SUPABASE_URL = 'https://nufpaayytxtjihqrvtfi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51ZnBhYXl5dHh0amlocXJ2dGZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMzA5NjIsImV4cCI6MjA3NTkwNjk2Mn0.766ENc3lMQSVJIsyxK6xlPE5DNlB3Np3eeXxvcoRGGY';
        
    const { createClient } = supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_KEY);
    let currentUserEmail = null;
    let ncsCache = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const { data: { user } } = await sb.auth.getUser();
                currentUserEmail = user?.email || user?.user_metadata?.email || user?.user_metadata?.full_name || null;
                const disp = document.getElementById('initiatedByDisplay');
                if (disp) disp.value = currentUserEmail || 'System';
            } catch (e) { console.warn('Auth not available for NC; defaulting Initiated By to System'); }
            loadDashboardStats();
            loadNCList();
            setMinDate();
        });

        function setMinDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('targetClosureDate').setAttribute('min', today);
        }

        // Load Dashboard Statistics
        async function loadDashboardStats() {
            try {
                const { data, error } = await sb
                    .from('non_conformances')
                    .select('status, initiated_date');

                if (error) throw error;

                const total = data.length;
                const open = data.filter(nc => nc.status === 'Open').length;
                const investigation = data.filter(nc => nc.status === 'Under Investigation').length;
                
                const currentMonth = new Date().getMonth();
                const closedThisMonth = data.filter(nc => {
                    if (nc.status === 'Closed' && nc.initiated_date) {
                        const ncMonth = new Date(nc.initiated_date).getMonth();
                        return ncMonth === currentMonth;
                    }
                    return false;
                }).length;

                document.getElementById('totalNCs').textContent = total;
                document.getElementById('openNCs').textContent = open;
                document.getElementById('investigationNCs').textContent = investigation;
                document.getElementById('closedNCs').textContent = closedThisMonth;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load NC List
        async function loadNCList() {
            try {
                const { data, error } = await sb
                    .from('non_conformances')
                    .select('*')
                    .order('initiated_date', { ascending: false });

                if (error) throw error;

                const tbody = document.getElementById('ncTableBody');
                
                if (data.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" style="text-align: center; padding: 40px; color: #6b7280;">
                                No non-conformances found. Click "New NC Report" to create one.
                            </td>
                        </tr>
                    `;
                    return;
                }

                ncsCache = data;
                tbody.innerHTML = data.map(nc => {
                    const overdue = isNcOverdue(nc) ? '<span class="overdue-badge">Overdue</span>' : '';
                    const initiated = nc.initiated_date ? new Date(nc.initiated_date).toLocaleDateString() : '-';
                    return `
                    <tr>
                        <td><strong>${nc.nc_number}</strong></td>
                        <td>${nc.title || ''}</td>
                        <td>${nc.source || ''}</td>
                        <td><span class="stat-badge badge-${(nc.severity||'Minor').toLowerCase()}">${nc.severity || ''}</span></td>
                        <td><span class="status-badge status-${getStatusClass(nc.status)}">${nc.status || 'Open'}</span> ${overdue}</td>
                        <td>${initiated}</td>
                        <td>
                            <button class="action-btn view" onclick="viewNC('${nc.id}')">View</button>
                            <button class="action-btn history" onclick="viewAuditTrail('${nc.id}')">History</button>
                        </td>
                    </tr>`;
                }).join('');
            } catch (error) {
                console.error('Error loading NC list:', error);
                showAlert('Error loading non-conformances', 'error');
            }
        }

        // Helper: determine if an NC is overdue (target date passed and not Closed)
        function isNcOverdue(nc){
            try{
                if (!nc || !nc.target_closure_date) return false;
                if ((nc.status||'') === 'Closed') return false;
                const today = new Date(); today.setHours(0,0,0,0);
                const due = new Date(nc.target_closure_date); due.setHours(0,0,0,0);
                return due < today;
            }catch{ return false; }
        }

        function getStatusClass(status) {
            const map = {
                'Open': 'open',
                'Under Investigation': 'investigation',
                'Impact Assessment': 'impact',
                'Action Plan': 'action',
                'Implementation': 'implementation',
                'Action Pending': 'action',
                'Effectiveness Check': 'effectiveness',
                'Closed': 'closed'
            };
            return map[status] || 'open';
        }

        // Generate NC Number
        async function generateNCNumber() {
            const year = new Date().getFullYear();
            const { data, error } = await sb
                .from('non_conformances')
                .select('nc_number')
                .like('nc_number', `NC-${year}-%`)
                .order('nc_number', { ascending: false })
                .limit(1);

            if (error) {
                console.error('Error generating NC number:', error);
                return `NC-${year}-0001`;
            }

            if (data.length === 0) {
                return `NC-${year}-0001`;
            }

            const lastNumber = parseInt(data[0].nc_number.split('-')[2]);
            const newNumber = (lastNumber + 1).toString().padStart(4, '0');
            return `NC-${year}-${newNumber}`;
        }

        // Open New NC Modal
        function openNewNCModal() {
            document.getElementById('ncModal').classList.add('active');
            document.getElementById('modalTitle').textContent = 'New Non-Conformance Report';
            document.getElementById('ncForm').reset();
            const disp = document.getElementById('initiatedByDisplay');
            if (disp) disp.value = currentUserEmail || 'System';
        }

        function closeModal() {
            document.getElementById('ncModal').classList.remove('active');
        }

        // Submit NC Form
        document.getElementById('ncForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            try {
                const ncNumber = await generateNCNumber();
                const formData = {
                    nc_number: ncNumber,
                    title: document.getElementById('title').value,
                    description: document.getElementById('description').value,
                    source: document.getElementById('source').value,
                    severity: document.getElementById('severity').value,
                    department: document.getElementById('department').value,
                    affected_product: document.getElementById('affectedProduct').value,
                    affected_batch: document.getElementById('affectedBatch').value,
                    initiated_by: currentUserEmail || 'System',
                    target_closure_date: document.getElementById('targetClosureDate').value,
                    status: 'Open'
                };

                const { data, error } = await sb
                    .from('non_conformances')
                    .insert([formData])
                    .select();

                if (error) throw error;

                // Create audit trail entry
                await createAuditEntry(data[0].id, 'NC Created', null, null, null, formData.initiated_by, 'Initial NC report created');

                showAlert('Non-conformance created successfully!', 'success');
                closeModal();
                loadDashboardStats();
                loadNCList();
            } catch (error) {
                console.error('Error creating NC:', error);
                showAlert(`Error creating non-conformance: ${error.message || error}`, 'error');
            }
        });

        // Create Audit Trail Entry
        async function createAuditEntry(ncId, action, fieldChanged, oldValue, newValue, changedBy, comments) {
            try {
                await sb
                    .from('audit_trail')
                    .insert([{
                        nc_id: ncId,
                        action: action,
                        field_changed: fieldChanged,
                        old_value: oldValue,
                        new_value: newValue,
                        changed_by: changedBy,
                        comments: comments,
                        changed_at: new Date().toISOString()
                    }]);
            } catch (error) {
                console.error('Error creating audit entry:', error);
            }
        }

        // View Audit Trail
        async function viewAuditTrail(ncId) {
            try {
                const { data, error } = await sb
                    .from('audit_trail')
                    .select('*')
                    .eq('nc_id', ncId)
                    .order('changed_at', { ascending: false });

                if (error) throw error;

                const tbody = document.getElementById('auditTableBody');
                tbody.innerHTML = data.map(entry => `
                    <tr>
                        <td>${new Date(entry.changed_at).toLocaleString()}</td>
                        <td>${entry.action}</td>
                        <td>${entry.field_changed || '-'}</td>
                        <td>${entry.changed_by}</td>
                        <td>${entry.comments || ''}</td>
                    </tr>
                `).join('');

                document.getElementById('auditModal').classList.add('active');
            } catch (error) {
                console.error('Error loading audit trail:', error);
                showAlert('Error loading audit trail', 'error');
            }
        }

        function closeAuditModal() {
            document.getElementById('auditModal').classList.remove('active');
        }

        // View/Edit NC Modal
        async function viewNC(id) {
            try {
                const { data, error } = await sb.from('non_conformances').select('*').eq('id', id).single();
                if (error) throw error;
                document.getElementById('editNcId').value = data.id;
                document.getElementById('editNcNumber').value = data.nc_number || '';
                document.getElementById('editTitle').value = data.title || '';
                document.getElementById('editSource').value = data.source || '';
                document.getElementById('editSeverity').value = data.severity || 'Minor';
                document.getElementById('editDepartment').value = data.department || '';
                document.getElementById('editAffectedProduct').value = data.affected_product || '';
                document.getElementById('editAffectedBatch').value = data.affected_batch || '';
                document.getElementById('editDescription').value = data.description || '';
                document.getElementById('editStatus').value = data.status || 'Open';
                document.getElementById('editTargetClosureDate').value = data.target_closure_date ? new Date(data.target_closure_date).toISOString().split('T')[0] : '';
                // Extended workflow fields
                const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v || ''; };
                const setDate = (id, v) => { const el = document.getElementById(id); if (el) el.value = v ? new Date(v).toISOString().split('T')[0] : ''; };
                setVal('editInvestigator', data.investigator);
                setDate('editInvestigationStart', data.investigation_start);
                setVal('editInvestigationSummary', data.investigation_summary);
                setVal('editInvestigationMethod', data.investigation_method);
                setVal('editImpactArea', data.impact_area);
                setVal('editRiskRating', data.risk_rating);
                setVal('editImpactAssessment', data.impact_assessment);
                setVal('editContainmentActions', data.containment_actions);
                setVal('editAnalysisMethod', data.analysis_method);
                setVal('editRootCause', data.root_cause);
                setVal('editContributingFactors', data.contributing_factors);
                setVal('editCorrectiveActions', data.corrective_actions);
                setVal('editPreventiveActions', data.preventive_actions);
                setVal('editActionOwner', data.action_owner);
                setDate('editActionDueDate', data.action_due_date);
                setVal('editImplementationNotes', data.implementation_notes);
                setVal('editImplementedBy', data.implemented_by);
                setDate('editImplementationDate', data.implementation_date);
                setVal('editEffectivenessResult', data.effectiveness_result);
                setVal('editEffectivenessNotes', data.effectiveness_notes);
                setVal('editClosureRemarks', data.closure_remarks);
                setVal('editClosedBy', data.closed_by);
                setDate('editClosedDate', data.closed_date);
                // Update modal summary line
                updateNcSummary({
                    severity: data.severity,
                    department: data.department,
                    status: data.status,
                    target_closure_date: data.target_closure_date
                });
                document.getElementById('ncEditModal').classList.add('active');
                if (typeof switchEditTab === 'function') switchEditTab('details');
            } catch (e) {
                console.error('Error loading NC', e);
                showAlert('Error loading NC details','error');
            }
        }

        function closeNcEditModal(){ document.getElementById('ncEditModal').classList.remove('active'); }

        // Save edit with diff-based audit trail
        document.getElementById('ncEditForm').addEventListener('submit', async (e)=>{
            e.preventDefault();
            const id = document.getElementById('editNcId').value;
            const payload = collectEditPayload();
            try{
                await updateNC(id, payload, 'NC fields updated');
                showAlert('NC updated','success');
                closeNcEditModal();
                loadDashboardStats();
                loadNCList();
            }catch(err){
                console.error(err);
                showAlert(`Failed to update NC: ${err.message || err}`,'error');
            }
        });

        function collectEditPayload(){
            return {
                title: document.getElementById('editTitle').value,
                source: document.getElementById('editSource').value,
                severity: document.getElementById('editSeverity').value,
                department: document.getElementById('editDepartment').value,
                affected_product: document.getElementById('editAffectedProduct').value,
                affected_batch: document.getElementById('editAffectedBatch').value,
                description: document.getElementById('editDescription').value,
                status: document.getElementById('editStatus').value,
                target_closure_date: document.getElementById('editTargetClosureDate').value || null,
                investigator: (document.getElementById('editInvestigator')||{}).value || null,
                investigation_start: (document.getElementById('editInvestigationStart')||{}).value || null,
                investigation_summary: (document.getElementById('editInvestigationSummary')||{}).value || null,
                investigation_method: (document.getElementById('editInvestigationMethod')||{}).value || null,
                impact_area: (document.getElementById('editImpactArea')||{}).value || null,
                risk_rating: (document.getElementById('editRiskRating')||{}).value || null,
                impact_assessment: (document.getElementById('editImpactAssessment')||{}).value || null,
                containment_actions: (document.getElementById('editContainmentActions')||{}).value || null,
                analysis_method: (document.getElementById('editAnalysisMethod')||{}).value || null,
                root_cause: (document.getElementById('editRootCause')||{}).value || null,
                contributing_factors: (document.getElementById('editContributingFactors')||{}).value || null,
                corrective_actions: (document.getElementById('editCorrectiveActions')||{}).value || null,
                preventive_actions: (document.getElementById('editPreventiveActions')||{}).value || null,
                action_owner: (document.getElementById('editActionOwner')||{}).value || null,
                action_due_date: (document.getElementById('editActionDueDate')||{}).value || null,
                implementation_notes: (document.getElementById('editImplementationNotes')||{}).value || null,
                implemented_by: (document.getElementById('editImplementedBy')||{}).value || null,
                implementation_date: (document.getElementById('editImplementationDate')||{}).value || null,
                effectiveness_result: (document.getElementById('editEffectivenessResult')||{}).value || null,
                effectiveness_notes: (document.getElementById('editEffectivenessNotes')||{}).value || null,
                closure_remarks: (document.getElementById('editClosureRemarks')||{}).value || null,
                closed_by: (document.getElementById('editClosedBy')||{}).value || null,
                closed_date: (document.getElementById('editClosedDate')||{}).value || null
            };
        }

        async function updateNC(id, payload, generalComment){
            const { data: existing, error: getErr } = await sb.from('non_conformances').select('*').eq('id', id).single();
            if (getErr) throw getErr;
            const prev = existing || {};
            const { error: updErr } = await sb.from('non_conformances').update(payload).eq('id', id);
            if (updErr) throw updErr;
            const changedBy = currentUserEmail || 'System';
            for (const k of Object.keys(payload)){
                const oldV = norm(prev[k]);
                const newV = norm(payload[k]);
                if (!valuesEqual(oldV, newV)){
                    await createAuditEntry(id, 'Field Updated', k, stringify(oldV), stringify(newV), changedBy, generalComment || '');
                }
            }
            if (!valuesEqual(prev.status, payload.status)){
                await createAuditEntry(id, 'Status Changed', 'status', prev.status, payload.status, changedBy, `Transition ${prev.status || 'N/A'} → ${payload.status}`);
            }
        }

        function norm(v){ return (v===undefined)? null : v; }
        function stringify(v){ if (v===null||v===undefined) return null; return typeof v==='string'? v : JSON.stringify(v); }
        function valuesEqual(a,b){
            if (a===b) return true;
            const da = (typeof a==='string' && /^\d{4}-\d{2}-\d{2}$/.test(a)) ? a : a;
            const db = (typeof b==='string' && /^\d{4}-\d{2}-\d{2}$/.test(b)) ? b : b;
            return da===db;
        }

        // Subtab management for workflow panes
        function switchEditTab(name){
            document.querySelectorAll('.editpane').forEach(p=>p.style.display='none');
            ['details','investigation','impact','rootcause','actionplan','implementation','effectiveness']
                .forEach(n=>{ const t=document.getElementById(`editTab-${n}`); if(t){ t.classList.remove('active'); }});
            const pane = document.getElementById(`editPane-${name}`);
            const tab = document.getElementById(`editTab-${name}`);
            if (pane) pane.style.display = 'grid';
            if (tab) tab.classList.add('active');
        }

        // Quick status transitions
        const stageOrder = ['Open','Under Investigation','Impact Assessment','Action Plan','Implementation','Effectiveness Check','Closed'];
        function nextStage(){
            const sel = document.getElementById('editStatus');
            const idx = stageOrder.indexOf(sel.value);
            if (idx>=0 && idx<stageOrder.length-1){ sel.value = stageOrder[idx+1]; switchEditTab(tabForStatus(sel.value)); refreshNcSummaryFromForm(); }
        }
        function previousStage(){
            const sel = document.getElementById('editStatus');
            const idx = stageOrder.indexOf(sel.value);
            if (idx>0){ sel.value = stageOrder[idx-1]; switchEditTab(tabForStatus(sel.value)); refreshNcSummaryFromForm(); }
        }
        function tabForStatus(status){
            switch(status){
                case 'Under Investigation': return 'investigation';
                case 'Impact Assessment': return 'impact';
                case 'Action Plan': return 'actionplan';
                case 'Implementation': return 'implementation';
                case 'Effectiveness Check': return 'effectiveness';
                default: return 'details';
            }
        }

        // Charts rendering
        let ncByStatusChart, ncBySeverityChart;
        function renderNcAnalytics(){
            const data = ncsCache || [];
            const statusCounts = {};
            const severityCounts = { Critical:0, Major:0, Minor:0 };
            data.forEach(n=>{
                const s=n.status||'Open'; statusCounts[s]=(statusCounts[s]||0)+1;
                const v=n.severity||'Minor'; if(severityCounts[v]!==undefined) severityCounts[v]++;
            });
            const ctx1 = document.getElementById('ncChartByStatus');
            const ctx2 = document.getElementById('ncChartBySeverity');
            if(ctx1){ if(ncByStatusChart) ncByStatusChart.destroy(); ncByStatusChart=new Chart(ctx1,{type:'bar',data:{labels:Object.keys(statusCounts),datasets:[{data:Object.values(statusCounts),backgroundColor:'#10b981'}]},options:{plugins:{legend:{display:false}}}});}            
            if(ctx2){ if(ncBySeverityChart) ncBySeverityChart.destroy(); ncBySeverityChart=new Chart(ctx2,{type:'doughnut',data:{labels:Object.keys(severityCounts),datasets:[{data:Object.values(severityCounts),backgroundColor:['#ef4444','#f59e0b','#10b981']} ]},options:{plugins:{legend:{position:'bottom'}}}});}            
            const rs = document.getElementById('ncReportsSummaryText');
            if (rs){ rs.textContent = `Total NCs: ${data.length}. Closed: ${(statusCounts['Closed']||0)}. Under Investigation: ${(statusCounts['Under Investigation']||0)}. Action Pending: ${(statusCounts['Action Pending']||0)}.`; }
        }

        // Modal summary helpers
        function updateNcSummary({severity, department, status, target_closure_date}){
            const line = document.getElementById('ncSummaryLine');
            if (!line) return;
            const sev = severity || '—';
            const dept = department || '—';
            const st = status || 'Open';
            const tgt = target_closure_date ? new Date(target_closure_date).toISOString().split('T')[0] : '—';
            const pseudoNc = { status: st, target_closure_date: target_closure_date };
            const overdue = isNcOverdue(pseudoNc);
            line.innerHTML = `
                <span><strong>Summary:</strong></span>
                <span class="pill">${sev}</span>
                <span class="dot"></span>
                <span>${dept}</span>
                <span class="dot"></span>
                <span><span class="status-badge status-${getStatusClass(st)}">${st}</span></span>
                <span class="dot"></span>
                <span>Target: ${tgt}</span>
                ${overdue ? '<span class="overdue-badge">Overdue</span>' : ''}
            `;
        }

        function refreshNcSummaryFromForm(){
            updateNcSummary({
                severity: (document.getElementById('editSeverity')||{}).value,
                department: (document.getElementById('editDepartment')||{}).value,
                status: (document.getElementById('editStatus')||{}).value,
                target_closure_date: (document.getElementById('editTargetClosureDate')||{}).value
            });
        }

        // Update summary when key fields change
        ['editSeverity','editDepartment','editStatus','editTargetClosureDate'].forEach(id=>{
            const el = document.getElementById(id);
            if (el) el.addEventListener('change', refreshNcSummaryFromForm);
        });

        // Exports
                function exportNCsCSV(){
                        const header = ['NC #','Title','Source','Severity','Status','Initiated Date','Target Closure','Investigator','Investigation Method','Impact Area','Risk','Root Cause','Action Owner','Implementation Date','Effectiveness','Closed Date'];
                        const toDate = (d)=> d ? new Date(d).toISOString().split('T')[0] : '';
                        const rows = [header].concat(
                            (ncsCache||[]).map(n=>[
                                n.nc_number||'',
                                n.title||'',
                                n.source||'',
                                n.severity||'',
                                n.status||'',
                                toDate(n.initiated_date),
                                toDate(n.target_closure_date),
                                n.investigator||'',
                                n.investigation_method||'',
                                n.impact_area||'',
                                n.risk_rating||'',
                                n.root_cause||'',
                                n.action_owner||'',
                                toDate(n.implementation_date),
                                n.effectiveness_result||'',
                                toDate(n.closed_date)
                            ])
                        );
                        downloadCsv('nc_register.csv', rows);
                }

        function exportNCSummaryCSV(){
            const data = ncsCache||[];
            const statusCounts = {};
            data.forEach(n=>{ const s=n.status||'Open'; statusCounts[s]=(statusCounts[s]||0)+1; });
            const rows = [['Status','Count']].concat(Object.entries(statusCounts));
            downloadCsv('nc_summary.csv', rows);
        }

        function downloadCsv(filename, rows){
            const csvContent = rows.map(r=>r.map(x=>`"${String(x??'').replace(/"/g,'""')}"`).join(',')).join('\n');
            const blob = new Blob([csvContent],{type:'text/csv;charset=utf-8;'});
            const link = document.createElement('a');
            link.href=URL.createObjectURL(blob); link.download=filename; document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        // Switch Tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
            if (tabName === 'analytics') { renderNcAnalytics(); }
        }

        // Show Alert
        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type} active`;
            
            setTimeout(() => {
                alert.classList.remove('active');
            }, 5000);
        }
    </script>
    <!-- Downloadable PDF support -->
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>
    <script>
        // Export Non-Conformance register to a downloadable PDF
        window.exportToPDF = function(){
            try{
                const table = document.querySelector('#ncTable');
                if(!table){ alert('No Non-Conformance table found'); return; }

                const wrap = document.createElement('div');
                wrap.style.padding = '16px';
                wrap.style.background = '#ffffff';
                wrap.style.color = '#111827';
                wrap.style.fontFamily = "Inter, Arial, sans-serif";
                wrap.style.width = '100%';

                const h1 = document.createElement('h2');
                h1.textContent = 'Non-Conformance Register';
                h1.style.margin = '0 0 4px';
                h1.style.fontWeight = '800';
                h1.style.fontSize = '20px';

                const sub = document.createElement('div');
                const dstr = new Date().toLocaleString();
                sub.textContent = `Generated on ${dstr}`;
                sub.style.fontSize = '12px';
                sub.style.margin = '0 0 12px';
                sub.style.color = '#6b7280';

                const cloned = table.cloneNode(true);
                cloned.style.width = '100%';
                cloned.style.borderCollapse = 'collapse';
                cloned.querySelectorAll('th, td').forEach(cell=>{ cell.style.border = '1px solid #e5e7eb'; cell.style.padding = '8px 10px'; });
                const thead = cloned.querySelector('thead');
                if(thead){ thead.style.background = '#f9fafb'; }

                wrap.appendChild(h1);
                wrap.appendChild(sub);
                wrap.appendChild(cloned);

                wrap.style.position = 'fixed';
                wrap.style.left = '-99999px';
                document.body.appendChild(wrap);

                const ymd = new Date().toISOString().slice(0,10);
                const opt = {
                    margin: 10,
                    filename: `Non_Conformance_Register_${ymd}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, backgroundColor: '#ffffff' },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' }
                };
                html2pdf().set(opt).from(wrap).save().then(()=>{
                    document.body.removeChild(wrap);
                }).catch(err=>{
                    console.error('PDF export failed', err);
                    document.body.removeChild(wrap);
                    window.print();
                });
            }catch(e){
                console.error(e);
                window.print();
            }
        };
    </script>
    <script src="assets/global-header.js"></script>
</body>
</html>
