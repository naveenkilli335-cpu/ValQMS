<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GxP Validation & Project Management | ValQMS</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
:root {
  /* Softer, more refined palette */
  --accent: #0ea474;
  --accent-bright: #0d9469;
  --accent-dim: rgba(14,164,116,0.06);
  --text: #18181b;              /* Deeper, richer black */
  --text-dim: #28282a;          /* Softer gray */
  --text-lighter: #a1a1aa;      /* Even lighter for subtle text */
  --surface: #fafafa;           /* Slightly warmer white */
  --surface-hover: #f4f4f5;     
  --border: #e4e4e7;            /* Much softer border */
  --border-light: #f4f4f5;      /* Ultra-light border */
  --glass: #ffffff;
  
  /* 21st.dev shadow system */
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.02), 
               0 0 0 0.75px rgba(0, 0, 0, 0.03);
  
  --shadow-md: 0 3px 6px -1.5px rgba(0, 0, 0, 0.01), 
               0 6px 12px -3px rgba(0, 0, 0, 0.02), 
               0 32px 56px -12px rgba(0, 0, 0, 0.02),
               0 0 0 0.75px rgba(0, 0, 0, 0.04);
  
  --shadow-hover: 0 3px 6px -1.5px rgba(0, 0, 0, 0.01), 
                  0 6px 12px -3px rgba(0, 0, 0, 0.02), 
                  0 32px 56px -12px rgba(0, 0, 0, 0.06),
                  0 0 0 0.75px rgba(0, 0, 0, 0.04);
}

body {
  font-family: 'Inter', system-ui, -apple-system, sans-serif;
  background: #092b47;          /* White background */
  color: var(--text);
  line-height: 1.6;
  min-height: 100vh;
}

body::before {
  /* Remove or hide the dark gradient overlay */
  display: none;
}

    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

    /* Header */
header {
  background: #ffffff;
  border: 1px solid var(--border-light);
  border-radius: 16px;
  padding: 16px 24px;
  margin-bottom: 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 16px;
  position: sticky;
  top: 12px;
  z-index: 100;
  box-shadow: var(--shadow-md);
  transition: box-shadow 0.2s ease;
}

header:hover {
  box-shadow: var(--shadow-hover);
}

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--text);
    }

    .logo-mark {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--accent), var(--accent-bright));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 800;
    }

    .logo-text {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: -0.5px;
    }

    .logo-subtitle {
      font-size: 11px;
      color: var(--text-dim);
      font-weight: 500;
    }

    .header-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }

.control-btn {
  padding: 8px 16px;
  background: #ffffff;
  border: 1px solid var(--border);
  border-radius: 12px;
  color: var(--text);
  font-weight: 500;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: flex;
  align-items: center;
  gap: 8px;
  box-shadow: var(--shadow-sm);
}

.control-btn:hover {
  background: var(--surface);
  border-color: var(--border);
  box-shadow: var(--shadow-md);
  transform: translateY(-1px);
}

.control-btn:active {
  transform: translateY(0);
  box-shadow: var(--shadow-sm);
}

    .control-btn:hover {
      background: var(--surface-hover);
      border-color: var(--accent);
      color: var(--accent-bright);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 30px;
      overflow-x: auto;
      padding-bottom: 12px;
    }

    .tab-btn {
      padding: 12px 24px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text-dim);
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .tab-btn.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-bright));
      border-color: var(--accent);
      color: #000;
    }

    .tab-btn:hover:not(.active) {
      border-color: var(--accent);
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Cards */
    .card {
      background: linear-gradient(145deg, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 30px;
      margin-bottom: 24px;
      transition: all 0.3s;
    }

    .card h2 {
      font-size: 28px;
      font-weight: 800;
      margin-bottom: 16px;
    }

    .card p {
      color: var(--text-dim);
      margin-bottom: 24px;
      font-size: 15px;
    }

    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 800;
      color: var(--accent);
      margin: 12px 0;
    }

    .stat-label {
      font-size: 14px;
      color: var(--text-dim);
    }

    /* Forms */
.form-group { display: flex; flex-direction: column; gap: 8px; }

.form-label { font-size: 13px; font-weight: 600; color: var(--text); }

.form-input, .form-select, .form-textarea {
  width: 100%;
  padding: 10px 14px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: #ffffff;
  color: #18181b !important;  /* Force dark text color */
  font-size: 14px;
  font-weight: 400;
  transition: all 0.2s ease;
  box-shadow: var(--shadow-sm);
}

/* Specific styling for select dropdowns */
.form-select {
  width: 100%;
  padding: 10px 14px;
  border: 1px solid var(--border);
  border-radius: 10px;
  background: #ffffff !important;
  color: #18181b !important;
  font-size: 14px;
  font-weight: 400;
  transition: all 0.2s ease;
  box-shadow: var(--shadow-sm);
  cursor: pointer;
}

/* Dropdown option styling - CRITICAL FIX */
.form-select option {
  color: #18181b !important;
  background: #ffffff !important;
  padding: 8px 12px;
}

.form-select option:hover {
  background-color: #334155 !important;
  color: #10b981 !important;
}

.form-select:focus option:checked,
.form-select option:checked {
  background: #f3f4f6 !important;
  color: #18181b !important;
}

.form-select option:focus {
  background-color: #334155 !important;
  color: #10b981 !important;
}

select, select option {
  background-color: #1e293b !important;
  color: #ffffff !important;
}

select option:checked {
  background: linear-gradient(#34d399, #34d399) #1e293b no-repeat !important;
  background-color: #0f172a !important;
}

.form-select optgroup {
  background: #0f172a;  /* Very dark background */
  color: #10b981;  /* Accent color */
  font-weight: 600;
  font-size: 13px;
}

/* Placeholder styling */
.form-input::placeholder,
.form-select::placeholder,
.form-textarea::placeholder {
  color: #a1a1aa;  /* Light gray placeholder */
  opacity: 1;
}

.form-input:focus,
.form-select:focus,
.form-textarea:focus {
  outline: none;
  border-color: var(--accent);
  background: var(--surface-hover);
  box-shadow: 0 0 0 3px var(--accent-dim);
  color: #ffffff;  /* Ensure white text on focus */
}

.form-textarea {
  min-height: 100px;
  resize: vertical;
}


.form-select option {
  background: #1e293b;  /* Dark background for dropdown options */
  color: var(--text);
  padding: 10px;
}

.form-select optgroup {
  background: #0f172a;  /* Even darker for optgroup */
  color: var(--accent);
  font-weight: 600;
}

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--surface-hover);
      box-shadow: 0 0 0 3px var(--accent-dim);
    }

.form-textarea { min-height: 110px; resize: vertical; }

/* Dropdown Options Styling */
.form-select option {
  background: #1e293b;
  color: #ffffff;
  padding: 10px;
}

.form-select option:hover {
  background: #dee0e3;
}

.form-select optgroup {
  background: #0f172a;
  color: var(--accent);
  font-weight: 600;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));  /* 2 columns */
  gap: 16px;
}
.form-grid.full { grid-template-columns: 1fr; }

    /* Buttons */
    .btn {
      padding: 12px 28px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-bright));
      color: #000;
      box-shadow: 0 6px 24px rgba(16,185,129,0.3);
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 10px 32px rgba(16,185,129,0.4);
    }

    .btn-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: var(--surface-hover);
      border-color: var(--accent);
    }

    .btn-block {
      width: 100%;
      justify-content: center;
      margin-top: 20px;
    }

    /* GAMP Selector */
    .gamp-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-top: 20px;
    }

    .gamp-option {
      background: var(--glass);
      border: 2px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.4s;
      position: relative;
      overflow: hidden;
    }

    .gamp-option::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-bright));
      transform: scaleX(0);
      transition: transform 0.4s;
    }

    .gamp-option:hover {
      border-color: var(--accent);
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(16,185,129,0.2);
    }

    .gamp-option:hover::before {
      transform: scaleX(1);
    }

    .gamp-option.selected {
      border-color: var(--accent);
      background: var(--accent-dim);
      transform: translateY(-4px);
    }

    .gamp-option.selected::before {
      transform: scaleX(1);
    }

    .gamp-badge {
      display: inline-block;
      padding: 4px 12px;
      background: var(--accent);
      color: #000;
      font-size: 11px;
      font-weight: 700;
      border-radius: 12px;
      margin-bottom: 12px;
    }

    .gamp-option h3 {
      font-size: 20px;
      font-weight: 800;
      margin-bottom: 8px;
    }

    .gamp-option p {
      font-size: 13px;
      color: var(--text-dim);
      line-height: 1.5;
    }

    /* Checkbox Group */
.checkbox-group { display: grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 12px; }
.checkbox-item {
  display: flex; align-items: center; gap: 10px;
  border: 1px solid var(--border); border-radius: 10px;
  padding: 10px; background: var(--surface);
}

.modal-actions {
  position: sticky; bottom: 0; background: rgba(10,15,30,0.9);
  padding-top: 12px; margin-top: 20px;
  display: flex; gap: 12px; justify-content: flex-end;
  border-top: 1px solid var(--border);
}


.checkbox-item:hover {
  background: var(--surface-hover);
  border-color: var(--accent);  /* Highlight border on hover */
}

.checkbox-item input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: var(--accent);
  flex-shrink: 0;  /* Prevent checkbox from shrinking */
}

.checkbox-item label {
  flex: 1;
  cursor: pointer;
  font-weight: 500;
  color: var(--text);  /* Ensure white text */
  font-size: 14px;
  line-height: 1.4;
}

    /* Deliverables */
    .deliverables-list {
      display: grid;
      gap: 16px;
    }

    .deliverable-item {
      background: var(--glass);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 16px;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .deliverable-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(180deg, var(--accent), var(--accent-bright));
      opacity: 0;
      transition: opacity 0.3s;
    }

    .deliverable-item:hover {
      border-color: var(--accent);
      transform: translateX(4px);
    }

    .deliverable-item:hover::before {
      opacity: 1;
    }

    .deliverable-info {
      flex: 1;
    }

    .deliverable-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .deliverable-meta {
      font-size: 12px;
      color: var(--text-dim);
    }

    .status-tag {
      padding: 6px 12px;
      border-radius: 16px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .status-pending {
      background: rgba(156, 163, 175, 0.2);
      color: #9ca3af;
    }

    .status-inprogress {
      background: rgba(249, 115, 22, 0.2);
      color: #fb923c;
    }

    .status-completed {
      background: var(--accent-dim);
      color: var(--accent-bright);
    }

    /* Projects Table */
    .projects-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .projects-table thead {
      background: var(--surface);
    }

    .projects-table th {
      padding: 16px;
      text-align: left;
      font-weight: 600;
      font-size: 12px;
      text-transform: uppercase;
      color: var(--text-dim);
      border-bottom: 1px solid var(--border);
    }

    .projects-table td {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }

    .projects-table tbody tr:hover {
      background: var(--surface);
    }

/* Modal shell */
.modal {
    display: none;
    position: fixed;
    z-index: 9999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    backdrop-filter: blur(4px);
    align-items: center;
    justify-content: center;
}


.modal.active {
    display: flex !important;
}

/* Modal content */
.modal-content {
  background: #ffffff;
  border: 1px solid var(--border);
  border-radius: 20px;
  padding: 28px;
  width: 92%;
  max-width: 980px;            /* constrain width */
  max-height: 88vh;            /* constrain height */
  overflow-y: auto;            /* scroll inside, not the page */
  position: relative;
}

/* Webkit browsers scrollbar styling */
.modal-content::-webkit-scrollbar {
  width: 8px;
}

.modal-content::-webkit-scrollbar-track {
  background: var(--surface);
  border-radius: 4px;
}

.modal-content::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 4px;
}

.modal-content::-webkit-scrollbar-thumb:hover {
  background: var(--accent-bright);
}


.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}

.modal-title {
  font-size: 24px;
  font-weight: 800;
  color: var(--text);
}

/* Fix modal form text colors */
.modal-content .form-input,
.modal-content .form-select,
.modal-content .form-textarea {
  color: #18181b !important;
  background: #ffffff;
}

.modal-content .form-label {
  color: #18181b !important;
}

.modal-content label {
  color: #18181b !important;
}

.modal-content h2,
.modal-content h3,
.modal-content p,
.modal-content div {
  color: #18181b;
}

    .close-btn {
      background: none;
      border: none;
      font-size: 28px;
      color: var(--text-dim);
      cursor: pointer;
      transition: color 0.3s;
    }

    .close-btn:hover {
      color: var(--text);
    }

    /* Progress */
    .progress-bar {
      width: 100%;
      height: 8px;
      background: var(--surface);
      border-radius: 999px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-bright));
      transition: width 0.5s ease;
    }

    .progress-text {
      font-size: 13px;
      color: var(--text-dim);
      text-align: right;
    }

    /* Wizard Steps */
    .wizard-step {
      display: none;
    }

    .wizard-step.active {
      display: block;
    }

    .step-indicator {
      display: flex;
      gap: 12px;
      margin-bottom: 30px;
      justify-content: center;
    }

    .step-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--border);
      transition: all 0.3s;
    }

    .step-dot.active {
      background: var(--accent);
      width: 32px;
      border-radius: 6px;
    }

    /* Alert */
    .alert {
      padding: 16px 20px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      display: none;
    }

    .alert.active {
      display: flex;
    }

    .alert.success {
      background: var(--accent-dim);
      color: var(--accent-bright);
      border: 1px solid var(--accent);
    }

    .alert.error {
      background: rgba(239, 68, 68, 0.15);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }

    .alert.info {
      background: rgba(59, 130, 246, 0.15);
      color: #93c5fd;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .alert-icon {
      width: 20px;
      height: 20px;
      flex-shrink: 0;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .gamp-selector {
        grid-template-columns: 1fr;
      }

      .deliverable-item {
        flex-direction: column;
        align-items: flex-start;
      }

      header {
        flex-direction: column;
        align-items: flex-start;
      }

      .tabs {
        flex-wrap: wrap;
      }

      .projects-table {
        font-size: 12px;
      }

      .projects-table th,
      .projects-table td {
        padding: 12px;
      }

      .modal-content {
        padding: 24px;
      }
    }

@media (max-width: 1200px) {
    .dashboard-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 768px) {
    .dashboard-grid {
        grid-template-columns: 1fr;
    }
    
    /* Stack the two-column grid on mobile */
    div[style*="grid-template-columns: 2fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
    
    div[style*="grid-template-columns: 1fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
}


    /* Loading Overlay */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(10, 14, 26, 0.95);
  backdrop-filter: blur(10px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

.loading-overlay.active {
  display: flex;
}

.loading-spinner {
  width: 60px;
  height: 60px;
  border: 4px solid var(--border);
  border-top: 4px solid var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Fix Applications tab visibility */
#applications {
    min-height: 400px;
    background: #fafafa;
}

#applications .card {
    background: #ffffff !important;
    border: 1px solid var(--border) !important;
    padding: 30px !important;
    border-radius: 20px !important;
    box-shadow: var(--shadow-md) !important;
}

#applications .card h2,
#applications .card p {
    color: var(--text) !important;
}

/* Make sure tab content shows when active */
.tab-content {
    display: none;
}

.tab-content.active {
    display: block !important;
}

/* ========================================
   FIX: Text Visibility for All Dark Tabs
   ======================================== */

/* Make all tab content cards have white background and dark text */
.tab-content .card,
#deliverables,
#requirements,
#testing,
#RTM,
#agile {
    background: #ffffff !important;
}

/* Ensure all text elements are dark and visible */
.tab-content h1,
.tab-content h2,
.tab-content h3,
.tab-content p,
.tab-content div,
.tab-content label,
.tab-content span,
.tab-content li {
    color: #18181b !important;
}

/* Fix for card containers specifically */
#deliverables .card,
#requirements .card,
#testing .card,
#RTM .card,
#agile .card {
    background: #575555 !important;
    border: 1px solid #e4e4e7 !important;
    border-radius: 16px !important;
}

/* Fix all headings in these tabs */
#deliverables h2,
#deliverables h3,
#deliverables p,
#requirements h2,
#requirements h3,
#requirements p,
#testing h2,
#testing h3,
#testing p,
#RTM h2,
#RTM h3,
#RTM p,
#agile h2,
#agile h3,
#agile p {
    color: #18181b !important;
}

/* Fix select dropdowns */
.tab-content select,
.tab-content input[type="text"],
.tab-content input[type="date"],
.tab-content textarea {
    background: #ffffff !important;
    color: #18181b !important;
    border: 1px solid #e4e4e7 !important;
}

/* Fix for empty state text */
.tab-content .card div[style*="text-align: center"] {
    color: #6b7280 !important;
}

/* Fix table text if present */
.tab-content table th,
.tab-content table td {
    color: #18181b !important;
}



  </style>
</head>
<body>
  <div class="container">
    
    <!-- Header -->
<header>
  <div class="logo">
    <div class="logo-mark">🎯</div>
    <div>
      <div class="logo-text">ValQMS</div>
      <div class="logo-subtitle">GAMP 5 | FDA 21 CFR Part 11 | Hybrid Agile/Waterfall</div>
    </div>
  </div>
  <div class="header-controls">
    <button class="control-btn" onclick="showAlert('Export feature coming soon', 'info')">
      📥 Export
    </button>
    <button class="control-btn" onclick="openNewProjectModal()">
      ➕ New Project
    </button>
    <a href="index.html" class="control-btn" style="background: var(--accent); color: #000; font-weight: 800; text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
      🏠 Home
    </a>
  </div>
</header>

    <!-- Alert -->
    <div id="alert" class="alert">
      <span class="alert-icon" id="alertIcon"></span>
      <span id="alertText"></span>
    </div>

    <!-- Tabs -->
<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('dashboard')">Dashboard</button>
    <button class="tab-btn" onclick="switchTab('applications')">Applications</button> <!-- NEW -->
    <button class="tab-btn" onclick="switchTab('projects')">Projects</button>
    <button class="tab-btn" onclick="switchTab('deliverables')">Deliverables</button>
    <button class="tab-btn" onclick="switchTab('requirements')">Requirements</button>
    <button class="tab-btn" onclick="switchTab('testing')">Testing</button>
    <button class="tab-btn" onclick="switchTab('RTM')">RTM</button>
    <button class="tab-btn" onclick="switchTab('agile')">Agile Sprints</button>

</div>

<!-- Dashboard Tab -->
<div id="dashboard" class="tab-content active">
    <!-- Stats Grid -->
    <div class="dashboard-grid">
        <div class="stat-card">
            <div class="stat-label">Total Projects</div>
            <div class="stat-value" id="totalProjects">0</div>
            <div style="margin-top: 12px; font-size: 12px; color: var(--text-dim);">
                <span id="activeProjectsCount">0</span> Active · 
                <span id="completedProjectsCount">0</span> Completed
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">GAMP Category 5</div>
            <div class="stat-value" id="gamp5Count">0</div>
            <div style="margin-top: 8px;">
                <span style="background: rgba(239, 68, 68, 0.2); color: #fca5a5; padding: 4px 12px; border-radius: 16px; font-size: 11px; font-weight: 700;">HIGH COMPLEXITY</span>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">In Progress</div>
            <div class="stat-value" id="inProgressCount">0</div>
            <div style="margin-top: 12px; font-size: 12px; color: var(--text-dim);">
                Validation Phase
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-label">Completed</div>
            <div class="stat-value" id="completedCount">0</div>
            <div style="margin-top: 12px; font-size: 12px; color: var(--text-dim);">
                Released Systems
            </div>
        </div>
    </div>

    <!-- Dashboard Content Section -->
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-top: 24px; margin-bottom: 24px;">
        <!-- Recent Projects -->
        <div class="card">
            <h2 style="font-size: 20px; margin-bottom: 20px;">Recent Projects</h2>
            <div id="recentProjectsList">
                <div style="text-align: center; padding: 40px; color: var(--text-dim);">
                    No recent projects
                </div>
            </div>
        </div>
        
        <!-- Quick Stats -->
        <div class="card">
            <h2 style="font-size: 20px; margin-bottom: 20px;">Deliverables Status</h2>
            <div id="deliverablesStats">
                <div style="text-align: center; padding: 40px; color: var(--text-dim);">
                    No data available
                </div>
            </div>
        </div>
    </div>

    <!-- GAMP Category Distribution -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
        <div class="card">
            <h2 style="font-size: 20px; margin-bottom: 20px;">GAMP Category Distribution</h2>
            <div id="gampDistribution" style="display: grid; gap: 12px;">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
        
        <div class="card">
            <h2 style="font-size: 20px; margin-bottom: 20px;">Project Status</h2>
            <div id="statusDistribution" style="display: grid; gap: 12px;">
                <!-- Will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Quick Start -->
    <div class="card">
        <h2>Quick Start</h2>
        <p>Create a new validation project and auto-generate all required deliverables based on GAMP classification.</p>
        <button class="btn btn-primary" onclick="openNewProjectModal()">Start New Project</button>
    </div>
    
</div> <!-- ✅ CLOSE DASHBOARD TAB HERE -->


<!-- Applications Tab -->
<div id="applications" class="tab-content">
  <div class="card" style="background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:24px;">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
      <div>
        <h2 style="margin:0;">Applications & Systems</h2>
        <p style="margin:4px 0 0; color:#6b7280;">Manage all GxP systems and their validation projects</p>
      </div>
      <div style="display:flex; gap:12px;">
        <button class="btn btn-secondary" onclick="openVersionManagement()">📋 Versions</button>
        <button class="btn btn-primary" onclick="openNewApplicationModal()">+ New Application</button>
      </div>
    </div>

    <div id="applicationsContainer">
      <div style="text-align:center; padding:40px; color:#6b7280;">Loading applications...</div>
    </div>
  </div>
</div>


<!-- Projects Tab -->
<div id="projects" class="tab-content">
  <div class="card">
    <h2>Validation Projects</h2>
    <p>All validation projects with auto-generated deliverables and phase tracking</p>
    
    <table class="projects-table" id="projectsTable">
      <thead>
        <tr>
          <th>Project ID</th>
          <th>System Name</th>
          <th>GAMP</th>
          <th>Status</th>
          <th>Progress</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="projectsTableBody">
        <tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-dim);">No projects yet. Create one to get started.</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Deliverables Tab -->
<div id="deliverables" class="tab-content">
  <div class="card">
    <h2>Validation Deliverables (Phase-Wise)</h2>
    <p>Manage deliverables by validation phase. Add new or remove with justification.</p>
    
    <select class="form-input" id="projectSelector" onchange="loadProjectDeliverables()" style="margin-top: 20px;">
      <option value="">Select a project...</option>
    </select>

    <div id="phasesContainer" style="margin-top: 30px;"></div>

    <div style="margin-top: 30px;">
      <button class="btn btn-primary" onclick="openAddDeliverableModal()" id="addDelBtn" style="display: none;">
        ➕ Add New Deliverable
      </button>
    </div>
  </div>
</div>



<!-- Requirements Tab -->
<div id="requirements" class="tab-content">
  <div class="card">
    <h2>User Requirements Specification (URS)</h2>
    <p>Define GxP-compliant requirements following GAMP 5 guidelines. Ensure traceability to test cases (21 CFR Part 11).</p>
    
    <select class="form-input" id="reqProjectSelector" onchange="loadProjectRequirements()" style="margin-top: 20px;">
      <option value="">Select a project...</option>
    </select>

    <!-- RTM View Toggle -->
    <div style="display: flex; gap: 12px; margin: 20px 0; align-items: center;" id="reqViewToggle" style="display: none;">
      <button class="btn btn-secondary" id="reqViewBtn" onclick="toggleRequirementsView('requirements')" style="background: var(--accent); color: #000;">
        📋 Requirements View
      </button>
      <button class="btn btn-secondary" id="rtmViewBtn" onclick="toggleRequirementsView('rtm')">
        🔗 Traceability Matrix (RTM)
      </button>
    </div>


    <!-- Requirements View -->
    <div id="requirementsViewContainer">
      <div id="requirementsContainer" style="margin-top: 30px;">
        <div style="text-align: center; padding: 40px; color: var(--text-dim);">
          Select a project to manage requirements
        </div>
      </div>
    </div>

    <!-- RTM View -->
    <div id="rtmViewContainer" style="display: none;">
      <div id="rtmContainer" style="margin-top: 30px;">
        <div style="text-align: center; padding: 40px; color: var(--text-dim);">
          Select a project to view traceability matrix
        </div>
      </div>
    </div>
  </div>
</div>


    <!-- Testing Tab -->
<!-- Testing Tab -->
<div id="testing" class="tab-content">
    <div class="card">
        <h2>Test Suite Management (IQ/OQ/PQ/UAT)</h2>
        <p>Manage test suites, link requirements, execute tests, and track compliance</p>
        
        <div style="margin: 20px 0;">
            <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Select Project:</label>
            <select id="testProjectSelector" class="form-input" style="max-width: 400px;" onchange="loadTestSuites()">
                <option value="">-- Select Project --</option>
            </select>
        </div>

        <!-- View Toggle -->
        <div style="display: flex; gap: 12px; margin: 20px 0; align-items: center;" id="testViewToggle" style="display: none;">
            <button class="btn btn-secondary" id="testSuiteViewBtn" onclick="toggleTestView('suites')" style="background: var(--accent); color: #000;">Test Suites</button>
            <button class="btn btn-secondary" id="rtmViewBtn" onclick="toggleTestView('rtm')">RTM</button>
        </div>

        <!-- Test Suites View -->
        <div id="testSuitesView">
            <button class="btn btn-primary" onclick="openNewTestSuiteModal()" style="margin: 20px 0;">+ New Test Suite</button>
            
            <div id="testSuitesContainer">
                <div style="text-align: center; color: var(--text-dim); padding: 40px;">Select a project to manage test suites</div>
            </div>
        </div>

        <!-- RTM View -->
        <div id="rtmView" style="display: none;">
            <button class="btn btn-primary" onclick="generateRTMReport()" style="margin: 20px 0;">📊 Generate RTM Report</button>
            
            <div id="rtmContainer">
                <div style="text-align: center; color: var(--text-dim); padding: 40px;">Select a project to view RTM</div>
            </div>
        </div>
    </div>
</div>


    <!-- Agile Tab -->
    <div id="agile" class="tab-content">
        <div class="card">
            <h2>Agile Sprint Management</h2>
            <p>Manage sprints for your validation projects with story points and velocity tracking</p>
            
            <div style="margin: 20px 0;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">Select Project:</label>
                <select id="sprintProjectSelector" class="form-input" style="max-width: 400px;" onchange="loadSprints()">
                    <option value="">-- Select Project --</option>
                </select>
            </div>

            <button class="btn btn-primary" onclick="openNewSprintModal()" style="margin: 20px 0;">+ New Sprint</button>

            <div id="sprintsContainer">
                <div style="text-align: center; color: var(--text-dim); padding: 40px;">Select a project to manage sprints</div>
            </div>
        </div>
    </div>

  <!-- Delete Deliverable Modal -->
  <div id="deleteDeliverableModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Remove Deliverable</h2>
        <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
      </div>

      <div style="background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); padding: 16px; border-radius: 12px; margin-bottom: 20px;">
        <strong>Deliverable:</strong> <span id="deleteDelName"></span>
        <div style="font-size: 12px; color: var(--text-dim); margin-top: 8px;">Phase: <span id="deleteDelPhase"></span></div>
      </div>

      <div class="form-group">
        <label class="form-label required">Justification for Removal</label>
        <textarea class="form-textarea" id="deleteJustification" placeholder="Explain why this deliverable is no longer needed (e.g., scope change, redundant with another document, etc.)"></textarea>
      </div>

      <div class="form-group">
        <label class="form-label required">Approval Authority</label>
        <input type="text" class="form-input" id="deleteApprovalAuth" placeholder="Name of QA/Validation Lead approving removal">
      </div>

      <div style="display: flex; gap: 12px; margin-top: 30px;">
        <button class="btn btn-secondary" onclick="closeDeleteModal()">Cancel</button>
        <button class="btn btn-primary" style="background: #ef4444;" onclick="confirmDeleteDeliverable()">Confirm Removal</button>
      </div>
    </div>
  </div>

  <!-- Add Deliverable Modal -->
  <div id="addDeliverableModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Add New Deliverable</h2>
        <button class="close-btn" onclick="closeAddDeliverableModal()">&times;</button>
      </div>

      <div style="background: var(--accent-dim); border: 1px solid var(--accent); padding: 16px; border-radius: 12px; margin-bottom: 20px; font-size: 13px;">
        <strong>Note:</strong> Custom deliverables should be justified and approved by QA leadership.
      </div>

      <div class="form-group">
        <label class="form-label required">Deliverable Name</label>
        <input type="text" class="form-input" id="newDelName" placeholder="e.g., System Integration Testing Report">
      </div>

      <div class="form-grid">
        <div class="form-group">
          <label class="form-label required">Deliverable Code</label>
          <input type="text" class="form-input" id="newDelCode" placeholder="e.g., SIT" maxlength="10">
        </div>

        <div class="form-group">
          <label class="form-label required">Phase</label>
          <select class="form-select" id="newDelPhase">
            <option value="">Select Phase</option>
            <option value="Planning">Planning</option>
            <option value="Requirements">Requirements</option>
            <option value="Design">Design</option>
            <option value="Build">Build</option>
            <option value="Testing">Testing</option>
            <option value="Verification">Verification</option>
            <option value="Release">Release</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label class="form-label required">Justification</label>
        <textarea class="form-textarea" id="newDelJustification" placeholder="Why is this deliverable needed for your project?"></textarea>
      </div>

      <div class="form-group">
        <label class="form-label required">Created By (Name)</label>
        <input type="text" class="form-input" id="newDelCreatedBy" placeholder="Your name">
      </div>

      <div style="display: flex; gap: 12px; margin-top: 30px;">
        <button class="btn btn-secondary" onclick="closeAddDeliverableModal()">Cancel</button>
        <button class="btn btn-primary" onclick="confirmAddDeliverable()">Add Deliverable</button>
      </div>
    </div>
  </div>

<div id="projectModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitle">New Validation Project</h2>
      <button class="close-btn" onclick="closeProjectModal()">&times;</button>
    </div>

    <div id="projectForm">
      <div class="step-indicator">
        <div class="step-dot active" id="step1Dot"></div>
        <div class="step-dot" id="step2Dot"></div>
        <div class="step-dot" id="step3Dot"></div>
      </div>

      <!-- Step 1: Basic Info -->
      <div id="step1" class="wizard-step active">
        <h3>Step 1: Project Information</h3>

    <div class="form-group">
        <label class="form-label required">Select Application</label>
        <select class="form-select" id="projectApplication" required>
            <option value="">Select Application</option>
            <!-- Will be populated by loadApplicationsForProject() -->
        </select>
        <small style="color: var(--text-dim); font-size: 12px; margin-top: 4px; display: block;">
            Don't see your application? <a href="#" onclick="event.preventDefault(); switchTab('applications'); closeProjectModal();" style="color: var(--accent); text-decoration: underline;">Create it first in Applications tab</a>
        </small>
    </div>
        
<!-- After Application selector -->
<div class="form-group">
    <label class="form-label required">Application Version</label>
    <select class="form-select" id="projectVersion" required disabled>
        <option value="">Select Application First</option>
    </select>
    <small style="color: var(--text-dim); font-size: 12px;">
        Select application first, then choose a version or create new
    </small>
</div>



        <div class="form-group">
          <label class="form-label required">Project Name</label>
          <input type="text" class="form-input" id="projectName" placeholder="e.g., LIMS System Validation">
        </div>



        <div class="form-group">
          <label class="form-label required">System Name</label>
          <input type="text" class="form-input" id="systemName" placeholder="e.g., Waters LIMS XYZ">
        </div>

        <div class="form-group">
          <label class="form-label">System Description</label>
          <textarea class="form-textarea" id="systemDescription" placeholder="Brief description of the system"></textarea>
        </div>

        <div class="form-grid">
          <div class="form-group">
            <label class="form-label required">Project Type</label>
            <select class="form-select" id="projectType">
              <option value="">Select Type</option>
<option value="New System">New Implementation</option>
<option value="Upgrade">System Upgrade</option>
<option value="Migration">Migration</option>
<option value="Retirement">Retirement</option>
<option value="Periodic Review">Periodic Review</option>
            </select>
          </div>

<!-- GxP Impact Field with Assessment Button -->
<div class="form-group">
    <label class="form-label required">GxP Impact</label>
    <div style="display: flex; gap: 12px;">
        <select class="form-select" id="gxpImpact" required style="flex: 1;">
            <option value="">Select Impact</option>
            <option value="GxP Critical">GxP Critical</option>
            <option value="GxP Non-Critical">GxP Non-Critical</option>
            <option value="Non-GxP">Non-GxP</option>
        </select>
        <button type="button" class="btn" onclick="openGxPAssessment()" 
                style="background: linear-gradient(135deg, #3b82f6, #60a5fa); color: white; white-space: nowrap; padding: 12px 20px; font-size: 14px;">
            🔍 Run Assessment
        </button>
    </div>
    <small style="color: var(--text-dim); font-size: 12px; margin-top: 4px; display: block;">
        Not sure about GxP classification? Run our guided 5-question assessment
    </small>
</div>
        </div>

        <div class="form-group">
          <label class="form-label">Vendor/Supplier</label>
          <input type="text" class="form-input" id="vendor" placeholder="e.g., Waters Corporation">
        </div>

        <div style="display: flex; gap: 12px; margin-top: 30px;">
          <button type="button" class="btn btn-secondary" onclick="closeProjectModal()">Cancel</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="goToStep2()">Next: GAMP Assessment →</button>
        </div>
      </div>

      <!-- Step 2: GAMP Assessment -->
      <div id="step2" class="wizard-step">
        <h3>Step 2: GAMP 5 Category Assessment</h3>
        
        <div style="background: var(--accent-dim); border: 1px solid var(--border); padding: 16px; border-radius: 12px; margin-bottom: 20px; font-size: 13px;">
          <strong>Answer the following questions to auto-classify your system:</strong>
        </div>

        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="isInfrastructure" onchange="updateGAMPPreview()">
            <label for="isInfrastructure">Is this infrastructure software? (OS, Database, Middleware)</label>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="isCOTS" onchange="updateGAMPPreview()">
            <label for="isCOTS">Is this COTS software used without modification?</label>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="isConfigurable" onchange="updateGAMPPreview()">
            <label for="isConfigurable">Does it require configuration? (LIMS, MES, ERP)</label>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="hasCustomCode" onchange="updateGAMPPreview()">
            <label for="hasCustomCode">Does it have custom code, scripts, or macros?</label>
          </div>

          <div class="checkbox-item">
            <input type="checkbox" id="isCustomDeveloped" onchange="updateGAMPPreview()">
            <label for="isCustomDeveloped">Is this custom-developed software?</label>
          </div>
        </div>

        <div id="gampResult" style="background: var(--accent-dim); border: 1px solid var(--accent); padding: 20px; border-radius: 12px; margin-top: 20px; display: none;">
          <div style="text-align: center;">
            <div style="font-size: 12px; color: var(--text-dim); margin-bottom: 8px;">RECOMMENDED GAMP CATEGORY</div>
            <div style="font-size: 32px; font-weight: 800; color: var(--accent); margin: 12px 0;">
              <span id="gampCategoryText">GAMP 3</span>
            </div>
            <div style="font-size: 13px; color: var(--text-dim);" id="gampDescText">Classified as standard product</div>
          </div>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 30px;">
          <button class="btn btn-secondary" onclick="goToStep1()">← Back</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="goToStep3()">Next: Methodology →</button>
        </div>
      </div>

      <!-- Step 3: Methodology & Timeline -->
      <div id="step3" class="wizard-step">
        <h3>Step 3: Methodology & Timeline</h3>
        
        <div class="form-grid">
          <div class="form-group">
            <label class="form-label required">Methodology</label>
            <select class="form-select" id="methodology">
              <option value="">Select Methodology</option>
              <option value="Waterfall">Waterfall (V-Model)</option>
              <option value="Agile">Agile (Pure Agile)</option>
              <option value="Hybrid - Agile Dev + Waterfall Val">Hybrid (Agile Dev + Waterfall Validation)</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Agile Framework</label>
            <select class="form-select" id="agileFramework">
              <option value="N/A">N/A</option>
              <option value="Scrum">Scrum</option>
              <option value="Kanban">Kanban</option>
              <option value="SAFe">SAFe</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Start Date</label>
            <input type="date" class="form-input" id="startDate">
          </div>

          <div class="form-group">
            <label class="form-label">Go-Live Date</label>
            <input type="date" class="form-input" id="goLiveDate">
          </div>

          <div class="form-group">
            <label class="form-label">Validation Lead</label>
            <input type="text" class="form-input" id="validationLead" placeholder="Name">
          </div>

          <div class="form-group">
            <label class="form-label">System Owner</label>
            <input type="text" class="form-input" id="systemOwner" placeholder="Name">
          </div>
        </div>

        <div style="display: flex; gap: 12px; margin-top: 30px;">
          <button class="btn btn-secondary" onclick="goToStep2()">← Back</button>
          <button class="btn btn-primary" style="flex: 1;" onclick="createProject()">Create Project & Generate Deliverables</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add User Requirement Modal -->
<div id="addRequirementModal" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h2 class="modal-title">Add User Requirement (URS)</h2>
      <button class="close-btn" onclick="closeAddRequirementModal()">&times;</button>
    </div>

    <div style="background: var(--accent-dim); border: 1px solid var(--accent); padding: 16px; border-radius: 12px; margin-bottom: 24px; font-size: 13px;">
      <strong>📋 Regulatory Note:</strong> Requirements must be specific, measurable, testable, and traceable per GAMP 5 and 21 CFR Part 11 guidelines.
    </div>

    <!-- Requirement ID -->
    <div class="form-group">
      <label class="form-label">Requirement ID</label>
      <input type="text" class="form-input" id="reqId" placeholder="Auto-generated" readonly style="background: rgba(255,255,255,0.02); cursor: not-allowed;">
      <div style="font-size: 11px; color: var(--text-dim); margin-top: 4px;">✨ Auto-generated based on requirement type</div>
    </div>






    
    <!-- Requirement Type -->
    <div class="form-group">
      <label class="form-label required">Requirement Type</label>
      <select class="form-select" id="reqType" onchange="updateRequirementIdPrefix()">
        <option value="">Select Type</option>
        <option value="Functional">Functional (FR)</option>
        <option value="Non-Functional">Non-Functional (NFR)</option>
        <option value="Data Integrity">Data Integrity (DI)</option>
        <option value="Security">Security (SEC)</option>
        <option value="Audit Trail">Audit Trail (AT)</option>
        <option value="Electronic Signature">Electronic Signature (ES)</option>
        <option value="Interface">Interface (INT)</option>
        <option value="Performance">Performance (PERF)</option>
        <option value="Regulatory">Regulatory Compliance (REG)</option>
      </select>
    </div>

    <!-- Category and Priority -->
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label required">Category</label>
        <select class="form-select" id="reqCategory">
          <option value="">Select Category</option>
          <option value="User Interface">User Interface</option>
          <option value="System Functionality">System Functionality</option>
          <option value="Data Management">Data Management</option>
          <option value="Security & Access">Security & Access Control</option>
          <option value="Audit & Compliance">Audit Trail & Compliance</option>
          <option value="Integration">System Integration</option>
          <option value="Reporting">Reporting & Analytics</option>
          <option value="Validation">Validation & Testing</option>
          <option value="Business Process">Business Process</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label required">Priority (MoSCoW)</label>
        <select class="form-select" id="reqPriority">
          <option value="">Select Priority</option>
          <option value="Critical">Critical - Must Have (System Cannot Operate)</option>
          <option value="High">High - Should Have (Important for Business)</option>
          <option value="Medium">Medium - Could Have (Desirable Enhancement)</option>
          <option value="Low">Low - Won't Have Now (Future Consideration)</option>
        </select>
      </div>
    </div>

    <!-- Requirement Statement -->
    <div class="form-group">
      <label class="form-label required">Requirement Statement</label>
      <textarea class="form-textarea" id="reqDescription" placeholder="The system shall... (Use 'shall' for mandatory, 'should' for recommended)"></textarea>
      <div style="font-size: 11px; color: var(--text-dim); margin-top: 4px;">
        ✓ Be specific and measurable<br>
        ✓ Use "shall" for mandatory requirements<br>
        ✓ Include success criteria
      </div>
    </div>

    <!-- Rationale and Acceptance Criteria -->
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label required">Rationale / Business Justification</label>
        <textarea class="form-textarea" id="reqRationale" placeholder="Why is this requirement needed?"></textarea>
      </div>

      <div class="form-group">
        <label class="form-label required">Acceptance Criteria</label>
        <textarea class="form-textarea" id="reqAcceptance" placeholder="How will this be verified? Define pass/fail criteria..."></textarea>
      </div>
    </div>

    <!-- Risk and GxP Impact -->
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label required">Risk Level (Patient/Data/Product)</label>
        <select class="form-select" id="reqRisk">
          <option value="High">High - Direct impact on patient safety, data integrity, or product quality</option>
          <option value="Medium">Medium - Indirect impact requiring controls</option>
          <option value="Low">Low - Minimal impact with existing controls</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label required">GxP Impact</label>
        <select class="form-select" id="reqGxpImpact">
          <option value="">Select Impact</option>
          <option value="Direct">Direct - Critical GxP system</option>
          <option value="Indirect">Indirect - Supports GxP processes</option>
          <option value="None">None - No GxP impact</option>
        </select>
      </div>
    </div>

    <!-- Regulatory References -->
    <div class="form-group">
      <label class="form-label">Regulatory References</label>
      <div class="checkbox-group">
        <div class="checkbox-item">
          <input type="checkbox" id="ref21cfr11" value="21 CFR Part 11">
          <label for="ref21cfr11">21 CFR Part 11 (Electronic Records & Signatures)</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="refannex11" value="EU GMP Annex 11">
          <label for="refannex11">EU GMP Annex 11 (Computerized Systems)</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="refgamp5" value="GAMP 5">
          <label for="refgamp5">GAMP 5 (Good Automated Manufacturing Practice)</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="refich" value="ICH Q7/Q9/Q10">
          <label for="refich">ICH Q7/Q9/Q10 (Quality Management)</label>
        </div>
        <div class="checkbox-item">
          <input type="checkbox" id="refalcoa" value="ALCOA+">
          <label for="refalcoa">ALCOA+ Principles (Data Integrity)</label>
        </div>
      </div>
    </div>

    <!-- Additional Details -->
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label">Source Document Reference</label>
        <input type="text" class="form-input" id="reqSource" placeholder="e.g., Business Requirements Doc v1.2, Section 3.4">
      </div>

      <div class="form-group">
        <label class="form-label required">Requirement Owner</label>
        <input type="text" class="form-input" id="reqOwner" placeholder="Name of business/process owner">
      </div>
    </div>

    <!-- Comments -->
    <div class="form-group">
      <label class="form-label">Additional Comments / Notes</label>
      <textarea class="form-textarea" id="reqComments" placeholder="Any additional information, dependencies, or constraints..."></textarea>
    </div>

    <!-- Action Buttons -->
    <div style="display: flex; gap: 12px; margin-top: 30px;">
      <button class="btn btn-secondary" onclick="closeAddRequirementModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmAddRequirement()" style="flex: 1;">
        ✓ Add Requirement
      </button>
    </div>
  </div>
</div>

<div id="viewRequirementModal" class="modal">
  <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
    <div class="modal-header">
      <h2 id="viewReqTitle">Requirement Details</h2>
      <button class="close-btn" onclick="closeViewRequirementModal()">&times;</button>
    </div>
    
    <div class="modal-body">
      <!-- Action Buttons at Top -->
      <div style="display: flex; gap: 12px; margin-bottom: 20px; padding: 12px; background: #f9fafb; border-radius: 8px;">
        <button class="btn btn-primary" onclick="openEditRequirementModal()" style="flex: 1;">
          ✏️ Edit Requirement
        </button>
        <button class="btn btn-secondary" onclick="toggleAuditTrail()" style="flex: 1;">
          📋 View Audit Trail
        </button>
        <button class="btn btn-secondary" onclick="exportRequirementPDF()" style="flex: 1;">
          📄 Export PDF
        </button>
      </div>


      <div id="viewReqContent"></div>

            <!-- Audit Trail Section (Initially Hidden) -->
      <div id="auditTrailSection" style="display: none; margin-top: 30px; padding-top: 30px; border-top: 2px solid var(--border);">
        <h3 style="font-size: 18px; font-weight: 700; margin-bottom: 16px;">📋 Audit Trail</h3>
        <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 12px;">
          <strong>Compliance Note:</strong> All changes are tracked per 21 CFR Part 11 requirements for audit trails.
        </div>
        <div id="auditTrailContent">
          <div style="text-align: center; padding: 20px; color: var(--text-dim);">
            Loading audit trail...
          </div>
        </div>
      </div>

      <!-- Test Cases Section -->
      <div style="margin-top: 30px; padding-top: 30px; border-top: 2px solid var(--border);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h3 style="font-size: 18px; font-weight: 700;">🔗 Linked Test Cases (Traceability)</h3>
          <button class="btn btn-primary" onclick="openLinkTestCaseModal()" style="font-size: 12px; padding: 8px 16px;">
            ➕ Link Test Case
          </button>
        </div>
        
        <div style="background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.3); padding: 12px; border-radius: 8px; margin-bottom: 16px; font-size: 12px; color: #93c5fd;">
          <strong>Traceability Note:</strong> Each requirement must be verified by at least one test case (IQ/OQ/PQ/UAT) to ensure compliance.
        </div>

        <div id="linkedTestCases" style="display: flex; flex-direction: column; gap: 12px;">
          <div style="text-align: center; padding: 20px; color: var(--text-dim); background: var(--surface); border-radius: 12px;">
            No test cases linked yet. Click "Link Test Case" to add traceability.
          </div>
        </div>
      </div>

      <button class="btn btn-secondary" onclick="closeViewRequirementModal()" style="margin-top: 30px; width: 100%;">Close</button>
    </div>
  </div>
</div>

<!-- Link Test Case Modal - FIXED VERSION -->
<div id="linkTestCaseModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Link Test Case to Requirement</h2>
      <button class="close-btn" onclick="closeLinkTestCaseModal()">&times;</button>
    </div>

    <div style="background: var(--accent-dim); border: 1px solid var(--accent); padding: 16px; border-radius: 12px; margin-bottom: 20px; font-size: 13px;">
      <strong>Linking to:</strong> <span id="linkingToReq"></span>
    </div>

    <div class="form-group">
      <label class="form-label required">Test Case ID</label>
      <input type="text" class="form-input" id="testCaseId" placeholder="e.g., TC-001">
    </div>

    <div class="form-group">
      <label class="form-label required">Test Case Name</label>
      <input type="text" class="form-input" id="testCaseName" placeholder="e.g., Verify login functionality">
    </div>

    <div class="form-grid">
      <div class="form-group">
        <label class="form-label required">Test Type</label>
        <select class="form-select" id="testType">
          <option value="IQ">Installation Qualification (IQ)</option>
          <option value="OQ">Operational Qualification (OQ)</option>
          <option value="PQ">Performance Qualification (PQ)</option>
          <option value="UAT">User Acceptance Testing (UAT)</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Test Status</label>
        <select class="form-select" id="testStatus">
          <option value="Not Started">Not Started</option>
          <option value="In Progress">In Progress</option>
          <option value="Passed">Passed</option>
          <option value="Failed">Failed</option>
        </select>
      </div>
    </div>

    <div class="form-group">
      <label class="form-label">Test Description</label>
      <textarea class="form-textarea" id="testDescription" placeholder="Describe what this test case validates"></textarea>
    </div>

    <div style="display: flex; gap: 12px; margin-top: 30px;">
      <button class="btn btn-secondary" onclick="closeLinkTestCaseModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmLinkTestCase()">Link Test Case</button>
    </div>
  </div>
</div>
<!-- ✅ IMPORTANT: Link Test Case Modal properly closed above -->


<!-- Edit Requirement Modal -->
<div id="editRequirementModal" class="modal">
  <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto;">
    <div class="modal-header">
      <h2 class="modal-title">✏️ Edit Requirement</h2>
      <button class="close-btn" onclick="closeEditRequirementModal()">&times;</button>
    </div>

    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); padding: 16px; border-radius: 12px; margin-bottom: 24px; font-size: 13px;">
      <strong>⚠️ Change Control:</strong> All edits will be logged in the audit trail with timestamp and user information per 21 CFR Part 11.
    </div>

    <!-- Requirement ID (Read-only) -->
    <div class="form-group">
      <label class="form-label">Requirement ID</label>
      <input type="text" class="form-input" id="editReqId" readonly style="background: rgba(255,255,255,0.02); cursor: not-allowed;">
    </div>

    <!-- Requirement Type -->
    <div class="form-group">
      <label class="form-label required">Requirement Type</label>
      <select class="form-select" id="editReqType">
        <option value="">Select Type</option>
        <option value="Functional">Functional (FR)</option>
        <option value="Non-Functional">Non-Functional (NFR)</option>
        <option value="Data Integrity">Data Integrity (DI)</option>
        <option value="Security">Security (SEC)</option>
        <option value="Audit Trail">Audit Trail (AT)</option>
        <option value="Electronic Signature">Electronic Signature (ES)</option>
        <option value="Interface">Interface (INT)</option>
        <option value="Performance">Performance (PERF)</option>
        <option value="Regulatory">Regulatory Compliance (REG)</option>
      </select>
    </div>

    <!-- Category and Priority -->
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label required">Category</label>
        <select class="form-select" id="editReqCategory">
          <option value="">Select Category</option>
          <option value="User Interface">User Interface</option>
          <option value="System Functionality">System Functionality</option>
          <option value="Data Management">Data Management</option>
          <option value="Security & Access">Security & Access Control</option>
          <option value="Audit & Compliance">Audit Trail & Compliance</option>
          <option value="Integration">System Integration</option>
          <option value="Reporting">Reporting & Analytics</option>
          <option value="Validation">Validation & Testing</option>
          <option value="Business Process">Business Process</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label required">Priority (MoSCoW)</label>
        <select class="form-select" id="editReqPriority">
          <option value="">Select Priority</option>
          <option value="Critical">Critical - Must Have</option>
          <option value="High">High - Should Have</option>
          <option value="Medium">Medium - Could Have</option>
          <option value="Low">Low - Won't Have Now</option>
        </select>
      </div>
    </div>

    <!-- Requirement Statement -->
    <div class="form-group">
      <label class="form-label required">Requirement Statement</label>
      <textarea class="form-textarea" id="editReqDescription" rows="4"></textarea>
    </div>

    <!-- Rationale and Acceptance Criteria -->
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label required">Rationale / Business Justification</label>
        <textarea class="form-textarea" id="editReqRationale" rows="3"></textarea>
      </div>

      <div class="form-group">
        <label class="form-label required">Acceptance Criteria</label>
        <textarea class="form-textarea" id="editReqAcceptance" rows="3"></textarea>
      </div>
    </div>

    <!-- Risk and GxP Impact -->
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label required">Risk Level</label>
        <select class="form-select" id="editReqRisk">
          <option value="High">High - Direct impact on patient safety/data integrity</option>
          <option value="Medium">Medium - Indirect impact requiring controls</option>
          <option value="Low">Low - Minimal impact with existing controls</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label required">GxP Impact</label>
        <select class="form-select" id="editReqGxpImpact">
          <option value="">Select Impact</option>
          <option value="Direct">Direct - Critical GxP system</option>
          <option value="Indirect">Indirect - Supports GxP processes</option>
          <option value="None">None - No GxP impact</option>
        </select>
      </div>
    </div>

    <!-- Additional Details -->
    <div class="form-grid">
      <div class="form-group">
        <label class="form-label">Source Document Reference</label>
        <input type="text" class="form-input" id="editReqSource">
      </div>

      <div class="form-group">
        <label class="form-label required">Requirement Owner</label>
        <input type="text" class="form-input" id="editReqOwner">
      </div>
    </div>

    <!-- Comments -->
    <div class="form-group">
      <label class="form-label">Additional Comments / Notes</label>
      <textarea class="form-textarea" id="editReqComments" rows="2"></textarea>
    </div>

    <!-- Change Reason (Required for Audit Trail) -->
    <div class="form-group">
      <label class="form-label required">Change Reason (For Audit Trail)</label>
      <textarea class="form-textarea" id="editChangeReason" placeholder="Explain why this requirement is being modified..." rows="3" required></textarea>
      <small style="color: var(--text-dim); font-size: 12px;">This will be recorded in the audit trail for compliance purposes.</small>
    </div>

    <!-- Electronic Signature -->
    <div class="form-group">
      <label class="form-label">Electronic Signature Confirmation</label>
      <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); padding: 12px; border-radius: 8px; margin-bottom: 8px;">
        <div style="font-size: 12px; color: #3b82f6; margin-bottom: 4px;">
          <strong>Signed by:</strong> <span id="currentUserEmail">Loading...</span>
        </div>
        <div style="font-size: 11px; color: #6b7280;">
          Per 21 CFR Part 11, this change will be electronically signed with your authenticated user credentials.
        </div>
      </div>
      <input type="text" class="form-input" id="editUserName" placeholder="Enter your name to confirm (optional)">
      <small style="color: var(--text-dim); font-size: 12px;">Your email and user ID will be recorded automatically.</small>
    </div>



    <!-- Action Buttons -->
    <div style="display: flex; gap: 12px; margin-top: 30px;">
      <button class="btn btn-secondary" onclick="closeEditRequirementModal()">Cancel</button>
      <button class="btn btn-primary" onclick="confirmEditRequirement()" style="flex: 1;">
        ✓ Save Changes & Update Audit Trail
      </button>
    </div>
  </div>
</div>
 

<!-- Sprint Modal -->
<div id="sprintModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Create New Sprint</h2>
            <button class="close-btn" onclick="closeSprintModal()">&times;</button>
        </div>

        <form id="sprintForm" onsubmit="createSprint(event)">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label required">Sprint Number</label>
                    <input type="number" class="form-input" id="sprintNumber" min="1" required>
                </div>

                <div class="form-group">
                    <label class="form-label required">Sprint Name</label>
                    <input type="text" class="form-input" id="sprintName" placeholder="e.g., Sprint 1 - User Management" required>
                </div>

                <div class="form-group full">
                    <label class="form-label">Sprint Goal</label>
                    <textarea class="form-textarea" id="sprintGoal" placeholder="What will be achieved in this sprint?"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label required">Start Date</label>
                    <input type="date" class="form-input" id="sprintStartDate" required>
                </div>

                <div class="form-group">
                    <label class="form-label required">End Date</label>
                    <input type="date" class="form-input" id="sprintEndDate" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Planned Story Points</label>
                    <input type="number" class="form-input" id="plannedStoryPoints" min="0">
                </div>

                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-select" id="sprintStatus">
                        <option value="Planned">Planned</option>
                        <option value="Active">Active</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 30px;">
                <button type="button" class="btn btn-secondary" onclick="closeSprintModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" style="flex: 1;">Create Sprint</button>
            </div>
        </form>
    </div>
</div>

<!-- New Test Suite Modal -->
<div id="testSuiteModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Create Test Suite</h2>
            <button class="close-btn" onclick="closeTestSuiteModal()">&times;</button>
        </div>

        <form id="testSuiteForm" onsubmit="createTestSuite(event)">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label required">Test Suite ID</label>
                    <input type="text" class="form-input" id="testSuiteId" placeholder="e.g., TS-IQ-001" required>
                </div>

                <div class="form-group">
                    <label class="form-label required">Test Type</label>
                    <select class="form-select" id="testType" required>
                        <option value="">Select Type</option>
                        <option value="IQ">IQ - Installation Qualification</option>
                        <option value="OQ">OQ - Operational Qualification</option>
                        <option value="PQ">PQ - Performance Qualification</option>
                        <option value="UAT">UAT - User Acceptance Testing</option>
                        <option value="SIT">SIT - System Integration Testing</option>
                        <option value="Regression">Regression Testing</option>
                    </select>
                </div>

                <div class="form-group full">
                    <label class="form-label required">Test Suite Name</label>
                    <input type="text" class="form-input" id="testSuiteName" placeholder="e.g., System Hardware Installation Verification" required>
                </div>

                <div class="form-group full">
                    <label class="form-label">Test Objective</label>
                    <textarea class="form-textarea" id="testObjective" placeholder="What is the purpose of this test suite?"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Assigned To</label>
                    <input type="text" class="form-input" id="testAssignedTo" placeholder="Test Lead Name">
                </div>

                <div class="form-group">
                    <label class="form-label">Planned Execution Date</label>
                    <input type="date" class="form-input" id="testPlannedDate">
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 30px;">
                <button type="button" class="btn btn-secondary" onclick="closeTestSuiteModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" style="flex: 1;">Create Test Suite</button>
            </div>
        </form>
    </div>
</div>

<!-- Add Test Case to Suite Modal -->
<div id="addTestCaseModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Add Test Case</h2>
            <button class="close-btn" onclick="closeAddTestCaseModal()">&times;</button>
        </div>

        <form id="testCaseForm" onsubmit="addTestCase(event)">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label required">Test Case ID</label>
                    <input type="text" class="form-input" id="tcId" placeholder="e.g., TC-IQ-001" required>
                </div>

                <div class="form-group">
                    <label class="form-label required">Link to Requirement</label>
                    <select class="form-select" id="tcRequirement" required>
                        <option value="">Select Requirement</option>
                    </select>
                </div>

                <div class="form-group full">
                    <label class="form-label required">Test Case Title</label>
                    <input type="text" class="form-input" id="tcTitle" placeholder="e.g., Verify power supply installation" required>
                </div>

                <div class="form-group full">
                    <label class="form-label required">Test Procedure</label>
                    <textarea class="form-textarea" id="tcProcedure" placeholder="Step-by-step procedure..." required></textarea>
                </div>

                <div class="form-group full">
                    <label class="form-label required">Expected Result</label>
                    <textarea class="form-textarea" id="tcExpected" placeholder="What should happen..." required></textarea>
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 30px;">
                <button type="button" class="btn btn-secondary" onclick="closeAddTestCaseModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" style="flex: 1;">Add Test Case</button>
            </div>
        </form>
    </div>
</div>

<!-- Execute Test Case Modal -->
<div id="executeTestModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Execute Test Case</h2>
            <button class="close-btn" onclick="closeExecuteTestModal()">&times;</button>
        </div>

        <div id="executeTestContent">
            <!-- Will be populated dynamically -->
        </div>

        <form id="executeTestForm" onsubmit="saveTestExecution(event)">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label required">Test Result</label>
                    <select class="form-select" id="testResult" required onchange="toggleDeviationFields()">
                        <option value="">Select Result</option>
                        <option value="Pass">Pass</option>
                        <option value="Fail">Fail</option>
                        <option value="N/A">N/A</option>
                        <option value="Blocked">Blocked</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label required">Executed By</label>
                    <input type="text" class="form-input" id="executedBy" placeholder="Your name" required>
                </div>

                <div class="form-group full">
                    <label class="form-label">Actual Result</label>
                    <textarea class="form-textarea" id="actualResult" placeholder="What actually happened..."></textarea>
                </div>

                <div id="deviationFields" style="display: none; grid-column: 1 / -1;">
                    <div class="form-group">
                        <label class="form-label">Deviation Number</label>
                        <input type="text" class="form-input" id="deviationNumber" placeholder="e.g., DEV-2025-001">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Deviation Justification</label>
                        <textarea class="form-textarea" id="deviationJustification" placeholder="Explain the deviation..."></textarea>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 30px;">
                <button type="button" class="btn btn-secondary" onclick="closeExecuteTestModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" style="flex: 1;">Save Execution</button>
            </div>
        </form>
    </div>
</div>

<!-- New Application Modal -->
<div id="applicationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">New Application/System</h2>
            <button class="close-btn" onclick="closeApplicationModal()">&times;</button>
        </div>

        <form id="applicationForm" onsubmit="createApplication(event)">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label required">Application Name</label>
                    <input type="text" class="form-input" id="appName" placeholder="e.g., LabWare LIMS" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Application Code</label>
                    <input type="text" class="form-input" id="appCode" placeholder="e.g., LIMS-LAB">
                </div>

                <div class="form-group">
                    <label class="form-label">System Type</label>
                    <select class="form-select" id="appSystemType">
                        <option value="">Select Type</option>
                        <option value="LIMS">LIMS</option>
                        <option value="ERP">ERP (SAP, Oracle)</option>
                        <option value="MES">MES</option>
                        <option value="QMS">QMS</option>
                        <option value="EDMS">EDMS</option>
                        <option value="Chromatography">Chromatography Data System</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Vendor Name</label>
                    <input type="text" class="form-input" id="appVendor" placeholder="e.g., LabWare Inc.">
                </div>

                <div class="form-group">
                    <label class="form-label">Current Version</label>
                    <input type="text" class="form-input" id="appVersion" placeholder="e.g., v8.5">
                </div>

                <div class="form-group">
                    <label class="form-label">System Owner</label>
                    <input type="text" class="form-input" id="appOwner" placeholder="Business owner name">
                </div>

                <div class="form-group">
                    <label class="form-label">Business Unit</label>
                    <input type="text" class="form-input" id="appBusinessUnit" placeholder="e.g., QC Lab">
                </div>

                <div class="form-group">
                  <label class="form-label">GxP Impact</label>
                  <select class="form-select" id="appGxpImpact">
                      <option value="">Select Impact</option>
                      <option value="Direct">Direct - Affects product quality/patient safety</option>
                      <option value="Indirect">Indirect - Supports GxP processes</option>
                      <option value="None">None - No GxP impact</option>
                  </select>
                </div>

                <div class="form-group full">
                    <label class="form-label">System Description</label>
                    <textarea class="form-textarea" id="appDescription" placeholder="Brief description of the system purpose..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Installation Date</label>
                    <input type="date" class="form-input" id="appInstallDate">
                </div>

                <div class="form-group">
                    <label class="form-label">Go-Live Date</label>
                    <input type="date" class="form-input" id="appGoLiveDate">
                </div>
            </div>

            <div style="display: flex; gap: 12px; margin-top: 30px;">
                <button type="button" class="btn btn-secondary" onclick="closeApplicationModal()">Cancel</button>
                <button type="submit" class="btn btn-primary" style="flex: 1;">Create Application</button>
            </div>
        </form>
    </div>
</div>

<!-- Version Management Modal -->
<div id="versionManagementModal" class="modal">
    <div class="modal-content" style="max-width: 1200px;">
        <div class="modal-header">
            <h2 class="modal-title">📋 Version Management</h2>
            <button class="close-btn" onclick="closeVersionManagement()">&times;</button>
        </div>
        
        <div style="display: flex; gap: 12px; margin-bottom: 24px;">
            <select id="versionAppFilter" class="form-select" onchange="filterVersionsByApp()" style="flex: 1;">
                <option value="">All Applications</option>
            </select>
            <button class="btn btn-primary" onclick="openNewVersionModal()">+ New Version</button>
        </div>
        
        <div id="versionsListContainer">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Application</th>
                        <th>Version</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Go-Live Date</th>
                        <th>Projects</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="versionsTableBody">
                    <tr><td colspan="7" style="text-align: center; padding: 40px;">Loading versions...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- New Version Modal -->
<div id="newVersionModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h2 class="modal-title">➕ New Version</h2>
            <button class="close-btn" onclick="closeNewVersionModal()">&times;</button>
        </div>
        
        <form id="versionForm" onsubmit="event.preventDefault(); createVersion();">
            <div class="form-group">
                <label class="form-label required">Application</label>
                <select class="form-select" id="versionAppId" required>
                    <option value="">Select Application</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label required">Version Number</label>
                <input type="text" class="form-input" id="versionNumber" placeholder="e.g., 8.5.1" pattern="^\d+\.\d+(\.\d+)?$" required>
                <small style="color: var(--text-dim); font-size: 12px;">Format: MAJOR.MINOR or MAJOR.MINOR.PATCH (e.g., 8.5 or 8.5.1)</small>
            </div>
            
            <div class="form-group">
                <label class="form-label required">Version Type</label>
                <select class="form-select" id="versionType" required onchange="updateValidationApproach()">
                    <option value="">Select Type</option>
                    <option value="Major">Major Release (Breaking changes)</option>
                    <option value="Minor">Minor Release (New features)</option>
                    <option value="Patch">Patch (Bug fixes)</option>
                    <option value="Configuration">Configuration Only</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Validation Approach</label>
                <select class="form-select" id="validationApproach">
                    <option value="">Select Approach</option>
                    <option value="Full CSV">Full CSV (IQ/OQ/PQ)</option>
                    <option value="Partial Validation">Partial Validation (Risk-based OQ/PQ)</option>
                    <option value="Impact Assessment">Impact Assessment + Testing</option>
                    <option value="Configuration OQ">Configuration OQ Only</option>
                </select>
            </div>
            
            <div class="form-group">
                <label class="form-label">Release Date</label>
                <input type="date" class="form-input" id="releaseDate">
            </div>
            
            <div class="form-group">
                <label class="form-label">Planned Go-Live Date</label>
                <input type="date" class="form-input" id="goLiveDate">
            </div>
            
            <div class="form-group">
                <label class="form-label">Change Description</label>
                <textarea class="form-input" id="changeDescription" rows="4" placeholder="Describe what changed in this version..."></textarea>
            </div>
            
            <div class="form-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="isProduction">
                    <span>Mark as Production Version</span>
                </label>
            </div>
            
            <div class="btn-group">
                <button type="button" class="btn btn-secondary" onclick="closeNewVersionModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Create Version</button>
            </div>
        </form>
    </div>
</div>


  <script>
    // ========== STATE MANAGEMENT ==========
    let projects = [];
    let selectedProjectForDeliverables = null;
    let currentGAMPCategory = 'Category 3';


  const SUPABASE_URL = 'https://nufpaayytxtjihqrvtfi.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51ZnBhYXl5dHh0amlocXJ2dGZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjAzMzA5NjIsImV4cCI6MjA3NTkwNjk2Mn0.766ENc3lMQSVJIsyxK6xlPE5DNlB3Np3eeXxvcoRGGY';
  
  const { createClient } = supabase;
  const supabaseClient = createClient(SUPABASE_URL, SUPABASE_KEY);

    // ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', async () => {
  await loadProjectsFromDatabase();
  updateDashboard();
  loadApplications();
});

// Store current user information
let currentUser = null;

// Get current user on page load
async function getCurrentUser() {
    try {
        const { data: { user }, error } = await supabaseClient.auth.getUser();
        if (error) throw error;
        currentUser = user;
        console.log('Current user:', currentUser);
        return user;
    } catch (error) {
        console.error('Error getting current user:', error);
        return null;
    }
}

// Call this when page loads
getCurrentUser();


    // ========== STORAGE ==========
    function saveProjects() {
  loadProjectsFromDatabase();
}

async function loadProjects() {
  await loadProjectsFromDatabase();
}

async function loadProjectsFromDatabase() {
    try {
        const { data: projectsData, error: projectsError } = await supabaseClient
            .from('validation_projects')
            .select(`
                *,
                validation_deliverables(*)
            `)
            .order('created_at', { ascending: false });

        if (projectsError) {
            console.error('Supabase error:', projectsError);
            throw projectsError;
        }

        console.log('Loaded projects from database:', projectsData);

        // Transform database structure to match your app structure
        projects = projectsData.map(proj => ({
            id: proj.id,
            projectNumber: proj.project_number,
            projectName: proj.project_name,
            systemName: proj.system_name,
            description: proj.system_description,
            projectType: proj.project_type,
            gxpImpact: proj.gxp_impact,
            vendor: proj.vendor_name,
            gampCategory: proj.gamp_category,
            methodology: proj.methodology,
            agileFramework: proj.agile_framework,
            validationLead: proj.validation_lead,
            systemOwner: proj.system_owner,
            startDate: proj.planned_start_date,
            goLiveDate: proj.planned_go_live_date,
            status: proj.status,
            progress: 0, // Will calculate below
            createdAt: proj.created_at,
            applicationId: proj.application_id,  // ADD THIS LINE
            deliverables: (proj.validation_deliverables || []).map(del => ({
                code: del.deliverable_code,
                name: del.deliverable_name,
                phase: del.phase,
                status: del.status === 'Completed' ? 'completed' : del.status === 'In Progress' ? 'inprogress' : 'pending',
                createdAt: del.created_at,
                isCustom: !del.is_mandatory
            })),
            requirements: [] // Will be loaded separately when needed
        }));

        // Calculate progress for each project
        projects.forEach(proj => {
            const completed = proj.deliverables.filter(d => d.status === 'completed').length;
            const total = proj.deliverables.length;
            proj.progress = total > 0 ? Math.round((completed / total) * 100) : 0;
        });

        console.log('Transformed projects:', projects);

        // Render projects
        await renderProjects(projects);
        updateProjectSelector();
        updateDashboard();

    } catch (error) {
        console.error('Error loading projects:', error);
        showAlert('Failed to load projects from database', 'error');
        
        // Set projects to empty array so UI doesn't break
        projects = [];
        
        // Show error in UI
        const tbody = document.getElementById('projectsTableBody');
        if (tbody) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: #ef4444;">
                        ✕ Failed to load projects from database<br>
                        <small style="color: var(--text-dim); margin-top: 8px; display: block;">Error: ${error.message}</small>
                        <button class="btn btn-primary" onclick="loadProjectsFromDatabase()" style="margin-top: 16px;">Retry</button>
                    </td>
                </tr>
            `;
        }
        
        updateDashboard();
    }
}


    // ========== GAMP CLASSIFICATION ==========
function updateGAMPPreview() {
  const isInfra = document.getElementById('isInfrastructure').checked;
  const isCOTS = document.getElementById('isCOTS').checked;
  const isConfig = document.getElementById('isConfigurable').checked;
  const hasCustom = document.getElementById('hasCustomCode').checked;
  const isCustomDev = document.getElementById('isCustomDeveloped').checked;

  let category = 'Category 3';  // Changed from 'GAMP3'
  let displayName = 'GAMP 3';   // For display only
  let description = 'Non-configured COTS Product - Standard software used as-is';

  if (isInfra) {
    category = 'Category 3';
    displayName = 'GAMP 3';
    description = 'Infrastructure Software - Low risk, minimal testing required';
  } else if (isCOTS && !isConfig && !hasCustom) {
    category = 'Category 3';
    displayName = 'GAMP 3';
    description = 'Non-configured COTS - Standard product, IQ/OQ required';
  } else if (isConfig && !hasCustom && !isCustomDev) {
    category = 'Category 4';
    displayName = 'GAMP 4';
    description = 'Configured Software (LIMS, MES, ERP) - Configuration testing, IQ/OQ/PQ required';
  } else if (hasCustom || isCustomDev) {
    category = 'Category 5';
    displayName = 'GAMP 5';
    description = 'Custom Application - Full SDLC, extensive testing, FS/DS/IQ/OQ/PQ required';
  }

  currentGAMPCategory = category;  // This is what gets saved to database
  document.getElementById('gampResult').style.display = 'block';
  document.getElementById('gampCategoryText').textContent = displayName;  // This is what user sees
  document.getElementById('gampDescText').textContent = description;
}

    // ========== DELIVERABLES GENERATION ==========
function getDeliverablesForGAMP(gampCategory) {
  const base = [
    { code: 'VMP', name: 'Validation Master Plan', phase: 'Planning', status: 'pending' },
    { code: 'VMP', name: 'Validation Plan', phase: 'Planning', status: 'pending' },
    { code: 'URS', name: 'User Requirements Specification', phase: 'Requirements', status: 'pending' },
    { code: 'RA', name: 'Risk Assessment', phase: 'Planning', status: 'pending' },
    { code: 'IQ', name: 'Installation Qualification', phase: 'Testing', status: 'pending' },
    { code: 'OQ', name: 'Operational Qualification', phase: 'Testing', status: 'pending' },
    { code: 'PQ', name: 'Performance Qualification', phase: 'Testing', status: 'pending' },
    { code: 'RTM', name: 'Requirements Traceability Matrix', phase: 'Testing', status: 'pending' }, // Changed from 'Verification'
    { code: 'VSR', name: 'Validation Summary Report', phase: 'Release', status: 'pending' },
  ];

  if (gampCategory === 'Category 4' || gampCategory === 'Category 5') {
    base.push(
      { code: 'FS', name: 'Functional Specification', phase: 'Design', status: 'pending' },
      { code: 'SAT', name: 'Supplier Assessment & Testing', phase: 'Design', status: 'pending' }
    );
  }

  if (gampCategory === 'Category 5') {
    base.push(
      { code: 'DS', name: 'Design Specification', phase: 'Design', status: 'pending' },
      { code: 'CODE', name: 'Code Review Report', phase: 'Build', status: 'pending' },
      { code: 'UT', name: 'Unit Testing Report', phase: 'Build', status: 'pending' },
      { code: 'IT', name: 'Integration Testing Report', phase: 'Testing', status: 'pending' }
    );
  }

  return base;
}



    // ========== PROJECT MANAGEMENT ==========
async function createProject() {
  const projectName = document.getElementById('projectName').value.trim();
  const systemName = document.getElementById('systemName').value.trim();
  const methodology = document.getElementById('methodology').value;

  if (!projectName || !systemName || !methodology) {
    showAlert('Please fill all required fields', 'error');
    return;
  }

  // Generate a unique project number
  const timestamp = Date.now();
  const projectNumber = `VAL-${currentGAMPCategory}-${timestamp}`;
  const projectId = `VAL-${currentGAMPCategory}-${timestamp}-${Math.random().toString(36).substr(2, 4).toUpperCase()}`;

  try {
    showAlert('Creating project...', 'info');

    console.log('Project data being sent:', {
  project_name: projectName,
  system_name: systemName,
  project_type: document.getElementById('projectType').value,
  gxp_impact: document.getElementById('gxpImpact').value,
  gamp_category: currentGAMPCategory,
  methodology: methodology
});

    // Insert project into Supabase validation_projects table
    const { data: projectData, error: projectError } = await supabaseClient
      .from('validation_projects')
      .insert([{
        id: projectId,
        project_number: projectNumber,
        project_name: projectName,
        system_name: systemName,
        application_id: document.getElementById('projectApplication').value,
        system_description: document.getElementById('systemDescription').value || null,
        project_type: document.getElementById('projectType').value || null,
        gxp_impact: document.getElementById('gxpImpact').value || null,
        vendor_name: document.getElementById('vendor').value || null,
        gamp_category: currentGAMPCategory,
        gamp_auto_classified: true,
        methodology: methodology,
        agile_framework: document.getElementById('agileFramework').value || 'N/A',
        validation_lead: document.getElementById('validationLead').value || null,
        system_owner: document.getElementById('systemOwner').value || null,
        planned_start_date: document.getElementById('startDate').value || null,
        planned_go_live_date: document.getElementById('goLiveDate').value || null,
        status: 'Planning',
        current_phase: 'Planning',
        created_by: document.getElementById('validationLead').value || 'System',
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      }])
      .select();

    if (projectError) {
  console.error('Full error object:', projectError);
  throw new Error(`Database error: ${projectError.message} - ${projectError.details}`);
}

    // Generate and insert deliverables
    const deliverables = getDeliverablesForGAMP(currentGAMPCategory);
    const deliverableInserts = deliverables.map(del => ({
      project_id: projectId,
      deliverable_code: del.code,
      deliverable_name: del.name,
      phase: del.phase,
      status: 'Not Started',
      is_mandatory: true,
      applicable_gamp_categories: [currentGAMPCategory],
      created_at: new Date().toISOString()
    }));

    const { error: delError } = await supabaseClient
      .from('validation_deliverables')
      .insert(deliverableInserts);

    if (delError) throw delError;

    showAlert(`✓ Project "${projectName}" created with ${deliverables.length} deliverables!`, 'success');
    closeProjectModal();
    
    // Reload projects from database
    await loadProjectsFromDatabase();
    switchTab('projects');
    resetProjectForm();

  } catch (error) {
    console.error('Error creating project:', error);
    showAlert(`Failed to create project: ${error.message}`, 'error');
  }
}



    function resetProjectForm() {
      document.getElementById('projectName').value = '';
      document.getElementById('systemName').value = '';
      document.getElementById('systemDescription').value = '';
      document.getElementById('projectType').value = '';
      document.getElementById('gxpImpact').value = '';
      document.getElementById('vendor').value = '';
      document.getElementById('methodology').value = '';
      document.getElementById('agileFramework').value = 'N/A';
      document.getElementById('validationLead').value = '';
      document.getElementById('systemOwner').value = '';
      document.getElementById('startDate').value = '';
      document.getElementById('goLiveDate').value = '';
      document.getElementById('isInfrastructure').checked = false;
      document.getElementById('isCOTS').checked = false;
      document.getElementById('isConfigurable').checked = false;
      document.getElementById('hasCustomCode').checked = false;
      document.getElementById('isCustomDeveloped').checked = false;
      document.getElementById('gampResult').style.display = 'none';
      currentGAMPCategory = 'Category 3';
      setWizardStep(1);
    }

    // ==========================================
// HELPER FUNCTIONS FOR RENDERING
// ==========================================

function getGAMPBadgeClass(gampCategory) {
    const classMap = {
        'Category 1': 'status-completed',
        'Category 3': 'status-inprogress',
        'Category 4': 'status-pending',
        'Category 5': 'status-pending'
    };
    return classMap[gampCategory] || 'status-pending';
}

function getStatusClass(status) {
    const classMap = {
        'Planning': 'status-pending',
        'In Progress': 'status-inprogress',
        'Testing': 'status-inprogress',
        'Completed': 'status-completed',
        'On Hold': 'status-pending',
        'Cancelled': 'status-pending'
    };
    return classMap[status] || 'status-pending';
}


async function renderProjects(projects) {
    const tbody = document.getElementById('projectsTableBody');
    
    if (!projects || projects.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 40px; color: var(--text-dim);">No projects found</td></tr>';
        return;
    }

    // Load applications for display - MOVED OUTSIDE the map
    let appMap = {};
    try {
        const { data: applications, error } = await supabaseClient
            .from('applications')
            .select('id, application_name');
        
        if (!error && applications) {
            applications.forEach(app => {
                appMap[app.id] = app.application_name;
            });
        }
    } catch (err) {
        console.error('Error loading applications for display:', err);
        // Continue without applications - just show projects
    }

    // NOW render the HTML - NO await inside map
    tbody.innerHTML = projects.map(proj => {
        const appName = proj.application_id && appMap[proj.application_id] 
            ? appMap[proj.application_id] 
            : 'No Application';
        
        return `
            <tr onclick="viewProjectDetails('${proj.id}')" style="cursor: pointer;">
                <td>
                    <div style="font-weight: 600; font-family: monospace; font-size: 12px;">${proj.project_number || 'N/A'}</div>
                    <div style="font-size: 11px; color: var(--text-dim); margin-top: 4px;">
                        ${proj.application_id ? `📱 ${appName}` : '⚠️ No Application'}
                    </div>
                </td>
                <td>${proj.system_name || 'N/A'}</td>
                <td><span class="status-tag ${getGAMPBadgeClass(proj.gamp_category)}">${proj.gamp_category || 'N/A'}</span></td>
                <td><span class="status-tag ${getStatusClass(proj.status)}">${proj.status || 'Planning'}</span></td>
                <td>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="flex: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                            <div style="width: ${proj.progress || 0}%; height: 100%; background: var(--accent);"></div>
                        </div>
                        <span style="font-size: 12px; color: var(--text-dim); min-width: 35px;">${proj.progress || 0}%</span>
                    </div>
                </td>
                <td>
                    <button class="btn btn-primary" onclick="event.stopPropagation(); viewProjectDetails('${proj.id}')" style="padding: 6px 16px; font-size: 13px;">View</button>
                </td>
            </tr>
        `;
    }).join('');
}



function viewProjectDetails(projectId) {
  const proj = projects.find(p => p.id === projectId);
  if (!proj) return;

  selectedProjectForDeliverables = projectId;
  
  // Set the project selector value
  const selector = document.getElementById('projectSelector');
  if (selector) {
    selector.value = projectId;
  }
  
  switchTab('deliverables');
  loadProjectDeliverables();
}

    // ========== DELIVERABLES ==========
    function loadProjectDeliverables() {
      const selector = document.getElementById('projectSelector');
      const projectId = selector.value;

      if (!projectId) {
        document.getElementById('phasesContainer').innerHTML = '';
        document.getElementById('addDelBtn').style.display = 'none';
        return;
      }

      const proj = projects.find(p => p.id === projectId);
      if (!proj) return;

      selectedProjectForDeliverables = projectId;
      document.getElementById('addDelBtn').style.display = 'block';
      renderPhaseWiseDeliverables(proj);
    }

    function renderPhaseWiseDeliverables(proj) {
      const phases = ['Planning', 'Requirements', 'Design', 'Build', 'Testing', 'Verification', 'Release'];
      const container = document.getElementById('phasesContainer');
      
      let html = '';

      phases.forEach(phase => {
        const phaseDeliverables = proj.deliverables.filter(d => d.phase === phase);
        
        if (phaseDeliverables.length === 0) return; // Skip empty phases

        html += `
          <div class="card" style="margin-bottom: 24px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="font-size: 20px; font-weight: 700;">📋 ${phase} Phase</h3>
              <span style="background: var(--accent); color: #000; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 700;">${phaseDeliverables.length} deliverables</span>
            </div>
            <div class="deliverables-list">
        `;

        phaseDeliverables.forEach((del, idx) => {
          const statusColor = del.status === 'completed' ? 'status-completed' : 
                              del.status === 'inprogress' ? 'status-inprogress' : 'status-pending';

          html += `
            <div class="deliverable-item" style="position: relative;">
              <div class="deliverable-info">
                <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px; flex-wrap: wrap;">
                  <div style="width: 32px; height: 32px; background: var(--accent); color: #000; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 800; font-size: 14px; flex-shrink: 0;">${idx + 1}</div>
                  <div class="deliverable-title">${del.name}</div>
                  ${del.isCustom ? '<span style="font-size: 11px; background: rgba(139, 92, 246, 0.3); color: #a78bfa; padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(139, 92, 246, 0.5);">CUSTOM</span>' : ''}
                </div>
                <div class="deliverable-meta">
                  <span style="background: var(--surface); padding: 4px 8px; border-radius: 4px; font-family: monospace;">${del.code}</span>
                  <span style="margin-left: 12px; font-size: 12px; color: var(--text-dim);">Created: ${new Date(del.createdAt).toLocaleDateString()}</span>
                  ${del.justification ? `<span style="margin-left: 12px; font-size: 11px; color: var(--text-dim);">📝 Justified</span>` : ''}
                </div>
              </div>
              <div style="display: flex; gap: 12px; align-items: center;">
                <span class="status-tag ${statusColor}">${del.status}</span>
                ${del.status === 'pending' ? `
                  <button class="btn" onclick="updateDeliverableStatus('${proj.id}', '${del.code}', 'inprogress')" style="background: var(--accent); color: #000; font-size: 12px; padding: 6px 12px;">Start</button>
                ` : del.status === 'inprogress' ? `
                  <button class="btn" onclick="updateDeliverableStatus('${proj.id}', '${del.code}', 'completed')" style="background: var(--accent); color: #000; font-size: 12px; padding: 6px 12px;">Complete</button>
                ` : ''}
                <button class="btn" onclick="openDeleteModal('${proj.id}', '${del.code}')" style="background: rgba(239, 68, 68, 0.2); color: #fca5a5; font-size: 12px; padding: 6px 12px; border: 1px solid rgba(239, 68, 68, 0.3);">🗑️ Remove</button>
              </div>
            </div>
          `;
        });

        html += `
            </div>
          </div>
        `;
      });

      container.innerHTML = html || '<div style="text-align: center; padding: 40px; color: var(--text-dim);">No deliverables found for this project.</div>';
    }

    function openDeleteModal(projectId, deliverableCode) {
      const proj = projects.find(p => p.id === projectId);
      const del = proj.deliverables.find(d => d.code === deliverableCode);

      if (!del) return;

      document.getElementById('deleteDelName').textContent = del.name;
      document.getElementById('deleteDelPhase').textContent = del.phase;
      document.getElementById('deleteJustification').value = '';
      document.getElementById('deleteApprovalAuth').value = '';
      
      window.deleteContext = { projectId, deliverableCode };
      document.getElementById('deleteDeliverableModal').classList.add('active');
    }

    function closeDeleteModal() {
      document.getElementById('deleteDeliverableModal').classList.remove('active');
      window.deleteContext = null;
    }

    function confirmDeleteDeliverable() {
      const justification = document.getElementById('deleteJustification').value.trim();
      const approvalAuth = document.getElementById('deleteApprovalAuth').value.trim();

      if (!justification || !approvalAuth) {
        showAlert('Please provide justification and approval authority', 'error');
        return;
      }

      const { projectId, deliverableCode } = window.deleteContext;
      const proj = projects.find(p => p.id === projectId);
      const delIndex = proj.deliverables.findIndex(d => d.code === deliverableCode);

      if (delIndex > -1) {
        const del = proj.deliverables[delIndex];
        
        // Create removal record
        if (!proj.removalHistory) proj.removalHistory = [];
        proj.removalHistory.push({
          code: del.code,
          name: del.name,
          phase: del.phase,
          justification,
          approvalAuth,
          removedAt: new Date().toISOString(),
        });

        proj.deliverables.splice(delIndex, 1);
        saveProjects();
        
        closeDeleteModal();
        loadProjectDeliverables();
        showAlert(`✓ Deliverable "${del.name}" removed with justification recorded`, 'success');
      }
    }

    function openAddDeliverableModal() {
      document.getElementById('newDelName').value = '';
      document.getElementById('newDelCode').value = '';
      document.getElementById('newDelPhase').value = '';
      document.getElementById('newDelJustification').value = '';
      document.getElementById('newDelCreatedBy').value = '';
      document.getElementById('addDeliverableModal').classList.add('active');
    }

    function closeAddDeliverableModal() {
      document.getElementById('addDeliverableModal').classList.remove('active');
    }

    function confirmAddDeliverable() {
      const name = document.getElementById('newDelName').value.trim();
      const code = document.getElementById('newDelCode').value.trim().toUpperCase();
      const phase = document.getElementById('newDelPhase').value;
      const justification = document.getElementById('newDelJustification').value.trim();
      const createdBy = document.getElementById('newDelCreatedBy').value.trim();

      if (!name || !code || !phase || !justification || !createdBy) {
        showAlert('Please fill all required fields', 'error');
        return;
      }

      const proj = projects.find(p => p.id === selectedProjectForDeliverables);
      if (!proj) return;

      // Check for duplicate codes
      if (proj.deliverables.some(d => d.code === code)) {
        showAlert('Deliverable code already exists', 'error');
        return;
      }

      const newDeliverable = {
        code,
        name,
        phase,
        status: 'pending',
        isCustom: true,
        justification,
        createdBy,
        createdAt: new Date().toISOString(),
        completedAt: null,
      };

      proj.deliverables.push(newDeliverable);
      
      // Add to change history
      if (!proj.changeHistory) proj.changeHistory = [];
      proj.changeHistory.push({
        type: 'deliverable_added',
        code,
        name,
        justification,
        createdBy,
        timestamp: new Date().toISOString(),
      });

      saveProjects();
      closeAddDeliverableModal();
      loadProjectDeliverables();
      showAlert(`✓ New deliverable "${name}" added to ${phase} phase`, 'success');
    }

async function updateDeliverableStatus(projectId, deliverableCode, newStatus) {
  try {
    // Map internal status to database status
    const dbStatus = newStatus === 'completed' ? 'Completed' : 
                     newStatus === 'inprogress' ? 'In Progress' : 'Not Started';

    const { error } = await supabaseClient
      .from('validation_deliverables')
      .update({ 
        status: dbStatus,
        updated_at: new Date().toISOString(),
        completion_date: newStatus === 'completed' ? new Date().toISOString() : null
      })
      .eq('project_id', projectId)
      .eq('deliverable_code', deliverableCode);

    if (error) throw error;

    showAlert(`✓ Deliverable status updated to ${newStatus}`, 'success');
    
    // Reload from database
    await loadProjectsFromDatabase();
    loadProjectDeliverables();

  } catch (error) {
    console.error('Error updating deliverable:', error);
    showAlert('Failed to update deliverable status', 'error');
  }
}

function updateProjectSelector() {
  const selector = document.getElementById('projectSelector');
  const reqSelector = document.getElementById('reqProjectSelector');
  
  const options = '<option value="">Select a project...</option>' + 
    projects.map(p => `<option value="${p.id}">${p.projectName} (${p.gampCategory})</option>`).join('');
  
  selector.innerHTML = options;
  if (reqSelector) reqSelector.innerHTML = options;
}

    // ========== USER REQUIREMENTS ==========
let currentRequirementForLink = null;
let currentReqView = 'requirements';
let selectedProjectForReq = null;

function toggleRequirementsView(view) {
  currentReqView = view;
  
  if (view === 'requirements') {
    document.getElementById('requirementsViewContainer').style.display = 'block';
    document.getElementById('rtmViewContainer').style.display = 'none';
    document.getElementById('reqViewBtn').style.background = 'var(--accent)';
    document.getElementById('reqViewBtn').style.color = '#000';
    document.getElementById('rtmViewBtn').style.background = 'var(--surface)';
    document.getElementById('rtmViewBtn').style.color = 'var(--text)';
  } else {
    document.getElementById('requirementsViewContainer').style.display = 'none';
    document.getElementById('rtmViewContainer').style.display = 'block';
    document.getElementById('rtmViewBtn').style.background = 'var(--accent)';
    document.getElementById('rtmViewBtn').style.color = '#000';
    document.getElementById('reqViewBtn').style.background = 'var(--surface)';
    document.getElementById('reqViewBtn').style.color = 'var(--text)';
    loadRTM();
  }
}

async function loadProjectRequirements() {
    const selector = document.getElementById('reqProjectSelector');
    const projectId = selector.value;
    
    if (!projectId) {
        document.getElementById('requirementsContainer').innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-dim);">
                Select a project to manage requirements
            </div>`;
        document.getElementById('rtmContainer').innerHTML = `
            <div style="text-align: center; padding: 40px; color: var(--text-dim);">
                Select a project to view traceability matrix
            </div>`;
        document.getElementById('reqViewToggle').style.display = 'none';
        return;
    }
    
    selectedProjectForReq = projectId;
    
    try {
        // ✅ Using correct column name: project_id
        const { data: requirements, error } = await supabaseClient
            .from('requirements')
            .select('*')
            .eq('project_id', projectId)  // ✅ Correct!
            .order('created_at', { ascending: false });
        
        if (error) {
            console.error('Error loading requirements:', error);
            throw error;
        }
        
        console.log('Loaded requirements:', requirements);
        
        // Find project and assign requirements
        const proj = projects.find(p => p.id === projectId);
        
        if (proj) {
            // Map database fields to application format
            proj.requirements = (requirements || []).map(req => ({
                id: req.id,
                reqId: req.requirement_id,
                type: req.requirement_type || req.type || 'Functional',
                category: req.category || 'General',
                priority: req.priority || 'Medium',
                description: req.requirement_description || req.requirement_title || '',
                rationale: req.rationale || '',
                acceptance: req.acceptance_criteria || '',
                risk: req.risk_level || 'Medium',
                gxpImpact: req.gxp_impact || 'Direct',
                source: req.source || '',
                owner: req.owner || '',
                comments: req.comments || '',
                regulatoryRefs: req.regulatory_refs || [],
                createdAt: req.created_at,
                createdBy: req.created_by || 'System',
                testCases: [],
                status: req.status || 'Draft',
                gxpRelevant: req.gxp_relevant !== false
            }));
            
            document.getElementById('reqViewToggle').style.display = 'flex';
            renderRequirements(proj);
            
            if (currentReqView === 'rtm') {
                loadRTM();
            }
        }
        
    } catch (error) {
        console.error('Error loading requirements:', error);
        showAlert(`Failed to load requirements: ${error.message}`, 'error');
        
        // Show empty state
        const proj = projects.find(p => p.id === projectId);
        if (proj) {
            if (!proj.requirements) proj.requirements = [];
            document.getElementById('reqViewToggle').style.display = 'flex';
            renderRequirements(proj);
        }
    }
}




function renderRequirements(proj) {
    const container = document.getElementById('requirementsContainer');
    
    try {
        if (!proj.requirements || proj.requirements.length === 0) {
            // Show empty state
            container.innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">📋</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">No Requirements Defined</div>
                    <div style="color: var(--text-dim); margin-bottom: 24px;">Start by adding user requirements for traceability and compliance</div>
                    <button class="btn btn-primary" onclick="openAddRequirementModal()">📝 Add First Requirement</button>
                </div>`;
            return;
        }

  // Summary Statistics
  const totalReqs = proj.requirements.length;
  const criticalReqs = proj.requirements.filter(r => r.priority === 'Critical').length;
  const totalTests = proj.requirements.reduce((sum, r) => sum + (r.testCases?.length || 0), 0);
  const passedTests = proj.requirements.reduce((sum, r) => sum + (r.testCases?.filter(tc => tc.status === 'Passed').length || 0), 0);

  let html = `
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 30px;">
      <div style="background: var(--surface); border: 1px solid var(--border); padding: 20px; border-radius: 12px; text-align: center;">
        <div style="font-size: 11px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px;">Total Requirements</div>
        <div style="font-size: 32px; font-weight: 800; color: var(--accent);">${totalReqs}</div>
      </div>
      <div style="background: var(--surface); border: 1px solid var(--border); padding: 20px; border-radius: 12px; text-align: center;">
        <div style="font-size: 11px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px;">Critical Priority</div>
        <div style="font-size: 32px; font-weight: 800; color: #ef4444;">${criticalReqs}</div>
      </div>
      <div style="background: var(--surface); border: 1px solid var(--border); padding: 20px; border-radius: 12px; text-align: center;">
        <div style="font-size: 11px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px;">Test Cases Linked</div>
        <div style="font-size: 32px; font-weight: 800; color: #3b82f6;">${totalTests}</div>
      </div>
      <div style="background: var(--surface); border: 1px solid var(--border); padding: 20px; border-radius: 12px; text-align: center;">
        <div style="font-size: 11px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px;">Tests Passed</div>
        <div style="font-size: 32px; font-weight: 800; color: var(--accent);">${passedTests}/${totalTests}</div>
      </div>
    </div>
  `;

  // Group by Type
  const types = [...new Set(proj.requirements.map(r => r.type))];
  
  types.forEach(type => {
    const typeReqs = proj.requirements.filter(r => r.type === type);
    
    html += `
      <div class="card" style="margin-bottom: 24px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="font-size: 20px; font-weight: 700;">
            ${type === 'Functional' ? '⚙️' : type === 'Security' ? '🔒' : type === 'Data Integrity' ? '📊' : type === 'Audit Trail' ? '📝' : '📋'} 
            ${type} Requirements
          </h3>
          <span style="background: var(--accent); color: #000; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 700;">${typeReqs.length} items</span>
        </div>
        <div style="display: grid; gap: 16px;">
    `;

    typeReqs.forEach(req => {
      const priorityColors = {
        'Critical': 'background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3);',
        'High': 'background: rgba(249, 115, 22, 0.2); color: #fb923c; border: 1px solid rgba(249, 115, 22, 0.3);',
        'Medium': 'background: rgba(59, 130, 246, 0.2); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3);',
        'Low': 'background: rgba(156, 163, 175, 0.2); color: #9ca3af; border: 1px solid rgba(156, 163, 175, 0.3);'
      };

      const testCaseCount = req.testCases ? req.testCases.length : 0;
      const passedTests = req.testCases ? req.testCases.filter(tc => tc.status === 'Passed').length : 0;
      const coveragePercent = testCaseCount > 0 ? Math.round((passedTests / testCaseCount) * 100) : 0;

      html += `
        <div class="deliverable-item" onclick="viewRequirement('${proj.id}', '${req.id}')" style="cursor: pointer;">
          <div class="deliverable-info" style="flex: 1;">
            <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 8px; flex-wrap: wrap;">
              <div style="padding: 6px 12px; background: var(--accent); color: #000; border-radius: 8px; font-weight: 800; font-size: 12px;">${req.requirement_id || req.id}</div>
              <div class="deliverable-title" style="flex: 1;">${req.description.substring(0, 120)}${req.description.length > 120 ? '...' : ''}</div>
            </div>
            <div class="deliverable-meta" style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
              <span style="${priorityColors[req.priority]} padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${req.priority}</span>
              <span style="background: var(--surface); padding: 4px 8px; border-radius: 4px; font-size: 11px;">Risk: ${req.risk}</span>
              <span style="background: var(--surface); padding: 4px 8px; border-radius: 4px; font-size: 11px;">GxP: ${req.gxpImpact}</span>
              <span style="color: var(--text-dim); font-size: 11px;">🔗 ${testCaseCount} test case${testCaseCount !== 1 ? 's' : ''}</span>
              ${testCaseCount > 0 ? `
                <span style="color: ${coveragePercent === 100 ? 'var(--accent)' : '#fb923c'}; font-size: 11px; font-weight: 600;">
                  ${coveragePercent === 100 ? '✓' : '⚠'} ${coveragePercent}% verified
                </span>
              ` : `
                <span style="color: #ef4444; font-size: 11px; font-weight: 600;">⚠ Not traced</span>
              `}
            </div>
          </div>
          <div style="font-size: 24px; color: var(--text-dim);">›</div>
        </div>
      `;
    });

    html += `
        </div>
      </div>
    `;
  });

  html += `
    <div style="margin-top: 40px; text-align: center;">
      <button class="btn btn-primary" onclick="openAddRequirementModal()" style="padding: 14px 32px; font-size: 15px;">
        ➕ Add Another Requirement
      </button>
    </div>
  `;
  
  container.innerHTML = html;


    } catch (error) {
        console.error('Error rendering requirements:', error);
        container.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ef4444;">
                <div style="font-size: 48px; margin-bottom: 16px;">⚠️</div>
                <div style="font-weight: 600; margin-bottom: 8px;">Error Displaying Requirements</div>
                <div style="color: var(--text-dim); margin-bottom: 16px;">${error.message}</div>
                <button class="btn btn-primary" onclick="loadProjectRequirements()">Retry</button>
            </div>`;
    }
}

// ========== AUTO-GENERATE REQUIREMENT ID ==========
async function generateRequirementId() {
  const proj = projects.find(p => p.id === selectedProjectForReq);
  if (!proj) return 'UR-001';

  // Get current count of requirements in this project
  const currentCount = proj.requirements ? proj.requirements.length : 0;
  const nextNumber = (currentCount + 1).toString().padStart(3, '0');
  
  // Format: UR-FN-001, UR-FN-002, etc.
  // You can customize the prefix based on requirement type later
  return `UR-FN-${nextNumber}`;
}

// Alternative: If you want to fetch from Supabase to get the next ID
async function generateRequirementIdFromSupabase() {
  try {
    // Fetch the latest requirement ID from Supabase
    const response = await fetch(`${SUPABASE_URL}/rest/v1/requirements?select=id&order=id.desc&limit=1`, {
      headers: {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      }
    });
    
    const data = await response.json();
    
    if (data && data.length > 0) {
      // Extract number from last ID (e.g., "UR-FN-005" -> 5)
      const lastId = data[0].id;
      const match = lastId.match(/UR-FN-(\d+)/);
      if (match) {
        const lastNumber = parseInt(match[1]);
        const nextNumber = (lastNumber + 1).toString().padStart(3, '0');
        return `UR-FN-${nextNumber}`;
      }
    }
    
    // If no requirements exist yet, start with 001
    return 'UR-FN-001';
  } catch (error) {
    console.error('Error generating requirement ID:', error);
    // Fallback to local generation
    return generateRequirementId();
  }
}

function openAddRequirementModal() {
    // Close any other open modals first
    closeViewRequirementModal();
    
    // Check if a project is selected
    if (!selectedProjectForReq) {
        const selector = document.getElementById('reqProjectSelector');
        if (selector && selector.value) {
            selectedProjectForReq = selector.value;
        } else {
            showAlert('Please select a project first', 'error');
            return;
        }
    }
    
    // Clear form
    document.getElementById('reqType').value = '';
    document.getElementById('reqCategory').value = '';
    document.getElementById('reqPriority').value = '';
    document.getElementById('reqDescription').value = '';
    document.getElementById('reqRationale').value = '';
    document.getElementById('reqAcceptance').value = '';
    document.getElementById('reqRisk').value = 'Medium';
    document.getElementById('reqGxpImpact').value = 'Direct';
    document.getElementById('reqSource').value = '';
    document.getElementById('reqOwner').value = '';
    document.getElementById('reqComments').value = '';
    
    // Uncheck regulatory references
    const refCheckboxes = ['ref21cfr11', 'refannex11', 'refgamp5', 'refich', 'refalcoa'];
    refCheckboxes.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) checkbox.checked = false;
    });
    
    // Show modal
    const modal = document.getElementById('addRequirementModal');
    if (!modal) {
        console.error('addRequirementModal not found in DOM');
        showAlert('Error: Modal not found. Please refresh the page.', 'error');
        return;
    }
    
    modal.classList.add('active');
    modal.style.display = 'flex';
    
    // Scroll modal content to top
    setTimeout(() => {
        const modalContent = modal.querySelector('.modal-content');
        if (modalContent) modalContent.scrollTop = 0;
    }, 50);
}


function closeAddRequirementModal() {
    const modal = document.getElementById('addRequirementModal');
    if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
    }
    
    // Clear form fields
    const form = document.getElementById('addRequirementForm');
    if (form) {
        form.reset();
    }
    
    // Clear any specific fields
    document.getElementById('reqType').value = '';
    document.getElementById('reqCategory').value = '';
    document.getElementById('reqPriority').value = '';
    document.getElementById('reqDescription').value = '';
    document.getElementById('reqRationale').value = '';
    document.getElementById('reqAcceptance').value = '';
    document.getElementById('reqRisk').value = 'Medium';
    document.getElementById('reqGxpImpact').value = 'Direct';
    document.getElementById('reqSource').value = '';
    document.getElementById('reqOwner').value = '';
    document.getElementById('reqComments').value = '';
    
    // Uncheck all regulatory reference checkboxes
    const refCheckboxes = ['ref21cfr11', 'refannex11', 'refgamp5', 'refich', 'refalcoa'];
    refCheckboxes.forEach(id => {
        const checkbox = document.getElementById(id);
        if (checkbox) checkbox.checked = false;
    });
}


function closeViewRequirementModal() {
    const modal = document.getElementById('viewRequirementModal');
    if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
    }
    currentRequirementForLink = null;
    currentViewedRequirement = { projectId: null, reqId: null }; // ADD THIS LINE
}



function updateRequirementIdPrefix() {
  const reqType = document.getElementById('reqType').value;
  const proj = projects.find(p => p.id === selectedProjectForReq);
  
  if (!proj || !reqType) return;
  
  // Map requirement types to prefixes
  const prefixMap = {
    'Functional': 'FR',
    'Non-Functional': 'NFR',
    'Data Integrity': 'DI',
    'Security': 'SEC',
    'Audit Trail': 'AT',
    'Electronic Signature': 'ES',
    'Interface': 'INT',
    'Performance': 'PERF',
    'Regulatory': 'REG'
  };
  
  const prefix = prefixMap[reqType] || 'FN';
  
  // Count existing requirements of this type
  const typeCount = proj.requirements 
    ? proj.requirements.filter(r => r.type === reqType).length 
    : 0;
  
  const nextNumber = (typeCount + 1).toString().padStart(3, '0');
  document.getElementById('reqId').value = `UR-${prefix}-${nextNumber}`;
}

async function confirmAddRequirement() {
    const projectId = selectedProjectForReq;
    
    // ✅ FIX: Check if project is selected
    if (!projectId) {
        showAlert('Please select a project first', 'error');
        return;
    }
    
    // Get form values
    const reqType = document.getElementById('reqType').value;
    const category = document.getElementById('reqCategory').value;
    const priority = document.getElementById('reqPriority').value;
    const description = document.getElementById('reqDescription').value.trim();
    const rationale = document.getElementById('reqRationale').value.trim();
    const acceptance = document.getElementById('reqAcceptance').value.trim();
    const risk = document.getElementById('reqRisk').value;
    const gxpImpact = document.getElementById('reqGxpImpact').value;
    const source = document.getElementById('reqSource').value.trim();
    const owner = document.getElementById('reqOwner').value.trim();
    const comments = document.getElementById('reqComments').value.trim();

    // ✅ FIX: Proper validation with specific error messages
    if (!reqType || reqType === 'Select Type') {
        showAlert('Please select Requirement Type', 'error');
        document.getElementById('reqType').focus();
        return;
    }
    
    if (!category || category === 'Select Category') {
        showAlert('Please select Category', 'error');
        document.getElementById('reqCategory').focus();
        return;
    }
    
    if (!priority || priority === 'Select Priority') {
        showAlert('Please select Priority', 'error');
        document.getElementById('reqPriority').focus();
        return;
    }
    
    if (!description) {
        showAlert('Please enter Requirement Statement', 'error');
        document.getElementById('reqDescription').focus();
        return;
    }
    
    if (!rationale) {
        showAlert('Please enter Rationale/Business Justification', 'error');
        document.getElementById('reqRationale').focus();
        return;
    }
    
    if (!acceptance) {
        showAlert('Please enter Acceptance Criteria', 'error');
        document.getElementById('reqAcceptance').focus();
        return;
    }
    
    if (!owner) {
        showAlert('Please enter Requirement Owner', 'error');
        document.getElementById('reqOwner').focus();
        return;
    }

    // Collect regulatory references
    const regulatoryRefs = [];
    if (document.getElementById('ref21cfr11')?.checked) regulatoryRefs.push('21 CFR Part 11');
    if (document.getElementById('refannex11')?.checked) regulatoryRefs.push('EU GMP Annex 11');
    if (document.getElementById('refgamp5')?.checked) regulatoryRefs.push('GAMP 5');
    if (document.getElementById('refich')?.checked) regulatoryRefs.push('ICH Q7/Q9/Q10');
    if (document.getElementById('refalcoa')?.checked) regulatoryRefs.push('ALCOA+');

    try {
        showAlert('Creating requirement...', 'info');

        // ✅ Using correct column names from schema
        const requirementData = {
            project_id: projectId,
            requirement_type: reqType,
            requirement_title: description.substring(0, 100),
            requirement_description: description,
            acceptance_criteria: acceptance,
            priority: priority,
            category: category,
            rationale: rationale,
            gxp_relevant: (gxpImpact === 'Direct'),
            gxp_impact: gxpImpact,
            risk_level: risk,
            source: source || null,
            owner: owner,
            comments: comments || null,
            regulatory_refs: regulatoryRefs.length > 0 ? regulatoryRefs : null,
            status: 'Draft',
            created_by: owner,
            type: reqType,
            created_at: new Date().toISOString(),
            updated_at: new Date().toISOString()
        };

        const { data, error } = await supabaseClient
            .from('requirements')
            .insert([requirementData])
            .select();

        if (error) {
            console.error('Supabase error:', error);
            throw error;
        }

        if (data && data.length > 0) {
            showAlert(`Requirement ${data[0].requirement_id} added successfully!`, 'success');
            closeAddRequirementModal();
            await loadProjectRequirements();
        }

    } catch (error) {
        console.error('Error saving requirement:', error);
        showAlert(`Error: ${error.message} - Failed to create requirement`, 'error');
    }
}




function viewRequirement(projectId, reqId) {
    console.log('Opening requirement:', projectId, reqId);
    
    // Store for later use (IMPORTANT: ADD THIS NEW LINE)
    currentViewedRequirement = { projectId, reqId };
    
    // Find the project
    const proj = projects.find(p => p.id === projectId);
    
    if (!proj) {
        console.error('Project not found:', projectId);
        showAlert('Project not found', 'error');
        return;
    }
    
    if (!proj.requirements || proj.requirements.length === 0) {
        console.error('No requirements found for project');
        showAlert('No requirements loaded for this project', 'error');
        return;
    }
    
    // Find the requirement
    const req = proj.requirements.find(r => r.id === reqId);
    
    if (!req) {
        console.error('Requirement not found:', reqId);
        showAlert('Requirement not found', 'error');
        return;
    }
    
    currentRequirementForLink = { projectId, reqId };
    
    // Define priority colors
    const priorityColors = {
        'Critical': { bg: 'rgba(239, 68, 68, 0.2)', color: '#ef4444', border: 'rgba(239, 68, 68, 0.3)' },
        'High': { bg: 'rgba(249, 115, 22, 0.2)', color: '#f97316', border: 'rgba(249, 115, 22, 0.3)' },
        'Medium': { bg: 'rgba(59, 130, 246, 0.2)', color: '#3b82f6', border: 'rgba(59, 130, 246, 0.3)' },
        'Low': { bg: 'rgba(156, 163, 175, 0.2)', color: '#6b7280', border: 'rgba(156, 163, 175, 0.3)' }
    };
    
    const pColor = priorityColors[req.priority] || priorityColors['Medium'];
    
    // Build the content HTML
    const content = `
        <div style="background: #ffffff; border: 1px solid #e4e4e7; padding: 24px; border-radius: 12px; margin-bottom: 20px;">
            <!-- Header Badges -->
            <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 20px; flex-wrap: wrap;">
                <div style="padding: 8px 16px; background: var(--accent); color: #fff; border-radius: 8px; font-weight: 800; font-size: 14px;">${req.reqId || req.id}</div>
                <div style="padding: 6px 12px; background: ${pColor.bg}; color: ${pColor.color}; border-radius: 6px; font-size: 12px; font-weight: 600; border: 1px solid ${pColor.border};">${req.priority}</div>
                <div style="padding: 6px 12px; background: #f4f4f5; border: 1px solid #e4e4e7; border-radius: 6px; font-size: 12px; color: #18181b;">${req.type}</div>
                <div style="padding: 6px 12px; background: #f4f4f5; border: 1px solid #e4e4e7; border-radius: 6px; font-size: 12px; color: #18181b;">Risk: ${req.risk}</div>
                <div style="padding: 6px 12px; background: rgba(14,164,116,0.1); border: 1px solid var(--accent); border-radius: 6px; font-size: 12px; color: var(--accent);">GxP: ${req.gxpImpact}</div>
            </div>
            
            <!-- Main Details Grid -->
            <div style="display: grid; gap: 20px;">
                <div>
                    <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; margin-bottom: 6px; font-weight: 600;">Category</div>
                    <div style="font-weight: 600; color: #18181b;">${req.category}</div>
                </div>

                <div>
                    <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; margin-bottom: 6px; font-weight: 600;">Requirement Statement</div>
                    <div style="line-height: 1.6; padding: 12px; background: #f9fafb; border-radius: 8px; border-left: 3px solid var(--accent); color: #18181b;">${req.description || 'No description provided'}</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; margin-bottom: 6px; font-weight: 600;">Rationale</div>
                        <div style="line-height: 1.6; color: #4b5563; font-size: 13px;">${req.rationale || 'No rationale provided'}</div>
                    </div>

                    <div>
                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; margin-bottom: 6px; font-weight: 600;">Acceptance Criteria</div>
                        <div style="line-height: 1.6; color: #4b5563; font-size: 13px;">${req.acceptance || 'No acceptance criteria provided'}</div>
                    </div>
                </div>

                ${req.regulatoryRefs && req.regulatoryRefs.length > 0 ? `
                    <div>
                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; margin-bottom: 8px; font-weight: 600;">Regulatory References</div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            ${req.regulatoryRefs.map(ref => `
                                <span style="padding: 4px 10px; background: rgba(14,164,116,0.1); color: var(--accent); border-radius: 6px; font-size: 11px; font-weight: 600; border: 1px solid var(--accent);">${ref}</span>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                ${req.source ? `
                    <div>
                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; margin-bottom: 6px; font-weight: 600;">Source Document</div>
                        <div style="font-size: 13px; color: #4b5563;">${req.source}</div>
                    </div>
                ` : ''}

                ${req.comments ? `
                    <div>
                        <div style="font-size: 11px; color: #6b7280; text-transform: uppercase; margin-bottom: 6px; font-weight: 600;">Additional Notes</div>
                        <div style="line-height: 1.6; color: #4b5563; font-size: 13px; font-style: italic;">${req.comments}</div>
                    </div>
                ` : ''}

                <!-- Metadata Footer -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 12px; padding-top: 20px; border-top: 1px solid #e4e4e7;">
                    <div>
                        <div style="font-size: 10px; color: #6b7280; text-transform: uppercase; margin-bottom: 4px;">Requirement Owner</div>
                        <div style="font-size: 12px; font-weight: 600; color: #18181b;">${req.owner || 'Not assigned'}</div>
                    </div>
                    <div>
                        <div style="font-size: 10px; color: #6b7280; text-transform: uppercase; margin-bottom: 4px;">Created Date</div>
                        <div style="font-size: 12px; color: #18181b;">${req.createdAt ? new Date(req.createdAt).toLocaleDateString() : 'N/A'}</div>
                    </div>
                    <div>
                        <div style="font-size: 10px; color: #6b7280; text-transform: uppercase; margin-bottom: 4px;">Last Modified</div>
                        <div style="font-size: 12px; color: #18181b;">${req.lastModified ? new Date(req.lastModified).toLocaleDateString() : 'Never'}</div>
                    </div>
<div>
                        <div style="font-size: 10px; color: #6b7280; text-transform: uppercase; margin-bottom: 4px;">Status</div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="font-size: 12px; font-weight: 600; padding: 4px 12px; background: ${req.status === 'Approved' ? 'rgba(34, 197, 94, 0.2)' : req.status === 'Modified' ? 'rgba(249, 115, 22, 0.2)' : 'rgba(156, 163, 175, 0.2)'}; color: ${req.status === 'Approved' ? '#22c55e' : req.status === 'Modified' ? '#f97316' : '#6b7280'}; border-radius: 6px;">${req.status || 'Draft'}</div>
                            <button onclick="showStatusChangeMenu(); event.stopPropagation();" style="padding: 4px 8px; background: var(--accent); color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;">Change</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Set the modal title and content
    document.getElementById('viewReqTitle').textContent = `${req.reqId || req.id} - ${req.type}`;
    document.getElementById('viewReqContent').innerHTML = content;

    // Render linked test cases (keep existing code)
    const testCasesHtml = req.testCases && req.testCases.length > 0 ? 
        req.testCases.map((tc, idx) => {
            const statusColors = {
                'Not Started': 'background: rgba(156, 163, 175, 0.2); color: #6b7280;',
                'In Progress': 'background: rgba(59, 130, 246, 0.2); color: #3b82f6;',
                'Passed': 'background: rgba(34, 197, 94, 0.2); color: #22c55e;',
                'Failed': 'background: rgba(239, 68, 68, 0.2); color: #ef4444;'
            };

            const statusStyle = statusColors[tc.status] || statusColors['Not Started'];

            return `
                <div style="background: #ffffff; border: 1px solid #e4e4e7; padding: 16px; border-radius: 12px; display: flex; justify-content: space-between; align-items: start; gap: 16px;">
                    <div style="flex: 1;">
                        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 6px;">
                            <span style="padding: 4px 8px; background: var(--accent); color: #fff; border-radius: 6px; font-size: 11px; font-weight: 700;">${tc.id}</span>
                            <span style="font-weight: 600; font-size: 14px; color: #18181b;">${tc.name}</span>
                        </div>
                        <div style="font-size: 12px; color: #4b5563; margin-bottom: 4px;">
                            <strong>Type:</strong> ${tc.type} 
                            ${tc.description ? `<br><strong>Description:</strong> ${tc.description}` : ''}
                        </div>
                        <div style="font-size: 11px; color: #6b7280;">
                            Linked: ${new Date(tc.linkedAt).toLocaleDateString()}
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center; flex-shrink: 0;">
                        <span style="padding: 4px 12px; border-radius: 6px; font-size: 11px; font-weight: 600; white-space: nowrap; ${statusStyle}">${tc.status}</span>
                        <button onclick="updateTestCaseStatus('${projectId}', '${reqId}', ${idx}); event.stopPropagation();" class="btn" style="background: var(--accent); color: #fff; font-size: 11px; padding: 6px 10px; border: none; cursor: pointer; border-radius: 6px;">
                            ${tc.status === 'Not Started' ? '▶ Start' : tc.status === 'In Progress' ? '✓ Pass' : '🔄'}
                        </button>
                        <button onclick="deleteTestCase('${projectId}', '${reqId}', ${idx}); event.stopPropagation();" class="btn" style="background: rgba(239, 68, 68, 0.2); color: #ef4444; font-size: 11px; padding: 6px 10px; border: 1px solid rgba(239, 68, 68, 0.3); cursor: pointer; border-radius: 6px;">🗑️</button>
                    </div>
                </div>
            `;
        }).join('') :
        '<div style="text-align: center; padding: 30px 20px; color: #6b7280; background: #f9fafb; border-radius: 12px; border: 2px dashed #e4e4e7;"><div style="font-size: 36px; margin-bottom: 12px;">🔗</div><div style="font-weight: 600; margin-bottom: 6px; color: #18181b;">No Test Cases Linked Yet</div><div style="font-size: 13px;">Click "Link Test Case" above to establish traceability</div></div>';

    document.getElementById('linkedTestCases').innerHTML = testCasesHtml;
    
    // Hide audit trail by default (NEW LINE)
    document.getElementById('auditTrailSection').style.display = 'none';
    
    // Show the modal
    const modal = document.getElementById('viewRequirementModal');
    if (modal) {
        modal.classList.add('active');
        modal.style.display = 'flex';
    } else {
        console.error('viewRequirementModal not found');
        showAlert('Error: Modal not found', 'error');
    }
}

function closeViewRequirementModal() {
    const modal = document.getElementById('viewRequirementModal');
    if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
    }
    currentRequirementForLink = null;
}

// Store current requirement being viewed/edited
let currentViewedRequirement = { projectId: null, reqId: null };

// Open Edit Modal and populate with current data
function openEditRequirementModal() {
    const { projectId, reqId } = currentViewedRequirement;
    
    if (!projectId || !reqId) {
        showAlert('No requirement selected for editing', 'error');
        return;
    }
    
    const proj = projects.find(p => p.id === projectId);
    if (!proj) return;
    
    const req = proj.requirements.find(r => r.id === reqId);
    if (!req) return;
    
    // Populate edit form with current values
    document.getElementById('editReqId').value = req.reqId || req.id;
    document.getElementById('editReqType').value = req.type || '';
    document.getElementById('editReqCategory').value = req.category || '';
    document.getElementById('editReqPriority').value = req.priority || '';
    document.getElementById('editReqDescription').value = req.description || '';
    document.getElementById('editReqRationale').value = req.rationale || '';
    document.getElementById('editReqAcceptance').value = req.acceptance || '';
    document.getElementById('editReqRisk').value = req.risk || '';
    document.getElementById('editReqGxpImpact').value = req.gxpImpact || '';
    document.getElementById('editReqSource').value = req.source || '';
    document.getElementById('editReqOwner').value = req.owner || '';
    document.getElementById('editReqComments').value = req.comments || '';
    document.getElementById('editChangeReason').value = '';
    document.getElementById('editUserName').value = '';
    document.getElementById('currentUserEmail').textContent = currentUser?.email || 'Not authenticated';
    
    // Show edit modal
    const modal = document.getElementById('editRequirementModal');
    if (modal) {
        modal.classList.add('active');
        modal.style.display = 'flex';
    }
}

function closeEditRequirementModal() {
    const modal = document.getElementById('editRequirementModal');
    if (modal) {
        modal.classList.remove('active');
        modal.style.display = 'none';
    }
}

async function confirmEditRequirement() {
    const { projectId, reqId } = currentViewedRequirement;
    
    if (!projectId || !reqId) {
        showAlert('Error: No requirement selected', 'error');
        return;
    }
    
    // Get change reason
    const changeReason = document.getElementById('editChangeReason').value.trim();
    if (!changeReason) {
        showAlert('Change Reason is required for audit trail compliance', 'error');
        return;
    }
    
    // Get current user for electronic signature
    if (!currentUser) {
        await getCurrentUser();
    }
    
    if (!currentUser) {
        showAlert('User not authenticated. Please log in.', 'error');
        return;
    }
    
    const userName = document.getElementById('editUserName').value.trim() || currentUser.email || 'System User';
    
    // Collect updated values
    const updatedData = {
        type: document.getElementById('editReqType').value,
        category: document.getElementById('editReqCategory').value,
        priority: document.getElementById('editReqPriority').value,
        description: document.getElementById('editReqDescription').value,
        rationale: document.getElementById('editReqRationale').value,
        acceptance: document.getElementById('editReqAcceptance').value,
        risk: document.getElementById('editReqRisk').value,
        gxpImpact: document.getElementById('editReqGxpImpact').value,
        source: document.getElementById('editReqSource').value,
        owner: document.getElementById('editReqOwner').value,
        comments: document.getElementById('editReqComments').value,
        lastModified: new Date().toISOString(),
        status: 'Modified'
    };
    
    try {
        // 🟢 USE IN-MEMORY DATA (same as viewRequirement)
        const proj = projects.find(p => p.id === projectId);
        
        if (!proj) {
            throw new Error('Project not found in memory');
        }
        
        if (!proj.requirements || proj.requirements.length === 0) {
            throw new Error('No requirements found for this project');
        }
        
        // Clone requirements array
        let requirements = [...proj.requirements];
        
        // Find requirement index
        const reqIndex = requirements.findIndex(r => r.id === reqId);
        
        if (reqIndex === -1) {
            console.error('Requirement not found:', reqId);
            console.error('Available IDs:', requirements.map(r => r.id));
            throw new Error('Requirement not found in project');
        }
        
        const oldReq = {...requirements[reqIndex]};
        
        // Create audit trail entry
        const auditEntry = {
            timestamp: new Date().toISOString(),
            action: 'Modified',
            changedBy: userName,
            changedByUserId: currentUser.id,
            changedByEmail: currentUser.email,
            changeReason: changeReason,
            requirementId: reqId,
            requirementCode: oldReq.reqId || reqId,
            changes: []
        };
        
        // Track what changed
        const fieldsToCheck = ['type', 'category', 'priority', 'description', 'rationale', 'acceptance', 'risk', 'gxpImpact', 'source', 'owner', 'comments'];
        fieldsToCheck.forEach(field => {
            if (oldReq[field] !== updatedData[field]) {
                auditEntry.changes.push({
                    field: field,
                    oldValue: oldReq[field] || '(empty)',
                    newValue: updatedData[field] || '(empty)'
                });
            }
        });
        
        // Check if status changed
        if (oldReq.status !== updatedData.status) {
            auditEntry.changes.push({
                field: 'status',
                oldValue: oldReq.status || 'Draft',
                newValue: updatedData.status
            });
        }
        
        // Update requirement in array
        requirements[reqIndex] = {
            ...requirements[reqIndex],
            ...updatedData
        };
        
        // Update local cache
        proj.requirements = requirements;
        
        // Fetch current audit trail from database
        const { data: projectData, error: fetchError } = await supabaseClient
            .from('validation_projects')
            .select('requirement_audit_trail')
            .eq('id', projectId)
            .single();
        
        if (fetchError) throw fetchError;
        
        // Get existing audit trail
        let auditTrail = projectData.requirement_audit_trail || [];
        
        // Add new audit entry
        auditTrail.push(auditEntry);
        
        // Save to database
        const { error: updateError } = await supabaseClient
            .from('validation_projects')
            .update({ 
                requirements: requirements,
                requirement_audit_trail: auditTrail,
                updated_at: new Date().toISOString()
            })
            .eq('id', projectId);
        
        if (updateError) throw updateError;
        
        showAlert('✅ Requirement updated successfully! Changes logged in audit trail.', 'success');
        closeEditRequirementModal();
        
        // Refresh view
        viewRequirement(projectId, reqId);
        
    } catch (error) {
        console.error('Error updating requirement:', error);
        showAlert('❌ Failed to update requirement: ' + error.message, 'error');
    }
}

function showStatusChangeMenu() {
    const statuses = ['Draft', 'Under Review', 'Approved', 'Modified', 'Rejected', 'Obsolete'];
    
    let menu = 'Change requirement status to:\n\n';
    statuses.forEach((status, idx) => {
        menu += `${idx + 1}. ${status}\n`;
    });
    menu += '\nEnter number (1-6):';
    
    const choice = prompt(menu);
    
    if (choice && choice >= 1 && choice <= 6) {
        const selectedStatus = statuses[choice - 1];
        changeRequirementStatus(selectedStatus);
    }
}


// Toggle Audit Trail visibility
function toggleAuditTrail() {
    const section = document.getElementById('auditTrailSection');
    const isVisible = section.style.display !== 'none';
    
    if (isVisible) {
        section.style.display = 'none';
    } else {
        section.style.display = 'block';
        loadAuditTrail();
    }
}

async function loadAuditTrail() {
    const { projectId, reqId } = currentViewedRequirement;
    
    if (!projectId || !reqId) return;
    
    try {
        // Fetch audit trail from database
        const { data: project, error } = await supabaseClient
            .from('validation_projects')
            .select('requirement_audit_trail')
            .eq('id', projectId)
            .single();
        
        if (error) throw error;
        
        // Get audit entries for this specific requirement
        const allAuditTrail = project.requirement_audit_trail || [];
        const auditTrail = allAuditTrail.filter(entry => entry.requirementId === reqId);
        
        if (auditTrail.length === 0) {
            document.getElementById('auditTrailContent').innerHTML = `
                <div style="text-align: center; padding: 40px; color: var(--text-dim); background: #f9fafb; border-radius: 12px;">
                    <div style="font-size: 36px; margin-bottom: 12px;">📋</div>
                    <div style="font-weight: 600; margin-bottom: 6px; color: #18181b;">No Audit Trail History</div>
                    <div style="font-size: 13px;">This requirement has not been modified since creation.</div>
                </div>
            `;
            return;
        }
        
        // Render audit trail (most recent first)
        const auditHtml = [...auditTrail].reverse().map((entry, idx) => {
            const changesHtml = entry.changes && entry.changes.length > 0 ? 
                entry.changes.map(change => `
                    <div style="margin: 8px 0; padding: 8px; background: #f9fafb; border-radius: 6px; border-left: 3px solid var(--accent);">
                        <strong style="color: var(--accent); text-transform: capitalize;">${change.field.replace(/([A-Z])/g, ' $1')}:</strong><br>
                        <div style="display: flex; gap: 8px; align-items: center; margin-top: 4px;">
                            <span style="color: #ef4444; text-decoration: line-through; font-size: 12px; flex: 1;">${change.oldValue}</span>
                            <span style="color: #6b7280;">→</span>
                            <span style="color: #22c55e; font-size: 12px; flex: 1; font-weight: 600;">${change.newValue}</span>
                        </div>
                    </div>
                `).join('') : '<div style="font-size: 12px; color: #6b7280;">No specific field changes recorded</div>';
            
            return `
                <div style="background: #ffffff; border: 1px solid #e4e4e7; padding: 20px; border-radius: 12px; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div>
                            <div style="font-weight: 700; color: #18181b; font-size: 14px; margin-bottom: 4px;">
                                📝 ${entry.action} by ${entry.changedBy}
                            </div>
                            <div style="font-size: 11px; color: #6b7280;">
                                🕒 ${new Date(entry.timestamp).toLocaleString('en-US', { 
                                    year: 'numeric', 
                                    month: 'short', 
                                    day: 'numeric', 
                                    hour: '2-digit', 
                                    minute: '2-digit',
                                    second: '2-digit'
                                })}
                            </div>
                            ${entry.changedByEmail ? `<div style="font-size: 10px; color: #9ca3af; margin-top: 2px;">✉️ ${entry.changedByEmail}</div>` : ''}
                        </div>
                        <div style="display: flex; flex-direction: column; gap: 4px; align-items: flex-end;">
                            <div style="padding: 4px 12px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 6px; font-size: 11px; color: #3b82f6; font-weight: 600;">
                                Entry #${auditTrail.length - idx}
                            </div>
                            <div style="padding: 2px 8px; background: rgba(14,164,116,0.1); border-radius: 4px; font-size: 10px; color: var(--accent); font-weight: 600;">
                                ${entry.requirementCode || reqId}
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 12px; padding: 12px; background: rgba(249, 115, 22, 0.1); border-left: 3px solid #f97316; border-radius: 6px;">
                        <div style="font-size: 11px; color: #6b7280; margin-bottom: 4px; font-weight: 600;">📝 CHANGE REASON:</div>
                        <div style="font-size: 13px; color: #18181b; line-height: 1.5;">${entry.changeReason}</div>
                    </div>
                    
                    ${entry.changes && entry.changes.length > 0 ? `
                        <div>
                            <div style="font-size: 11px; color: #6b7280; margin-bottom: 8px; font-weight: 600; display: flex; align-items: center; gap: 6px;">
                                <span>🔄 FIELDS MODIFIED:</span>
                                <span style="background: rgba(239, 68, 68, 0.1); color: #ef4444; padding: 2px 8px; border-radius: 12px; font-size: 10px;">${entry.changes.length} changes</span>
                            </div>
                            ${changesHtml}
                        </div>
                    ` : ''}
                </div>
            `;
        }).join('');
        
        document.getElementById('auditTrailContent').innerHTML = auditHtml;
        
    } catch (error) {
        console.error('Error loading audit trail:', error);
        document.getElementById('auditTrailContent').innerHTML = `
            <div style="text-align: center; padding: 40px; color: #ef4444; background: rgba(239, 68, 68, 0.1); border-radius: 12px;">
                <div style="font-size: 36px; margin-bottom: 12px;">⚠️</div>
                <div style="font-weight: 600; margin-bottom: 6px;">Error Loading Audit Trail</div>
                <div style="font-size: 13px;">${error.message}</div>
            </div>
        `;
    }
}

// Status change with audit trail
async function changeRequirementStatus(newStatus) {
    const { projectId, reqId } = currentViewedRequirement;
    
    if (!projectId || !reqId) return;
    
    const statusReason = prompt(`Change status to "${newStatus}".\n\nPlease provide a reason for this status change:`);
    
    if (!statusReason || statusReason.trim() === '') {
        showAlert('Status change cancelled - reason is required', 'info');
        return;
    }
    
    try {
        // Get current user
        if (!currentUser) {
            await getCurrentUser();
        }
        
        // Fetch project
        const { data: project, error: fetchError } = await supabaseClient
            .from('validation_projects')
            .select('requirements, requirement_audit_trail')
            .eq('id', projectId)
            .single();
        
        if (fetchError) throw fetchError;
        
        let requirements = project.requirements || [];
        const reqIndex = requirements.findIndex(r => r.id === reqId);
        
        if (reqIndex === -1) throw new Error('Requirement not found');
        
        const oldStatus = requirements[reqIndex].status || 'Draft';
        
        // Create audit entry for status change
        const auditEntry = {
            timestamp: new Date().toISOString(),
            action: 'Status Changed',
            changedBy: currentUser?.email || 'System User',
            changedByUserId: currentUser?.id || null,
            changedByEmail: currentUser?.email || null,
            changeReason: statusReason,
            requirementId: reqId,
            requirementCode: requirements[reqIndex].reqId || reqId,
            changes: [{
                field: 'status',
                oldValue: oldStatus,
                newValue: newStatus
            }]
        };
        
        // Update requirement status
        requirements[reqIndex].status = newStatus;
        requirements[reqIndex].lastModified = new Date().toISOString();
        
        // Update audit trail
        let auditTrail = project.requirement_audit_trail || [];
        auditTrail.push(auditEntry);
        
        // Save to database
        const { error: updateError } = await supabaseClient
            .from('validation_projects')
            .update({ 
                requirements: requirements,
                requirement_audit_trail: auditTrail,
                updated_at: new Date().toISOString()
            })
            .eq('id', projectId);
        
        if (updateError) throw updateError;
        
        // Update local cache
        const projIndex = projects.findIndex(p => p.id === projectId);
        if (projIndex !== -1) {
            projects[projIndex].requirements = requirements;
            projects[projIndex].requirement_audit_trail = auditTrail;
        }
        
        showAlert(`✅ Status changed to "${newStatus}" successfully!`, 'success');
        
        // Refresh view
        viewRequirement(projectId, reqId);
        
    } catch (error) {
        console.error('Error changing status:', error);
        showAlert('❌ Failed to change status: ' + error.message, 'error');
    }
}

// Export requirement as PDF (placeholder)
function exportRequirementPDF() {
    showAlert('PDF export feature coming soon!', 'info');
}


function openLinkTestCaseModal() {
  if (!currentRequirementForLink) return;

  const { projectId, reqId } = currentRequirementForLink;
  document.getElementById('linkingToReq').textContent = reqId;
  document.getElementById('testCaseId').value = '';
  document.getElementById('testCaseName').value = '';
  document.getElementById('testType').value = 'IQ';
  document.getElementById('testStatus').value = 'Not Started';
  document.getElementById('testDescription').value = '';
  document.getElementById('linkTestCaseModal').classList.add('active');
}

function closeLinkTestCaseModal() {
  document.getElementById('linkTestCaseModal').classList.remove('active');
}

function confirmLinkTestCase() {
  if (!currentRequirementForLink) return;

  const { projectId, reqId } = currentRequirementForLink;
  const testCaseId = document.getElementById('testCaseId').value.trim().toUpperCase();
  const testCaseName = document.getElementById('testCaseName').value.trim();
  const testType = document.getElementById('testType').value;
  const testStatus = document.getElementById('testStatus').value;
  const testDescription = document.getElementById('testDescription').value.trim();

  if (!testCaseId || !testCaseName) {
    showAlert('Please fill Test Case ID and Name', 'error');
    return;
  }

  const proj = projects.find(p => p.id === projectId);
  const req = proj.requirements.find(r => r.id === reqId);

  if (!req.testCases) req.testCases = [];

  // Check duplicate
  if (req.testCases.some(tc => tc.id === testCaseId)) {
    showAlert('Test case ID already linked to this requirement', 'error');
    return;
  }

  const newTestCase = {
    id: testCaseId,
    name: testCaseName,
    type: testType,
    status: testStatus,
    description: testDescription,
    linkedAt: new Date().toISOString(),
    executedBy: null,
    executedDate: null
  };

  req.testCases.push(newTestCase);
  saveProjects();
  closeLinkTestCaseModal();
  viewRequirement(projectId, reqId); // Refresh view
  showAlert(`✓ Test case ${testCaseId} linked to ${reqId}`, 'success');
}

function updateTestCaseStatus(projectId, reqId, testCaseIndex) {
  const proj = projects.find(p => p.id === projectId);
  const req = proj.requirements.find(r => r.id === reqId);
  const tc = req.testCases[testCaseIndex];

  if (!tc) return;

  // Cycle through statuses
  if (tc.status === 'Not Started') {
    tc.status = 'In Progress';
  } else if (tc.status === 'In Progress') {
    tc.status = 'Passed';
    tc.executedDate = new Date().toISOString();
  } else if (tc.status === 'Passed') {
    tc.status = 'Failed';
  } else {
    tc.status = 'Not Started';
  }

  saveProjects();
  viewRequirement(projectId, reqId);
  showAlert(`✓ Test case ${tc.id} status updated to ${tc.status}`, 'success');
}

function deleteTestCase(projectId, reqId, testCaseIndex) {
  if (!confirm('Are you sure you want to unlink this test case from the requirement?')) return;

  const proj = projects.find(p => p.id === projectId);
  const req = proj.requirements.find(r => r.id === reqId);

  if (req && req.testCases && req.testCases[testCaseIndex]) {
    const tcId = req.testCases[testCaseIndex].id;
    req.testCases.splice(testCaseIndex, 1);
    saveProjects();
    viewRequirement(projectId, reqId);
    showAlert(`✓ Test case ${tcId} unlinked from ${reqId}`, 'success');
  }
}

// ========== REQUIREMENTS TRACEABILITY MATRIX ==========
function loadRTM() {
  const selector = document.getElementById('reqProjectSelector');
  const projectId = selector.value;
  const container = document.getElementById('rtmContainer');

  if (!projectId) {
    container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-dim);">Select a project to view traceability matrix</div>';
    return;
  }

  const proj = projects.find(p => p.id === projectId);
  if (!proj || !proj.requirements || proj.requirements.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 60px 20px;">
        <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
        <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">No Requirements Found</div>
        <div style="color: var(--text-dim);">Add requirements first to generate the traceability matrix</div>
      </div>
    `;
    return;
  }

  // Calculate statistics
  const totalReqs = proj.requirements.length;
  const withTests = proj.requirements.filter(r => r.testCases && r.testCases.length > 0).length;
  const withoutTests = totalReqs - withTests;
  const totalTests = proj.requirements.reduce((sum, r) => sum + (r.testCases?.length || 0), 0);
  const passedTests = proj.requirements.reduce((sum, r) => sum + (r.testCases?.filter(tc => tc.status === 'Passed').length || 0), 0);
  const traceabilityPercent = totalReqs > 0 ? Math.round((withTests / totalReqs) * 100) : 0;
  const verificationPercent = totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0;

  let html = `
    <!-- Summary Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; margin-bottom: 30px;">
      <div style="background: var(--surface); border: 1px solid var(--border); padding: 20px; border-radius: 12px;">
        <div style="font-size: 11px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px;">Traceability Coverage</div>
        <div style="display: flex; align-items: baseline; gap: 8px;">
          <div style="font-size: 32px; font-weight: 800; color: ${traceabilityPercent === 100 ? 'var(--accent)' : '#fb923c'};">${traceabilityPercent}%</div>
          <div style="font-size: 12px; color: var(--text-dim);">${withTests}/${totalReqs} traced</div>
        </div>
      </div>
      
      <div style="background: var(--surface); border: 1px solid var(--border); padding: 20px; border-radius: 12px;">
        <div style="font-size: 11px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px;">Test Verification</div>
        <div style="display: flex; align-items: baseline; gap: 8px;">
          <div style="font-size: 32px; font-weight: 800; color: ${verificationPercent === 100 ? 'var(--accent)' : '#fb923c'};">${verificationPercent}%</div>
          <div style="font-size: 12px; color: var(--text-dim);">${passedTests}/${totalTests} passed</div>
        </div>
      </div>
      
      <div style="background: var(--surface); border: 1px solid var(--border); padding: 20px; border-radius: 12px;">
        <div style="font-size: 11px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px;">Total Test Cases</div>
        <div style="font-size: 32px; font-weight: 800; color: var(--accent);">${totalTests}</div>
      </div>
      
      <div style="background: var(--surface); border: 1px solid var(--border); padding: 20px; border-radius: 12px;">
        <div style="font-size: 11px; color: var(--text-dim); text-transform: uppercase; margin-bottom: 8px;">Untraced Reqs</div>
        <div style="font-size: 32px; font-weight: 800; color: ${withoutTests > 0 ? '#ef4444' : 'var(--accent)'};">${withoutTests}</div>
      </div>
    </div>

    ${withoutTests > 0 ? `
      <div style="background: rgba(239, 68, 68, 0.15); border: 1px solid rgba(239, 68, 68, 0.3); padding: 16px; border-radius: 12px; margin-bottom: 20px; font-size: 13px; color: #fca5a5;">
        <strong>⚠ Compliance Alert:</strong> ${withoutTests} requirement${withoutTests !== 1 ? 's' : ''} without test case traceability. All requirements must be verified per GAMP 5 guidelines.
      </div>
    ` : `
      <div style="background: var(--accent-dim); border: 1px solid var(--accent); padding: 16px; border-radius: 12px; margin-bottom: 20px; font-size: 13px; color: var(--accent);">
        <strong>✓ Complete Traceability:</strong> All requirements are traced to test cases. Excellent compliance!
      </div>
    `}

    <!-- RTM Table -->
    <div style="overflow-x: auto;">
      <table class="projects-table">
        <thead>
          <tr>
            <th style="width: 120px;">Req ID</th>
            <th style="min-width: 250px;">Requirement</th>
            <th style="width: 100px;">Type</th>
            <th style="width: 100px;">Priority</th>
            <th style="width: 80px;">Risk</th>
            <th style="width: 200px;">Linked Test Cases</th>
            <th style="width: 100px;">Status</th>
          </tr>
        </thead>
        <tbody>
  `;

  proj.requirements.forEach(req => {
    const testCaseCount = req.testCases ? req.testCases.length : 0;
    const passedCount = req.testCases ? req.testCases.filter(tc => tc.status === 'Passed').length : 0;
    const failedCount = req.testCases ? req.testCases.filter(tc => tc.status === 'Failed').length : 0;
    const inProgressCount = req.testCases ? req.testCases.filter(tc => tc.status === 'In Progress').length : 0;
    
    const testCasesList = req.testCases && req.testCases.length > 0 ? 
      req.testCases.map(tc => {
        const statusIcons = {
          'Not Started': '⚪',
          'In Progress': '🟡',
          'Passed': '🟢',
          'Failed': '🔴'
        };
        return `<div style="margin: 4px 0; font-size: 11px; padding: 6px 8px; background: var(--surface); border-radius: 6px; display: flex; justify-content: space-between; align-items: center;">
          <span><strong>${tc.id}</strong> (${tc.type})</span>
          <span>${statusIcons[tc.status]}</span>
        </div>`;
      }).join('') : 
      '<span style="color: #ef4444; font-size: 12px; font-weight: 600;">⚠ No tests linked</span>';

    const priorityColors = {
      'Critical': 'background: rgba(239, 68, 68, 0.2); color: #fca5a5; border: 1px solid rgba(239, 68, 68, 0.3);',
      'High': 'background: rgba(249, 115, 22, 0.2); color: #fb923c; border: 1px solid rgba(249, 115, 22, 0.3);',
      'Medium': 'background: rgba(59, 130, 246, 0.2); color: #93c5fd; border: 1px solid rgba(59, 130, 246, 0.3);',
      'Low': 'background: rgba(156, 163, 175, 0.2); color: #9ca3af; border: 1px solid rgba(156, 163, 175, 0.3);'
    };

    const verificationStatus = testCaseCount === 0 ? 
      '<span style="color: #ef4444; font-weight: 600;">Not Traced</span>' :
      passedCount === testCaseCount ?
      '<span style="color: var(--accent); font-weight: 600;">✓ Verified</span>' :
      failedCount > 0 ?
      '<span style="color: #ef4444; font-weight: 600;">✗ Failed</span>' :
      '<span style="color: #fb923c; font-weight: 600;">In Progress</span>';

    html += `
      <tr onclick="viewRequirement('${proj.id}', '${req.id}')" style="cursor: pointer;" title="Click to view details">
        <td><strong style="color: var(--accent);">${req.id}</strong></td>
        <td>
          <div style="font-weight: 600; margin-bottom: 4px;">${req.description.substring(0, 100)}${req.description.length > 100 ? '...' : ''}</div>
          <div style="font-size: 11px; color: var(--text-dim);">Category: ${req.category}</div>
        </td>
        <td><span style="font-size: 11px; padding: 4px 8px; background: var(--surface); border-radius: 4px; display: inline-block;">${req.type}</span></td>
        <td><span style="${priorityColors[req.priority]} padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; display: inline-block; white-space: nowrap;">${req.priority}</span></td>
        <td style="text-align: center;"><span style="font-weight: 600; color: ${req.risk === 'High' ? '#ef4444' : req.risk === 'Medium' ? '#fb923c' : '#9ca3af'};">${req.risk}</span></td>
        <td>${testCasesList}</td>
        <td style="text-align: center;">
          ${verificationStatus}
          ${testCaseCount > 0 ? `<div style="font-size: 10px; color: var(--text-dim); margin-top: 4px;">${passedCount}/${testCaseCount} passed</div>` : ''}
        </td>
      </tr>
    `;
  });

  html += `
        </tbody>
      </table>
    </div>

    <!-- Export Options -->
    <div style="margin-top: 30px; padding: 20px; background: var(--surface); border: 1px solid var(--border); border-radius: 12px; text-align: center;">
      <div style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">Export RTM Report</div>
      <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
        <button class="btn btn-secondary" onclick="showAlert('CSV export coming soon', 'info')">📄 Export to CSV</button>
        <button class="btn btn-secondary" onclick="showAlert('PDF export coming soon', 'info')">📑 Export to PDF</button>
        <button class="btn btn-secondary" onclick="showAlert('Excel export coming soon', 'info')">📊 Export to Excel</button>
      </div>
    </div>
  `;

  container.innerHTML = html;
}


    // ========== DASHBOARD ==========
// DASHBOARD - Enhanced Version
async function updateDashboard() {
    try {
        // Load all projects
        const { data: projects, error } = await supabaseClient
            .from('validation_projects')
            .select('*, validation_deliverables(*)')
            .order('created_at', { ascending: false });

        if (error) throw error;

        // Basic counts
        const totalProjects = projects.length;
        const gamp5Count = projects.filter(p => p.gamp_category === 'Category 5').length;
        const inProgressCount = projects.filter(p => 
            p.status === 'Planning' || p.status === 'In Progress' || p.status === 'Testing'
        ).length;
        const completedCount = projects.filter(p => p.status === 'Completed').length;
        const activeCount = projects.filter(p => p.status !== 'Completed' && p.status !== 'Cancelled').length;

        // Update main stats
        document.getElementById('totalProjects').textContent = totalProjects;
        document.getElementById('gamp5Count').textContent = gamp5Count;
        document.getElementById('inProgressCount').textContent = inProgressCount;
        document.getElementById('completedCount').textContent = completedCount;
        document.getElementById('activeProjectsCount').textContent = activeCount;
        document.getElementById('completedProjectsCount').textContent = completedCount;

        // Recent Projects List
        renderRecentProjects(projects.slice(0, 5));

        // Deliverables Statistics
        renderDeliverablesStats(projects);

        // GAMP Distribution
        renderGAMPDistribution(projects);

        // Status Distribution
        renderStatusDistribution(projects);

    } catch (error) {
        console.error('Error updating dashboard:', error);
    }
}

function renderRecentProjects(projects) {
    const container = document.getElementById('recentProjectsList');
    
    if (projects.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-dim);">No recent projects</div>';
        return;
    }

    container.innerHTML = projects.map(proj => {
        const statusColors = {
            'Planning': 'status-pending',
            'In Progress': 'status-inprogress',
            'Testing': 'status-inprogress',
            'Completed': 'status-completed'
        };

        return `
            <div class="deliverable-item" style="margin-bottom: 12px; cursor: pointer;" onclick="viewProjectDetails('${proj.id}')">
                <div class="deliverable-info" style="flex: 1;">
                    <div class="deliverable-title">${proj.system_name}</div>
                    <div class="deliverable-meta" style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center;">
                        <span style="font-size: 11px; padding: 4px 8px; background: var(--surface); border-radius: 4px; font-family: monospace;">${proj.project_number}</span>
                        <span style="font-size: 12px; color: var(--text-dim);">${proj.gamp_category}</span>
                        <span style="font-size: 12px; color: var(--text-dim);">${proj.methodology}</span>
                    </div>
                </div>
                <span class="status-tag ${statusColors[proj.status] || 'status-pending'}">${proj.status}</span>
            </div>
        `;
    }).join('');
}

function renderDeliverablesStats(projects) {
    const container = document.getElementById('deliverablesStats');
    
    let totalDeliverables = 0;
    let completedDeliverables = 0;
    let inProgressDeliverables = 0;
    let pendingDeliverables = 0;

    projects.forEach(proj => {
        if (proj.validation_deliverables) {
            totalDeliverables += proj.validation_deliverables.length;
            completedDeliverables += proj.validation_deliverables.filter(d => d.status === 'Completed').length;
            inProgressDeliverables += proj.validation_deliverables.filter(d => d.status === 'In Progress').length;
            pendingDeliverables += proj.validation_deliverables.filter(d => d.status === 'Not Started').length;
        }
    });

    const completionRate = totalDeliverables > 0 
        ? Math.round((completedDeliverables / totalDeliverables) * 100) 
        : 0;

    container.innerHTML = `
        <div style="display: grid; gap: 16px;">
            <div style="background: var(--surface); padding: 16px; border-radius: 12px;">
                <div style="font-size: 11px; color: var(--text-dim); margin-bottom: 4px;">Completion Rate</div>
                <div style="font-size: 28px; font-weight: 800; color: var(--accent); margin-bottom: 8px;">${completionRate}%</div>
                <div class="progress-bar" style="height: 8px; margin-top: 8px;">
                    <div class="progress-fill" style="width: ${completionRate}%;"></div>
                </div>
            </div>

            <div style="display: grid; gap: 8px;">
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--surface); border-radius: 8px;">
                    <span style="font-size: 13px;">Completed</span>
                    <span style="font-weight: 700; color: var(--accent);">${completedDeliverables}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--surface); border-radius: 8px;">
                    <span style="font-size: 13px;">In Progress</span>
                    <span style="font-weight: 700; color: #fb923c;">${inProgressDeliverables}</span>
                </div>
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--surface); border-radius: 8px;">
                    <span style="font-size: 13px;">Pending</span>
                    <span style="font-weight: 700; color: #9ca3af;">${pendingDeliverables}</span>
                </div>
            </div>
        </div>
    `;
}

function renderGAMPDistribution(projects) {
    const container = document.getElementById('gampDistribution');
    
    const gampCounts = {
        'Category 1': 0,
        'Category 3': 0,
        'Category 4': 0,
        'Category 5': 0
    };

    projects.forEach(proj => {
        if (gampCounts.hasOwnProperty(proj.gamp_category)) {
            gampCounts[proj.gamp_category]++;
        }
    });

    const total = projects.length;
    const colors = {
        'Category 1': '#9ca3af',
        'Category 3': '#93c5fd',
        'Category 4': '#fb923c',
        'Category 5': '#fca5a5'
    };

    container.innerHTML = Object.entries(gampCounts).map(([category, count]) => {
        const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
        return `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--surface); border-radius: 10px;">
                <div style="width: 40px; height: 40px; background: ${colors[category]}20; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 800; color: ${colors[category]};">
                    ${count}
                </div>
                <div style="flex: 1;">
                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 4px;">${category}</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="flex: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: ${colors[category]};"></div>
                        </div>
                        <span style="font-size: 12px; color: var(--text-dim); min-width: 35px;">${percentage}%</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function renderStatusDistribution(projects) {
    const container = document.getElementById('statusDistribution');
    
    const statusCounts = {
        'Planning': 0,
        'In Progress': 0,
        'Testing': 0,
        'Completed': 0,
        'On Hold': 0
    };

    projects.forEach(proj => {
        if (statusCounts.hasOwnProperty(proj.status)) {
            statusCounts[proj.status]++;
        }
    });

    const total = projects.length;
    const colors = {
        'Planning': '#93c5fd',
        'In Progress': '#fb923c',
        'Testing': '#a78bfa',
        'Completed': '#34d399',
        'On Hold': '#9ca3af'
    };

    container.innerHTML = Object.entries(statusCounts).map(([status, count]) => {
        const percentage = total > 0 ? Math.round((count / total) * 100) : 0;
        return `
            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--surface); border-radius: 10px;">
                <div style="width: 40px; height: 40px; background: ${colors[status]}20; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 800; color: ${colors[status]};">
                    ${count}
                </div>
                <div style="flex: 1;">
                    <div style="font-size: 13px; font-weight: 600; margin-bottom: 4px;">${status}</div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="flex: 1; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden;">
                            <div style="width: ${percentage}%; height: 100%; background: ${colors[status]};"></div>
                        </div>
                        <span style="font-size: 12px; color: var(--text-dim); min-width: 35px;">${percentage}%</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}


function switchTab(tabName) {
    // Remove active from all tabs
    document.querySelectorAll('.tab-content').forEach(el => {
        if (el) el.classList.remove('active');
    });
    
    document.querySelectorAll('.tab-btn').forEach(el => {
        if (el) el.classList.remove('active');
    });
    
    // Activate selected tab content
    const tabContent = document.getElementById(tabName);
    if (tabContent) {
        tabContent.classList.add('active');
    } else {
        console.error('Tab not found:', tabName);
        return;
    }
    
    // Activate the corresponding button
    // Find button by matching onclick attribute or data attribute
    const buttons = document.querySelectorAll('.tab-btn');
    buttons.forEach(btn => {
        const onclick = btn.getAttribute('onclick');
        if (onclick && onclick.includes(`'${tabName}'`)) {
            btn.classList.add('active');
        }
    });
    
    // Load data based on tab
    if (tabName === 'agile') {
        loadSprintProjects();
    } else if (tabName === 'applications') {
        loadApplications();
    } else if (tabName === 'requirements') {
        loadProjectsForRequirements();
    } else if (tabName === 'deliverables') {
        loadProjectsForDeliverables();
    } else if (tabName === 'projects') {
        // Load projects if needed
    } else if (tabName === 'testing') {
        // Load testing data if needed
    }
}





// Load projects for deliverables tab
async function loadProjectsForDeliverables() {
    try {
        const { data, error } = await supabaseClient
            .from('validation_projects')
            .select('id, project_number, system_name')
            .order('created_at', { ascending: false });

        if (error) throw error;

        const selector = document.getElementById('deliverablesProjectSelector');
        if (selector) {
            selector.innerHTML = '<option value="">-- Select Project --</option>';
            data.forEach(proj => {
                const option = document.createElement('option');
                option.value = proj.id;
                option.textContent = `${proj.project_number} - ${proj.system_name}`;
                selector.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading projects for deliverables:', error);
    }
}

// Load projects for requirements tab
async function loadProjectsForRequirements() {
    try {
        const { data, error } = await supabaseClient
            .from('validation_projects')
            .select('id, project_number, system_name')
            .order('created_at', { ascending: false });

        if (error) throw error;

        const selector = document.getElementById('requirementsProjectSelector');
        if (selector) {
            selector.innerHTML = '<option value="">-- Select Project --</option>';
            data.forEach(proj => {
                const option = document.createElement('option');
                option.value = proj.id;
                option.textContent = `${proj.project_number} - ${proj.system_name}`;
                selector.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading projects for requirements:', error);
    }
}

// Placeholder for test suite modal
function openNewTestSuiteModal() {
    alert('Test Suite Management coming soon! This feature is under development.');
}

// Placeholder for test view toggle
function toggleTestView(view) {
    alert('Test view toggle coming soon! Feature: ' + view);
}


// Open PROJECT modal - BULLETPROOF VERSION (same as application modal)
function openNewProjectModal() {
    try {
        console.log('🎯 Opening PROJECT modal...');
        
        // Find the modal - it's called 'projectModal' in your HTML
        const modal = document.getElementById('projectModal');
        if (!modal) {
            console.error('❌ Project Modal not found!');
            alert('Error: Project modal not found in page');
            return;
        }
        
        console.log('✅ Project modal found:', modal);
        
        // Show the modal - BOTH methods for safety
        modal.style.display = 'flex';
        modal.classList.add('active');
        
        // Reset the form
        const form = modal.querySelector('form');
        if (form) {
            form.reset();
            console.log('✅ Form reset');
        } else {
            console.warn('⚠️ No form found, but modal will still show');
        }
        
        // Reset all inputs manually (in case form.reset() doesn't work)
        const inputs = modal.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            if (input.type === 'checkbox' || input.type === 'radio') {
                input.checked = false;
            } else {
                input.value = '';
            }
        });
        
        // Load applications into dropdown
        console.log('📡 Loading applications...');
        loadApplicationsForProject();
        
        // Show step 1 (if wizard)
        if (typeof setWizardStep === 'function') {
            setWizardStep(1);
        }
        
        // Scroll to top
        setTimeout(() => {
            const modalContent = modal.querySelector('.modal-content');
            if (modalContent) {
                modalContent.scrollTop = 0;
            }
        }, 100);
        
        console.log('✅ Project modal opened successfully');
        
    } catch (error) {
        console.error('❌ Error opening project modal:', error);
        alert('Error opening modal: ' + error.message);
    }
}

// Make it globally accessible
window.openNewProjectModal = openNewProjectModal;





function closeProjectModal() {
  const modal = document.getElementById('projectModal');
  
  if (modal) {
    modal.classList.remove('active');
    modal.style.display = 'none';
  }
}


    function goToStep2() {
      if (!document.getElementById('projectName').value.trim() || !document.getElementById('systemName').value.trim()) {
        showAlert('Please fill Project Name and System Name', 'error');
        return;
      }
      setWizardStep(2);
    }

    function goToStep1() {
      setWizardStep(1);
    }

    function goToStep3() {
      setWizardStep(3);
    }

    function setWizardStep(step) {
      document.querySelectorAll('.wizard-step').forEach(el => el.classList.remove('active'));
      document.getElementById(`step${step}`).classList.add('active');

      document.querySelectorAll('.step-dot').forEach((el, idx) => {
        if (idx < step) el.classList.add('active');
        else el.classList.remove('active');
      });
    }

    function showAlert(message, type = 'info') {
      const alert = document.getElementById('alert');
      const icon = document.getElementById('alertIcon');
      const text = document.getElementById('alertText');

      alert.className = `alert ${type} active`;
      text.textContent = message;

      if (type === 'success') icon.textContent = '✓';
      else if (type === 'error') icon.textContent = '✕';
      else icon.textContent = 'ⓘ';

      setTimeout(() => alert.classList.remove('active'), 4000);
    }

    // Close modals on outside click
    document.getElementById('projectModal').addEventListener('click', (e) => {
      if (e.target.id === 'projectModal') closeProjectModal();
    });

    document.getElementById('deleteDeliverableModal').addEventListener('click', (e) => {
      if (e.target.id === 'deleteDeliverableModal') closeDeleteModal();
    });

    document.getElementById('addDeliverableModal').addEventListener('click', (e) => {
      if (e.target.id === 'addDeliverableModal') closeAddDeliverableModal();
    });

// Close modals on outside click
document.getElementById('addRequirementModal')?.addEventListener('click', (e) => {
  if (e.target.id === 'addRequirementModal') closeAddRequirementModal();
});

document.getElementById('viewRequirementModal')?.addEventListener('click', (e) => {
  if (e.target.id === 'viewRequirementModal') closeViewRequirementModal();
});

document.getElementById('linkTestCaseModal')?.addEventListener('click', (e) => {
  if (e.target.id === 'linkTestCaseModal') closeLinkTestCaseModal();
});

function goToHome() {
  // Navigate to Dashboard tab
  switchTab('dashboard');
  
  // Scroll to top
  window.scrollTo(0, 0);
}

// ==========================================
// AGILE SPRINT MANAGEMENT
// ==========================================

let selectedProjectForSprints = null;

// Load projects into sprint selector
async function loadSprintProjects() {
    try {
        const { data, error } = await supabaseClient
            .from('validation_projects')
            .select('id, project_number, system_name')
            .order('created_at', { ascending: false });

        if (error) throw error;

        const selector = document.getElementById('sprintProjectSelector');
        selector.innerHTML = '<option value="">-- Select Project --</option>';
        
        data.forEach(proj => {
            const option = document.createElement('option');
            option.value = proj.id;
            option.textContent = `${proj.project_number} - ${proj.system_name}`;
            selector.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading projects:', error);
    }
}

// Load sprints for selected project
async function loadSprints() {
    const selector = document.getElementById('sprintProjectSelector');
    const projectId = selector.value;
    
    if (!projectId) {
        document.getElementById('sprintsContainer').innerHTML = 
            '<div style="text-align: center; color: var(--text-dim); padding: 40px;">Select a project to manage sprints</div>';
        return;
    }

    selectedProjectForSprints = projectId;

    try {
        const { data, error } = await supabaseClient
            .from('agile_sprints')
            .select('*')
            .eq('project_id', projectId)
            .order('sprint_number', { ascending: true });

        if (error) throw error;

        const container = document.getElementById('sprintsContainer');
        
        if (data.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <div style="font-size: 48px; margin-bottom: 16px;">🏃</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 8px;">No Sprints Defined</div>
                    <div style="color: var(--text-dim);">Start by creating your first sprint for this project</div>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <table class="projects-table">
                <thead>
                    <tr>
                        <th>Sprint #</th>
                        <th>Sprint Name</th>
                        <th>Sprint Goal</th>
                        <th>Start Date</th>
                        <th>End Date</th>
                        <th>Story Points</th>
                        <th>Velocity</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map(sprint => `
                        <tr>
                            <td><strong>Sprint ${sprint.sprint_number}</strong></td>
                            <td>${sprint.sprint_name}</td>
                            <td>${sprint.sprint_goal || '-'}</td>
                            <td>${new Date(sprint.start_date).toLocaleDateString()}</td>
                            <td>${new Date(sprint.end_date).toLocaleDateString()}</td>
                            <td>${sprint.completed_story_points || 0} / ${sprint.planned_story_points || 0}</td>
                            <td>${sprint.velocity || '-'}</td>
                            <td>
                                <span class="status-tag ${getSprintStatusClass(sprint.status)}">
                                    ${sprint.status}
                                </span>
                            </td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
        `;

    } catch (error) {
        console.error('Error loading sprints:', error);
        showAlert('Error loading sprints: ' + error.message, 'error');
    }
}

function getSprintStatusClass(status) {
    const map = {
        'Planned': 'status-pending',
        'Active': 'status-inprogress',
        'Completed': 'status-completed',
        'Cancelled': 'status-pending'
    };
    return map[status] || 'status-pending';
}

// Open New Sprint Modal
function openNewSprintModal() {
    if (!selectedProjectForSprints) {
        showAlert('Please select a project first', 'error');
        return;
    }

    document.getElementById('sprintModal').classList.add('active');
    document.getElementById('sprintForm').reset();
    
    // Auto-suggest next sprint number
    suggestNextSprintNumber();
}

// Suggest next sprint number
async function suggestNextSprintNumber() {
    try {
        const { data, error } = await supabaseClient
            .from('agile_sprints')
            .select('sprint_number')
            .eq('project_id', selectedProjectForSprints)
            .order('sprint_number', { ascending: false })
            .limit(1);

        if (error) throw error;

        const nextNumber = data.length > 0 ? data[0].sprint_number + 1 : 1;
        document.getElementById('sprintNumber').value = nextNumber;
        document.getElementById('sprintName').value = `Sprint ${nextNumber}`;
    } catch (error) {
        console.error('Error suggesting sprint number:', error);
    }
}

// Close Sprint Modal
function closeSprintModal() {
    document.getElementById('sprintModal').classList.remove('active');
}

// Create Sprint
async function createSprint(event) {
    event.preventDefault();

    if (!selectedProjectForSprints) {
        showAlert('No project selected', 'error');
        return;
    }

    try {
        const sprintData = {
            project_id: selectedProjectForSprints,
            sprint_number: parseInt(document.getElementById('sprintNumber').value),
            sprint_name: document.getElementById('sprintName').value,
            sprint_goal: document.getElementById('sprintGoal').value,
            start_date: document.getElementById('sprintStartDate').value,
            end_date: document.getElementById('sprintEndDate').value,
            planned_story_points: parseInt(document.getElementById('plannedStoryPoints').value) || null,
            status: document.getElementById('sprintStatus').value
        };

        const { data, error } = await supabaseClient
            .from('agile_sprints')
            .insert([sprintData])
            .select();

        if (error) throw error;

        showAlert('Sprint created successfully!', 'success');
        closeSprintModal();
        loadSprints();
    } catch (error) {
        console.error('Error creating sprint:', error);
        showAlert('Error creating sprint: ' + error.message, 'error');
    }
}

// ==========================================
// APPLICATIONS MANAGEMENT
// ==========================================

// Load all applications
async function loadApplications() {
    console.log('🔵 Starting loadApplications...');
    
    try {
        console.log('📡 Querying Supabase...');
        
        const { data: applications, error } = await supabaseClient
            .from('applications')
            .select('*')
            .order('created_at', { ascending: false });

        console.log('📊 Query result:', { data: applications, error });

        if (error) {
            console.error('❌ Supabase error:', error);
            throw error;
        }

        console.log('✅ Got applications:', applications);
        console.log('📝 Number of applications:', applications?.length || 0);
        
        renderApplications(applications || []);
        
    } catch (error) {
        console.error('💥 Error in loadApplications:', error);
        const container = document.getElementById('applicationsContainer');
        if (container) {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <div style="color: #ef4444; margin-bottom: 12px; font-size: 18px;">⚠️ Error Loading Applications</div>
                    <div style="color: var(--text-dim); font-size: 14px; margin-bottom: 8px;">${error.message}</div>
                    <div style="color: var(--text-lighter); font-size: 12px;">Check browser console for details</div>
                </div>
            `;
        }
    }
}

function renderApplications(applications) {
  const container = document.getElementById('applicationsContainer');
  if (!container) { console.error('applicationsContainer not found'); return; }

  if (!applications || applications.length === 0) {
    container.innerHTML = `
      <div style="text-align:center; padding:60px 20px;">
        <div style="font-size:48px; margin-bottom:12px;">📦</div>
        <div style="font-weight:700; margin-bottom:6px;">No Applications Defined</div>
        <div style="color:#6b7280; margin-bottom:16px;">Create your first system/application</div>
        <button class="btn btn-primary" onclick="openNewApplicationModal()">+ Add Application</button>
      </div>`;
    return;
  }

  container.innerHTML = `
    <div style="display:grid; grid-template-columns:repeat(auto-fill,minmax(340px,1fr)); gap:16px;">
      ${applications.map(app => `
        <div class="card" style="background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:20px;">
          <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <div>
              <div style="font-weight:800; font-size:18px;">${app.application_name || 'Unnamed'}</div>
              <div style="color:#6b7280; font-family:monospace; font-size:12px;">${app.application_code || '-'}</div>
            </div>
            <div style="font-size:28px;">${getSystemIcon(app.system_type)}</div>
          </div>

          <div style="margin-top:12px; display:grid; gap:6px; font-size:13px;">
            <div style="display:flex; justify-content:space-between;">
              <span style="color:#6b7280;">Vendor</span><span>${app.vendor_name || 'N/A'}</span>
            </div>
            <div style="display:flex; justify-content:space-between;">
              <span style="color:#6b7280;">Version</span><span>${app.current_version || 'N/A'}</span>
            </div>
            <div style="display:flex; justify-content:space-between;">
              <span style="color:#6b7280;">Owner</span><span>${app.system_owner || 'N/A'}</span>
            </div>
          </div>

          <div style="margin-top:12px; display:flex; gap:8px;">
            <span style="background:rgba(16,185,129,.1); color:#10b981; border:1px solid #10b981; border-radius:6px; padding:2px 8px; font-size:11px; font-weight:700;">
              ${app.status || 'Active'}
            </span>
            <span style="background:#f3f4f6; color:#6b7280; border-radius:6px; padding:2px 8px; font-size:11px;">
              ${app.system_type || 'System'}
            </span>
          </div>
        </div>
      `).join('')}
    </div>`;
}



function getSystemIcon(systemType) {
    const icons = {
        'LIMS': '🧪',
        'ERP': '💼',
        'MES': '🏭',
        'QMS': '✅',
        'EDMS': '📄',
        'Chromatography': '📊'
    };
    return icons[systemType] || '💻';
}

// Open application modal - BULLETPROOF VERSION
function openNewApplicationModal() {
    try {
        console.log('Opening application modal...');
        
        // Find the modal
        const modal = document.getElementById('applicationModal');
        if (!modal) {
            console.error('❌ Modal not found!');
            alert('Error: Application modal not found in page');
            return;
        }
        
        // Show the modal
        modal.style.display = 'flex';
        modal.classList.add('active');
        
        // Reset the form
        const form = document.getElementById('applicationForm');
        if (form) {
            form.reset();
        } else {
            console.warn('⚠️ Form not found, but modal will still show');
        }
        
        console.log('✅ Modal opened successfully');
        
    } catch (error) {
        console.error('❌ Error opening modal:', error);
        alert('Error opening modal: ' + error.message);
    }
}

// Close application modal
function closeApplicationModal() {
    try {
        const modal = document.getElementById('applicationModal');
        if (modal) {
            modal.style.display = 'none';
            modal.classList.remove('active');
        }
    } catch (error) {
        console.error('Error closing modal:', error);
    }
}

// Also close modal when clicking outside
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('applicationModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === modal) {
                closeApplicationModal();
            }
        });
    }
});


async function loadApplicationsForProject() {
  try {
    console.log('Loading applications for project dropdown...');
    
    const { data: applications, error } = await supabaseClient
      .from('applications')
      .select('id, application_name, system_type, vendor_name')
      .order('application_name', { ascending: true });

    if (error) {
      console.error('Error loading applications:', error);
      throw error;
    }

    console.log('Got applications:', applications);

    const dropdown = document.getElementById('projectApplication');
    
    if (!dropdown) {
      console.error('projectApplication dropdown not found!');
      return;
    }

    // Clear existing options
    dropdown.innerHTML = '<option value="">Select Application</option>';

    // Add applications
    if (applications && applications.length > 0) {
      applications.forEach(app => {
        const option = document.createElement('option');
        option.value = app.id;
        option.textContent = `${app.application_name} ${app.system_type ? '(' + app.system_type + ')' : ''}`;
        dropdown.appendChild(option);
      });
      
      console.log(`✅ Loaded ${applications.length} applications into dropdown`);
    } else {
      dropdown.innerHTML = '<option value="">No applications found - Create one first</option>';
      console.warn('No applications found in database');
    }

  } catch (error) {
    console.error('Failed to load applications:', error);
    const dropdown = document.getElementById('projectApplication');
    if (dropdown) {
      dropdown.innerHTML = '<option value="">Error loading applications</option>';
    }
  }
}


// ==========================================
// AUTO-VERSION GENERATION
// ==========================================

async function generateNextVersionNumber(applicationId) {
    try {
        // Get latest version for this application
        const { data: versions, error } = await supabaseClient
            .from('application_versions')
            .select('version_number')
            .eq('application_id', applicationId)
            .order('created_at', { ascending: false })
            .limit(1);
        
        if (error) throw error;
        
        // If no versions exist, return 1.0
        if (!versions || versions.length === 0) {
            return '1.0';
        }
        
        return versions[0].version_number;
        
    } catch (error) {
        console.error('Error getting latest version:', error);
        return '1.0'; // Default to 1.0 if error
    }
}

function calculateNextVersion(currentVersion, releaseType) {
    // Parse current version (handles both 1.0 and 1.0.0 formats)
    const parts = currentVersion.split('.').map(Number);
    let major = parts[0] || 1;
    let minor = parts[1] || 0;
    let patch = parts[2] || 0;
    
    switch(releaseType) {
        case 'Major':
            major += 1;
            minor = 0;
            patch = 0;
            return `${major}.0`;
        
        case 'Minor':
            minor += 1;
            patch = 0;
            return `${major}.${minor}`;
        
        case 'Patch':
            patch += 1;
            return `${major}.${minor}.${patch}`;
        
        case 'Configuration':
            // Configuration doesn't change version number
            return currentVersion;
        
        default:
            return currentVersion;
    }
}


// Create new application
async function createApplication(event) {
    event.preventDefault();

    try {
        const appId = `APP-${Date.now()}`;
        
const applicationData = {
    id: appId,
    application_name: document.getElementById('appName').value,
    application_code: document.getElementById('appCode').value,
    system_type: document.getElementById('appSystemType').value,
    gxp_impact: 'Direct',  // Default value or remove this line if column is nullable
    vendor_name: document.getElementById('appVendor').value,
            current_version: document.getElementById('appVersion').value,
            system_owner: document.getElementById('appOwner').value,
            business_unit: document.getElementById('appBusinessUnit').value,
            description: document.getElementById('appDescription').value,
            installation_date: document.getElementById('appInstallDate').value || null,
            go_live_date: document.getElementById('appGoLiveDate').value || null,
            status: 'Active'
        };

        const { data, error } = await supabaseClient
            .from('applications')
            .insert([applicationData])
            .select();

        if (error) throw error;

        showAlert('Application created successfully!', 'success');
        closeApplicationModal();
        loadApplications();
    } catch (error) {
        console.error('Error creating application:', error);
        showAlert('Error creating application: ' + error.message, 'error');
    }
}

// View application details and its projects
function viewApplicationDetails(appId) {
    // TODO: Navigate to application detail view or open modal showing projects
    alert('View application details: ' + appId + '\n\nComing soon: Show all validation projects for this application');
}

// ==========================================
// GXP ASSESSMENT INTEGRATION
// ==========================================

let gxpAssessmentWindow = null;

function openGxPAssessment() {
    // Open assessment in a centered popup window
    const width = 1000;
    const height = 800;
    const left = (screen.width - width) / 2;
    const top = (screen.height - height) / 2;
    
    gxpAssessmentWindow = window.open(
        'gxp-assessment.html', 
        'GxPAssessment', 
        `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`
    );
    
    // Listen for result from assessment
    window.addEventListener('message', handleGxPAssessmentResult);
}

function handleGxPAssessmentResult(event) {
    // Security: Only accept messages from same origin
    if (event.origin !== window.location.origin) return;
    
    if (event.data.type === 'gxpAssessmentComplete') {
        const result = event.data.result;
        
        // Auto-fill the GxP Impact dropdown based on assessment
        const gxpImpactSelect = document.getElementById('gxpImpact');
        if (gxpImpactSelect) {
            if (result.is_gxp_critical) {
                gxpImpactSelect.value = 'GxP Critical';
                
                // Show detailed success message
                showAlert(
                    `✅ Assessment Complete! System classified as GxP Critical (${result.yes_count}/5 factors). The dropdown has been auto-filled.`, 
                    'success'
                );
            } else {
                gxpImpactSelect.value = 'Non-GxP';
                
                showAlert(
                    `ℹ️ Assessment Complete! System classified as Non-GxP (${result.yes_count}/5 factors). The dropdown has been auto-filled.`, 
                    'success'
                );
            }
            
            // Trigger change event to ensure form validation updates
            gxpImpactSelect.dispatchEvent(new Event('change'));
        }
        
        // Store the full assessment result for later use
        sessionStorage.setItem('lastGxPAssessment', JSON.stringify({
            ...result,
            projectAssociatedAt: new Date().toISOString()
        }));
        
        // Remove the event listener after handling
        window.removeEventListener('message', handleGxPAssessmentResult);
    }
}

// ==========================================
// VERSION MANAGEMENT FUNCTIONS
// ==========================================

let allVersions = [];

async function openVersionManagement() {
    document.getElementById('versionManagementModal').classList.add('active');
    document.getElementById('versionManagementModal').style.display = 'flex';
    await loadVersions();
}

function closeVersionManagement() {
    document.getElementById('versionManagementModal').classList.remove('active');
    document.getElementById('versionManagementModal').style.display = 'none';
}

async function loadVersions() {
    try {
        const { data: versions, error } = await supabaseClient
            .from('application_versions')
            .select(`
                *,
                applications (application_name, application_code)
            `)
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        allVersions = versions;
        renderVersions(versions);
        
        // Populate filter dropdown
        const filterSelect = document.getElementById('versionAppFilter');
        const { data: apps } = await supabaseClient.from('applications').select('id, application_name').order('application_name');
        filterSelect.innerHTML = '<option value="">All Applications</option>' +
            apps.map(app => `<option value="${app.id}">${app.application_name}</option>`).join('');
            
    } catch (error) {
        console.error('Error loading versions:', error);
        showAlert('Failed to load versions', 'error');
    }
}

function renderVersions(versions) {
    const tbody = document.getElementById('versionsTableBody');
    
    if (!versions || versions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 40px;">No versions found</td></tr>';
        return;
    }
    
    tbody.innerHTML = versions.map(ver => `
        <tr>
            <td>
                <strong>${ver.applications.application_name}</strong><br>
                <small style="color: var(--text-dim);">${ver.applications.application_code}</small>
            </td>
            <td>
                <strong style="font-family: monospace; font-size: 16px;">${ver.version_number}</strong>
                ${ver.is_production ? '<br><span class="status-tag status-completed" style="font-size: 10px;">PROD</span>' : ''}
            </td>
            <td><span class="status-tag">${ver.version_type}</span></td>
            <td><span class="status-tag ${getStatusClass(ver.status)}">${ver.status}</span></td>
            <td>${ver.go_live_date ? new Date(ver.go_live_date).toLocaleDateString() : '-'}</td>
            <td><button class="btn btn-sm" onclick="viewVersionProjects('${ver.id}')">View (0)</button></td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="editVersion('${ver.id}')">Edit</button>
            </td>
        </tr>
    `).join('');
}

function filterVersionsByApp() {
    const appId = document.getElementById('versionAppFilter').value;
    const filtered = appId ? allVersions.filter(v => v.application_id === appId) : allVersions;
    renderVersions(filtered);
}

async function openNewVersionModal() {
    document.getElementById('newVersionModal').classList.add('active');
    document.getElementById('newVersionModal').style.display = 'flex';
    
    // Load applications
    const { data: apps } = await supabaseClient.from('applications').select('*').eq('status', 'Active');
    const select = document.getElementById('versionAppId');
    select.innerHTML = '<option value="">Select Application</option>' +
        apps.map(app => `<option value="${app.id}">${app.application_name}</option>`).join('');
}

function closeNewVersionModal() {
    document.getElementById('newVersionModal').classList.remove('active');
    document.getElementById('newVersionModal').style.display = 'none';
    document.getElementById('versionForm').reset();
}

function updateValidationApproach() {
    const type = document.getElementById('versionType').value;
    const approachSelect = document.getElementById('validationApproach');
    
    const recommendations = {
        'Major': 'Full CSV',
        'Minor': 'Partial Validation',
        'Patch': 'Impact Assessment',
        'Configuration': 'Configuration OQ'
    };
    
    approachSelect.value = recommendations[type] || '';
}

async function createVersion() {
    try {
        const versionData = {
            application_id: document.getElementById('versionAppId').value,
            version_number: document.getElementById('versionNumber').value,
            version_type: document.getElementById('versionType').value,
            validation_approach: document.getElementById('validationApproach').value,
            release_date: document.getElementById('releaseDate').value || null,
            go_live_date: document.getElementById('goLiveDate').value || null,
            change_description: document.getElementById('changeDescription').value,
            is_production: document.getElementById('isProduction').checked,
            status: 'Planning'
        };
        
        const { data, error } = await supabaseClient
            .from('application_versions')
            .insert([versionData])
            .select();
        
        if (error) throw error;
        
        showAlert('Version created successfully!', 'success');
        closeNewVersionModal();
        loadVersions();
        
    } catch (error) {
        console.error('Error creating version:', error);
        showAlert('Failed to create version: ' + error.message, 'error');
    }
}


// Load versions when application changes
document.getElementById('projectApplication').addEventListener('change', async function() {
    const appId = this.value;
    const versionSelect = document.getElementById('projectVersion');
    
    if (!appId) {
        versionSelect.innerHTML = '<option value="">Select Application First</option>';
        versionSelect.disabled = true;
        return;
    }
    
    try {
        versionSelect.innerHTML = '<option value="">Loading versions...</option>';
        versionSelect.disabled = true;
        
        const { data: versions, error } = await supabaseClient
            .from('application_versions')
            .select('*')
            .eq('application_id', appId)
            .eq('is_active', true)
            .order('version_number', { ascending: false });
        
        if (error) throw error;
        
        if (!versions || versions.length === 0) {
            versionSelect.innerHTML = `
                <option value="_new_">No versions yet - Create first version (1.0)</option>
            `;
        } else {
            versionSelect.innerHTML = '<option value="">Select Version</option>' +
                '<option value="_new_">+ Create New Version</option>' +
                '<option disabled>────────────────</option>' +
                versions.map(v => `
                    <option value="${v.id}">
                        ${v.version_number} - ${v.status}${v.is_production ? ' (PROD)' : ''}
                    </option>
                `).join('');
        }
        
        versionSelect.disabled = false;
        
    } catch (error) {
        console.error('Error loading versions:', error);
        versionSelect.innerHTML = '<option value="">Error loading versions</option>';
        showAlert('Failed to load versions: ' + error.message, 'error');
    }
});

// Handle version selection
document.getElementById('projectVersion').addEventListener('change', async function() {
    if (this.value === '_new_') {
        await openQuickVersionDialog();
    }
});


async function openQuickVersionDialog() {
    const appId = document.getElementById('projectApplication').value;
    
    if (!appId) {
        showAlert('Please select an application first', 'error');
        return;
    }
    
    // Get latest version
    const latestVersion = await generateNextVersionNumber(appId);
    
    // Show dialog
    const releaseType = prompt(
        `Current version: ${latestVersion}\n\n` +
        `Select release type:\n` +
        `1 = Major Release (${calculateNextVersion(latestVersion, 'Major')})\n` +
        `2 = Minor Release (${calculateNextVersion(latestVersion, 'Minor')})\n` +
        `3 = Patch Release (${calculateNextVersion(latestVersion, 'Patch')})\n\n` +
        `Enter 1, 2, or 3:`,
        '2'
    );
    
    if (!releaseType || !['1', '2', '3'].includes(releaseType)) {
        document.getElementById('projectVersion').value = '';
        return;
    }
    
    const releaseTypes = { '1': 'Major', '2': 'Minor', '3': 'Patch' };
    const selectedType = releaseTypes[releaseType];
    const newVersion = calculateNextVersion(latestVersion, selectedType);
    
    // Create version
    try {
        const versionData = {
            application_id: appId,
            version_number: newVersion,
            version_type: selectedType,
            status: 'Planning',
            is_active: true,
            is_production: false,
            validation_approach: selectedType === 'Major' ? 'Full CSV' : selectedType === 'Minor' ? 'Partial Validation' : 'Impact Assessment',
            change_description: `${selectedType} release ${newVersion}`
        };
        
        const { data, error } = await supabaseClient
            .from('application_versions')
            .insert([versionData])
            .select();
        
        if (error) throw error;
        
        showAlert(`Version ${newVersion} created successfully!`, 'success');
        
        // Refresh version dropdown
        document.getElementById('projectApplication').dispatchEvent(new Event('change'));
        
        // Auto-select the new version
        setTimeout(() => {
            document.getElementById('projectVersion').value = data[0].id;
        }, 500);
        
    } catch (error) {
        console.error('Error creating version:', error);
        showAlert('Failed to create version: ' + error.message, 'error');
    }
}


// Add this near the bottom of your script, with other event listeners
document.getElementById('projectApplication')?.addEventListener('change', async function() {
  const appId = this.value;
  const versionDropdown = document.getElementById('projectVersion');
  
  if (!appId || !versionDropdown) {
    if (versionDropdown) {
      versionDropdown.disabled = true;
      versionDropdown.innerHTML = '<option value="">Select Application First</option>';
    }
    return;
  }

  // Load versions for selected application
  versionDropdown.disabled = false;
  versionDropdown.innerHTML = '<option value="">Loading versions...</option>';

  try {
    const { data: versions, error } = await supabaseClient
      .from('application_versions')
      .select('id, version_number, is_production')
      .eq('application_id', appId)
      .order('version_number', { ascending: false });

    if (error) throw error;

    versionDropdown.innerHTML = '<option value="">Select Version</option>';
    versionDropdown.innerHTML += '<option value="new">➕ Create New Version</option>';

    if (versions && versions.length > 0) {
      versions.forEach(ver => {
        const option = document.createElement('option');
        option.value = ver.id;
        option.textContent = `v${ver.version_number}${ver.is_production ? ' (Production)' : ''}`;
        versionDropdown.appendChild(option);
      });
    }

  } catch (error) {
    console.error('Error loading versions:', error);
    versionDropdown.innerHTML = '<option value="">Error loading versions</option>';
  }
});



  </script>
</body>
</html>