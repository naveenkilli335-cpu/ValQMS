<script>
  // ===== AUTHENTICATION CHECK - MUST BE FIRST =====
  (function checkAuth() {
    const user = localStorage.getItem('valqmsUser');
    
    if (!user) {
      window.location.href = 'login.html';
      return;
    }
    
    try {
      const userData = JSON.parse(user);
      
      if (!userData.loggedIn) {
        window.location.href = 'login.html';
        return;
      }
      
      const sessionDuration = 24 * 60 * 60 * 1000;
      const now = Date.now();
      
      if (userData.timestamp && (now - userData.timestamp) > sessionDuration) {
        localStorage.removeItem('valqmsUser');
        alert('Session expired. Please log in again.');
        window.location.href = 'login.html';
        return;
      }
      
    } catch (e) {
      localStorage.removeItem('valqmsUser');
      window.location.href = 'login.html';
    }
  })();

  // Initialize theme/background
  (function init(){
    const savedTheme = localStorage.getItem('valqmsTheme') || 'green';
    const savedBg = localStorage.getItem('valqmsBg') || 'mesh';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.documentElement.setAttribute('data-bg', savedBg);
  })();

  // Theme System
  const themeBtn = document.getElementById('themeBtn');
  const themeDropdown = document.getElementById('themeDropdown');
  const themeOptions = document.querySelectorAll('.theme-option');
  
  themeBtn.addEventListener('click', e => {
    e.stopPropagation();
    themeDropdown.classList.toggle('active');
    document.getElementById('bgDropdown').classList.remove('active');
  });
  
  document.addEventListener('click', () => {
    themeDropdown.classList.remove('active');
    document.getElementById('bgDropdown').classList.remove('active');
  });
  
  themeDropdown.addEventListener('click', e => e.stopPropagation());
  
  themeOptions.forEach(opt => {
    opt.addEventListener('click', () => {
      const theme = opt.dataset.theme;
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('valqmsTheme', theme);
      themeDropdown.classList.remove('active');
    });
  });

  // Background System
  const bgBtn = document.getElementById('bgBtn');
  const bgDropdown = document.getElementById('bgDropdown');
  const bgOptions = document.querySelectorAll('.bg-option');
  
  bgBtn.addEventListener('click', e => {
    e.stopPropagation();
    bgDropdown.classList.toggle('active');
    themeDropdown.classList.remove('active');
  });
  
  bgDropdown.addEventListener('click', e => e.stopPropagation());
  
  bgOptions.forEach(opt => {
    opt.addEventListener('click', () => {
      const bg = opt.dataset.bg;
      document.documentElement.setAttribute('data-bg', bg);
      localStorage.setItem('valqmsBg', bg);
      bgDropdown.classList.remove('active');
    });
  });

  // User Session Management
  const loginLink = document.getElementById('loginLink');
  const userMenu = document.getElementById('userMenu');
  const userBadge = document.getElementById('userBadge');
  const userDropdown = document.getElementById('userDropdown');
  const logoutBtn = document.getElementById('logoutBtn');

  function getSession() {
    try {
      return JSON.parse(localStorage.getItem('valqmsUser'));
    } catch (e) {
      return null;
    }
  }

  function getInitials(name) {
    if (!name) return 'U';
    const parts = name.trim().split(' ');
    if (parts.length >= 2) {
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }
    return name[0].toUpperCase();
  }

  function updateUserUI() {
    const user = getSession();
    if (user) {
      if (loginLink) loginLink.style.display = 'none';
      userMenu.style.display = 'inline-block';
      
      const displayName = user.name || user.email.split('@')[0];
      userBadge.textContent = getInitials(displayName);
    } else {
      userMenu.style.display = 'none';
      if (loginLink) loginLink.style.display = 'inline-block';
    }
  }

  // User menu toggle
  if (userBadge) {
    userBadge.addEventListener('click', e => {
      e.stopPropagation();
      const isOpen = userDropdown.style.display === 'block';
      userDropdown.style.display = isOpen ? 'none' : 'block';
      themeDropdown.classList.remove('active');
      bgDropdown.classList.remove('active');
    });
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', e => {
    if (userMenu && !userMenu.contains(e.target)) {
      if (userDropdown) userDropdown.style.display = 'none';
    }
  });

  // âœ… FIXED LOGOUT - This was missing proper event binding
  if (logoutBtn) {
    logoutBtn.addEventListener('click', (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      if (confirm('Are you sure you want to logout?')) {
        // Clear user session
        localStorage.removeItem('valqmsUser');
        
        // Close dropdown
        if (userDropdown) userDropdown.style.display = 'none';
        
        // Redirect to login
        window.location.href = 'login.html';
      }
    });
  }

  // Initialize user UI
  updateUserUI();

  // Mobile Menu
  const mobileMenuBtn = document.getElementById('mobileMenuBtn');
  const mainNav = document.getElementById('mainNav');
  
  if (mobileMenuBtn && mainNav) {
    mobileMenuBtn.addEventListener('click', e => {
      e.stopPropagation();
      mainNav.classList.toggle('active');
    });
  }
</script>
