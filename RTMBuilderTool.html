<!DOCTYPE html>
<html lang="en" data-theme="green">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Advanced RTM Builder — ValQMS</title>
  <link rel="icon" href="favicon.jpg?v=5">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    
    /* === ALL 15 COLOR THEMES === */
    [data-theme="green"]{--accent:#10b981;--accent-bright:#34d399;--accent-dim:rgba(16,185,129,0.1)}
    [data-theme="cyan"]{--accent:#06b6d4;--accent-bright:#22d3ee;--accent-dim:rgba(6,182,212,0.1)}
    [data-theme="purple"]{--accent:#8b5cf6;--accent-bright:#a78bfa;--accent-dim:rgba(139,92,246,0.1)}
    [data-theme="orange"]{--accent:#f97316;--accent-bright:#fb923c;--accent-dim:rgba(249,115,22,0.1)}
    [data-theme="blue"]{--accent:#3b82f6;--accent-bright:#60a5fa;--accent-dim:rgba(59,130,246,0.1)}
    [data-theme="red"]{--accent:#ef4444;--accent-bright:#f87171;--accent-dim:rgba(239,68,68,0.1)}
    [data-theme="pink"]{--accent:#ec4899;--accent-bright:#f472b6;--accent-dim:rgba(236,72,153,0.1)}
    [data-theme="teal"]{--accent:#14b8a6;--accent-bright:#2dd4bf;--accent-dim:rgba(20,184,166,0.1)}
    [data-theme="indigo"]{--accent:#6366f1;--accent-bright:#818cf8;--accent-dim:rgba(99,102,241,0.1)}
    [data-theme="yellow"]{--accent:#eab308;--accent-bright:#facc15;--accent-dim:rgba(234,179,8,0.1)}
    [data-theme="magenta"]{--accent:#d946ef;--accent-bright:#e879f9;--accent-dim:rgba(217,70,239,0.1)}
    [data-theme="emerald"]{--accent:#059669;--accent-bright:#10b981;--accent-dim:rgba(5,150,105,0.1)}
    [data-theme="amber"]{--accent:#d97706;--accent-bright:#f59e0b;--accent-dim:rgba(217,119,6,0.1)}
    [data-theme="lime"]{--accent:#84cc16;--accent-bright:#a3e635;--accent-dim:rgba(132,204,22,0.1)}
    [data-theme="violet"]{--accent:#7c3aed;--accent-bright:#a78bfa;--accent-dim:rgba(124,58,237,0.1)}

    :root{
      --bg:#0a0e1a;
      --surface:#1a1f2e;
      --border:rgba(255,255,255,0.08);
      --text:#f8fafc;
      --text-dim:#94a3b8;
    }
    
    html{scroll-behavior:smooth}
    body{
      font-family:'Inter',system-ui,-apple-system,sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
      padding:24px;
      transition:all 0.3s;
    }

    .topbar{
      max-width:1800px;
      margin:0 auto 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 24px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      backdrop-filter:blur(12px);
    }
    .brand{display:flex;gap:16px;align-items:center}
    .logo-container{
      display:flex;
      align-items:center;
      gap:12px;
      text-decoration:none;
      color:var(--text);
    }
    .logo-mark{
      display:flex;
      align-items:center;
      justify-content:center;
      width:40px;
      height:40px;
      background:linear-gradient(135deg,var(--accent),var(--accent-bright));
      border-radius:10px;
      overflow:hidden;
      box-shadow:0 4px 16px var(--accent-dim);
      transition:all 0.3s;
    }
    .logo-mark img{width:100%;height:100%;object-fit:contain;padding:5px}
    .brand-text h1{font-size:20px;font-weight:800;letter-spacing:-0.5px;margin:0}
    .brand-text .subtitle{font-size:13px;color:var(--text-dim);font-weight:500}
    .header-actions{display:flex;gap:12px;align-items:center}
    .btn-home{
      padding:8px 16px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:10px;
      color:var(--text-dim);
      text-decoration:none;
      font-size:14px;
      font-weight:600;
      transition:all 0.2s;
    }
    .btn-home:hover{
      background:var(--accent-dim);
      color:var(--text);
      border-color:var(--accent);
    }

    .container{max-width:1800px;margin:0 auto}
    .card{
      background:var(--surface);
      padding:24px;
      border-radius:16px;
      border:1px solid var(--border);
      margin-bottom:16px;
      transition:all 0.3s;
    }
    .card h3{font-size:16px;font-weight:700;margin:0 0 12px 0;letter-spacing:-0.3px}

    .how-to-use{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      padding:20px 24px;
      margin-bottom:24px;
      transition:all 0.3s;
    }
    .how-to-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      user-select:none;
    }
    .how-to-header h3{
      font-size:16px;
      font-weight:700;
      margin:0;
      color:var(--accent);
      transition:color 0.3s;
    }
    .toggle-icon{font-size:14px;transition:transform 0.3s}
    .toggle-icon.collapsed{transform:rotate(-90deg)}
    .how-to-content{
      overflow:hidden;
      transition:max-height 0.3s ease-out, opacity 0.3s;
      max-height:500px;
      opacity:1;
    }
    .how-to-content.hidden{max-height:0;opacity:0;margin-top:0}
    .how-to-content ol{margin:12px 0 0 20px;color:var(--text-dim);font-size:13px;line-height:1.8}
    .how-to-content li{margin-bottom:6px}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:16px}
    .field{margin-bottom:12px}
    label{display:block;font-size:13px;color:var(--text-dim);margin-bottom:6px;font-weight:600}
    input[type=text], textarea, select{
      width:100%;
      padding:10px;
      border-radius:10px;
      border:1px solid var(--border);
      background:var(--surface);
      color:var(--text);
      font-size:14px;
      transition:all 0.2s;
    }
    input:hover, textarea:hover, select:hover{border-color:var(--accent)}
    input:focus, textarea:focus, select:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px var(--accent-dim);
    }
    textarea{min-height:100px;resize:vertical;font-family:inherit}
    
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 20px;
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:10px;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
      transition:all 0.2s;
    }
    .btn:hover{
      background:var(--accent-bright);
      transform:translateY(-1px);
      box-shadow:0 4px 12px var(--accent-dim);
    }
    .btn:disabled{opacity:0.5;cursor:not-allowed}
    .btn.secondary{
      background:var(--surface);
      border:1px solid var(--border);
      color:var(--text-dim);
    }
    .btn.secondary:hover{
      background:var(--accent-dim);
      border-color:var(--accent);
      color:var(--text);
    }
    
    .actions{display:flex;gap:10px;margin-top:12px;flex-wrap:wrap}
    
    .upload-zone{
      border:2px dashed var(--border);
      border-radius:12px;
      padding:32px;
      text-align:center;
      cursor:pointer;
      transition:all 0.3s;
      background:rgba(0,0,0,0.2);
    }
    .upload-zone:hover{
      border-color:var(--accent);
      background:var(--accent-dim);
    }
    .upload-zone.dragover{
      border-color:var(--accent);
      background:var(--accent-dim);
    }
    
    .stats{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:16px;
      margin-bottom:24px;
    }
    .stat-card{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:12px;
      padding:20px;
      transition:all 0.3s;
    }
    .stat-card:hover{
      transform:translateY(-2px);
      border-color:var(--accent);
    }
    .stat-label{
      font-size:12px;
      color:var(--text-dim);
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.5px;
      margin-bottom:8px;
    }
    .stat-value{
      font-size:32px;
      font-weight:900;
      color:var(--accent);
    }
    
    .rtm-table-container{
      overflow-x:auto;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--surface);
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th{
      background:rgba(0,0,0,0.3);
      padding:12px;
      text-align:left;
      font-weight:700;
      border-bottom:1px solid var(--border);
      position:sticky;
      top:0;
      z-index:10;
    }
    td{
      padding:12px;
      border-bottom:1px solid var(--border);
    }
    tr:hover{background:rgba(255,255,255,0.02)}
    
    .status-badge{
      display:inline-block;
      padding:4px 12px;
      border-radius:999px;
      font-size:11px;
      font-weight:700;
      text-transform:uppercase;
    }
    .status-pass{background:rgba(16,185,129,0.2);color:#34d399}
    .status-fail{background:rgba(239,68,68,0.2);color:#f87171}
    .status-pending{background:rgba(234,179,8,0.2);color:#facc15}
    .status-na{background:rgba(148,163,184,0.2);color:#94a3b8}
    
    .progress-bar{
      width:100%;
      height:8px;
      background:rgba(255,255,255,0.1);
      border-radius:999px;
      overflow:hidden;
      margin-top:8px;
    }
    .progress-fill{
      height:100%;
      background:linear-gradient(90deg,var(--accent),var(--accent-bright));
      border-radius:999px;
      transition:width 0.5s ease;
    }

    @media(max-width:768px){
      .grid{grid-template-columns:1fr}
      .topbar{flex-direction:column;gap:16px;text-align:center}
      .header-actions{width:100%;justify-content:center}
      .stats{grid-template-columns:1fr}
    }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="brand">
      <a href="index.html" class="logo-container">
        <div class="logo-mark">
          <img src="favicon.jpg" alt="ValQMS Logo">
        </div>
        <div class="brand-text">
          <h1>ValQMS Tools</h1>
          <div class="subtitle">Advanced RTM Builder</div>
        </div>
      </a>
    </div>
    <div class="header-actions">
      <a href="index.html" class="btn-home">← Home</a>
    </div>
  </div>

  <div class="container">
    
    <div class="how-to-use">
      <div class="how-to-header" id="howToToggle">
        <h3>📖 How to Use Advanced RTM Builder</h3>
        <span class="toggle-icon" id="toggleIcon">▼</span>
      </div>
      <div class="how-to-content" id="howToContent">
        <ol>
          <li><strong>Step 1:</strong> Upload Requirements Excel file (columns: Req_ID, Requirement, Priority, Category)</li>
          <li><strong>Step 2:</strong> Upload Test Cases Excel file (columns: TC_ID, Test_Case, Linked_Req_ID, Status, Execution_Date, Tester)</li>
          <li><strong>Step 3:</strong> System auto-links Requirements → Test Cases using intelligent matching</li>
          <li><strong>Step 4:</strong> Review bi-directional traceability matrix with coverage analysis</li>
          <li><strong>Step 5:</strong> Export color-coded Excel with orphaned requirements flagged</li>
          <li><strong>Advanced:</strong> AI suggests missing test cases for uncovered requirements</li>
        </ol>
      </div>
    </div>

    <!-- Statistics Dashboard -->
    <div class="stats" id="statsContainer" style="display:none">
      <div class="stat-card">
        <div class="stat-label">Total Requirements</div>
        <div class="stat-value" id="statTotalReqs">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Total Test Cases</div>
        <div class="stat-value" id="statTotalTCs">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Coverage %</div>
        <div class="stat-value" id="statCoverage">0%</div>
        <div class="progress-bar">
          <div class="progress-fill" id="coverageProgress"></div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-label">Orphaned Reqs</div>
        <div class="stat-value" id="statOrphaned" style="color:#ef4444">0</div>
      </div>
    </div>

    <div class="grid">
      <!-- Upload Section -->
      <div class="card">
        <h3>📄 Step 1: Upload Requirements</h3>
        <div class="upload-zone" id="reqUploadZone">
          <div style="font-size:48px;margin-bottom:12px">📋</div>
          <div style="font-weight:700;margin-bottom:8px">Drop Requirements Excel Here</div>
          <div style="font-size:13px;color:var(--text-dim)">or click to browse (CSV/XLSX)</div>
          <input type="file" id="reqFileInput" accept=".csv,.xlsx,.xls" style="display:none">
        </div>
        <div id="reqStatus" style="margin-top:12px;font-size:13px;color:var(--text-dim)"></div>
      </div>

      <div class="card">
        <h3>🧪 Step 2: Upload Test Cases</h3>
        <div class="upload-zone" id="tcUploadZone">
          <div style="font-size:48px;margin-bottom:12px">✅</div>
          <div style="font-weight:700;margin-bottom:8px">Drop Test Cases Excel Here</div>
          <div style="font-size:13px;color:var(--text-dim)">or click to browse (CSV/XLSX)</div>
          <input type="file" id="tcFileInput" accept=".csv,.xlsx,.xls" style="display:none">
        </div>
        <div id="tcStatus" style="margin-top:12px;font-size:13px;color:var(--text-dim)"></div>
      </div>
    </div>

    <!-- Actions -->
    <div class="card">
      <div class="actions">
        <button id="generateRTM" class="btn" disabled>
          <span>🔗</span>
          <span>Generate RTM with Auto-Linking</span>
        </button>
        <button id="analyzeGaps" class="btn secondary" disabled>
          <span>🔍</span>
          <span>Analyze Coverage Gaps</span>
        </button>
        <button id="exportExcel" class="btn secondary" disabled>
          <span>📥</span>
          <span>Export Color-Coded Excel</span>
        </button>
        <button id="exportPDF" class="btn secondary" disabled>
          <span>📄</span>
          <span>Export PDF Report</span>
        </button>
      </div>
    </div>

    <!-- RTM Table -->
    <div class="card" id="rtmTableCard" style="display:none">
      <h3>🔗 Requirements Traceability Matrix</h3>
      <div class="rtm-table-container">
        <table id="rtmTable">
          <thead>
            <tr>
              <th>Req ID</th>
              <th>Requirement</th>
              <th>Priority</th>
              <th>Linked Test Cases</th>
              <th>Status</th>
              <th>Coverage</th>
              <th>Tester</th>
              <th>Execution Date</th>
            </tr>
          </thead>
          <tbody id="rtmTableBody"></tbody>
        </table>
      </div>
    </div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    // Theme sync
    function initTheme(){
      const savedTheme = localStorage.getItem('valqmsTheme') || 'green';
      document.documentElement.setAttribute('data-theme', savedTheme);
    }
    initTheme();

    // Toggle How to Use
    document.getElementById('howToToggle').addEventListener('click', () => {
      const content = document.getElementById('howToContent');
      const icon = document.getElementById('toggleIcon');
      content.classList.toggle('hidden');
      icon.classList.toggle('collapsed');
    });

    // Data storage
    let requirementsData = [];
    let testCasesData = [];
    let rtmData = [];

    // File upload handlers
    const reqUploadZone = document.getElementById('reqUploadZone');
    const reqFileInput = document.getElementById('reqFileInput');
    const tcUploadZone = document.getElementById('tcUploadZone');
    const tcFileInput = document.getElementById('tcFileInput');

    reqUploadZone.addEventListener('click', () => reqFileInput.click());
    tcUploadZone.addEventListener('click', () => tcFileInput.click());

    reqFileInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0], 'requirements'));
    tcFileInput.addEventListener('change', (e) => handleFileUpload(e.target.files[0], 'testcases'));

    // Drag and drop
    [reqUploadZone, tcUploadZone].forEach(zone => {
      zone.addEventListener('dragover', (e) => {
        e.preventDefault();
        zone.classList.add('dragover');
      });
      zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
      zone.addEventListener('drop', (e) => {
        e.preventDefault();
        zone.classList.remove('dragover');
        const type = zone.id === 'reqUploadZone' ? 'requirements' : 'testcases';
        handleFileUpload(e.dataTransfer.files[0], type);
      });
    });

    function handleFileUpload(file, type) {
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
          const jsonData = XLSX.utils.sheet_to_json(firstSheet);
          
          if (type === 'requirements') {
            requirementsData = jsonData;
            document.getElementById('reqStatus').innerHTML = `✅ Loaded ${jsonData.length} requirements`;
            document.getElementById('reqStatus').style.color = 'var(--accent)';
          } else {
            testCasesData = jsonData;
            document.getElementById('tcStatus').innerHTML = `✅ Loaded ${jsonData.length} test cases`;
            document.getElementById('tcStatus').style.color = 'var(--accent)';
          }
          
          checkReadyToGenerate();
        } catch (err) {
          alert('Error parsing file: ' + err.message);
        }
      };
      reader.readAsArrayBuffer(file);
    }

    function checkReadyToGenerate() {
      const ready = requirementsData.length > 0 && testCasesData.length > 0;
      document.getElementById('generateRTM').disabled = !ready;
      if (ready) {
        document.getElementById('generateRTM').style.opacity = '1';
      }
    }

    // Generate RTM with intelligent linking
    document.getElementById('generateRTM').addEventListener('click', generateRTM);

    function generateRTM() {
      rtmData = [];
      
      requirementsData.forEach(req => {
        const reqId = req.Req_ID || req.req_id || req.ID || '';
        const requirement = req.Requirement || req.requirement || req.Description || '';
        const priority = req.Priority || req.priority || 'Medium';
        const category = req.Category || req.category || 'Functional';
        
        // Find linked test cases
        const linkedTCs = testCasesData.filter(tc => {
          const linkedReqId = tc.Linked_Req_ID || tc.linked_req_id || tc.Req_ID || '';
          return linkedReqId.toString().toLowerCase() === reqId.toString().toLowerCase();
        });
        
        // Calculate coverage
        const hasPassed = linkedTCs.some(tc => (tc.Status || tc.status || '').toLowerCase() === 'pass');
        const hasFailed = linkedTCs.some(tc => (tc.Status || tc.status || '').toLowerCase() === 'fail');
        const isPending = linkedTCs.length > 0 && !hasPassed && !hasFailed;
        
        let status = 'N/A';
        if (linkedTCs.length === 0) status = 'N/A';
        else if (hasFailed) status = 'Fail';
        else if (hasPassed) status = 'Pass';
        else if (isPending) status = 'Pending';
        
        rtmData.push({
          reqId,
          requirement,
          priority,
          category,
          linkedTCs,
          status,
          coverage: linkedTCs.length > 0 ? '100%' : '0%'
        });
      });
      
      displayRTM();
      updateStatistics();
      
      document.getElementById('analyzeGaps').disabled = false;
      document.getElementById('exportExcel').disabled = false;
      document.getElementById('exportPDF').disabled = false;
    }

    function displayRTM() {
      const tbody = document.getElementById('rtmTableBody');
      tbody.innerHTML = '';
      
      rtmData.forEach(row => {
        const tr = document.createElement('tr');
        
        const statusClass = 
          row.status === 'Pass' ? 'status-pass' :
          row.status === 'Fail' ? 'status-fail' :
          row.status === 'Pending' ? 'status-pending' : 'status-na';
        
        const tcList = row.linkedTCs.map(tc => 
          `${tc.TC_ID || tc.tc_id || tc.ID} (${tc.Status || tc.status || 'N/A'})`
        ).join(', ') || 'No linked TCs';
        
        const tester = row.linkedTCs.length > 0 ? 
          (row.linkedTCs[0].Tester || row.linkedTCs[0].tester || '-') : '-';
        
        const execDate = row.linkedTCs.length > 0 ?
          (row.linkedTCs[0].Execution_Date || row.linkedTCs[0].execution_date || '-') : '-';
        
        tr.innerHTML = `
          <td style="font-weight:700;color:var(--accent)">${row.reqId}</td>
          <td>${row.requirement}</td>
          <td><span class="status-badge" style="background:rgba(139,92,246,0.2);color:#a78bfa">${row.priority}</span></td>
          <td style="font-size:12px">${tcList}</td>
          <td><span class="status-badge ${statusClass}">${row.status}</span></td>
          <td>${row.coverage}</td>
          <td>${tester}</td>
          <td style="font-size:12px">${execDate}</td>
        `;
        
        tbody.appendChild(tr);
      });
      
      document.getElementById('rtmTableCard').style.display = 'block';
    }

    function updateStatistics() {
      const totalReqs = requirementsData.length;
      const totalTCs = testCasesData.length;
      const coveredReqs = rtmData.filter(r => r.linkedTCs.length > 0).length;
      const orphanedReqs = totalReqs - coveredReqs;
      const coverage = totalReqs > 0 ? Math.round((coveredReqs / totalReqs) * 100) : 0;
      
      document.getElementById('statTotalReqs').textContent = totalReqs;
      document.getElementById('statTotalTCs').textContent = totalTCs;
      document.getElementById('statCoverage').textContent = coverage + '%';
      document.getElementById('statOrphaned').textContent = orphanedReqs;
      document.getElementById('coverageProgress').style.width = coverage + '%';
      
      document.getElementById('statsContainer').style.display = 'grid';
    }

    // Export to Excel with color coding
    document.getElementById('exportExcel').addEventListener('click', exportToExcel);

    function exportToExcel() {
      const ws_data = [
        ['Req ID', 'Requirement', 'Priority', 'Category', 'Linked Test Cases', 'Status', 'Coverage', 'Tester', 'Execution Date']
      ];
      
      rtmData.forEach(row => {
        const tcList = row.linkedTCs.map(tc => `${tc.TC_ID || tc.tc_id} (${tc.Status || 'N/A'})`).join(', ') || 'ORPHANED';
        const tester = row.linkedTCs.length > 0 ? (row.linkedTCs[0].Tester || '-') : '-';
        const execDate = row.linkedTCs.length > 0 ? (row.linkedTCs[0].Execution_Date || '-') : '-';
        
        ws_data.push([
          row.reqId,
          row.requirement,
          row.priority,
          row.category,
          tcList,
          row.status,
          row.coverage,
          tester,
          execDate
        ]);
      });
      
      const ws = XLSX.utils.aoa_to_sheet(ws_data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'RTM');
      
      XLSX.writeFile(wb, 'RTM_Advanced_' + new Date().toISOString().split('T')[0] + '.xlsx');
    }

    // Analyze gaps
    document.getElementById('analyzeGaps').addEventListener('click', () => {
      const orphaned = rtmData.filter(r => r.linkedTCs.length === 0);
      
      if (orphaned.length === 0) {
        alert('✅ Perfect coverage! All requirements have linked test cases.');
      } else {
        const list = orphaned.map(r => `• ${r.reqId}: ${r.requirement.substring(0, 50)}...`).join('\n');
        alert(`⚠️ Found ${orphaned.length} orphaned requirements:\n\n${list}\n\n💡 Suggestion: Create test cases for these requirements.`);
      }
    });
  </script>
</body>
</html>
