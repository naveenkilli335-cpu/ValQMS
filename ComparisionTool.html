<!DOCTYPE html>
<html lang="en" data-theme="green" data-bg="mesh">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Excel Comparison Tool — ValQMS</title>
  <link rel="icon" href="favicon.jpg?v=5">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <!-- SheetJS & Fuse.js -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    
    /* Theme Colors */
    [data-theme="green"]{--accent:#10b981;--accent-bright:#34d399;--accent-dim:rgba(16,185,129,0.15);--accent-glow:rgba(16,185,129,0.4)}
    [data-theme="cyan"]{--accent:#06b6d4;--accent-bright:#22d3ee;--accent-dim:rgba(6,182,212,0.15);--accent-glow:rgba(6,182,212,0.4)}
    [data-theme="purple"]{--accent:#8b5cf6;--accent-bright:#a78bfa;--accent-dim:rgba(139,92,246,0.15);--accent-glow:rgba(139,92,246,0.4)}
    [data-theme="orange"]{--accent:#f97316;--accent-bright:#fb923c;--accent-dim:rgba(249,115,22,0.15);--accent-glow:rgba(249,115,22,0.4)}
    [data-theme="blue"]{--accent:#3b82f6;--accent-bright:#60a5fa;--accent-dim:rgba(59,130,246,0.15);--accent-glow:rgba(59,130,246,0.4)}
    [data-theme="red"]{--accent:#ef4444;--accent-bright:#f87171;--accent-dim:rgba(239,68,68,0.15);--accent-glow:rgba(239,68,68,0.4)}
    [data-theme="pink"]{--accent:#ec4899;--accent-bright:#f472b6;--accent-dim:rgba(236,72,153,0.15);--accent-glow:rgba(236,72,153,0.4)}
    [data-theme="teal"]{--accent:#14b8a6;--accent-bright:#2dd4bf;--accent-dim:rgba(20,184,166,0.15);--accent-glow:rgba(20,184,166,0.4)}
    [data-theme="indigo"]{--accent:#6366f1;--accent-bright:#818cf8;--accent-dim:rgba(99,102,241,0.15);--accent-glow:rgba(99,102,241,0.4)}
    [data-theme="yellow"]{--accent:#eab308;--accent-bright:#facc15;--accent-dim:rgba(234,179,8,0.15);--accent-glow:rgba(234,179,8,0.4)}
    [data-theme="magenta"]{--accent:#d946ef;--accent-bright:#e879f9;--accent-dim:rgba(217,70,239,0.15);--accent-glow:rgba(217,70,239,0.4)}
    [data-theme="emerald"]{--accent:#059669;--accent-bright:#10b981;--accent-dim:rgba(5,150,105,0.15);--accent-glow:rgba(5,150,105,0.4)}
    [data-theme="amber"]{--accent:#d97706;--accent-bright:#f59e0b;--accent-dim:rgba(217,119,6,0.15);--accent-glow:rgba(217,119,6,0.4)}
    [data-theme="lime"]{--accent:#84cc16;--accent-bright:#a3e635;--accent-dim:rgba(132,204,22,0.15);--accent-glow:rgba(132,204,22,0.4)}
    [data-theme="violet"]{--accent:#7c3aed;--accent-bright:#a78bfa;--accent-dim:rgba(124,58,237,0.15);--accent-glow:rgba(124,58,237,0.4)}

    :root{
      --text:#ffffff;
      --text-dim:#94a3b8;
      --surface:rgba(255,255,255,0.05);
      --surface-hover:rgba(255,255,255,0.08);
      --border:rgba(255,255,255,0.1);
      --glass:rgba(255,255,255,0.03);
      --ok:#10b981;
      --warn:#fbbf24;
      --err:#ef4444;
    }

    /* ANIMATED BACKGROUNDS */
    [data-bg="mesh"] body{background:#0f172a;position:relative}
    [data-bg="mesh"] body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 20% 50%, rgba(16,185,129,0.15) 0%, transparent 50%),radial-gradient(circle at 80% 80%, rgba(99,102,241,0.15) 0%, transparent 50%),radial-gradient(circle at 40% 80%, rgba(236,72,153,0.1) 0%, transparent 50%);animation:meshMove 15s ease-in-out infinite alternate;z-index:-1}

    [data-bg="gradient"] body{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);position:relative}
    [data-bg="gradient"] body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg, transparent 0%, rgba(0,0,0,0.3) 100%);z-index:-1}

    [data-bg="dots"] body{background:#0a0e27;position:relative}
    [data-bg="dots"] body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background-image:radial-gradient(circle, rgba(255,255,255,0.05) 1px, transparent 1px);background-size:30px 30px;z-index:-1}

    [data-bg="waves"] body{background:#0f172a;position:relative}
    [data-bg="waves"] body::before{content:'';position:fixed;bottom:0;left:0;width:100%;height:400px;background:linear-gradient(180deg, transparent 0%, rgba(16,185,129,0.1) 100%);animation:waveMove 8s ease-in-out infinite;z-index:-1}

    [data-bg="dark"] body{background:#0a0e1a;position:relative}
    [data-bg="dark"] body::before{content:'';position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at center, rgba(59,130,246,0.05) 0%, transparent 70%);z-index:-1}

    @keyframes meshMove{0%{transform:scale(1) rotate(0deg)}100%{transform:scale(1.1) rotate(5deg)}}
    @keyframes waveMove{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}
    
    html{scroll-behavior:smooth}
    body{
      font-family:'Inter',system-ui,-apple-system,sans-serif;
      color:var(--text);
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
      transition:background 0.5s ease;
      min-height:100vh;
      overflow-x:hidden;
    }

    /* GLASSMORPHISM HEADER - FIXED */
    header{
      position:sticky;
      top:12px;
      z-index:1000;
      padding:0 24px;
      margin-bottom:40px;
    }
    .header-glass{
      background:rgba(255,255,255,0.03);
      backdrop-filter:blur(20px) saturate(180%);
      -webkit-backdrop-filter:blur(20px) saturate(180%);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:20px;
      padding:16px 32px;
      box-shadow:0 8px 32px rgba(0,0,0,0.1),inset 0 1px 0 rgba(255,255,255,0.1);
    }
    header .header-container{
      display:flex;
      justify-content:space-between;
      align-items:center;
      max-width:1400px;
      margin:0 auto;
    }
    
    .logo{
      display:flex;
      align-items:center;
      gap:12px;
      text-decoration:none;
      color:var(--text);
      font-weight:800;
      font-size:22px;
      letter-spacing:-0.7px;
      transition:all 0.3s;
    }
    .logo:hover{transform:translateY(-2px)}
    .logo-mark{
      display:flex;
      align-items:center;
      justify-content:center;
      width:48px;
      height:48px;
      background:linear-gradient(135deg,var(--accent),var(--accent-bright));
      border-radius:12px;
      box-shadow:0 4px 20px var(--accent-glow);
      transition:all 0.3s;
      position:relative;
    }
    .logo-mark::after{
      content:'';
      position:absolute;
      inset:-2px;
      background:linear-gradient(135deg,var(--accent),var(--accent-bright));
      border-radius:14px;
      z-index:-1;
      opacity:0;
      filter:blur(10px);
      transition:opacity 0.3s;
    }
    .logo-mark:hover::after{opacity:0.7}
    .logo-mark img{
      width:100%;
      height:100%;
      object-fit:contain;
      padding:6px;
    }
    .brand-text{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand-text h1{
      font-size:20px;
      font-weight:800;
      letter-spacing:-0.5px;
      margin:0;
      line-height:1.2;
      color:var(--text);
    }
    .brand-text .subtitle{
      font-size:13px;
      color:var(--text-dim);
      font-weight:500;
      line-height:1.2;
    }

    .header-controls{
      display:flex;
      gap:12px;
      align-items:center;
    }
    
    .bg-selector{position:relative}
    .bg-btn{
      padding:10px 18px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:12px;
      color:var(--text-dim);
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      transition:all 0.3s;
    }
    .bg-btn:hover{
      background:var(--surface-hover);
      border-color:var(--accent);
      color:var(--text);
    }
    .bg-dropdown{
      position:absolute;
      top:calc(100% + 12px);
      right:0;
      background:rgba(255,255,255,0.05);
      backdrop-filter:blur(20px);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      display:none;
      min-width:200px;
      box-shadow:0 20px 60px rgba(0,0,0,0.3);
      z-index:100;
    }
    .bg-dropdown.active{display:block}
    .bg-option{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.3s;
      font-size:14px;
      font-weight:500;
    }
    .bg-option:hover{background:var(--surface-hover)}
    .bg-preview{
      width:32px;
      height:32px;
      border-radius:8px;
      border:2px solid rgba(255,255,255,0.2);
    }
    .bg-preview.mesh{background:radial-gradient(circle, #10b981 0%, #6366f1 100%)}
    .bg-preview.gradient{background:linear-gradient(135deg, #667eea 0%, #764ba2 100%)}
    .bg-preview.dots{background:#0a0e27;background-image:radial-gradient(circle, rgba(255,255,255,0.2) 1px, transparent 1px);background-size:15px 15px}
    .bg-preview.waves{background:linear-gradient(180deg, #0f172a 0%, #10b981 100%)}
    .bg-preview.dark{background:#0a0e1a}

    .theme-selector{position:relative}
    .theme-btn{
      padding:10px 18px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:12px;
      color:var(--text-dim);
      font-size:14px;
      font-weight:600;
      cursor:pointer;
      display:flex;
      align-items:center;
      gap:8px;
      transition:all 0.3s;
    }
    .theme-btn:hover{
      background:var(--surface-hover);
      border-color:var(--accent);
      color:var(--text);
    }
    .theme-dropdown{
      position:absolute;
      top:calc(100% + 12px);
      right:0;
      background:rgba(255,255,255,0.05);
      backdrop-filter:blur(20px);
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      display:none;
      min-width:200px;
      max-height:400px;
      overflow-y:auto;
      box-shadow:0 20px 60px rgba(0,0,0,0.3);
      z-index:100;
    }
    .theme-dropdown.active{display:block}
    .theme-dropdown::-webkit-scrollbar{width:6px}
    .theme-dropdown::-webkit-scrollbar-track{background:transparent}
    .theme-dropdown::-webkit-scrollbar-thumb{background:var(--accent);border-radius:10px}
    .theme-option{
      display:flex;
      align-items:center;
      gap:12px;
      padding:12px;
      border-radius:10px;
      cursor:pointer;
      transition:all 0.3s;
      font-size:14px;
      font-weight:500;
    }
    .theme-option:hover{background:var(--surface-hover)}
    .theme-color{
      width:28px;
      height:28px;
      border-radius:8px;
      border:2px solid rgba(255,255,255,0.2);
      transition:all 0.3s;
    }
    .theme-option:hover .theme-color{transform:scale(1.1)}
    .theme-color.green{background:linear-gradient(135deg,#10b981,#34d399)}
    .theme-color.cyan{background:linear-gradient(135deg,#06b6d4,#22d3ee)}
    .theme-color.purple{background:linear-gradient(135deg,#8b5cf6,#a78bfa)}
    .theme-color.orange{background:linear-gradient(135deg,#f97316,#fb923c)}
    .theme-color.blue{background:linear-gradient(135deg,#3b82f6,#60a5fa)}
    .theme-color.red{background:linear-gradient(135deg,#ef4444,#f87171)}
    .theme-color.pink{background:linear-gradient(135deg,#ec4899,#f472b6)}
    .theme-color.teal{background:linear-gradient(135deg,#14b8a6,#2dd4bf)}
    .theme-color.indigo{background:linear-gradient(135deg,#6366f1,#818cf8)}
    .theme-color.yellow{background:linear-gradient(135deg,#eab308,#facc15)}
    .theme-color.magenta{background:linear-gradient(135deg,#d946ef,#e879f9)}
    .theme-color.emerald{background:linear-gradient(135deg,#059669,#10b981)}
    .theme-color.amber{background:linear-gradient(135deg,#d97706,#f59e0b)}
    .theme-color.lime{background:linear-gradient(135deg,#84cc16,#a3e635)}
    .theme-color.violet{background:linear-gradient(135deg,#7c3aed,#a78bfa)}

    .btn-home{
      padding:10px 20px;
      background:linear-gradient(135deg,var(--accent),var(--accent-bright));
      border:none;
      border-radius:12px;
      color:#000;
      font-size:14px;
      font-weight:700;
      text-decoration:none;
      transition:all 0.3s;
      display:inline-flex;
      align-items:center;
      gap:8px;
      box-shadow:0 4px 16px var(--accent-glow);
    }
    .btn-home:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 24px var(--accent-glow);
    }

    .container{max-width:1400px;margin:0 auto;padding:0 24px}
    
    .card{
      background:var(--glass);
      backdrop-filter:blur(10px);
      padding:28px;
      border-radius:18px;
      border:1px solid var(--border);
      margin-bottom:20px;
      transition:all 0.3s;
    }
    .card:hover{border-color:var(--accent);box-shadow:0 8px 24px rgba(0,0,0,0.2)}
    .card h3{font-size:18px;font-weight:700;margin:0 0 16px 0;letter-spacing:-0.3px}

    /* How to Use */
    .how-to-use{
      background:var(--glass);
      backdrop-filter:blur(10px);
      border:1px solid var(--border);
      border-radius:18px;
      padding:24px 28px;
      margin-bottom:24px;
      transition:all 0.3s;
    }
    .how-to-use:hover{border-color:var(--accent)}
    .how-to-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      user-select:none;
    }
    .how-to-header h3{
      font-size:18px;
      font-weight:700;
      margin:0;
      color:var(--text);
      letter-spacing:-0.3px;
    }
    .toggle-icon{
      font-size:16px;
      transition:transform 0.3s;
      color:var(--accent);
    }
    .toggle-icon.collapsed{
      transform:rotate(-90deg);
    }
    .how-to-content{
      overflow:hidden;
      transition:max-height 0.3s ease-out, opacity 0.3s;
      max-height:600px;
      opacity:1;
    }
    .how-to-content.hidden{
      max-height:0;
      opacity:0;
      margin-top:0;
    }
    .how-to-content ul{
      margin:16px 0 0 24px;
      color:var(--text-dim);
      font-size:14px;
      line-height:2;
      font-weight:300;
    }
.how-to-content li {
  margin-bottom: 8px;
  font-size: 15px; /* increased from 14px */
  line-height: 1.8; /* increased from 2 */
  color: #b4c3d8; /* lighter than current --text-dim */
}

    /* Controls */
    .controls{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:16px;
      margin-bottom:16px;
    }

    .file-input{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

label.small {
  font-size: 14px; /* increased from 13px */
  color: #cbd5e1; /* brighter than --text-dim */
  font-weight: 600;
}

    input[type=file]{
      padding:12px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:12px;
      color:#ffffff !important;
      font-size:13px;
      cursor:pointer;
      transition:all 0.3s;
    }
    input[type=file]:hover{
      border-color:var(--accent);
      background:var(--surface-hover);
    }
    input[type=file]::file-selector-button{
      padding:6px 12px;
      background:var(--accent);
      color:#000;
      border:none;
      border-radius:8px;
      font-weight:600;
      cursor:pointer;
      margin-right:10px;
    }

    .select{
      padding:12px 16px;
      border-radius:12px;
      background:var(--surface);
      border:1px solid var(--border);
      color:#ffffff !important;
      font-size:14px;
      font-weight:500;
      transition:all 0.3s;
      font-family:inherit;
    }
    .select:hover{border-color:var(--accent)}
    .select:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 3px var(--accent-dim);
    }
    .select option{
      background:#1a1f2e !important;
      color:#ffffff !important;
      padding:10px;
    }

    .options{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }

    .options label{
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
      color:var(--text-dim);
      font-weight:400;
    }

    /* Buttons */
    .btn{
      padding:12px 24px;
      background:linear-gradient(135deg,var(--accent),var(--accent-bright));
      color:#000;
      border:none;
      border-radius:12px;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
      transition:all 0.3s;
      box-shadow:0 4px 16px var(--accent-glow);
    }
    .btn:hover{
      transform:translateY(-2px);
      box-shadow:0 8px 24px var(--accent-glow);
    }

    .btn.secondary{
      background:var(--surface);
      border:1px solid var(--border);
      color:var(--text);
      box-shadow:none;
    }
    .btn.secondary:hover{
      background:var(--surface-hover);
      border-color:var(--accent);
    }

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px;
      margin-top:20px;
    }

    .pane{
      min-height:400px;
      max-height:600px;
      overflow:auto;
    }
    .pane::-webkit-scrollbar{width:10px}
    .pane::-webkit-scrollbar-track{background:var(--glass);border-radius:10px}
    .pane::-webkit-scrollbar-thumb{background:var(--accent);border-radius:10px}

    .pane-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:16px;
      padding-bottom:12px;
      border-bottom:2px solid var(--border);
    }

    .pane-header h3{
      font-size:16px;
      font-weight:700;
      margin:0;
      letter-spacing:-0.3px;
    }

    /* Table */
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }

    th,td{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      text-align:left;
    }

    th{
      position:sticky;
      top:0;
      background:rgba(0,0,0,0.6);
      backdrop-filter:blur(10px);
      z-index:2;
      font-weight:700;
      color:var(--text);
      text-transform:uppercase;
      font-size:12px;
      letter-spacing:0.5px;
    }

    td.diff-cell{background:rgba(251,191,36,0.2);border-left:3px solid #fbbf24}
    td.added{background:rgba(16,185,129,0.15);border-left:3px solid #10b981}
    td.removed{background:rgba(239,68,68,0.15);border-left:3px solid #ef4444}

    /* Legend */
    .legend{
      display:flex;
      gap:12px;
      margin-top:20px;
      flex-wrap:wrap;
    }

    .legend span{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:10px 16px;
      border-radius:12px;
      font-size:13px;
      background:var(--glass);
      backdrop-filter:blur(10px);
      border:1px solid var(--border);
      color:var(--text-dim);
      font-weight:500;
    }

    .dot{
      width:12px;
      height:12px;
      border-radius:4px;
      display:inline-block;
    }

    .dot.diff{background:var(--warn)}
    .dot.add{background:var(--ok)}
    .dot.rem{background:var(--err)}

    /* Summary */
    .summary{
      margin-top:20px;
      padding:20px 24px;
      background:var(--glass);
      backdrop-filter:blur(10px);
      border:1px solid var(--accent);
      border-radius:14px;
      font-size:15px;
      color:var(--text);
      font-weight:600;
      letter-spacing:-0.3px;
    }

    /* Key checkboxes */
    .key-checkboxes{
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height:200px;
      overflow-y:auto;
      padding:12px;
      border:1px solid var(--border);
      border-radius:12px;
      background:var(--surface);
    }
    .key-checkboxes::-webkit-scrollbar{width:6px}
    .key-checkboxes::-webkit-scrollbar-track{background:transparent}
    .key-checkboxes::-webkit-scrollbar-thumb{background:var(--accent);border-radius:10px}

    .key-checkboxes label{
      display:flex;
      gap:8px;
      cursor:pointer;
      padding:8px;
      border-radius:8px;
      transition:background 0.2s;
      color:var(--text-dim);
      font-weight:400;
    }

    .key-checkboxes label:hover{
      background:var(--surface-hover);
    }

    /* Mapping */
    .mapping-row{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      gap:12px;
      align-items:center;
      margin-bottom:12px;
    }

    .mapping-row span{
      text-align:center;
      color:var(--accent);
      font-weight:700;
      font-size:18px;
    }

    .mobile-menu-btn{display:none;background:var(--surface);border:1px solid var(--border);padding:10px;border-radius:12px;cursor:pointer;color:var(--text)}

    /* Responsive */
    @media(max-width:968px){
      header{top:8px;padding:0 16px}
      .header-glass{padding:12px 20px;border-radius:16px}
      .brand-text h1{font-size:16px}
      .brand-text .subtitle{font-size:11px}
      .logo-mark{width:40px;height:40px}
      .mobile-menu-btn{display:block}
      .header-controls{gap:8px}
      .bg-btn,.theme-btn{padding:10px;font-size:0}
      .bg-btn span:last-child,.theme-btn span:last-child{display:none}
      .btn-home span:first-child{display:none}
      .layout{grid-template-columns:1fr}
      .controls{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  
  <!-- GLASSMORPHISM HEADER - FIXED -->
  <header>
    <div class="header-glass">
      <div class="header-container">
        <a href="index.html" class="logo">
          <div class="logo-mark"><img src="favicon.jpg" alt="ValQMS"></div>
          <div class="brand-text">
            <h1>ValQMS Tools</h1>
            <div class="subtitle">Excel Comparison Tool</div>
          </div>
        </a>

        <div class="header-controls">
          <!-- Background Selector -->
          <div class="bg-selector">
            <button class="bg-btn" id="bgBtn"><span>🎨</span><span>Background</span></button>
            <div class="bg-dropdown" id="bgDropdown">
              <div class="bg-option" data-bg="mesh"><div class="bg-preview mesh"></div><span>Mesh Gradient</span></div>
              <div class="bg-option" data-bg="gradient"><div class="bg-preview gradient"></div><span>Purple Gradient</span></div>
              <div class="bg-option" data-bg="dots"><div class="bg-preview dots"></div><span>Dot Pattern</span></div>
              <div class="bg-option" data-bg="waves"><div class="bg-preview waves"></div><span>Wave Motion</span></div>
              <div class="bg-option" data-bg="dark"><div class="bg-preview dark"></div><span>Dark Mode</span></div>
            </div>
          </div>

          <!-- Theme Selector -->
          <div class="theme-selector">
            <button class="theme-btn" id="themeBtn"><span>🎨</span><span>Theme</span></button>
            <div class="theme-dropdown" id="themeDropdown">
              <div class="theme-option" data-theme="green"><div class="theme-color green"></div><span>Green</span></div>
              <div class="theme-option" data-theme="cyan"><div class="theme-color cyan"></div><span>Cyan</span></div>
              <div class="theme-option" data-theme="purple"><div class="theme-color purple"></div><span>Purple</span></div>
              <div class="theme-option" data-theme="orange"><div class="theme-color orange"></div><span>Orange</span></div>
              <div class="theme-option" data-theme="blue"><div class="theme-color blue"></div><span>Blue</span></div>
              <div class="theme-option" data-theme="red"><div class="theme-color red"></div><span>Red</span></div>
              <div class="theme-option" data-theme="pink"><div class="theme-color pink"></div><span>Pink</span></div>
              <div class="theme-option" data-theme="teal"><div class="theme-color teal"></div><span>Teal</span></div>
              <div class="theme-option" data-theme="indigo"><div class="theme-color indigo"></div><span>Indigo</span></div>
              <div class="theme-option" data-theme="yellow"><div class="theme-color yellow"></div><span>Yellow</span></div>
              <div class="theme-option" data-theme="magenta"><div class="theme-color magenta"></div><span>Magenta</span></div>
              <div class="theme-option" data-theme="emerald"><div class="theme-color emerald"></div><span>Emerald</span></div>
              <div class="theme-option" data-theme="amber"><div class="theme-color amber"></div><span>Amber</span></div>
              <div class="theme-option" data-theme="lime"><div class="theme-color lime"></div><span>Lime</span></div>
              <div class="theme-option" data-theme="violet"><div class="theme-color violet"></div><span>Violet</span></div>
            </div>
          </div>

          <a href="index.html" class="btn-home"><span>←</span><span>Home</span></a>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    
    <!-- How to Use with Toggle -->
    <div class="how-to-use">
      <div class="how-to-header" id="howToToggle">
        <h3>📖 How to Use</h3>
        <span class="toggle-icon" id="toggleIcon">▼</span>
      </div>
      <div class="how-to-content" id="howToContent">
        <ul>
          <li><strong>Step-1:</strong> Upload both Excel/CSV files and select sheets from dropdowns</li>
          <li><strong>Step-2:</strong> Select one or more key columns to create a composite unique identifier</li>
          <li><strong>Step-3:</strong> Use Column Mapping to compare columns with different names</li>
          <li><strong>Step-4:</strong> Select <strong>(ignore)</strong> for columns you don't want to compare</li>
          <li><strong>Step-5:</strong> Click Compare to highlight differences in both files</li>
          <li><strong>Step-6:</strong> Export creates an Excel file with Status & Comments columns</li>
        </ul>
      </div>
    </div>

    <!-- Controls -->
    <section class="card">
      <div class="controls">
        <div class="file-input">
          <label class="small">Base File (Left)</label>
          <input id="fileA" type="file" accept=".xlsx,.xls,.csv">
          <select id="sheetA" class="select"></select>
        </div>

        <div class="file-input">
          <label class="small">Compare File (Right)</label>
          <input id="fileB" type="file" accept=".xlsx,.xls,.csv">
          <select id="sheetB" class="select"></select>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px">
          <label class="small">Match Settings</label>
          <div class="options">
            <select id="fuzzyLevel" class="select">
              <option value="0">Exact match</option>
              <option value="0.3">Low fuzziness</option>
              <option value="0.5" selected>Medium fuzziness</option>
              <option value="0.8">High fuzziness</option>
            </select>
          </div>
          <div class="options">
            <label class="small"><input id="ignoreOrder" type="checkbox"> Ignore order</label>
            <label class="small"><input id="trimSpaces" type="checkbox" checked> Trim spaces</label>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px">
          <label class="small">Actions</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="compareBtn" class="btn">Compare</button>
            <button id="exportDiff" class="btn">Export Excel</button>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="autoMapBtn" class="btn secondary">Auto-map</button>
            <button id="resetBtn" class="btn secondary">Reset</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Composite Keys -->
    <section class="card">
      <h3>Composite Key Columns</h3>
      <div class="small" style="margin-bottom:12px;color:var(--text-dim)">Select one or more columns to form a composite key for row matching</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div>
          <div class="small" style="margin-bottom:8px">Base Key Columns:</div>
          <div id="leftKeyCheckboxes" class="key-checkboxes"></div>
        </div>
        <div>
          <div class="small" style="margin-bottom:8px">Compare Key Columns:</div>
          <div id="rightKeyCheckboxes" class="key-checkboxes"></div>
        </div>
      </div>
    </section>

    <!-- Column Mapping -->
    <section class="card">
      <h3>Column Mapping</h3>
      <div class="small" style="margin-bottom:12px;color:var(--text-dim)">Map Base columns to Compare columns. Select <strong>(ignore)</strong> to skip columns</div>
      <div id="mappingContainer"></div>
      <button id="applyMappingBtn" class="btn secondary" style="margin-top:12px">Apply Mapping</button>
    </section>

    <!-- Preview -->
    <div class="layout">
      <div class="pane card">
        <div class="pane-header">
          <h3>Base File</h3>
          <span id="leftName" class="small">—</span>
        </div>
        <div id="leftPreview"></div>
      </div>

      <div class="pane card">
        <div class="pane-header">
          <h3>Compare File</h3>
          <span id="rightName" class="small">—</span>
        </div>
        <div id="rightPreview"></div>
      </div>
    </div>

    <!-- Legend & Summary -->
    <div class="legend">
      <span><i class="dot diff"></i> Cell difference</span>
      <span><i class="dot add"></i> Added row</span>
      <span><i class="dot rem"></i> Removed row</span>
    </div>

    <div id="summary" class="summary">No comparison yet. Upload files and click Compare.</div>

  </div>

<script>
// Theme System
const themeBtn=document.getElementById('themeBtn');
const themeDropdown=document.getElementById('themeDropdown');
const themeOptions=document.querySelectorAll('.theme-option');
themeBtn.addEventListener('click',e=>{e.stopPropagation();themeDropdown.classList.toggle('active');bgDropdown.classList.remove('active')});
document.addEventListener('click',()=>{themeDropdown.classList.remove('active');bgDropdown.classList.remove('active')});
themeDropdown.addEventListener('click',e=>e.stopPropagation());
themeOptions.forEach(opt=>{
  opt.addEventListener('click',()=>{
    const theme=opt.dataset.theme;
    document.documentElement.setAttribute('data-theme',theme);
    localStorage.setItem('valqmsTheme',theme);
    themeDropdown.classList.remove('active');
  });
});

// Background System
const bgBtn=document.getElementById('bgBtn');
const bgDropdown=document.getElementById('bgDropdown');
const bgOptions=document.querySelectorAll('.bg-option');
bgBtn.addEventListener('click',e=>{e.stopPropagation();bgDropdown.classList.toggle('active');themeDropdown.classList.remove('active')});
bgDropdown.addEventListener('click',e=>e.stopPropagation());
bgOptions.forEach(opt=>{
  opt.addEventListener('click',()=>{
    const bg=opt.dataset.bg;
    document.documentElement.setAttribute('data-bg',bg);
    localStorage.setItem('valqmsBg',bg);
    bgDropdown.classList.remove('active');
  });
});

// Initialize
function initTheme(){
  const savedTheme=localStorage.getItem('valqmsTheme')||'green';
  const savedBg=localStorage.getItem('valqmsBg')||'mesh';
  document.documentElement.setAttribute('data-theme',savedTheme);
  document.documentElement.setAttribute('data-bg',savedBg);
}
initTheme();

/* === HOW TO USE TOGGLE === */
const howToToggle = document.getElementById('howToToggle');
const howToContent = document.getElementById('howToContent');
const toggleIcon = document.getElementById('toggleIcon');

// Load toggle state
const howToVisible = localStorage.getItem('howToVisible') !== 'false';
if(!howToVisible){
  howToContent.classList.add('hidden');
  toggleIcon.classList.add('collapsed');
}

howToToggle.addEventListener('click', () => {
  const isHidden = howToContent.classList.toggle('hidden');
  toggleIcon.classList.toggle('collapsed');
  localStorage.setItem('howToVisible', !isHidden);
});

/* === REST OF YOUR EXISTING CODE === */
const el = id => document.getElementById(id);
let workbookA = null, workbookB = null;
let leftSheetName = '', rightSheetName = '';
let dataA = [], dataB = [];
let windowReport = null;
let columnMap = {};

function showEmpty(v){
  return (v === '' || v === null || v === undefined) ? 'empty' : String(v);
}

function readAsWorkbook(file, cb){
  const r = new FileReader();
  r.onload = e => {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, {type:'array'});
    cb(null, wb);
  };
  if(file.name.endsWith('.csv')) r.readAsText(file);
  else r.readAsArrayBuffer(file);
}

function populateSheetSelect(wb, selectEl){
  selectEl.innerHTML = '';
  wb.SheetNames.forEach((s,i)=>{
    const opt = document.createElement('option'); opt.value = s; opt.textContent = s;
    selectEl.appendChild(opt);
  });
}

function sheetToJson(wb, sheetName){
  const ws = wb.Sheets[sheetName]; if(!ws) return [];
  return XLSX.utils.sheet_to_json(ws, {defval:''});
}

function getHeaders(rows){
  if(!rows || rows.length===0) return [];
  return Object.keys(rows[0]);
}

function autoDetectKey(headers){
  const candidates = ['id','uuid','code','reference','name','email'];
  const lower = headers.map(h=>h.toLowerCase());
  for(let c of candidates){
    const idx = lower.findIndex(x=>x.includes(c));
    if(idx>=0) return [headers[idx]];
  }
  return headers[0] ? [headers[0]] : [];
}

function renderTableWithHighlights(container, rows, highlights){
  container.innerHTML = '';
  if(!rows || rows.length===0){ container.innerHTML = '<div class="small">No rows</div>'; return;}
  const headers = getHeaders(rows);
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  headers.forEach(h=>{ const th = document.createElement('th'); th.textContent = h; trh.appendChild(th); });
  thead.appendChild(trh); table.appendChild(thead);
  const tbody = document.createElement('tbody');
  rows.forEach((r,ri)=>{
    const tr = document.createElement('tr');
    headers.forEach(h=>{
      const td = document.createElement('td');
      td.textContent = r[h]===undefined||r[h]===null?'':r[h];
      if(highlights && highlights[ri] && highlights[ri][h]){
        td.classList.add('diff-cell');
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); container.appendChild(table);
}

/* File load */
el('fileA').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  readAsWorkbook(f,(err,wb)=>{
    if(err) return alert('Error reading file A');
    workbookA = wb;
    leftSheetName = wb.SheetNames[0];
    populateSheetSelect(wb, el('sheetA'));
    el('leftName').textContent = f.name;
    dataA = sheetToJson(wb, leftSheetName);
    populateKeyCheckboxes();
    buildColumnMappingUI();
    renderTableWithHighlights(el('leftPreview'), dataA, {});
  });
});

el('fileB').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  readAsWorkbook(f,(err,wb)=>{
    if(err) return alert('Error reading file B');
    workbookB = wb;
    rightSheetName = wb.SheetNames[0];
    populateSheetSelect(wb, el('sheetB'));
    el('rightName').textContent = f.name;
    dataB = sheetToJson(wb, rightSheetName);
    populateKeyCheckboxes();
    buildColumnMappingUI();
    renderTableWithHighlights(el('rightPreview'), dataB, {});
  });
});

el('sheetA').addEventListener('change', e=>{
  if(!workbookA) return;
  leftSheetName = e.target.value;
  dataA = sheetToJson(workbookA, leftSheetName);
  populateKeyCheckboxes();
  buildColumnMappingUI();
  renderTableWithHighlights(el('leftPreview'), dataA, {});
});

el('sheetB').addEventListener('change', e=>{
  if(!workbookB) return;
  rightSheetName = e.target.value;
  dataB = sheetToJson(workbookB, rightSheetName);
  populateKeyCheckboxes();
  buildColumnMappingUI();
  renderTableWithHighlights(el('rightPreview'), dataB, {});
});

/* Key checkboxes */
function populateKeyCheckboxes(){
  const headersA = getHeaders(dataA);
  const headersB = getHeaders(dataB);
  
  const leftContainer = el('leftKeyCheckboxes');
  const rightContainer = el('rightKeyCheckboxes');
  
  leftContainer.innerHTML = '';
  rightContainer.innerHTML = '';
  
  if(!headersA.length || !headersB.length){
    leftContainer.innerHTML = '<div class="small">Load both files</div>';
    rightContainer.innerHTML = '<div class="small">Load both files</div>';
    return;
  }

  const autoA = autoDetectKey(headersA);
  const autoB = autoDetectKey(headersB);
  
  headersA.forEach(h=>{
    const label = document.createElement('label');
    label.className = 'small';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.value = h;
    cb.dataset.side = 'left';
    if(autoA.includes(h)) cb.checked = true;
    label.appendChild(cb);
    label.appendChild(document.createTextNode(h));
    leftContainer.appendChild(label);
  });

  headersB.forEach(h=>{
    const label = document.createElement('label');
    label.className = 'small';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.value = h;
    cb.dataset.side = 'right';
    if(autoB.includes(h)) cb.checked = true;
    label.appendChild(cb);
    label.appendChild(document.createTextNode(h));
    rightContainer.appendChild(label);
  });
}

/* Column mapping */
function buildColumnMappingUI(){
  const container = el('mappingContainer');
  container.innerHTML = '';
  const headersA = getHeaders(dataA);
  const headersB = getHeaders(dataB);
  if(!headersA.length || !headersB.length){
    container.innerHTML = '<div class="small">Load both files to see column mapping.</div>';
    return;
  }

  headersA.forEach(ha=>{
    const row = document.createElement('div');
    row.className = 'mapping-row';

    const selA = document.createElement('select');
    selA.className = 'select';
    selA.innerHTML = `<option value="${ha}">${ha}</option>`;
    selA.disabled = true;

    const arrow = document.createElement('span');
    arrow.textContent = '→';

    const selB = document.createElement('select');
    selB.className = 'select';
    selB.dataset.baseCol = ha;
    selB.innerHTML = '<option value="__IGNORE__">(ignore)</option><option value="">(same name)</option>' + 
                     headersB.map(hb=>`<option value="${hb}">${hb}</option>`).join('');
    if(headersB.includes(ha)) selB.value = ha;

    row.appendChild(selA);
    row.appendChild(arrow);
    row.appendChild(selB);
    container.appendChild(row);
  });
}

el('applyMappingBtn').addEventListener('click', ()=>{
  const selects = el('mappingContainer').querySelectorAll('select[data-base-col]');
  columnMap = {};
  selects.forEach(sel=>{
    const base = sel.dataset.baseCol;
    const compare = sel.value || base;
    columnMap[base] = compare;
  });
  alert('Column mapping applied!');
});

el('autoMapBtn').addEventListener('click', ()=>{
  const headersA = getHeaders(dataA), headersB = getHeaders(dataB);
  if(!headersA.length || !headersB.length) return alert('Load both sheets first');
  const fuse = new Fuse(headersB, {includeScore:true,threshold:0.5});
  const map = {};
  headersA.forEach(h=>{
    const res = fuse.search(h);
    map[h] = res.length ? res[0].item : h;
  });
  columnMap = map;
  alert('Auto-mapping complete!');
  
  const selects = el('mappingContainer').querySelectorAll('select[data-base-col]');
  selects.forEach(sel=>{
    const base = sel.dataset.baseCol;
    if(map[base]) sel.value = map[base];
  });
});

/* Compare */
el('compareBtn').addEventListener('click', ()=>{
  if(!dataA.length || !dataB.length) return alert('Load both sheets');

  const trim = el('trimSpaces').checked;
  const fuzzyLevel = parseFloat(el('fuzzyLevel').value);

  let a = JSON.parse(JSON.stringify(dataA));
  let b = JSON.parse(JSON.stringify(dataB));

  if(trim){
    a = a.map(r=>{ Object.keys(r).forEach(k=>{ if(typeof r[k]==='string') r[k]=r[k].trim(); }); return r; });
    b = b.map(r=>{ Object.keys(r).forEach(k=>{ if(typeof r[k]==='string') r[k]=r[k].trim(); }); return r; });
  }

  a.forEach((r, idx) => { r.__idx = idx; });
  b.forEach((r, idx) => { r.__idx = idx; });

  const headersA = getHeaders(a), headersB = getHeaders(b);
  
  const leftKeys = Array.from(el('leftKeyCheckboxes').querySelectorAll('input:checked')).map(cb=>cb.value);
  const rightKeys = Array.from(el('rightKeyCheckboxes').querySelectorAll('input:checked')).map(cb=>cb.value);
  
  let keysA = leftKeys.length ? leftKeys : autoDetectKey(headersA);
  let keysB = rightKeys.length ? rightKeys : autoDetectKey(headersB);
  
  if(!keysA.length || !keysB.length) return alert('Select at least one key column');

  const mapB = new Map(); 
  b.forEach((r, idx) => {
    const compositeKey = keysB.map(k => String(r[k] ?? '')).join('|');
    mapB.set(compositeKey, r);
  });
  
  let fuseKeys = null;
  if(fuzzyLevel>0){
    fuseKeys = new Fuse(Array.from(mapB.keys()), {threshold: fuzzyLevel});
  }

  const finalMap = Object.keys(columnMap).length ? columnMap : {};
  if(!Object.keys(finalMap).length){
    headersA.forEach(h=>{ finalMap[h] = h; });
  }

  const highlightsA = {}, highlightsB = {};
  const report = { matched:0, changed:0, added:0, removed:0, rows: [], leftSheet: leftSheetName, rightSheet: rightSheetName };

  const matchedBKeys = new Set();

  for(let i=0;i<a.length;i++){
    const ra = a[i];
    const rawKey = keysA.map(k => String(ra[k] ?? '')).join('|');
    let matchedKey = null;
    if(mapB.has(rawKey)) matchedKey = rawKey;
    else if(fuseKeys){
      const r = fuseKeys.search(rawKey);
      if(r && r.length) matchedKey = r[0].item;
    }

    if(matchedKey === null){
      report.removed++;
      highlightsA[i] = {}; headersA.forEach(h=>highlightsA[i][h]=true);
      report.rows.push({ key: rawKey, type:'removed', left: ra, right: null });
      continue;
    }

    matchedBKeys.add(matchedKey);
    const rb = mapB.get(matchedKey);
    const rowDiffs = {};
    let rowChanged = false;

    headersA.forEach(colA=>{
      if(colA === '__idx') return;
      const colB = finalMap[colA] || colA;
      if(colB === '__IGNORE__') return;
      
      const va = (ra[colA]===undefined||ra[colA]===null)?'':String(ra[colA]);
      const vb = (rb[colB]===undefined||rb[colB]===null)?'':String(rb[colB]);
      if(va !== vb){
        rowDiffs[colA] = colB;
        rowChanged = true;
      }
    });

    if(rowChanged){
      report.changed++;
      highlightsA[i] = {};
      Object.keys(rowDiffs).forEach(k=>highlightsA[i][k]=true);
      const idxB = rb.__idx;
      if(idxB>=0){
        highlightsB[idxB] = {};
        Object.keys(rowDiffs).forEach(k=>highlightsB[idxB][rowDiffs[k]]=true);
      }
      report.rows.push({ key: rawKey, type:'changed', left: ra, right: rb, diffs: rowDiffs });
    } else {
      report.matched++;
      report.rows.push({ key: rawKey, type:'matched', left: ra, right: rb });
    }
  }

  for(let j=0;j<b.length;j++){
    const rb = b[j]; 
    const k = keysB.map(col => String(rb[col] ?? '')).join('|');
    if(!matchedBKeys.has(k)){
      report.added++;
      highlightsB[j] = {}; headersB.forEach(h=>highlightsB[j][h]=true);
      report.rows.push({ key:k, type:'added', left:null, right:rb });
    }
  }

  renderTableWithHighlights(el('leftPreview'), dataA, highlightsA);
  renderTableWithHighlights(el('rightPreview'), dataB, highlightsB);

  el('summary').textContent = `✓ ${report.matched} matched  •  ⚠ ${report.changed} changed  •  + ${report.added} added  •  − ${report.removed} removed`;
  windowReport = report;
});

/* Export */
el('exportDiff').addEventListener('click', ()=> {
  if(!windowReport) return alert('Run a comparison first');

  const headersA = getHeaders(dataA).filter(h => h !== '__idx');
  const headersB = getHeaders(dataB).filter(h => h !== '__idx');
  const allHeaders = Array.from(new Set([...headersA, ...headersB]));
  const outHeaders = allHeaders.concat(['Status','Comments']);

  const rowsOut = [];
  windowReport.rows.forEach((r, ridx) => {
    const rowObj = {};
    outHeaders.forEach(h=>{
      if(h==='Status'){
        rowObj[h] = r.type;
      } else if(h==='Comments'){
        if(r.type==='changed'){
          const realDiffs = Object.keys(r.diffs || {}).filter(k => k !== '__idx' && r.diffs[k] !== '__IGNORE__');
          const diffsText = realDiffs.map((colA, i) => {
            const colB = r.diffs[colA];
            const baseVal = r.left ? (r.left[colA] ?? '') : '';
            const cmpVal  = r.right ? (r.right[colB] ?? '') : '';
            
            const colIndexA = allHeaders.indexOf(colA);
            const colLetterA = colIndexA >= 0 ? XLSX.utils.encode_col(colIndexA) : colA;
            
            const colIndexB = allHeaders.indexOf(colB);
            const colLetterB = colIndexB >= 0 ? XLSX.utils.encode_col(colIndexB) : colB;
            
            const leftRowIndex  = (r.left  && r.left.__idx  !== undefined) ? (r.left.__idx  + 2) : (ridx + 2);
            const rightRowIndex = (r.right && r.right.__idx !== undefined) ? (r.right.__idx + 2) : (ridx + 2);
            
            return `${i+1}. Base: ${windowReport.leftSheet}!${colLetterA}${leftRowIndex}="${showEmpty(baseVal)}" → Compare: ${windowReport.rightSheet}!${colLetterB}${rightRowIndex}="${showEmpty(cmpVal)}"`;
          }).join('\n');
          rowObj[h] = diffsText;
        } else if (r.type==='added'){
          rowObj[h] = `New row in ${windowReport.rightSheet}`;
        } else if (r.type==='removed'){
          rowObj[h] = `Missing in ${windowReport.rightSheet}`;
        } else {
          rowObj[h] = 'Match';
        }
      } else {
        rowObj[h] = (r.right && r.right[h]!==undefined) ? r.right[h] : (r.left && r.left[h]!==undefined ? r.left[h] : '');
      }
    });
    rowsOut.push(rowObj);
  });

  const ws = XLSX.utils.json_to_sheet(rowsOut, {header: outHeaders});

  rowsOut.forEach((rowObj, ridx)=>{
    const status = rowObj['Status'];
    const excelRow = ridx + 2;
    for(let c=0;c<outHeaders.length;c++){
      const addr = XLSX.utils.encode_cell({r: excelRow-1, c});
      if(!ws[addr]) continue;
      if(status === 'added'){
        ws[addr].s = { fill: { patternType: "solid", fgColor: { rgb: "D1FAE5" } } };
      } else if(status === 'removed'){
        ws[addr].s = { fill: { patternType: "solid", fgColor: { rgb: "FEE2E2" } } };
      } else if(status === 'changed'){
        ws[addr].s = { fill: { patternType: "solid", fgColor: { rgb: "FEF3C7" } } };
      }
    }
  });

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Comparison');
  XLSX.writeFile(wb, 'ValQMS_Excel_Comparison.xlsx');
});

/* Reset */
el('resetBtn').addEventListener('click', ()=>{ location.reload(); });
</script>
</body>
</html>
