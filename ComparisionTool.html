<!DOCTYPE html>
<html lang="en" data-theme="green">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Excel Comparison Tool ‚Äî ValQMS</title>
  <link rel="icon" href="favicon.jpg?v=5">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
  
  <!-- SheetJS & Fuse.js -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    
    /* === ALL 15 COLOR THEMES === */
    [data-theme="green"]{--accent:#10b981;--accent-bright:#34d399;--accent-dim:rgba(16,185,129,0.1)}
    [data-theme="cyan"]{--accent:#06b6d4;--accent-bright:#22d3ee;--accent-dim:rgba(6,182,212,0.1)}
    [data-theme="purple"]{--accent:#8b5cf6;--accent-bright:#a78bfa;--accent-dim:rgba(139,92,246,0.1)}
    [data-theme="orange"]{--accent:#f97316;--accent-bright:#fb923c;--accent-dim:rgba(249,115,22,0.1)}
    [data-theme="blue"]{--accent:#3b82f6;--accent-bright:#60a5fa;--accent-dim:rgba(59,130,246,0.1)}
    [data-theme="red"]{--accent:#ef4444;--accent-bright:#f87171;--accent-dim:rgba(239,68,68,0.1)}
    [data-theme="pink"]{--accent:#ec4899;--accent-bright:#f472b6;--accent-dim:rgba(236,72,153,0.1)}
    [data-theme="teal"]{--accent:#14b8a6;--accent-bright:#2dd4bf;--accent-dim:rgba(20,184,166,0.1)}
    [data-theme="indigo"]{--accent:#6366f1;--accent-bright:#818cf8;--accent-dim:rgba(99,102,241,0.1)}
    [data-theme="yellow"]{--accent:#eab308;--accent-bright:#facc15;--accent-dim:rgba(234,179,8,0.1)}
    [data-theme="magenta"]{--accent:#d946ef;--accent-bright:#e879f9;--accent-dim:rgba(217,70,239,0.1)}
    [data-theme="emerald"]{--accent:#059669;--accent-bright:#10b981;--accent-dim:rgba(5,150,105,0.1)}
    [data-theme="amber"]{--accent:#d97706;--accent-bright:#f59e0b;--accent-dim:rgba(217,119,6,0.1)}
    [data-theme="lime"]{--accent:#84cc16;--accent-bright:#a3e635;--accent-dim:rgba(132,204,22,0.1)}
    [data-theme="violet"]{--accent:#7c3aed;--accent-bright:#a78bfa;--accent-dim:rgba(124,58,237,0.1)}

    :root{
      --bg:#0a0e1a;
      --surface:#1a1f2e;
      --border:rgba(255,255,255,0.08);
      --text:#f8fafc;
      --text-dim:#94a3b8;
      --ok:#10b981;
      --warn:#fbbf24;
      --err:#ef4444;
    }
    
    html{scroll-behavior:smooth}
    
    body{
      font-family:'Inter',system-ui,-apple-system,sans-serif;
      background:var(--bg);
      color:var(--text);
      line-height:1.6;
      -webkit-font-smoothing:antialiased;
      padding:24px;
      transition:background 0.3s,color 0.3s;
    }

    /* Header */
    .topbar{
      max-width:1400px;
      margin:0 auto 24px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:16px 24px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      backdrop-filter:blur(12px);
    }

    .brand{display:flex;gap:16px;align-items:center}

    .logo-container{
      display:flex;
      align-items:center;
      gap:12px;
      text-decoration:none;
      color:var(--text);
    }

    .logo-mark{
      display:flex;
      align-items:center;
      justify-content:center;
      width:40px;
      height:40px;
      background:linear-gradient(135deg,var(--accent),var(--accent-bright));
      border-radius:10px;
      overflow:hidden;
      box-shadow:0 4px 16px var(--accent-dim);
      transition:all 0.3s;
    }

    .logo-mark img{
      width:100%;
      height:100%;
      object-fit:contain;
      padding:5px;
    }

    .brand-text h1{
      font-size:20px;
      font-weight:800;
      letter-spacing:-0.5px;
      margin:0;
    }

    .brand-text .subtitle{
      font-size:13px;
      color:var(--text-dim);
      font-weight:500;
    }

    .header-actions{display:flex;gap:12px;align-items:center}

    .btn-home{
      padding:8px 16px;
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:10px;
      color:var(--text-dim);
      text-decoration:none;
      font-size:14px;
      font-weight:600;
      transition:all 0.2s;
    }

    .btn-home:hover{
      background:var(--accent-dim);
      color:var(--text);
      border-color:var(--accent);
    }

    /* Container */
    .container{max-width:1400px;margin:0 auto}

    .card{
      background:var(--surface);
      padding:24px;
      border-radius:16px;
      border:1px solid var(--border);
      margin-bottom:16px;
      transition:all 0.3s;
    }

    .card h3{
      font-size:16px;
      font-weight:700;
      margin:0 0 12px 0;
      letter-spacing:-0.3px;
    }

    /* How to Use with Toggle */
    .how-to-use{
      background:var(--surface);
      border:1px solid var(--border);
      border-radius:16px;
      padding:20px 24px;
      margin-bottom:24px;
      transition:all 0.3s;
    }

    .how-to-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      cursor:pointer;
      user-select:none;
    }

    .how-to-header h3{
      font-size:16px;
      font-weight:700;
      margin:0;
      color:var(--accent);
      display:flex;
      align-items:center;
      gap:8px;
      transition:color 0.3s;
    }

    .toggle-icon{
      font-size:14px;
      transition:transform 0.3s;
    }

    .toggle-icon.collapsed{
      transform:rotate(-90deg);
    }

    .how-to-content{
      overflow:hidden;
      transition:max-height 0.3s ease-out, opacity 0.3s;
      max-height:500px;
      opacity:1;
    }

    .how-to-content.hidden{
      max-height:0;
      opacity:0;
      margin-top:0;
    }

    .how-to-content ul{
      margin:12px 0 0 20px;
      color:var(--text-dim);
      font-size:13px;
      line-height:1.8;
    }

    .how-to-content li{margin-bottom:6px}

    /* Controls */
    .controls{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
      gap:16px;
      margin-bottom:16px;
    }

    .file-input{
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    label.small{
      font-size:13px;
      color:var(--text-dim);
      font-weight:600;
    }

    input[type=file]{
      padding:10px;
      background:var(--accent-dim);
      border:1px solid var(--border);
      border-radius:10px;
      color:var(--text-dim);
      font-size:13px;
      cursor:pointer;
      transition:all 0.2s;
    }

    input[type=file]:hover{
      border-color:var(--accent);
      background:var(--accent-dim);
      filter:brightness(1.2);
    }

    .select{
      padding:10px;
      border-radius:10px;
      background:var(--surface);
      border:1px solid var(--border);
      color:var(--text);
      font-size:13px;
      font-weight:500;
      transition:all 0.2s;
    }

    .select:hover{border-color:var(--accent)}

    .options{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
    }

    .options label{
      display:flex;
      align-items:center;
      gap:6px;
      cursor:pointer;
    }

    /* Buttons */
    .btn{
      padding:10px 20px;
      background:var(--accent);
      color:#fff;
      border:none;
      border-radius:10px;
      font-size:14px;
      font-weight:700;
      cursor:pointer;
      transition:all 0.2s;
    }

    .btn:hover{
      background:var(--accent-bright);
      transform:translateY(-1px);
      box-shadow:0 4px 12px var(--accent-dim);
    }

    .btn.secondary{
      background:var(--surface);
      border:1px solid var(--border);
      color:var(--text-dim);
    }

    .btn.secondary:hover{
      background:var(--accent-dim);
      border-color:var(--accent);
      color:var(--text);
    }

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:16px;
      margin-top:16px;
    }

    .pane{
      min-height:400px;
      max-height:600px;
      overflow:auto;
    }

    .pane-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:12px;
      padding-bottom:12px;
      border-bottom:1px solid var(--border);
    }

    .pane-header h3{
      font-size:15px;
      font-weight:700;
      margin:0;
    }

    /* Table */
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }

    th,td{
      padding:10px 12px;
      border-bottom:1px solid var(--border);
      text-align:left;
    }

    th{
      position:sticky;
      top:0;
      background:var(--surface);
      z-index:2;
      font-weight:700;
      color:var(--text);
    }

    td.diff-cell{background:rgba(251,191,36,0.15)}
    td.added{background:rgba(16,185,129,0.12)}
    td.removed{background:rgba(239,68,68,0.10)}

    /* Legend */
    .legend{
      display:flex;
      gap:12px;
      margin-top:16px;
      flex-wrap:wrap;
    }

    .legend span{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border-radius:10px;
      font-size:13px;
      background:var(--surface);
      border:1px solid var(--border);
      color:var(--text-dim);
      font-weight:500;
    }

    .dot{
      width:12px;
      height:12px;
      border-radius:4px;
      display:inline-block;
    }

    .dot.diff{background:var(--warn)}
    .dot.add{background:var(--ok)}
    .dot.rem{background:var(--err)}

    /* Summary */
    .summary{
      margin-top:16px;
      padding:16px;
      background:var(--accent-dim);
      border:1px solid var(--accent);
      border-radius:10px;
      font-size:14px;
      color:var(--text);
      font-weight:600;
      transition:all 0.3s;
    }

    /* Key checkboxes */
    .key-checkboxes{
      display:flex;
      flex-direction:column;
      gap:6px;
      max-height:180px;
      overflow-y:auto;
      padding:8px;
      border:1px solid var(--border);
      border-radius:10px;
      background:var(--accent-dim);
    }

    .key-checkboxes label{
      display:flex;
      gap:8px;
      cursor:pointer;
      padding:6px;
      border-radius:6px;
      transition:background 0.2s;
    }

    .key-checkboxes label:hover{
      background:rgba(255,255,255,0.05);
    }

    /* Mapping */
    .mapping-row{
      display:grid;
      grid-template-columns:1fr auto 1fr;
      gap:12px;
      align-items:center;
      margin-bottom:8px;
    }

    .mapping-row span{
      text-align:center;
      color:var(--accent);
      font-weight:700;
      transition:color 0.3s;
    }

    /* Responsive */
    @media(max-width:768px){
      .layout{grid-template-columns:1fr}
      .controls{grid-template-columns:1fr}
      .topbar{flex-direction:column;gap:16px;text-align:center}
      .header-actions{width:100%;justify-content:center}
    }
  </style>
</head>
<body>
  
  <!-- Header -->
  <div class="topbar">
    <div class="brand">
      <a href="index.html" class="logo-container">
        <div class="logo-mark">
          <img src="favicon.jpg" alt="ValQMS Logo">
        </div>
        <div class="brand-text">
          <h1>ValQMS Tools</h1>
          <div class="subtitle">Excel Comparison Tool</div>
        </div>
      </a>
    </div>
    <div class="header-actions">
      <a href="index.html" class="btn-home">‚Üê Home</a>
    </div>
  </div>

  <div class="container">
    
    <!-- How to Use with Toggle -->
    <div class="how-to-use">
      <div class="how-to-header" id="howToToggle">
        <h3>üìñ How to Use</h3>
        <span class="toggle-icon" id="toggleIcon">‚ñº</span>
      </div>
      <div class="how-to-content" id="howToContent">
        <ul>
          <li>Step-1:Upload both Excel/CSV files and select sheets from dropdowns</li>
          <li>Step-2:Select one or more key columns to create a composite unique identifier</li>
          <li>Step-3:Use Column Mapping to compare columns with different names</li>
          <li>Step-4:Select <strong>(ignore)</strong> for columns you don't want to compare</li>
          <li>Step-5:Click Compare to highlight differences in both files</li>
          <li>Step-6:Export creates an Excel file with Status & Comments columns</li>
        </ul>
      </div>
    </div>

    <!-- Controls -->
    <section class="card">
      <div class="controls">
        <div class="file-input">
          <label class="small">Base File (Left)</label>
          <input id="fileA" type="file" accept=".xlsx,.xls,.csv">
          <select id="sheetA" class="select"></select>
        </div>

        <div class="file-input">
          <label class="small">Compare File (Right)</label>
          <input id="fileB" type="file" accept=".xlsx,.xls,.csv">
          <select id="sheetB" class="select"></select>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px">
          <label class="small">Match Settings</label>
          <div class="options">
            <select id="fuzzyLevel" class="select">
              <option value="0">Exact match</option>
              <option value="0.3">Low fuzziness</option>
              <option value="0.5" selected>Medium fuzziness</option>
              <option value="0.8">High fuzziness</option>
            </select>
          </div>
          <div class="options">
            <label class="small"><input id="ignoreOrder" type="checkbox"> Ignore order</label>
            <label class="small"><input id="trimSpaces" type="checkbox" checked> Trim spaces</label>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px">
          <label class="small">Actions</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="compareBtn" class="btn">Compare</button>
            <button id="exportDiff" class="btn">Export Excel</button>
          </div>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="autoMapBtn" class="btn secondary">Auto-map</button>
            <button id="resetBtn" class="btn secondary">Reset</button>
          </div>
        </div>
      </div>
    </section>

    <!-- Composite Keys -->
    <section class="card">
      <h3>Composite Key Columns</h3>
      <div class="small" style="margin-bottom:12px;color:var(--text-dim)">Select one or more columns to form a composite key for row matching</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
        <div>
          <div class="small" style="margin-bottom:8px">Base Key Columns:</div>
          <div id="leftKeyCheckboxes" class="key-checkboxes"></div>
        </div>
        <div>
          <div class="small" style="margin-bottom:8px">Compare Key Columns:</div>
          <div id="rightKeyCheckboxes" class="key-checkboxes"></div>
        </div>
      </div>
    </section>

    <!-- Column Mapping -->
    <section class="card">
      <h3>Column Mapping</h3>
      <div class="small" style="margin-bottom:12px;color:var(--text-dim)">Map Base columns to Compare columns. Select <strong>(ignore)</strong> to skip columns</div>
      <div id="mappingContainer"></div>
      <button id="applyMappingBtn" class="btn secondary" style="margin-top:12px">Apply Mapping</button>
    </section>

    <!-- Preview -->
    <div class="layout">
      <div class="pane card">
        <div class="pane-header">
          <h3>Base File</h3>
          <span id="leftName" class="small">‚Äî</span>
        </div>
        <div id="leftPreview"></div>
      </div>

      <div class="pane card">
        <div class="pane-header">
          <h3>Compare File</h3>
          <span id="rightName" class="small">‚Äî</span>
        </div>
        <div id="rightPreview"></div>
      </div>
    </div>

    <!-- Legend & Summary -->
    <div class="legend">
      <span><i class="dot diff"></i> Cell difference</span>
      <span><i class="dot add"></i> Added row</span>
      <span><i class="dot rem"></i> Removed row</span>
    </div>

    <div id="summary" class="summary">No comparison yet. Upload files and click Compare.</div>

  </div>

<script>
/* === HOW TO USE TOGGLE === */
const howToToggle = document.getElementById('howToToggle');
const howToContent = document.getElementById('howToContent');
const toggleIcon = document.getElementById('toggleIcon');

// Load toggle state
const howToVisible = localStorage.getItem('howToVisible') !== 'false';
if(!howToVisible){
  howToContent.classList.add('hidden');
  toggleIcon.classList.add('collapsed');
}

howToToggle.addEventListener('click', () => {
  const isHidden = howToContent.classList.toggle('hidden');
  toggleIcon.classList.toggle('collapsed');
  localStorage.setItem('howToVisible', !isHidden);
});

/* === THEME SYNC (Shared with index.html) === */
function initTheme(){
  const savedTheme = localStorage.getItem('valqmsTheme') || 'green';
  document.documentElement.setAttribute('data-theme', savedTheme);
}
initTheme();

/* === REST OF YOUR EXISTING CODE === */
const el = id => document.getElementById(id);
let workbookA = null, workbookB = null;
let leftSheetName = '', rightSheetName = '';
let dataA = [], dataB = [];
let windowReport = null;
let columnMap = {};

function showEmpty(v){
  return (v === '' || v === null || v === undefined) ? 'empty' : String(v);
}

function readAsWorkbook(file, cb){
  const r = new FileReader();
  r.onload = e => {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, {type:'array'});
    cb(null, wb);
  };
  if(file.name.endsWith('.csv')) r.readAsText(file);
  else r.readAsArrayBuffer(file);
}

function populateSheetSelect(wb, selectEl){
  selectEl.innerHTML = '';
  wb.SheetNames.forEach((s,i)=>{
    const opt = document.createElement('option'); opt.value = s; opt.textContent = s;
    selectEl.appendChild(opt);
  });
}

function sheetToJson(wb, sheetName){
  const ws = wb.Sheets[sheetName]; if(!ws) return [];
  return XLSX.utils.sheet_to_json(ws, {defval:''});
}

function getHeaders(rows){
  if(!rows || rows.length===0) return [];
  return Object.keys(rows[0]);
}

function autoDetectKey(headers){
  const candidates = ['id','uuid','code','reference','name','email'];
  const lower = headers.map(h=>h.toLowerCase());
  for(let c of candidates){
    const idx = lower.findIndex(x=>x.includes(c));
    if(idx>=0) return [headers[idx]];
  }
  return headers[0] ? [headers[0]] : [];
}

function renderTableWithHighlights(container, rows, highlights){
  container.innerHTML = '';
  if(!rows || rows.length===0){ container.innerHTML = '<div class="small">No rows</div>'; return;}
  const headers = getHeaders(rows);
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  headers.forEach(h=>{ const th = document.createElement('th'); th.textContent = h; trh.appendChild(th); });
  thead.appendChild(trh); table.appendChild(thead);
  const tbody = document.createElement('tbody');
  rows.forEach((r,ri)=>{
    const tr = document.createElement('tr');
    headers.forEach(h=>{
      const td = document.createElement('td');
      td.textContent = r[h]===undefined||r[h]===null?'':r[h];
      if(highlights && highlights[ri] && highlights[ri][h]){
        td.classList.add('diff-cell');
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); container.appendChild(table);
}

/* File load */
el('fileA').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  readAsWorkbook(f,(err,wb)=>{
    if(err) return alert('Error reading file A');
    workbookA = wb;
    leftSheetName = wb.SheetNames[0];
    populateSheetSelect(wb, el('sheetA'));
    el('leftName').textContent = f.name;
    dataA = sheetToJson(wb, leftSheetName);
    populateKeyCheckboxes();
    buildColumnMappingUI();
    renderTableWithHighlights(el('leftPreview'), dataA, {});
  });
});

el('fileB').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  readAsWorkbook(f,(err,wb)=>{
    if(err) return alert('Error reading file B');
    workbookB = wb;
    rightSheetName = wb.SheetNames[0];
    populateSheetSelect(wb, el('sheetB'));
    el('rightName').textContent = f.name;
    dataB = sheetToJson(wb, rightSheetName);
    populateKeyCheckboxes();
    buildColumnMappingUI();
    renderTableWithHighlights(el('rightPreview'), dataB, {});
  });
});

el('sheetA').addEventListener('change', e=>{
  if(!workbookA) return;
  leftSheetName = e.target.value;
  dataA = sheetToJson(workbookA, leftSheetName);
  populateKeyCheckboxes();
  buildColumnMappingUI();
  renderTableWithHighlights(el('leftPreview'), dataA, {});
});

el('sheetB').addEventListener('change', e=>{
  if(!workbookB) return;
  rightSheetName = e.target.value;
  dataB = sheetToJson(workbookB, rightSheetName);
  populateKeyCheckboxes();
  buildColumnMappingUI();
  renderTableWithHighlights(el('rightPreview'), dataB, {});
});

/* Key checkboxes */
function populateKeyCheckboxes(){
  const headersA = getHeaders(dataA);
  const headersB = getHeaders(dataB);
  
  const leftContainer = el('leftKeyCheckboxes');
  const rightContainer = el('rightKeyCheckboxes');
  
  leftContainer.innerHTML = '';
  rightContainer.innerHTML = '';
  
  if(!headersA.length || !headersB.length){
    leftContainer.innerHTML = '<div class="small">Load both files</div>';
    rightContainer.innerHTML = '<div class="small">Load both files</div>';
    return;
  }

  const autoA = autoDetectKey(headersA);
  const autoB = autoDetectKey(headersB);
  
  headersA.forEach(h=>{
    const label = document.createElement('label');
    label.className = 'small';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.value = h;
    cb.dataset.side = 'left';
    if(autoA.includes(h)) cb.checked = true;
    label.appendChild(cb);
    label.appendChild(document.createTextNode(h));
    leftContainer.appendChild(label);
  });

  headersB.forEach(h=>{
    const label = document.createElement('label');
    label.className = 'small';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.value = h;
    cb.dataset.side = 'right';
    if(autoB.includes(h)) cb.checked = true;
    label.appendChild(cb);
    label.appendChild(document.createTextNode(h));
    rightContainer.appendChild(label);
  });
}

/* Column mapping */
function buildColumnMappingUI(){
  const container = el('mappingContainer');
  container.innerHTML = '';
  const headersA = getHeaders(dataA);
  const headersB = getHeaders(dataB);
  if(!headersA.length || !headersB.length){
    container.innerHTML = '<div class="small">Load both files to see column mapping.</div>';
    return;
  }

  headersA.forEach(ha=>{
    const row = document.createElement('div');
    row.className = 'mapping-row';

    const selA = document.createElement('select');
    selA.className = 'select';
    selA.innerHTML = `<option value="${ha}">${ha}</option>`;
    selA.disabled = true;

    const arrow = document.createElement('span');
    arrow.textContent = '‚Üí';

    const selB = document.createElement('select');
    selB.className = 'select';
    selB.dataset.baseCol = ha;
    selB.innerHTML = '<option value="__IGNORE__">(ignore)</option><option value="">(same name)</option>' + 
                     headersB.map(hb=>`<option value="${hb}">${hb}</option>`).join('');
    if(headersB.includes(ha)) selB.value = ha;

    row.appendChild(selA);
    row.appendChild(arrow);
    row.appendChild(selB);
    container.appendChild(row);
  });
}

el('applyMappingBtn').addEventListener('click', ()=>{
  const selects = el('mappingContainer').querySelectorAll('select[data-base-col]');
  columnMap = {};
  selects.forEach(sel=>{
    const base = sel.dataset.baseCol;
    const compare = sel.value || base;
    columnMap[base] = compare;
  });
  alert('Column mapping applied!');
});

el('autoMapBtn').addEventListener('click', ()=>{
  const headersA = getHeaders(dataA), headersB = getHeaders(dataB);
  if(!headersA.length || !headersB.length) return alert('Load both sheets first');
  const fuse = new Fuse(headersB, {includeScore:true,threshold:0.5});
  const map = {};
  headersA.forEach(h=>{
    const res = fuse.search(h);
    map[h] = res.length ? res[0].item : h;
  });
  columnMap = map;
  alert('Auto-mapping complete!');
  
  const selects = el('mappingContainer').querySelectorAll('select[data-base-col]');
  selects.forEach(sel=>{
    const base = sel.dataset.baseCol;
    if(map[base]) sel.value = map[base];
  });
});

/* Compare - [YOUR EXISTING COMPARE CODE HERE - keeping it exactly as is] */
el('compareBtn').addEventListener('click', ()=>{
  if(!dataA.length || !dataB.length) return alert('Load both sheets');

  const trim = el('trimSpaces').checked;
  const fuzzyLevel = parseFloat(el('fuzzyLevel').value);

  let a = JSON.parse(JSON.stringify(dataA));
  let b = JSON.parse(JSON.stringify(dataB));

  if(trim){
    a = a.map(r=>{ Object.keys(r).forEach(k=>{ if(typeof r[k]==='string') r[k]=r[k].trim(); }); return r; });
    b = b.map(r=>{ Object.keys(r).forEach(k=>{ if(typeof r[k]==='string') r[k]=r[k].trim(); }); return r; });
  }

  a.forEach((r, idx) => { r.__idx = idx; });
  b.forEach((r, idx) => { r.__idx = idx; });

  const headersA = getHeaders(a), headersB = getHeaders(b);
  
  const leftKeys = Array.from(el('leftKeyCheckboxes').querySelectorAll('input:checked')).map(cb=>cb.value);
  const rightKeys = Array.from(el('rightKeyCheckboxes').querySelectorAll('input:checked')).map(cb=>cb.value);
  
  let keysA = leftKeys.length ? leftKeys : autoDetectKey(headersA);
  let keysB = rightKeys.length ? rightKeys : autoDetectKey(headersB);
  
  if(!keysA.length || !keysB.length) return alert('Select at least one key column');

  const mapB = new Map(); 
  b.forEach((r, idx) => {
    const compositeKey = keysB.map(k => String(r[k] ?? '')).join('|');
    mapB.set(compositeKey, r);
  });
  
  let fuseKeys = null;
  if(fuzzyLevel>0){
    fuseKeys = new Fuse(Array.from(mapB.keys()), {threshold: fuzzyLevel});
  }

  const finalMap = Object.keys(columnMap).length ? columnMap : {};
  if(!Object.keys(finalMap).length){
    headersA.forEach(h=>{ finalMap[h] = h; });
  }

  const highlightsA = {}, highlightsB = {};
  const report = { matched:0, changed:0, added:0, removed:0, rows: [], leftSheet: leftSheetName, rightSheet: rightSheetName };

  const matchedBKeys = new Set();

  for(let i=0;i<a.length;i++){
    const ra = a[i];
    const rawKey = keysA.map(k => String(ra[k] ?? '')).join('|');
    let matchedKey = null;
    if(mapB.has(rawKey)) matchedKey = rawKey;
    else if(fuseKeys){
      const r = fuseKeys.search(rawKey);
      if(r && r.length) matchedKey = r[0].item;
    }

    if(matchedKey === null){
      report.removed++;
      highlightsA[i] = {}; headersA.forEach(h=>highlightsA[i][h]=true);
      report.rows.push({ key: rawKey, type:'removed', left: ra, right: null });
      continue;
    }

    matchedBKeys.add(matchedKey);
    const rb = mapB.get(matchedKey);
    const rowDiffs = {};
    let rowChanged = false;

    headersA.forEach(colA=>{
      if(colA === '__idx') return;
      const colB = finalMap[colA] || colA;
      if(colB === '__IGNORE__') return;
      
      const va = (ra[colA]===undefined||ra[colA]===null)?'':String(ra[colA]);
      const vb = (rb[colB]===undefined||rb[colB]===null)?'':String(rb[colB]);
      if(va !== vb){
        rowDiffs[colA] = colB;
        rowChanged = true;
      }
    });

    if(rowChanged){
      report.changed++;
      highlightsA[i] = {};
      Object.keys(rowDiffs).forEach(k=>highlightsA[i][k]=true);
      const idxB = rb.__idx;
      if(idxB>=0){
        highlightsB[idxB] = {};
        Object.keys(rowDiffs).forEach(k=>highlightsB[idxB][rowDiffs[k]]=true);
      }
      report.rows.push({ key: rawKey, type:'changed', left: ra, right: rb, diffs: rowDiffs });
    } else {
      report.matched++;
      report.rows.push({ key: rawKey, type:'matched', left: ra, right: rb });
    }
  }

  for(let j=0;j<b.length;j++){
    const rb = b[j]; 
    const k = keysB.map(col => String(rb[col] ?? '')).join('|');
    if(!matchedBKeys.has(k)){
      report.added++;
      highlightsB[j] = {}; headersB.forEach(h=>highlightsB[j][h]=true);
      report.rows.push({ key:k, type:'added', left:null, right:rb });
    }
  }

  renderTableWithHighlights(el('leftPreview'), dataA, highlightsA);
  renderTableWithHighlights(el('rightPreview'), dataB, highlightsB);

  el('summary').textContent = `‚úì ${report.matched} matched  ‚Ä¢  ‚ö† ${report.changed} changed  ‚Ä¢  + ${report.added} added  ‚Ä¢  ‚àí ${report.removed} removed`;
  windowReport = report;
});

/* Export - [YOUR EXISTING EXPORT CODE HERE] */
el('exportDiff').addEventListener('click', ()=> {
  if(!windowReport) return alert('Run a comparison first');

  const headersA = getHeaders(dataA).filter(h => h !== '__idx');
  const headersB = getHeaders(dataB).filter(h => h !== '__idx');
  const allHeaders = Array.from(new Set([...headersA, ...headersB]));
  const outHeaders = allHeaders.concat(['Status','Comments']);

  const rowsOut = [];
  windowReport.rows.forEach((r, ridx) => {
    const rowObj = {};
    outHeaders.forEach(h=>{
      if(h==='Status'){
        rowObj[h] = r.type;
      } else if(h==='Comments'){
        if(r.type==='changed'){
          const realDiffs = Object.keys(r.diffs || {}).filter(k => k !== '__idx' && r.diffs[k] !== '__IGNORE__');
          const diffsText = realDiffs.map((colA, i) => {
            const colB = r.diffs[colA];
            const baseVal = r.left ? (r.left[colA] ?? '') : '';
            const cmpVal  = r.right ? (r.right[colB] ?? '') : '';
            
            const colIndexA = allHeaders.indexOf(colA);
            const colLetterA = colIndexA >= 0 ? XLSX.utils.encode_col(colIndexA) : colA;
            
            const colIndexB = allHeaders.indexOf(colB);
            const colLetterB = colIndexB >= 0 ? XLSX.utils.encode_col(colIndexB) : colB;
            
            const leftRowIndex  = (r.left  && r.left.__idx  !== undefined) ? (r.left.__idx  + 2) : (ridx + 2);
            const rightRowIndex = (r.right && r.right.__idx !== undefined) ? (r.right.__idx + 2) : (ridx + 2);
            
            return `${i+1}. Base: ${windowReport.leftSheet}!${colLetterA}${leftRowIndex}="${showEmpty(baseVal)}" ‚Üí Compare: ${windowReport.rightSheet}!${colLetterB}${rightRowIndex}="${showEmpty(cmpVal)}"`;
          }).join('\n');
          rowObj[h] = diffsText;
        } else if (r.type==='added'){
          rowObj[h] = `New row in ${windowReport.rightSheet}`;
        } else if (r.type==='removed'){
          rowObj[h] = `Missing in ${windowReport.rightSheet}`;
        } else {
          rowObj[h] = 'Match';
        }
      } else {
        rowObj[h] = (r.right && r.right[h]!==undefined) ? r.right[h] : (r.left && r.left[h]!==undefined ? r.left[h] : '');
      }
    });
    rowsOut.push(rowObj);
  });

  const ws = XLSX.utils.json_to_sheet(rowsOut, {header: outHeaders});

  rowsOut.forEach((rowObj, ridx)=>{
    const status = rowObj['Status'];
    const excelRow = ridx + 2;
    for(let c=0;c<outHeaders.length;c++){
      const addr = XLSX.utils.encode_cell({r: excelRow-1, c});
      if(!ws[addr]) continue;
      if(status === 'added'){
        ws[addr].s = { fill: { patternType: "solid", fgColor: { rgb: "D1FAE5" } } };
      } else if(status === 'removed'){
        ws[addr].s = { fill: { patternType: "solid", fgColor: { rgb: "FEE2E2" } } };
      } else if(status === 'changed'){
        ws[addr].s = { fill: { patternType: "solid", fgColor: { rgb: "FEF3C7" } } };
      }
    }
  });

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Comparison');
  XLSX.writeFile(wb, 'ValQMS_Excel_Comparison.xlsx');
});

/* Reset */
el('resetBtn').addEventListener('click', ()=>{ location.reload(); });
</script>
</body>
</html>
