<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Advanced Excel Comparison Tool â€” Themed & Fuzzy</title>

  <link rel="icon" type="image/x-icon" href="/favicon.ico">

  <!-- SheetJS for Excel parsing -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <!-- Fuse.js for fuzzy matching -->
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>

  <style>
    :root{
      --bg-light: #f7fafc; --card-light:#ffffff; --text-light:#0f1724; --accent:#06b6d4;
      --bg-dark: #071024; --card-dark: rgba(255,255,255,0.02); --text-dark:#e6eef6;
      --muted-dark: #9aa4b2;
      --ok: #10b981; --warn:#fbbf24; --err:#ef4444;
    }
    html[data-theme="dark"]{ --bg:var(--bg-dark); --card:var(--card-dark); --text:var(--text-dark); --muted:var(--muted-dark); }
    html[data-theme="light"]{ --bg:var(--bg-light); --card:var(--card-light); --text:var(--text-light); --muted:#475569; }

    *{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{margin:0;background:var(--bg);color:var(--text);padding:28px;transition:background .3s,color .3s}
    .container{max-width:1200px;margin:0 auto}
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .brand{display:flex;gap:12px;align-items:center}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 6px 20px rgba(2,6,23,0.15);border:1px solid rgba(255,255,255,0.03)}
    h1{margin:0;font-size:18px}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;margin-bottom:12px}
    .file-input{display:flex;flex-direction:column;gap:8px}
    input[type=file]{padding:8px;background:transparent;color:var(--muted)}
    label.small{font-size:12px;color:var(--muted)}
    .options{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .btn{background:var(--accent);color:#022;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
    .btn.secondary{background:transparent;border:1px solid rgba(0,0,0,0.08);color:var(--muted)}
    .layout{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    .pane{min-height:300px;overflow:auto}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:6px 8px;border-bottom:1px solid rgba(0,0,0,0.06);text-align:left}
    th{position:sticky;top:0;background:rgba(255,255,255,0.01);z-index:2}
    td.diff-cell{background:rgba(251,191,36,0.12)} /* yellow */
    td.added{background:rgba(16,185,129,0.10)} /* green */
    td.removed{background:rgba(239,68,68,0.08)} /* red */
    .legend{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
    .legend span{display:inline-flex;gap:6px;align-items:center;padding:6px 8px;border-radius:8px;font-size:13px;background:rgba(255,255,255,0.01);color:var(--muted)}
    .dot{width:12px;height:12px;border-radius:3px;display:inline-block}
    .dot.diff{background:var(--warn)}.dot.add{background:var(--ok)}.dot.rem{background:var(--err)}
    .footer{margin-top:12px;display:flex;gap:8px;align-items:center}
    .select{padding:8px;border-radius:6px;background:transparent;border:1px solid rgba(255,255,255,0.03);color:var(--muted)}
    .small{font-size:12px;color:var(--muted)}
    .summary{margin-top:12px;color:var(--muted);font-size:13px}
    .theme-toggle{cursor:pointer;padding:6px 10px;border-radius:999px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:var(--muted)}
    .mapping-row{display:grid;grid-template-columns:1fr auto 1fr;gap:8px;align-items:center;margin-bottom:6px}
    .key-checkboxes{display:flex;flex-direction:column;gap:4px;max-height:150px;overflow-y:auto;padding:4px;border:1px solid rgba(255,255,255,0.05);border-radius:6px}
    @media(max-width:880px){ .layout{grid-template-columns:1fr} .controls{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <div class="card" style="padding:10px 12px;display:flex;align-items:center;gap:10px">
          <img src="https://21st.dev/assets/21st-dev-logo-a8a8.svg" alt="21st" style="width:28px;opacity:.95">
        </div>
        <div>
          <h1>Advanced Excel Comparison</h1>
          <div class="small">Fuzzy keys, multi-column composite keys, custom column mapping & colorized export</div>
        </div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="themeBtn" class="theme-toggle">ðŸŒ™ Dark</button>
      </div>
    </div>

    <section class="card">
      <div class="controls">
        <div class="file-input">
          <label class="small">Left file (base)</label>
          <input id="fileA" type="file" accept=".xlsx,.xls,.csv" />
          <select id="sheetA" class="select"></select>
        </div>

        <div class="file-input">
          <label class="small">Right file (compare)</label>
          <input id="fileB" type="file" accept=".xlsx,.xls,.csv" />
          <select id="sheetB" class="select"></select>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px">
          <label class="small">Match settings</label>
          <div class="options">
            <select id="fuzzyLevel" class="select">
              <option value="0">Exact match</option>
              <option value="0.3">Low fuzziness</option>
              <option value="0.5" selected>Medium fuzziness</option>
              <option value="0.8">High fuzziness</option>
            </select>
            <label class="small"><input id="ignoreOrder" type="checkbox"> Ignore row order</label>
            <label class="small"><input id="trimSpaces" type="checkbox" checked> Trim spaces</label>
          </div>
        </div>

        <div style="display:flex;flex-direction:column;gap:8px">
          <label class="small">Actions</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button id="compareBtn" class="btn">Compare</button>
            <button id="autoMapBtn" class="btn secondary">Auto-map columns</button>
            <button id="exportDiff" class="btn">Export Excel (with Comments)</button>
            <button id="resetBtn" class="btn secondary">Reset</button>
          </div>
        </div>
      </div>

      <!-- Multi-column key selection -->
      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 8px 0">Composite Key Columns (select multiple)</h3>
        <div class="small" style="margin-bottom:8px">Check one or more columns to form a composite key for row matching. If no columns selected, auto-detect will be used.</div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
          <div>
            <div class="small" style="margin-bottom:4px">Base Key Columns:</div>
            <div id="leftKeyCheckboxes" class="key-checkboxes"></div>
          </div>
          <div>
            <div class="small" style="margin-bottom:4px">Compare Key Columns:</div>
            <div id="rightKeyCheckboxes" class="key-checkboxes"></div>
          </div>
        </div>
      </div>

      <!-- Column Mapping Section with (ignore) option -->
      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 8px 0">Column Mapping (Optional)</h3>
        <div class="small" style="margin-bottom:8px">Map Base columns to Compare columns. Select <strong>(ignore)</strong> to skip columns during comparison.</div>
        <div id="mappingContainer"></div>
        <button id="applyMappingBtn" class="btn secondary" style="margin-top:8px">Apply Mapping</button>
      </div>

      <div class="layout">
        <div class="pane card">
          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
            <h3 style="margin:0">Left: <span id="leftName" class="small">â€”</span></h3>
          </div>
          <div id="leftPreview"></div>
        </div>

        <div class="pane card">
          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
            <h3 style="margin:0">Right: <span id="rightName" class="small">â€”</span></h3>
          </div>
          <div id="rightPreview"></div>
        </div>
      </div>

      <div class="legend">
        <span><i class="dot diff"></i> Cell difference</span>
        <span><i class="dot add"></i> Added</span>
        <span><i class="dot rem"></i> Removed</span>
      </div>

      <div class="footer">
        <div class="small">Summary:</div>
        <div id="summary" class="summary">No comparison yet.</div>
      </div>

      <details style="margin-top:12px"><summary>Notes</summary>
        <ul>
          <li>Choose sheets from dropdowns after upload.</li>
          <li>Select one or more key columns to create a composite unique identifier for row matching.</li>
          <li>Use Column Mapping to compare Base column "A" with Compare column "B" if they have different names.</li>
          <li>Select <strong>(ignore)</strong> for columns you don't want to compare.</li>
          <li>Export creates a Comparison sheet with Status & Comments columns and attempts to style rows.</li>
        </ul>
      </details>
    </section>
  </div>

<script>
/* ---------------------
  State & helpers
----------------------*/
const el = id => document.getElementById(id);
let workbookA = null, workbookB = null;
let leftSheetName = '', rightSheetName = '';
let dataA = [], dataB = [];
let windowReport = null;
let columnMap = {}; // stores Base â†’ Compare column mappings (or '__IGNORE__')

function showEmpty(v){
  return (v === '' || v === null || v === undefined) ? 'empty' : String(v);
}

function readAsWorkbook(file, cb){
  const r = new FileReader();
  r.onload = e => {
    const data = new Uint8Array(e.target.result);
    const wb = XLSX.read(data, {type:'array'});
    cb(null, wb);
  };
  if(file.name.endsWith('.csv')) r.readAsText(file);
  else r.readAsArrayBuffer(file);
}

function populateSheetSelect(wb, selectEl){
  selectEl.innerHTML = '';
  wb.SheetNames.forEach((s,i)=>{
    const opt = document.createElement('option'); opt.value = s; opt.textContent = s;
    selectEl.appendChild(opt);
  });
}

function sheetToJson(wb, sheetName){
  const ws = wb.Sheets[sheetName]; if(!ws) return [];
  return XLSX.utils.sheet_to_json(ws, {defval:''});
}

function getHeaders(rows){
  if(!rows || rows.length===0) return [];
  return Object.keys(rows[0]);
}

function autoDetectKey(headers){
  const candidates = ['id','uuid','code','reference','name','email'];
  const lower = headers.map(h=>h.toLowerCase());
  for(let c of candidates){
    const idx = lower.findIndex(x=>x.includes(c));
    if(idx>=0) return [headers[idx]]; // return array
  }
  return headers[0] ? [headers[0]] : [];
}

function renderTableWithHighlights(container, rows, highlights){
  container.innerHTML = '';
  if(!rows || rows.length===0){ container.innerHTML = '<div class="small">No rows</div>'; return;}
  const headers = getHeaders(rows);
  const table = document.createElement('table');
  const thead = document.createElement('thead');
  const trh = document.createElement('tr');
  headers.forEach(h=>{ const th = document.createElement('th'); th.textContent = h; trh.appendChild(th); });
  thead.appendChild(trh); table.appendChild(thead);
  const tbody = document.createElement('tbody');
  rows.forEach((r,ri)=>{
    const tr = document.createElement('tr');
    headers.forEach(h=>{
      const td = document.createElement('td');
      td.textContent = r[h]===undefined||r[h]===null?'':r[h];
      if(highlights && highlights[ri] && highlights[ri][h]){
        td.classList.add('diff-cell');
      }
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
  table.appendChild(tbody); container.appendChild(table);
}

/* ---------------------
  File load & sheet selection
----------------------*/
el('fileA').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  readAsWorkbook(f,(err,wb)=>{
    if(err) return alert('Error reading file A');
    workbookA = wb;
    leftSheetName = wb.SheetNames[0];
    populateSheetSelect(wb, el('sheetA'));
    el('leftName').textContent = f.name;
    dataA = sheetToJson(wb, leftSheetName);
    populateKeyCheckboxes();
    buildColumnMappingUI();
    renderTableWithHighlights(el('leftPreview'), dataA, {});
  });
});

el('fileB').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  readAsWorkbook(f,(err,wb)=>{
    if(err) return alert('Error reading file B');
    workbookB = wb;
    rightSheetName = wb.SheetNames[0];
    populateSheetSelect(wb, el('sheetB'));
    el('rightName').textContent = f.name;
    dataB = sheetToJson(wb, rightSheetName);
    populateKeyCheckboxes();
    buildColumnMappingUI();
    renderTableWithHighlights(el('rightPreview'), dataB, {});
  });
});

el('sheetA').addEventListener('change', e=>{
  if(!workbookA) return;
  leftSheetName = e.target.value;
  dataA = sheetToJson(workbookA, leftSheetName);
  populateKeyCheckboxes();
  buildColumnMappingUI();
  renderTableWithHighlights(el('leftPreview'), dataA, {});
});

el('sheetB').addEventListener('change', e=>{
  if(!workbookB) return;
  rightSheetName = e.target.value;
  dataB = sheetToJson(workbookB, rightSheetName);
  populateKeyCheckboxes();
  buildColumnMappingUI();
  renderTableWithHighlights(el('rightPreview'), dataB, {});
});

/* ---------------------
  Populate key checkboxes for multi-column composite keys
----------------------*/
function populateKeyCheckboxes(){
  const headersA = getHeaders(dataA);
  const headersB = getHeaders(dataB);
  
  const leftContainer = el('leftKeyCheckboxes');
  const rightContainer = el('rightKeyCheckboxes');
  
  leftContainer.innerHTML = '';
  rightContainer.innerHTML = '';
  
  if(!headersA.length || !headersB.length){
    leftContainer.innerHTML = '<div class="small">Load both files</div>';
    rightContainer.innerHTML = '<div class="small">Load both files</div>';
    return;
  }

  // Auto-detect and pre-check first key column
  const autoA = autoDetectKey(headersA);
  const autoB = autoDetectKey(headersB);
  
  headersA.forEach(h=>{
    const label = document.createElement('label');
    label.className = 'small';
    label.style.display = 'flex';
    label.style.gap = '6px';
    label.style.cursor = 'pointer';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.value = h;
    cb.dataset.side = 'left';
    if(autoA.includes(h)) cb.checked = true;
    label.appendChild(cb);
    label.appendChild(document.createTextNode(h));
    leftContainer.appendChild(label);
  });

  headersB.forEach(h=>{
    const label = document.createElement('label');
    label.className = 'small';
    label.style.display = 'flex';
    label.style.gap = '6px';
    label.style.cursor = 'pointer';
    const cb = document.createElement('input');
    cb.type = 'checkbox';
    cb.value = h;
    cb.dataset.side = 'right';
    if(autoB.includes(h)) cb.checked = true;
    label.appendChild(cb);
    label.appendChild(document.createTextNode(h));
    rightContainer.appendChild(label);
  });
}

/* ---------------------
  Build column mapping UI with (ignore) option
----------------------*/
function buildColumnMappingUI(){
  const container = el('mappingContainer');
  container.innerHTML = '';
  const headersA = getHeaders(dataA);
  const headersB = getHeaders(dataB);
  if(!headersA.length || !headersB.length){
    container.innerHTML = '<div class="small">Load both files to see column mapping.</div>';
    return;
  }

  headersA.forEach(ha=>{
    const row = document.createElement('div');
    row.className = 'mapping-row';

    const selA = document.createElement('select');
    selA.className = 'select';
    selA.innerHTML = `<option value="${ha}">${ha}</option>`;
    selA.disabled = true;

    const arrow = document.createElement('span');
    arrow.textContent = 'â†’';
    arrow.className = 'small';

    const selB = document.createElement('select');
    selB.className = 'select';
    selB.dataset.baseCol = ha;
    selB.innerHTML = '<option value="__IGNORE__">(ignore)</option><option value="">(same name)</option>' + 
                     headersB.map(hb=>`<option value="${hb}">${hb}</option>`).join('');
    if(headersB.includes(ha)) selB.value = ha;

    row.appendChild(selA);
    row.appendChild(arrow);
    row.appendChild(selB);
    container.appendChild(row);
  });
}

/* ---------------------
  Apply mapping button
----------------------*/
el('applyMappingBtn').addEventListener('click', ()=>{
  const selects = el('mappingContainer').querySelectorAll('select[data-base-col]');
  columnMap = {};
  selects.forEach(sel=>{
    const base = sel.dataset.baseCol;
    const compare = sel.value || base;
    columnMap[base] = compare;
  });
  alert('Column mapping applied. Click Compare to use it.');
  console.log('Column map:', columnMap);
});

/* ---------------------
  Auto-map columns (simple header fuzzy)
----------------------*/
el('autoMapBtn').addEventListener('click', ()=>{
  const headersA = getHeaders(dataA), headersB = getHeaders(dataB);
  if(!headersA.length || !headersB.length) return alert('Load both sheets first');
  const fuse = new Fuse(headersB, {includeScore:true,threshold:0.5});
  const map = {};
  headersA.forEach(h=>{
    const res = fuse.search(h);
    map[h] = res.length ? res[0].item : h;
  });
  columnMap = map;
  alert('Auto-mapping complete (console). Check column mapping UI and adjust if needed, then Apply Mapping.');
  console.log('Auto column map', map);
  
  const selects = el('mappingContainer').querySelectorAll('select[data-base-col]');
  selects.forEach(sel=>{
    const base = sel.dataset.baseCol;
    if(map[base]) sel.value = map[base];
  });
});

/* ---------------------
  Compare logic with multi-column composite keys
----------------------*/
el('compareBtn').addEventListener('click', ()=>{
  if(!dataA.length || !dataB.length) return alert('Load both sheets and select the sheets');

  const trim = el('trimSpaces').checked;
  const fuzzyLevel = parseFloat(el('fuzzyLevel').value);

  let a = JSON.parse(JSON.stringify(dataA));
  let b = JSON.parse(JSON.stringify(dataB));

  if(trim){
    a = a.map(r=>{ Object.keys(r).forEach(k=>{ if(typeof r[k]==='string') r[k]=r[k].trim(); }); return r; });
    b = b.map(r=>{ Object.keys(r).forEach(k=>{ if(typeof r[k]==='string') r[k]=r[k].trim(); }); return r; });
  }

  // Tag original indices
  a.forEach((r, idx) => { r.__idx = idx; });
  b.forEach((r, idx) => { r.__idx = idx; });

  const headersA = getHeaders(a), headersB = getHeaders(b);
  
  // Get checked key columns
  const leftKeys = Array.from(el('leftKeyCheckboxes').querySelectorAll('input:checked')).map(cb=>cb.value);
  const rightKeys = Array.from(el('rightKeyCheckboxes').querySelectorAll('input:checked')).map(cb=>cb.value);
  
  let keysA = leftKeys.length ? leftKeys : autoDetectKey(headersA);
  let keysB = rightKeys.length ? rightKeys : autoDetectKey(headersB);
  
  if(!keysA.length || !keysB.length) return alert('Could not determine key columns â€” please check at least one.');

  // Build composite key maps
  const mapB = new Map(); 
  b.forEach((r, idx) => {
    const compositeKey = keysB.map(k => String(r[k] ?? '')).join('|');
    mapB.set(compositeKey, r);
  });
  
  let fuseKeys = null;
  if(fuzzyLevel>0){
    fuseKeys = new Fuse(Array.from(mapB.keys()), {threshold: fuzzyLevel});
  }

  // Use column map if set, else default 1:1
  const finalMap = Object.keys(columnMap).length ? columnMap : {};
  if(!Object.keys(finalMap).length){
    headersA.forEach(h=>{ finalMap[h] = h; });
  }

  const allCols = Array.from(new Set([...headersA, ...Object.values(finalMap).filter(v => v !== '__IGNORE__')]));
  const highlightsA = {}, highlightsB = {};
  const report = { matched:0, changed:0, added:0, removed:0, rows: [], leftSheet: leftSheetName, rightSheet: rightSheetName };

  const matchedBKeys = new Set();

  // Iterate A
  for(let i=0;i<a.length;i++){
    const ra = a[i];
    const rawKey = keysA.map(k => String(ra[k] ?? '')).join('|');
    let matchedKey = null;
    if(mapB.has(rawKey)) matchedKey = rawKey;
    else if(fuseKeys){
      const r = fuseKeys.search(rawKey);
      if(r && r.length) matchedKey = r[0].item;
    }

    if(matchedKey === null){
      report.removed++;
      highlightsA[i] = {}; headersA.forEach(h=>highlightsA[i][h]=true);
      report.rows.push({ key: rawKey, type:'removed', left: ra, right: null });
      continue;
    }

    matchedBKeys.add(matchedKey);
    const rb = mapB.get(matchedKey);
    const rowDiffs = {};
    let rowChanged = false;

    // Compare using column map, skip __idx and __IGNORE__
    headersA.forEach(colA=>{
      if(colA === '__idx') return;
      const colB = finalMap[colA] || colA;
      if(colB === '__IGNORE__') return;
      
      const va = (ra[colA]===undefined||ra[colA]===null)?'':String(ra[colA]);
      const vb = (rb[colB]===undefined||rb[colB]===null)?'':String(rb[colB]);
      if(va !== vb){
        rowDiffs[colA] = colB;
        rowChanged = true;
      }
    });

    if(rowChanged){
      report.changed++;
      highlightsA[i] = {};
      Object.keys(rowDiffs).forEach(k=>highlightsA[i][k]=true);
      const idxB = rb.__idx;
      if(idxB>=0){
        highlightsB[idxB] = {};
        Object.keys(rowDiffs).forEach(k=>highlightsB[idxB][rowDiffs[k]]=true);
      }
      report.rows.push({ key: rawKey, type:'changed', left: ra, right: rb, diffs: rowDiffs });
    } else {
      report.matched++;
      report.rows.push({ key: rawKey, type:'matched', left: ra, right: rb });
    }
  }

  // Added rows in B
  for(let j=0;j<b.length;j++){
    const rb = b[j]; 
    const k = keysB.map(col => String(rb[col] ?? '')).join('|');
    if(!matchedBKeys.has(k)){
      report.added++;
      highlightsB[j] = {}; headersB.forEach(h=>highlightsB[j][h]=true);
      report.rows.push({ key:k, type:'added', left:null, right:rb });
    }
  }

  renderTableWithHighlights(el('leftPreview'), dataA, highlightsA);
  renderTableWithHighlights(el('rightPreview'), dataB, highlightsB);

  el('summary').textContent = `${report.matched} matched â€¢ ${report.changed} changed â€¢ ${report.added} added â€¢ ${report.removed} removed`;
  windowReport = report;
});

/* ---------------------
  Export Excel with numbered Comments
----------------------*/
el('exportDiff').addEventListener('click', ()=> {
  if(!windowReport) return alert('Run a comparison first');

  const headersA = getHeaders(dataA).filter(h => h !== '__idx');
  const headersB = getHeaders(dataB).filter(h => h !== '__idx');
  const allHeaders = Array.from(new Set([...headersA, ...headersB]));
  const outHeaders = allHeaders.concat(['Status','Comments']);

  const rowsOut = [];
  windowReport.rows.forEach((r, ridx) => {
    const rowObj = {};
    outHeaders.forEach(h=>{
      if(h==='Status'){
        rowObj[h] = r.type;
      } else if(h==='Comments'){
        if(r.type==='changed'){
          const realDiffs = Object.keys(r.diffs || {}).filter(k => k !== '__idx' && r.diffs[k] !== '__IGNORE__');
          const diffsText = realDiffs.map((colA, i) => {
            const colB = r.diffs[colA];
            const baseVal = r.left ? (r.left[colA] ?? '') : '';
            const cmpVal  = r.right ? (r.right[colB] ?? '') : '';
            
            const colIndexA = allHeaders.indexOf(colA);
            const colLetterA = colIndexA >= 0 ? XLSX.utils.encode_col(colIndexA) : colA;
            
            const colIndexB = allHeaders.indexOf(colB);
            const colLetterB = colIndexB >= 0 ? XLSX.utils.encode_col(colIndexB) : colB;
            
            const leftRowIndex  = (r.left  && r.left.__idx  !== undefined) ? (r.left.__idx  + 2) : (ridx + 2);
            const rightRowIndex = (r.right && r.right.__idx !== undefined) ? (r.right.__idx + 2) : (ridx + 2);
            
            return `${i+1}. Base: ${windowReport.leftSheet}!${colLetterA}${leftRowIndex}="${showEmpty(baseVal)}" â†’ Compare: ${windowReport.rightSheet}!${colLetterB}${rightRowIndex}="${showEmpty(cmpVal)}"`;
          }).join('\n');
          rowObj[h] = diffsText;
        } else if (r.type==='added'){
          rowObj[h] = `New row in ${windowReport.rightSheet}`;
        } else if (r.type==='removed'){
          rowObj[h] = `Missing in ${windowReport.rightSheet}`;
        } else {
          rowObj[h] = 'Match';
        }
      } else {
        rowObj[h] = (r.right && r.right[h]!==undefined) ? r.right[h] : (r.left && r.left[h]!==undefined ? r.left[h] : '');
      }
    });
    rowsOut.push(rowObj);
  });

  const ws = XLSX.utils.json_to_sheet(rowsOut, {header: outHeaders});

  rowsOut.forEach((rowObj, ridx)=>{
    const status = rowObj['Status'];
    const excelRow = ridx + 2;
    for(let c=0;c<outHeaders.length;c++){
      const addr = XLSX.utils.encode_cell({r: excelRow-1, c});
      if(!ws[addr]) continue;
      if(status === 'added'){
        ws[addr].s = { fill: { patternType: "solid", fgColor: { rgb: "D1FAE5" } } };
      } else if(status === 'removed'){
        ws[addr].s = { fill: { patternType: "solid", fgColor: { rgb: "FEE2E2" } } };
      } else if(status === 'changed'){
        ws[addr].s = { fill: { patternType: "solid", fgColor: { rgb: "FEF3C7" } } };
      }
    }
  });

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Comparison');
  XLSX.writeFile(wb, 'Excel_Comparison_with_Comments.xlsx');
});

/* ---------------------
  Reset
----------------------*/
el('resetBtn').addEventListener('click', ()=>{ location.reload(); });

/* ---------------------
 Theme toggle
----------------------*/
const themeBtn = el('themeBtn');
function initTheme(){
  const saved = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', saved);
  themeBtn.textContent = saved === 'dark' ? 'ðŸŒ™ Dark' : 'ðŸŒž Light';
}
themeBtn.addEventListener('click', ()=>{
  const current = document.documentElement.getAttribute('data-theme') || 'dark';
  const next = current === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
  themeBtn.textContent = next === 'dark' ? 'ðŸŒ™ Dark' : 'ðŸŒž Light';
});
initTheme();
</script>
</body>
</html>
